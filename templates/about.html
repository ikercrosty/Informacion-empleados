{% extends "layout.html" %}
{% block title %}Información Académica{% endblock %}

{% block content %}
<div class="jumbotron">
  <h1 class="display-4">Información Académica</h1>
  <p class="lead">Datos académicos de los empleados</p>
</div>

<div class="mb-3">
  <button id="btnAgregar" type="button" class="btn btn-success btn-sm">Agregar</button>
  <button id="btnEditar" type="button" class="btn btn-primary btn-sm" disabled>Editar</button>
  <button id="btnGuardar" type="button" class="btn btn-success btn-sm">Guardar</button>
  <button id="btnCancelar" type="button" class="btn btn-secondary btn-sm">Cancelar</button>
</div>

<div class="table-responsive">
  <table id="tablaAcademico" class="table table-bordered table-striped table-hover table-sm">
    <thead class="thead-dark">
      <tr>
        <th>DPI</th>
        <th>Nombre</th>
        <th>Apellidos</th>
        <th>Nivel de estudios</th>
        <th>Profesión u Oficio</th>
        <th>Colegio o establecimiento</th>
        <th>Cursos o títulos adicionales</th>
      </tr>
    </thead>
    <tbody>
      {% if empleados %}
        {% for e in empleados %}
        <tr>
          <td>{{ e['Numero de DPI'] }}</td>
          <td>{{ e['Nombre'] }}</td>
          <td>{{ e['Apellidos'] }}</td>
          <td>{{ e.get('Nivel de estudios') }}</td>
          <td>{{ e.get('Profesión u Oficio') }}</td>
          <td>{{ e.get('Colegio o establecimiento') }}</td>
          <td>{{ e.get('Cursos o titulos adicionales') }}</td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted">No hay registros. Usa "Agregar" para crear la primera fila.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Include shared behavior AFTER the DOM elements above -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Register the table so main.js can wire selection / dblclick and use its API
  // registrarTabla(idTabla, columnas, endpoint, campos, bloqueadas)
  window.registrarTabla(
    'tablaAcademico',
    7,
    '/guardar_academico',
    [
      "Numero de DPI","Nombre","Apellidos",
      "Nivel de estudios","Profesión u Oficio",
      "Colegio o establecimiento","Cursos o titulos adicionales"
    ],
    [0,1,2] // columnas bloqueadas: DPI, Nombre, Apellidos
  );

  // Ensure buttons are enabled per your request:
  const btnAgregar = document.getElementById('btnAgregar');
  const btnEditar  = document.getElementById('btnEditar');
  const btnGuardar = document.getElementById('btnGuardar');
  const btnCancelar= document.getElementById('btnCancelar');

  if (btnAgregar) btnAgregar.disabled = false;
  if (btnEditar)  btnEditar.disabled = true;   // only enabled after double-click (main.js dblclick enables it)
  if (btnGuardar) btnGuardar.disabled = false;  // keep available
  if (btnCancelar) btnCancelar.disabled = false; // keep available

  // If main.js did not attach listeners (rare), attach fallback handlers that call the same functions inside main.js:
  // main.js attaches handlers to btnAgregar, btnEditar, btnGuardar, btnCancelar at load time when it finds elements.
  // The fallback below is safe: it only attaches if the button has no 'data-handler-attached' marker.
  function safeAttach(btn, ev, fnName) {
    if (!btn) return;
    if (btn.dataset.handlerAttached) return;
    btn.addEventListener(ev, (e) => {
      e.stopPropagation();
      // Some main.js versions expose helpers; try to call expected functions if present,
      // otherwise trigger a click on the handlers already in main.js (if any).
      // We call the click to ensure existing listeners run.
      btn.click();
    });
    btn.dataset.handlerAttached = '1';
  }

  // Provide a small visual cue when user double-click enables Edit (main.js should do this)
  const tabla = document.getElementById('tablaAcademico');
  if (tabla) {
    tabla.addEventListener('dblclick', (e) => {
      // ensure Edit button enabled after user double-clicks a row (in case main.js didn't)
      if (btnEditar) btnEditar.disabled = false;
    });
  }

  // Nothing else to force; main.js manages the rest (select, edit, save) through registrarTabla.
});
</script>
{% endblock %}
