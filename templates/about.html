{% extends "layout.html" %}
{% block title %}Información Académica{% endblock %}

{% block content %}
  <div class="jumbotron-welcome rounded-3 mb-3">
    <div class="d-flex flex-column flex-md-row align-items-center gap-3">
      <div class="flex-grow-1">
        <h1 class="h3 mb-1" style="letter-spacing: .2px; font-weight:700; color:#0b486b;">
          Información Académica
        </h1>
        <p class="text-muted mb-2" style="font-size:0.95rem;">
        Datos académicos de los empleados
<br>
<br>
<br>
        </p>
        <p class="text-muted mb-1" style="font-size:0.65rem;">
        'Presionar "Agrega" para poder agregar un nuevo empleado.'
        </p>
        <p class="text-muted mb-1" style="font-size:0.65rem;">
        'Hacer doble click en una fila para poder "Editar".'
        </p>
        <p class="text-muted mb-1" style="font-size:0.65rem;">
        'Siempre presionar el botón guardar para conservar los cambios.'
        </p>


        <div class="d-flex flex-wrap gap-2 align-items-center mt-2">
          <div class="d-flex gap-2">
          </div>
        </div>
      </div>

      <div class="d-none d-md-flex align-items-center" style="min-width:220px; justify-content:flex-end;">
        <div style="text-align:right;">
          <div style="font-size:.82rem; color:#6b7280;">Empresa</div>
          <div style="font-weight:700; color:#0b486b;">EMPAQUES Y TEXTURAS DE GUATEMALA, S.A.</div>
        </div>
      </div>
    </div>
  </div>

<div class="mb-3">
  <button id="btnAgregar" type="button" class="btn btn-success btn-sm">Agregar</button>
  <button id="btnEditar" type="button" class="btn btn-primary btn-sm" disabled>Editar</button>
  <button id="btnGuardar" type="button" class="btn btn-success btn-sm">Guardar</button>
  <button id="btnCancelar" type="button" class="btn btn-secondary btn-sm">Cancelar</button>
</div>

<div class="table-responsive">
  <table id="tablaAcademico" class="table table-bordered table-striped table-hover table-sm">
    <thead class="thead-dark">
      <tr>
        <th>DPI</th>
        <th>Nombre</th>
        <th>Apellidos</th>
        <th>Nivel de estudios</th>
        <th>Profesión u Oficio</th>
        <th>Colegio o establecimiento</th>
        <th>Cursos o títulos adicionales</th>
      </tr>
    </thead>
    <tbody>
      {% if empleados %}
        {% for e in empleados %}
        <tr>
          <td>{{ e['Numero de DPI']|default('') }}</td>
          <td>{{ e.get('Nombre')|default('') }}</td>
          <td>{{ e.get('Apellidos')|default('') }}</td>
          <td>{{ e.get('Nivel de estudios')|default('') }}</td>
          <td>{{ e.get('Profesión u Oficio')|default('') }}</td>
          <td>{{ e.get('Colegio o establecimiento')|default('') }}</td>
          <td>{{ e.get('Cursos o titulos adicionales')|default('') }}</td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="text-center text-muted">No hay registros. Usa "Agregar" para crear la primera fila.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
(function () {
  const TABLE_ID = 'tablaAcademico';
  const ENDPOINT = '/guardar_academico';
  const COLUMNS = 7;
  const BLOQUEADAS = [0,1,2]; // DPI, Nombre, Apellidos

  function flash(msg, type='info') {
    const id = 'aboutFlash';
    const prev = document.getElementById(id);
    if (prev) prev.remove();
    const d = document.createElement('div');
    d.id = id;
    d.className = `alert alert-${type} py-1 px-2 small position-fixed`;
    d.style.top = '16px';
    d.style.right = '16px';
    d.style.zIndex = 3000;
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(()=> d.remove(), 1800);
  }

  function tryRegister(retries = 20) {
    if (window.registrarTabla && typeof window.registrarTabla === 'function') {
      window.registrarTabla(
        TABLE_ID,
        COLUMNS,
        ENDPOINT,
        [
          "Numero de DPI","Nombre","Apellidos",
          "Nivel de estudios","Profesión u Oficio",
          "Colegio o establecimiento","Cursos o titulos adicionales"
        ],
        BLOQUEADAS
      );

      // requested button states
      const btnAgregar = document.getElementById('btnAgregar');
      const btnEditar  = document.getElementById('btnEditar');
      const btnGuardar = document.getElementById('btnGuardar');
      const btnCancelar= document.getElementById('btnCancelar');
      if (btnAgregar) btnAgregar.disabled = false;
      if (btnEditar)  btnEditar.disabled = true;
      if (btnGuardar) btnGuardar.disabled = false;
      if (btnCancelar) btnCancelar.disabled = false;

      // fallback attachments: use the public API exported by main.js safely
      const mainApi = window.__MAIN_TABLA || {};
      const addFn = mainApi.agregarFila || mainApi.addRow || mainApi.nuevo || null;
      const editFn = mainApi.editarFila || null;
      const saveFn = mainApi.guardarFila || null;
      const cancelFn = mainApi.cancelar || null;

      function safeAttach(id, fn) {
        const el = document.getElementById(id);
        if (!el || !fn) return;
        if (el.dataset.mainAttached) return;
        el.addEventListener('click', (e) => { e.stopPropagation(); fn(); });
        el.dataset.mainAttached = '1';
      }

      // Attach only if functions are present. This avoids ReferenceError or attaching undefined.
      safeAttach('btnAgregar', addFn);
      safeAttach('btnEditar', editFn);
      safeAttach('btnGuardar', saveFn);
      safeAttach('btnCancelar', cancelFn);

      // ensure dblclick enables Edit (defensive)
      const tabla = document.getElementById(TABLE_ID);
      if (tabla) {
        tabla.addEventListener('dblclick', (e) => {
          const tr = e.target.closest('tr');
          if (!tr || tr.parentElement.tagName !== 'TBODY') return;
          const be = document.getElementById('btnEditar');
          if (be) be.disabled = false;
        });
      }

      // Now replace click behavior: block any single-click selection added elsewhere
      // and implement our dblclick-based selection + photo load + edit start.
      installClickBlockAndDblHandler();

      return;
    }

    if (retries <= 0) {
      console.error('registrarTabla no disponible después de esperar main.js');
      flash('Error inicializando la tabla', 'danger');
      return;
    }
    setTimeout(() => tryRegister(retries - 1), 100);
  }

  function installClickBlockAndDblHandler() {
    const tabla = document.getElementById(TABLE_ID);
    if (!tabla) return;

    // Prevent any single-click from selecting rows or triggering handlers added elsewhere.
    // Use capture phase to intercept clicks before other listeners. We call stopImmediatePropagation
    // on the captured event to minimize other handlers being invoked.
    // Note: dblclick will still fire after two clicks.
    const clickBlocker = (e) => {
      // Ignore clicks that are not within tbody rows
      const tr = e.target && e.target.closest && e.target.closest('tr');
      if (!tr || tr.parentElement.tagName !== 'TBODY') return;
      // Prevent single-click effects
      try {
        e.stopImmediatePropagation();
      } catch (err) {
        e.stopPropagation();
      }
      e.preventDefault();
    };
    tabla.addEventListener('click', clickBlocker, true);

    // Helper utilities for photo panel (mirrors expected behavior from main app)
    const fotoEmpleado = document.getElementById('fotoEmpleado');
    const formSubir = document.getElementById('formSubirFoto');
    const formEliminar = document.getElementById('formEliminarFoto');
    const inputDpiUpload = document.getElementById('inputDpiForUpload');
    const inputDpiDelete = document.getElementById('inputDpiForDelete');

    function clearPhotoPanel() {
      if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
      if (formSubir) formSubir.style.display = 'none';
      if (formEliminar) formEliminar.style.display = 'none';
      if (inputDpiUpload) inputDpiUpload.value = '';
      if (inputDpiDelete) inputDpiDelete.value = '';
    }

    async function loadPhotoForDpi(dpi) {
      if (!dpi) {
        clearPhotoPanel();
        return;
      }
      if (inputDpiUpload) inputDpiUpload.value = dpi;
      if (inputDpiDelete) inputDpiDelete.value = dpi;
      try {
        const res = await fetch(`/api/foto/${encodeURIComponent(dpi)}`, { cache: 'no-store' });
        if (!res.ok) throw new Error('no-photo');
        const j = await res.json();
        if (j && j.url) {
          if (fotoEmpleado) fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
          if (formSubir) formSubir.style.display = 'none';
          if (formEliminar) formEliminar.style.display = 'block';
        } else {
          if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
          if (formSubir) formSubir.style.display = 'block';
          if (formEliminar) formEliminar.style.display = 'none';
        }
      } catch (e) {
        if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
        if (formSubir) formSubir.style.display = 'block';
        if (formEliminar) formEliminar.style.display = 'none';
      }
    }

    function clearSelection() {
      tabla.querySelectorAll('tbody tr').forEach(r => r.classList.remove('selected'));
    }

    // dblclick handler: select row + load photo + (optionally) start edit or delete with shift
    tabla.addEventListener('dblclick', async (ev) => {
      const tr = ev.target.closest && ev.target.closest('tr');
      if (!tr || tr.parentElement.tagName !== 'TBODY') return;

      // Select visually
      clearSelection();
      tr.classList.add('selected');

      // DPI handling for photo panel
      const dpi = (tr.cells[0] && tr.cells[0].innerText || '').trim();
      if (!dpi) { clearPhotoPanel(); return; }
      if (inputDpiUpload) inputDpiUpload.value = dpi;
      if (inputDpiDelete) inputDpiDelete.value = dpi;

      // Load photo (same behavior that single-click had before)
      await loadPhotoForDpi(dpi);

      // If shiftKey pressed => attempt delete (if your app supports it via dblclick+shift)
      if (ev.shiftKey) {
        // Delegate to global delete function if exists, otherwise show flash
        if (typeof window.eliminarFilaSeleccionada === 'function') {
          try { await window.eliminarFilaSeleccionada(tr); } catch (e) { flash('Error eliminando fila', 'danger'); }
        } else {
          flash('Shift+dblclick: eliminar fila (admin) [implementa eliminarFilaSeleccionada]', 'info');
        }
        return;
      }

      // Otherwise try to start edit (only if function exists)
      const be = document.getElementById('btnEditar');
      if (be) be.disabled = false;

      if (typeof window.iniciarEdicion === 'function') {
        try { window.iniciarEdicion(tr); } catch (e) { try { window.iniciarEdicion(); } catch (err) { flash('Editar: acción iniciada', 'info'); } }
      } else {
        flash('Editar: acción iniciada', 'info');
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => tryRegister(20));
  } else {
    tryRegister(20);
  }
})();
</script>
{% endblock %}
