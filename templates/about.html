{% extends "layout.html" %}
{% block title %}Información Académica{% endblock %}

{% block content %}
<div class="jumbotron">
  <h1 class="display-4">Información Académica</h1>
  <p class="lead">Datos académicos de los empleados</p>
</div>

<div class="mb-3">
  <button id="btnAgregar" type="button" class="btn btn-success btn-sm">Agregar</button>
  <button id="btnEditar" type="button" class="btn btn-primary btn-sm" disabled>Editar</button>
  <button id="btnGuardar" type="button" class="btn btn-success btn-sm">Guardar</button>
  <button id="btnCancelar" type="button" class="btn btn-secondary btn-sm">Cancelar</button>
</div>

<div class="table-responsive">
  <table id="tablaAcademico" class="table table-bordered table-striped table-hover table-sm">
    <thead class="thead-dark">
      <tr>
        <th>DPI</th>
        <th>Nombre</th>
        <th>Apellidos</th>
        <th>Nivel de estudios</th>
        <th>Profesión u Oficio</th>
        <th>Colegio o establecimiento</th>
        <th>Cursos o títulos adicionales</th>
      </tr>
    </thead>
    <tbody>
      {% if empleados %}
        {% for e in empleados %}
        <tr>
          <td>{{ e['Numero de DPI'] }}</td>
          <td>{{ e['Nombre'] }}</td>
          <td>{{ e['Apellidos'] }}</td>
          <td>{{ e.get('Nivel de estudios') }}</td>
          <td>{{ e.get('Profesión u Oficio') }}</td>
          <td>{{ e.get('Colegio o establecimiento') }}</td>
          <td>{{ e.get('Cursos o titulos adicionales') }}</td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted">No hay registros. Usa "Agregar" para crear la primera fila.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
/*
  about.html — integración con main.js (shared)
  Requisitos aplicados:
  - botones siempre habilitados excepto Editar (Edit se habilita tras dblclick en fila)
  - Agregar crea fila nueva con celdas editables (excepto DPI/Nombre/Apellidos)
  - Editar activa edición de fila seleccionada (excepto DPI/Nombre/Apellidos)
  - Guardar usa endpoint /guardar_academico y el main.js realiza POST; si DPI existe backend debe actualizar
  - Campos vacíos se envían como cadenas vacías "" (no "None")
  - No incluye panel de fotos
*/
(function () {
  const TABLE_ID = 'tablaAcademico';
  const ENDPOINT = '/guardar_academico';
  const COLS = 7;
  const BLOQUEADAS = [0,1,2]; // índices no editables: DPI, Nombre, Apellidos

  const btnAgregar = document.getElementById('btnAgregar');
  const btnEditar  = document.getElementById('btnEditar');
  const btnGuardar = document.getElementById('btnGuardar');
  const btnCancelar= document.getElementById('btnCancelar');
  const tabla = document.getElementById(TABLE_ID);

  function flash(msg, type='info') {
    const id = 'aboutFlash';
    const prev = document.getElementById(id);
    if (prev) prev.remove();
    const d = document.createElement('div');
    d.id = id;
    d.className = `alert alert-${type} py-1 px-2 small position-fixed`;
    d.style.top = '16px';
    d.style.right = '16px';
    d.style.zIndex = 3200;
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(()=> d.remove(), 1800);
  }

  // Intenta registrar la tabla cuando window.registrarTabla esté disponible
  function tryRegister(retries = 20) {
    if (window.registrarTabla && typeof window.registrarTabla === 'function') {
      window.registrarTabla(
        TABLE_ID,
        COLS,
        ENDPOINT,
        [
          "Numero de DPI","Nombre","Apellidos",
          "Nivel de estudios","Profesión u Oficio",
          "Colegio o establecimiento","Cursos o titulos adicionales"
        ],
        BLOQUEADAS
      );

      // Forzar estados solicitados
      if (btnAgregar) btnAgregar.disabled = false;
      if (btnEditar)  btnEditar.disabled = true;  // se habilita al dblclick
      if (btnGuardar) btnGuardar.disabled = false; // accesible
      if (btnCancelar) btnCancelar.disabled = false; // accesible

      // Si main.js expone __MAIN_TABLA, usamos esas funciones; si no, la registración de registrarTabla
      // en main.js se encargará de conectar los botones automáticamente. Aquí añadimos handlers de respaldo.
      function safe(fnName) {
        if (window.__MAIN_TABLA && typeof window.__MAIN_TABLA[fnName] === 'function') return window.__MAIN_TABLA[fnName];
        return null;
      }

      const addFn = safe('agregarFila');
      const editFn = safe('editarFila');
      const saveFn = safe('guardarFila');
      const cancelFn = safe('cancelar');

      // attach fallback handlers only if not already attached by main.js
      if (btnAgregar && addFn) {
        if (!btnAgregar.dataset.mainAttached) {
          btnAgregar.addEventListener('click', (e) => { e.stopPropagation(); addFn(); });
          btnAgregar.dataset.mainAttached = '1';
        }
      }
      if (btnEditar && editFn) {
        if (!btnEditar.dataset.mainAttached) {
          btnEditar.addEventListener('click', (e) => { e.stopPropagation(); editFn(); });
          btnEditar.dataset.mainAttached = '1';
        }
      }
      if (btnGuardar && saveFn) {
        if (!btnGuardar.dataset.mainAttached) {
          btnGuardar.addEventListener('click', (e) => { e.stopPropagation(); saveFn(); });
          btnGuardar.dataset.mainAttached = '1';
        }
      }
      if (btnCancelar && cancelFn) {
        if (!btnCancelar.dataset.mainAttached) {
          btnCancelar.addEventListener('click', (e) => { e.stopPropagation(); cancelFn(); });
          btnCancelar.dataset.mainAttached = '1';
        }
      }

      // Ensure double-click enables Edit button if main.js did not
      if (tabla) {
        tabla.addEventListener('dblclick', (ev) => {
          const tr = ev.target.closest('tr');
          if (!tr || tr.parentElement.tagName !== 'TBODY') return;
          if (btnEditar) btnEditar.disabled = false;
        });
      }

      return;
    }

    if (retries <= 0) {
      console.error('registrarTabla no disponible después de esperar main.js');
      flash('Error inicializando tabla (registrarTabla no disponible)', 'danger');
      return;
    }
    setTimeout(() => tryRegister(retries - 1), 100);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => tryRegister(20));
  } else {
    tryRegister(20);
  }
})();
</script>
{% endblock %}
