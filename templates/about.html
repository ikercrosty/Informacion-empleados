{% extends "layout.html" %}
{% block title %}Información Académica{% endblock %}

{% block content %}
<div class="jumbotron">
  <h1 class="display-4">Información Académica</h1>
  <p class="lead">Datos académicos de los empleados</p>
</div>

<div class="mb-3">
  <button id="btnAgregar" type="button" class="btn btn-success btn-sm">Agregar</button>
  <button id="btnEditar" type="button" class="btn btn-primary btn-sm" disabled>Editar</button>
  <button id="btnGuardar" type="button" class="btn btn-success btn-sm" disabled>Guardar</button>
  <button id="btnCancelar" type="button" class="btn btn-secondary btn-sm" disabled>Cancelar</button>
</div>

<div class="table-responsive">
  <table id="tablaAcademico" class="table table-bordered table-striped table-hover table-sm">
    <thead class="thead-dark">
      <tr>
        <th>DPI</th>
        <th>Nombre</th>
        <th>Apellidos</th>
        <th>Nivel de estudios</th>
        <th>Profesión u Oficio</th>
        <th>Colegio o establecimiento</th>
        <th>Cursos o títulos adicionales</th>
      </tr>
    </thead>
    <tbody>
      {% if empleados %}
        {% for e in empleados %}
        <tr>
          <td>{{ e['Numero de DPI'] }}</td>
          <td>{{ e['Nombre'] }}</td>
          <td>{{ e['Apellidos'] }}</td>
          <td>{{ e.get('Nivel de estudios') }}</td>
          <td>{{ e.get('Profesión u Oficio') }}</td>
          <td>{{ e.get('Colegio o establecimiento') }}</td>
          <td>{{ e.get('Cursos o titulos adicionales') }}</td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted">No hay registros. Usa "Agregar" para crear la primera fila.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
/*
 about.html standalone script (complete)
 - Buttons always enabled except Edit (Edit enabled after double-click on a row)
 - Add creates a new row; its cells are editable immediately except protected columns
 - Double-click selects a row and enables Edit button
 - Edit enables editing of non-protected cells for the selected row (no textboxes)
 - Save posts JSON to /guardar_academico (empty cells -> "" ; DPI required)
 - Cancel reverts or removes new row
 - Protected columns: 0 (DPI), 1 (Nombre), 2 (Apellidos)
*/
document.addEventListener('DOMContentLoaded', () => {
  const TABLE_ID = 'tablaAcademico';
  const ENDPOINT = '/guardar_academico';
  const COL_COUNT = 7;
  const PROTECTED = [0,1,2];

  const btnAgregar = document.getElementById('btnAgregar');
  const btnEditar  = document.getElementById('btnEditar');
  const btnGuardar = document.getElementById('btnGuardar');
  const btnCancelar= document.getElementById('btnCancelar');
  const tabla = document.getElementById(TABLE_ID);

  let selectedRow = null;
  let originalCells = null;
  let editing = false;
  let isNewRow = false;

  // initial state: buttons enabled except Edit (user required)
  if (btnAgregar) btnAgregar.disabled = false;
  if (btnEditar)  btnEditar.disabled = true;
  if (btnGuardar) btnGuardar.disabled = true;
  if (btnCancelar) btnCancelar.disabled = true;

  function flash(msg, type='info') {
    const id = 'aboutFlash';
    const prev = document.getElementById(id);
    if (prev) prev.remove();
    const div = document.createElement('div');
    div.id = id;
    div.className = `alert alert-${type} py-1 px-2 small position-fixed`;
    div.style.top = '16px';
    div.style.right = '16px';
    div.style.zIndex = 2200;
    div.innerText = msg;
    document.body.appendChild(div);
    setTimeout(()=> div.remove(), 2000);
  }

  function safeTrim(v){ return v == null ? '' : String(v).trim(); }

  function selectRow(tr) {
    if (!tr) return;
    if (selectedRow && selectedRow !== tr) selectedRow.classList.remove('table-active');
    selectedRow = tr;
    selectedRow.classList.add('table-active');
    // Edit remains disabled until double-click enables it
    if (btnGuardar) btnGuardar.disabled = true;
    if (btnCancelar) btnCancelar.disabled = false;
  }

  function agregarFila() {
    if (!tabla) return;
    const tb = tabla.querySelector('tbody');
    if (!tb) return;

    const placeholder = tb.querySelector('tr td[colspan]');
    if (placeholder) placeholder.parentElement.remove();

    const tr = document.createElement('tr');
    for (let i=0;i<COL_COUNT;i++){
      const td = document.createElement('td');
      td.innerText = '';
      td.tabIndex = 0;
      if (!PROTECTED.includes(i)) {
        td.contentEditable = true;
        td.style.backgroundColor = '#fff3cd';
      } else {
        td.contentEditable = false;
      }
      tr.appendChild(td);
    }
    tb.insertBefore(tr, tb.firstChild);

    if (selectedRow) selectedRow.classList.remove('table-active');
    selectedRow = tr;
    selectedRow.classList.add('table-active');
    editing = true;
    isNewRow = true;
    originalCells = null;

    if (btnEditar) btnEditar.disabled = true;
    if (btnGuardar) btnGuardar.disabled = false;
    if (btnCancelar) btnCancelar.disabled = false;

    // focus first editable cell
    const firstEditable = Array.from(tr.cells).find((c,idx)=> !PROTECTED.includes(idx));
    if (firstEditable) firstEditable.focus();
  }

  function editarFila() {
    if (!selectedRow) { flash('Selecciona una fila primero', 'warning'); return; }
    if (editing) return;
    editing = true;
    originalCells = Array.from(selectedRow.cells).map(td=> td.innerText);
    selectedRow.querySelectorAll('td').forEach((td, idx) => {
      if (!PROTECTED.includes(idx)) {
        td.contentEditable = true;
        td.style.backgroundColor = '#fff3cd';
      } else {
        td.contentEditable = false;
      }
    });
    if (btnEditar) btnEditar.disabled = true;
    if (btnGuardar) btnGuardar.disabled = false;
    if (btnCancelar) btnCancelar.disabled = false;
    const firstEditable = Array.from(selectedRow.cells).find((c,idx)=> !PROTECTED.includes(idx));
    if (firstEditable) firstEditable.focus();
  }

  function cancelarEdicion() {
    if (!selectedRow) return;
    if (isNewRow) {
      const p = selectedRow.parentNode;
      if (p) p.removeChild(selectedRow);
    } else if (editing && originalCells) {
      selectedRow.querySelectorAll('td').forEach((td, i) => {
        td.innerText = originalCells[i] || '';
        td.contentEditable = false;
        td.style.backgroundColor = '';
      });
      selectedRow.classList.remove('table-active');
    } else {
      selectedRow.querySelectorAll('td').forEach(td => { td.contentEditable = false; td.style.backgroundColor = ''; });
      selectedRow.classList.remove('table-active');
    }

    selectedRow = null;
    originalCells = null;
    editing = false;
    isNewRow = false;

    if (btnEditar) btnEditar.disabled = true;
    if (btnGuardar) btnGuardar.disabled = true;
    if (btnCancelar) btnCancelar.disabled = true;
  }

  async function guardarEdicion() {
    if (!selectedRow) return;
    const cells = Array.from(selectedRow.cells);
    const values = cells.map(td => safeTrim(td.innerText));
    const payload = {
      "Numero de DPI": values[0] || "",
      "Nivel de estudios": values[3] || "",
      "Profesión u Oficio": values[4] || "",
      "Colegio o establecimiento": values[5] || "",
      "Cursos o titulos adicionales": values[6] || "",
      "nuevo": isNewRow
    };

    if (!payload["Numero de DPI"] || payload["Numero de DPI"].trim() === "") {
      flash('El campo Numero de DPI es obligatorio', 'danger');
      return;
    }

    try {
      const res = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=>null);
        throw new Error(`${res.status} ${txt || res.statusText}`);
      }
      // lock cells
      cells.forEach((td, idx) => { td.contentEditable = false; td.style.backgroundColor = ''; });
      selectedRow.classList.remove('table-active');
      selectedRow = null;
      originalCells = null;
      editing = false;
      isNewRow = false;
      if (btnEditar) btnEditar.disabled = true;
      if (btnGuardar) btnGuardar.disabled = true;
      if (btnCancelar) btnCancelar.disabled = true;
      flash('Guardado correctamente', 'success');
    } catch (err) {
      console.error('guardar error', err);
      flash('Error al guardar: ' + (err.message || err), 'danger');
    }
  }

  // table click: select row (single click); double-click enables Edit button
  if (tabla) {
    tabla.addEventListener('click', (ev) => {
      const tr = ev.target.closest('tr');
      if (!tr || tr.parentElement.tagName !== 'TBODY') return;
      if (editing && selectedRow && tr !== selectedRow) return;
      selectRow(tr);
    });

    tabla.addEventListener('dblclick', (ev) => {
      const tr = ev.target.closest('tr');
      if (!tr || tr.parentElement.tagName !== 'TBODY') return;
      selectRow(tr);
      if (btnEditar) btnEditar.disabled = false;
    });
  }

  // attach unique handlers (replace node to avoid duplicates)
  function attachUnique(btn, handler) {
    if (!btn) return;
    const p = btn.parentNode;
    if (!p) { btn.addEventListener('click', handler); return; }
    const clean = btn.cloneNode(true);
    p.replaceChild(clean, btn);
    clean.addEventListener('click', (e)=>{ e.stopPropagation(); handler(e); });
    return clean;
  }

  attachUnique(btnAgregar, () => agregarFila());
  attachUnique(btnEditar,  () => editarFila());
  attachUnique(btnGuardar, () => guardarEdicion());
  attachUnique(btnCancelar,() => cancelarEdicion());

  // ensure PROTECTED columns are not editable on initial render
  Array.from(document.querySelectorAll(`#${TABLE_ID} tbody tr`)).forEach(tr => {
    tr.querySelectorAll('td').forEach((td, idx) => {
      if (PROTECTED.includes(idx)) td.contentEditable = false;
    });
  });

});
</script>
{% endblock %}
