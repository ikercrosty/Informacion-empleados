{% extends "layout.html" %}
{% block title %}Recibo de Pago{% endblock %}

{% block content %}
<div class="container py-2 receipt-root" id="receipt_main">
  <!-- Header card -->
  <div class="card header-card">
    <div class="card-body header-body d-flex justify-content-between align-items-center">
      <div>
        <h3 class="mb-0 title-large">Recibo de pago de sueldos</h3>
        <div class="small text-muted">Empresa: {{ empresa_nombre|default('Empaques y texturas de Guatemala S.A') }}</div>
      </div>

      <div class="d-flex gap-2 align-items-end justify-content-end header-controls">
        <div style="flex:1; min-width:120px;">
          <label class="form-label small text-muted">Fecha</label>
          <input id="comprobanteFecha" class="form-control form-control-sm" type="date" value="{{ recibo.fecha if recibo is defined else fecha_emision if fecha_emision is defined else '' }}">
        </div>

        <div style="align-self:flex-end;">
          <button id="imprimirBtn" class="btn-imprimir" title="Imprimir recibo">Imprimir</button>
        </div>
      </div>
    </div>

    <!-- Mirrored printable fecha -->
    <div class="header-print-row">
      <div id="print_comprobanteFecha" class="print-only small-print" aria-hidden="true"></div>
    </div>
  </div>

  <!-- SECCIÓN: Selección de empleado (oculta en impresión) -->
  <div class="card empleado-selection">
    <div class="card-body small-pad">
      <div class="row g-2">
        <div class="col-12 col-md-8">
          <label class="form-label">Empleado</label>
          <select id="empleadoSelect" class="form-select">
            <option value="">-- Seleccione empleado --</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Datos del Trabajador -->
  <div class="card datos-trabajador-print">
    <div class="card-body small-pad">
      <div class="row g-1">
        <div class="col-8">
          <label class="form-label small">Nombre completo</label>
          <input id="print_nombre" class="form-control" readonly value="{{ recibo.nombre if recibo is defined else '' }}" data-preserve="true">
        </div>
        <div class="col-4">
          <label class="form-label small">DPI / Identificación</label>
          <input id="print_dpi" class="form-control" readonly value="{{ recibo.dpi if recibo is defined else '' }}" data-preserve="true">
        </div>
      </div>
    </div>
  </div>

  <!-- Detalle de pago -->
  <div class="card section-card payment-section">
    <div class="card-body section-grid small-pad">
      <div class="section-left box-left">
        <h5 class="mb-1 small">Ganancias</h5>

        <div class="row g-1 compact-row">
          <div class="col-6">
            <label class="form-label xsmall">Sueldo Base</label>
            <input id="sueldoBase" class="form-control compact-input" type="text" readonly value="{{ recibo.sueldo if recibo is defined else (recibo.Sueldo if recibo is defined else 'Q 0.00') }}" data-preserve="true">
          </div>

          <div class="col-6">
            <label class="form-label xsmall">Horas extras (monto)</label>
            <input id="hextrasMonto" class="form-control compact-input" type="text" readonly value="{{ recibo.hextras_monto if recibo is defined else (recibo.hextras if recibo is defined else 'Q 0.00') }}" data-preserve="true">
          </div>

          <div class="col-6 mt-1">
            <label class="form-label xsmall">Bonificación</label>
            <input id="bonificacion" class="form-control compact-input" type="text" readonly value="{{ recibo.bono if recibo is defined else 'Q 0.00' }}" data-preserve="true">
          </div>

          <div class="col-6 mt-1">
            <label class="form-label xsmall">Comisiones</label>
            <input id="comisiones" class="form-control compact-input" type="text" readonly value="{{ recibo.comisiones if recibo is defined else 'Q 0.00' }}" data-preserve="true">
          </div>
        </div>
      </div>

      <div class="section-right box-right">
        <h5 class="mb-1 small">Deducciones</h5>

        <div class="row g-1 compact-row">
          <div class="col-6">
            <label class="form-label xsmall">IGSS</label>
            <input id="igss" class="form-control compact-input" type="text" readonly value="{{ 'Q ' ~ ('%.2f'|format(recibo.igss)) if recibo is defined and recibo.igss is defined else 'Q 0.00' }}" data-preserve="true">
          </div>

          <div class="col-6">
            <label class="form-label xsmall">ISR</label>
            <input id="isr" class="form-control compact-input" type="text" readonly value="{{ recibo.isr if recibo is defined else 'Q 0.00' }}" data-preserve="true">
          </div>

          <div class="col-12 mt-1">
            <label class="form-label xsmall">Otras deducciones</label>
            <input id="otrasDeducciones" class="form-control compact-input" type="text" readonly value="{{ recibo.otras_deducciones if recibo is defined else 'Q 0.00' }}" data-preserve="true">
          </div>
        </div>
      </div>
    </div>

    <!-- Líquido -->
    <div class="card-body px-2 py-2 liquido-total-row small-pad">
      <div class="liquido-total-inner">
        <div class="liquido-block">
          <label class="form-label xsmall">Líquido a recibir</label>
          <input id="liquidoTotal" class="form-control fw-bold text-end compact-amount" readonly value="Q 0.00" data-preserve="true">
        </div>
        <div class="letras-block">
          <label class="form-label xsmall">TOTAL EN LETRAS</label>
          <input id="totalEnLetras" class="form-control compact-input" type="text" readonly value="{{ recibo.total_letras if recibo is defined else '' }}" data-preserve="true">
        </div>
      </div>
    </div>
  </div>

  <!-- Medios de pago -->
  <div class="card totals-card">
    <div class="card-body small-pad">
      <div class="payment-methods compact-row">
        <h6 class="mb-1 small">MEDIOS DE PAGO</h6>

        <div class="payment-row">
          <div class="form-check printable-option" data-option="EFECTIVO">
            <input class="form-check-input medio-radio" type="radio" name="medioPago" id="pagoEfectivo" value="EFECTIVO" checked>
            <label class="form-check-label xsmall" for="pagoEfectivo">EFECTIVO</label>
          </div>

          <div class="form-check printable-option" data-option="TRANSFERENCIA">
            <input class="form-check-input medio-radio" type="radio" name="medioPago" id="pagoTransferencia" value="TRANSFERENCIA">
            <label class="form-check-label xsmall" for="pagoTransferencia">TRANSFERENCIA</label>

            <div class="transferencia-fields compact-transfer">
              <input id="transCuenta" class="form-control trans-input compact-input" type="text" aria-label="Número de cuenta (transferencia)" placeholder="No. cuenta" data-preserve="true">
              <input id="transBanco" class="form-control trans-input compact-input" type="text" aria-label="Banco (transferencia)" placeholder="Banco" data-preserve="true">
            </div>
          </div>

          <div class="form-check printable-option" data-option="CHEQUE">
            <input class="form-check-input medio-radio" type="radio" name="medioPago" id="pagoCheque" value="CHEQUE">
            <label class="form-check-label xsmall" for="pagoCheque">CHEQUE</label>

            <div class="cheque-fields compact-transfer">
              <input id="chequeNumero" class="form-control trans-input compact-input" type="text" aria-label="Número de cheque" placeholder="No. cheque" data-preserve="true">
              <input id="chequeBanco" class="form-control trans-input compact-input" type="text" aria-label="Banco (cheque)" placeholder="Banco" data-preserve="true">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firmas -->
  <div class="card signatures-card">
    <div class="card-body signatures-row print-signatures small-pad">
      <div class="sig-col">
        <div class="sig-line"></div>
        <div class="small text-muted xsmall">Firma del trabajador</div>
      </div>
      <div class="sig-col">
        <div class="sig-line"></div>
        <div class="small text-muted xsmall">Firma de la empresa</div>
      </div>
    </div>
  </div>
</div>

<!-- placeholder where print duplicate will be inserted (managed by JS) -->
<div id="print_clone_placeholder" aria-hidden="true" style="display:none;"></div>

<script>
(function(){
  // --- helpers y formato ---
  function fmtQ(n){ return 'Q ' + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function toNumberSafe(v){
    if(v === null || v === undefined) return 0;
    if(typeof v === 'number') return v;
    const s = String(v).replace(/\s+/g,'').replace(/^Q/i,'').replace(/,/g,'').trim();
    const n = Number(s);
    if(isFinite(n)) return n;
    const f = parseFloat(s);
    return isFinite(f) ? f : 0;
  }
  function textOf(el){
    if(!el) return '';
    if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') return String(el.value || '');
    if(el.tagName === 'SELECT') return (el.options[el.selectedIndex] ? el.options[el.selectedIndex].text : '');
    return el.textContent || '';
  }

  // --- sincronización simple de pantalla (mantener) ---
  function syncPrintableComprobante(){
    const fecha = document.getElementById('comprobanteFecha')?.value || '';
    const printFecha = document.getElementById('print_comprobanteFecha');
    if(printFecha){
      if(fecha){
        try{
          const d = new Date(fecha);
          if(!isNaN(d.getTime())){
            const dd = String(d.getDate()).padStart(2,'0');
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const yyyy = d.getFullYear();
            printFecha.textContent = 'Fecha: ' + dd + '/' + mm + '/' + yyyy;
          } else printFecha.textContent = 'Fecha: ' + fecha;
        }catch(e){ printFecha.textContent = 'Fecha: ' + fecha; }
      } else printFecha.textContent = '';
    }
  }

  // --- crear clon de impresión garantizando identicidad ---
  let currentPrintClone = null;
  function createExactPrintClone(){
    // si ya existe, sincroniza y sale
    if(currentPrintClone){
      syncValuesToClone();
      return;
    }
    const original = document.getElementById('receipt_main');
    if(!original) return;

    // clon profundo del nodo visible (incluye header, cards, etc.)
    const clone = original.cloneNode(true);

    // eliminamos ids en el clone para evitar duplicados, pero guardaremos data-clone donde haga falta
    (function removeIds(node){
      if(node && node.removeAttribute) node.removeAttribute('id');
      for(const c of node.children ? Array.from(node.children) : []) removeIds(c);
    })(clone);

    // Reemplazar controles interactivos por spans con EXACTO texto que se ve en pantalla
    // Recorremos el original y por cada control buscamos su equivalente por posición en el clone
    const origControls = original.querySelectorAll('input, textarea, select, button');
    const cloneControls = clone.querySelectorAll('input, textarea, select, button');

    // Mapeo por índice: en practicas reales aquí es robusto porque clone proviene de original
    for(let i = 0; i < Math.max(origControls.length, cloneControls.length); i++){
      const o = origControls[i];
      const c = cloneControls[i];
      if(!c) continue;
      // obtiene el texto visible del original
      const valueText = textOf(o);
      // crear nodo estático que preserva el estilo visual (span)
      const span = document.createElement('span');
      span.className = 'print-static';
      span.textContent = valueText;
      // Si el control original mostraba Q formatted numbers, garantizamos formato
      if((o.tagName === 'INPUT' || o.tagName === 'TEXTAREA') && /^-?\d+(\.\d+)?$/.test(String(valueText).replace(/,/g,'')) ){
        // si el value es numérico en el source, formateamos con Q
        span.textContent = fmtQ(Number(valueText));
      }
      // reemplazamos el control del clone por el span
      c.replaceWith(span);
    }

    // Además sincronizamos elementos no interactivos (p. ej. inputs readonly que no estaban en lista por alguna razón)
    const keysToCopy = ['print_nombre','print_dpi','sueldoBase','hextrasMonto','bonificacion','comisiones','igss','isr','otrasDeducciones','liquidoTotal','totalEnLetras','transCuenta','transBanco','chequeNumero','chequeBanco'];
    keysToCopy.forEach(id=>{
      const orig = document.getElementById(id);
      if(!orig) return;
      const value = textOf(orig);
      // buscamos en clone un span que tenga el mismo label cercano o fallback por posición
      // mejor estrategia: insertar un marker data-printkey en el original si es crítico; aquí hacemos best-effort por texto
      const foundInputs = clone.querySelectorAll('[data-clone="'+CSS.escape(id)+'"]');
      if(foundInputs && foundInputs.length){
        Array.from(foundInputs).forEach(fi => fi.textContent = value);
      } else {
        // si no existe data-clone, buscamos el primer input/elemento con mismo name/placeholder/label en clone
        const byId = clone.querySelector('#' + CSS.escape(id));
        if(byId) byId.textContent = value;
        else {
          // fallback: buscar cualquier .print-static con texto similar a placeholder y reemplazar (no destructivo)
          const approx = clone.querySelectorAll('.print-static');
          if(approx && approx.length){
            // reemplazar el primer que esté vacío o tenga similar longitud
            for(const p of approx){
              if(!p.textContent || p.textContent.length < 2){
                p.textContent = value;
                break;
              }
            }
          }
        }
      }
    });

    // Finalmente, aseguramos que la fecha impresa se sincronice (mirrored date ya existe en header-print-row)
    const origDate = document.getElementById('print_comprobanteFecha');
    if(origDate){
      // si en el clone existe un lugar equivalente, lo actualizamos
      const cloneDate = clone.querySelector('.header-print-row') || clone.querySelector('.print-only');
      if(cloneDate) cloneDate.textContent = origDate.textContent || '';
    }

    // Marcamos y anexamos clone al placeholder (el CSS @media print mostrará .print-duplicate)
    clone.classList.add('print-duplicate','print-clone-exact');
    clone.setAttribute('aria-hidden','true');
    const placeholder = document.getElementById('print_clone_placeholder');
    placeholder.style.display = 'block';
    placeholder.appendChild(clone);
    currentPrintClone = clone;
    // una pasada final para forzar estilos y espacios idénticos
    syncValuesToClone();
  }

  function syncValuesToClone(){
    if(!currentPrintClone) return;
    const original = document.getElementById('receipt_main');
    if(!original) return;

    // para cada span.print-static en el clone, intentar encontrar el control correspondiente en el original
    const cloneSpans = currentPrintClone.querySelectorAll('.print-static');
    const origControls = original.querySelectorAll('input, textarea, select, .form-check-label, .form-control');

    // copia por índice (método robusto porque clone fue creado a partir del original)
    for(let i = 0; i < cloneSpans.length && i < origControls.length; i++){
      const cSpan = cloneSpans[i];
      const oCtrl = origControls[i];
      if(!oCtrl) continue;
      cSpan.textContent = textOf(oCtrl);
    }

    // copia explícita de campos clave por id
    const explicit = ['print_nombre','print_dpi','sueldoBase','hextrasMonto','bonificacion','comisiones','igss','isr','otrasDeducciones','liquidoTotal','totalEnLetras','print_comprobanteFecha'];
    explicit.forEach(id=>{
      const o = document.getElementById(id);
      if(!o) return;
      const v = textOf(o);
      // buscar en clone: por data-clone o por texto exacto
      let target = currentPrintClone.querySelector('[data-clone="'+CSS.escape(id)+'"]') || currentPrintClone.querySelector('.print-static');
      if(target) target.textContent = v;
    });
  }

  function removePrintClone(){
    if(!currentPrintClone) return;
    try{ currentPrintClone.remove(); }catch(e){}
    currentPrintClone = null;
    const placeholder = document.getElementById('print_clone_placeholder');
    if(placeholder) placeholder.style.display = 'none';
  }

  // --- hooks de impresión ---
  function beforePrintHandler(){
    syncPrintableComprobante();
    // crear clon exacto
    createExactPrintClone();
    // forzar clase de medio de pago para mostrar su texto en la impresión
    const val = document.querySelector('input[name="medioPago"]:checked')?.value;
    document.body.classList.remove('print-medio-EFECTIVO','print-medio-TRANSFERENCIA','print-medio-CHEQUE');
    if(val) document.body.classList.add('print-medio-' + val);
    document.body.classList.add('printing-multiple');
  }
  function afterPrintHandler(){
    document.body.classList.remove('printing-multiple','print-medio-EFECTIVO','print-medio-TRANSFERENCIA','print-medio-CHEQUE');
    removePrintClone();
  }

  if(window.matchMedia){
    const m = window.matchMedia('print');
    if(m.addEventListener) m.addEventListener('change', (ev)=> { if(ev.matches) beforePrintHandler(); else afterPrintHandler(); });
    else m.addListener((ev)=> { if(ev.matches) beforePrintHandler(); else afterPrintHandler(); });
  }
  window.addEventListener('beforeprint', beforePrintHandler);
  window.addEventListener('afterprint', afterPrintHandler);

  // Botón imprimir: abre el flujo y lanza print
  document.getElementById('imprimirBtn')?.addEventListener('click', function(){
    beforePrintHandler();
    setTimeout(()=> window.print(), 120);
  });

  // Mantener fecha sincronizada en tiempo real
  document.getElementById('comprobanteFecha')?.addEventListener('input', syncPrintableComprobante);

  // En carga inicial sincronizamos formato de montos y liquido
  document.addEventListener('DOMContentLoaded', function(){
    // formatear campos numéricos si vienen sin Q
    ['sueldoBase','hextrasMonto','bonificacion','comisiones','igss','isr','otrasDeducciones'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const v = String(el.value || '').trim();
      if(v === '') el.value = fmtQ(0);
      else if(!/^Q\s*/i.test(v)) el.value = fmtQ(toNumberSafe(v));
    });
    // calcular liquido si existe función recalcLiquido en tu template (la mayoría la tiene)
    try{ if(typeof recalcLiquido === 'function') recalcLiquido(); }catch(e){}
    syncPrintableComprobante();
  });
})();
</script>


<style>
:root{
  --bg-1: #f7f6f3;
  --muted: #6b7280;
  --accent-naranja: #ff7a18;
  --accent-azul: #0b7285;
  font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* Page */
body { background: var(--bg-1); color:#0f1724; margin:0; padding:0; }
.container { max-width:1100px; margin:8px auto; padding:6px; box-sizing:border-box; }

/* Header */
.title-large { font-size: 1.2rem; font-weight: 800; color: var(--accent-azul); letter-spacing: -0.2px; margin-bottom:2px; }
.header-card { border-radius:8px; margin-bottom:6px; }
.header-body { padding:8px; }

/* Small padding utility for compact look */
.small-pad { padding:6px; }
.compact-row .col-6 { padding-bottom:4px; }
.xsmall { font-size:0.78rem; font-weight:700; color:var(--muted); }
.small { font-size:0.86rem; }

/* Inputs */
.form-control { border-radius:6px; border:1px solid rgba(11,19,30,0.06); background:#fff; padding:6px 8px; font-size:0.92rem; }
.form-control[readonly] { background:#fbfdff; color:#0b2a36; }
.compact-input { padding:5px 6px; font-size:0.88rem; }

/* Transfer inputs default wider on screen */
.trans-input { min-width:220px; max-width:520px; padding:8px 10px; }

/* Compact amount */
.compact-amount { width:150px; padding:6px; font-size:0.95rem; }

/* Small visual card */
.card { border-radius:8px; background:linear-gradient(180deg,#fff,#fbfcff); border:1px solid rgba(11,19,30,0.04); margin-bottom:6px; box-shadow:0 6px 18px rgba(11,50,80,0.03); }

/* Boxes for gains/deductions */
.section-grid { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
.section-left, .section-right { flex:1 1 320px; min-width:220px; }
.box-left, .box-right { padding:6px; border-radius:6px; background:#fff; border:1px solid rgba(11,19,30,0.04); }

/* Payment method extras */
.transferencia-fields, .cheque-fields { display:none; gap:6px; align-items:center; }

/* Liquido + letras: force single horizontal row */
.liquido-total-inner {
  display:flex;
  gap:12px;
  align-items:center;
  width:100%;
  box-sizing:border-box;
}
.liquido-block {
  min-width:150px;
  max-width:220px;
  display:flex;
  flex-direction:column;
  align-items:flex-end;
}
.letras-block {
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
}
.letras-block .form-control { width:100%; }

/* Signatures */
.sig-line { border-bottom:1px dashed #bfc7cb; height:1px; margin-bottom:6px; }
.signatures-row { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:6px; }

/* Print button */
.btn-imprimir {
  background: linear-gradient(90deg, #ff9042, #ff7a18);
  color: #fff;
  border: none;
  padding: .4rem .7rem;
  border-radius: 8px;
  font-weight: 800;
  cursor: pointer;
}

/* Reduce vertical spacing */
.mb-1 { margin-bottom:6px !important; }
.mt-1 { margin-top:6px !important; }

/* Header-print-row hidden on screen */
.header-print-row { display:none; }

/* Print styles */
@media print {
  @page { size: A4; margin: 6mm; }

  body { background:#fff; color:#000; margin:0; padding:0; }

  /* Stack receipts vertically: each receipt occupies full printable width */
  .receipt-root, .print-duplicate {
    width:100% !important;
    max-width:100% !important;
    float:none !important;
    margin: 0 0 6mm 0 !important;
    box-sizing:border-box;
    page-break-inside: avoid;
  }

  /* Add extra vertical space only before the cloned second receipt */
  #print_clone_placeholder .print-duplicate {
    margin-top: 12mm !important;
    display:block;
  }

  .card { box-shadow:none !important; border:1px solid #ffffff !important; background:#fff !important; margin:0 0 4px 0; border-radius:4px !important; }
  .card .card-body { padding:4px !important; }

  /* Hide interactive controls on print */
  .empleado-selection, select, .btn-imprimir, .header-controls { display:none !important; }
  input[type="date"] { display:none !important; }

  /* Show mirrored printable date */
  .header-print-row { display:block !important; }
  .print-only { display:block !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; color:#111; font-size:11px; margin-bottom:6px; text-align:right; }

  input.form-control, input.form-control[readonly] {
    background: #fff !important;
    border: 1px solid #111 !important;
    color: #000 !important;
    padding: 4px 6px !important;
    font-size: 11px !important;
    box-shadow:none;
  }

  /* Make transferencia / cheque textboxes wider in print so long values fit */
  body.print-medio-TRANSFERENCIA .transferencia-fields .trans-input,
  body.print-medio-CHEQUE .cheque-fields .trans-input {
    min-width:260px !important;
    max-width:380px !important;
    padding:5px 8px !important;
    font-size:11px !important;
  }

  /* Payment methods presentation in print */
  .printable-option { display:none; font-size:10px; }
  body.print-medio-EFECTIVO .printable-option[data-option="EFECTIVO"] { display:inline-flex; }
  body.print-medio-TRANSFERENCIA .printable-option[data-option="TRANSFERENCIA"] { display:inline-flex; }
  body.print-medio-CHEQUE .printable-option[data-option="CHEQUE"] { display:inline-flex; }

  /* Show transfer/cheque fields inline in print when selected */
  body.print-medio-TRANSFERENCIA .transferencia-fields,
  body.print-medio-CHEQUE .cheque-fields {
    display:inline-flex !important;
    gap:8px;
    align-items:center;
    margin-left:6px;
  }

  /* Compact signatures */
  .print-signatures .sig-col { flex:1 1 48%; text-align:center; padding:0 4px; }
  .sig-line { margin-bottom:6px; border-bottom:1px dashed #111; }

  .receipt-root, .card, .section-card, .totals-card, .signatures-row { page-break-inside: avoid; break-inside: avoid; }

  .receipt-root:last-of-type { margin-bottom:6mm; }
}

/* ensure cloned print-only container is invisible on screen */
.print-duplicate { display:none; }

/* micro polish */
.small.text-muted { color:var(--muted); font-size:0.86rem; }
.form-check-label { font-weight:700; color:#233642; font-size:0.88rem; }
.compact-transfer .form-control { padding:6px 8px; font-size:0.9rem; }

/* print static span that replaced inputs */
.print-static { display:inline-block; color: inherit; font-size: inherit; padding:2px 4px; }
</style>
{% endblock %}
