{% extends "layout.html" %}
{% block title %}Recibo de Pago{% endblock %}

{% block content %}
<div class="container py-2 receipt-root" id="receipt_main">
  <!-- Header card -->
  <div class="card header-card">
    <div class="card-body header-body d-flex justify-content-between align-items-center">
      <div>
        <h3 class="mb-0 title-large">Recibo de pago de sueldos</h3>
        <div class="small text-muted">Empresa: Empaques y Texturas de Guatemala S.A</div>
      </div>

      <div class="d-flex gap-2 align-items-end justify-content-end header-controls">
        <div style="flex:1; min-width:120px;">
          <label class="form-label small text-muted">Fecha</label>
          <input id="comprobanteFecha" class="form-control form-control-sm" type="date" value="{{ recibo.fecha if recibo is defined else fecha_emision if fecha_emision is defined else '' }}">
        </div>

        <div style="align-self:flex-end;">
          <button id="imprimirBtn" class="btn-imprimir" title="Imprimir recibo">Imprimir</button>
        </div>
      </div>
    </div>

    <!-- Mirrored printable fecha -->
    <div class="header-print-row">
      <div id="print_comprobanteFecha" class="print-only small-print" aria-hidden="true"></div>
    </div>
  </div>

  <!-- SECCIÓN: Selección de empleado (oculta en impresión) -->
  <div class="card empleado-selection">
    <div class="card-body small-pad">
      <div class="row g-2">
        <div class="col-12 col-md-8">
          <label class="form-label">Empleado</label>
          <select id="empleadoSelect" class="form-select">
            <option value="">-- Seleccione empleado --</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Datos del Trabajador -->
  <div class="card datos-trabajador-print">
    <div class="card-body small-pad">
      <div class="row g-1">
        <div class="col-8">
          <label class="form-label small">Nombre completo</label>
          <input id="print_nombre" class="form-control" readonly value="{{ recibo.nombre if recibo is defined else '' }}">
        </div>
        <div class="col-4">
          <label class="form-label small">DPI / Identificación</label>
          <input id="print_dpi" class="form-control" readonly value="{{ recibo.dpi if recibo is defined else '' }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Detalle de pago -->
  <div class="card section-card payment-section">
    <div class="card-body section-grid small-pad">
      <div class="section-left box-left">
        <h5 class="mb-1 small">Ganancias</h5>

        <div class="row g-1 compact-row">
          <div class="col-6">
            <label class="form-label xsmall">Sueldo Base</label>
            <input id="sueldoBase" class="form-control compact-input" type="text" readonly value="{{ recibo.sueldo if recibo is defined else (recibo.Sueldo if recibo is defined else 'Q 0.00') }}">
          </div>

          <div class="col-6">
            <label class="form-label xsmall">Horas extras (monto)</label>
            <input id="hextrasMonto" class="form-control compact-input" type="text" readonly value="{{ recibo.hextras_monto if recibo is defined else (recibo.hextras if recibo is defined else 'Q 0.00') }}">
          </div>

          <div class="col-6 mt-1">
            <label class="form-label xsmall">Bonificación</label>
            <input id="bonificacion" class="form-control compact-input" type="text" readonly value="{{ recibo.bono if recibo is defined else 'Q 0.00' }}">
          </div>

          <div class="col-6 mt-1">
            <label class="form-label xsmall">Comisiones</label>
            <input id="comisiones" class="form-control compact-input" type="text" readonly value="{{ recibo.comisiones if recibo is defined else 'Q 0.00' }}">
          </div>
        </div>
      </div>

      <div class="section-right box-right">
        <h5 class="mb-1 small">Deducciones</h5>

        <div class="row g-1 compact-row">
          <div class="col-6">
            <label class="form-label xsmall">IGSS</label>
            <input id="igss" class="form-control compact-input" type="text" readonly value="{{ 'Q ' ~ ('%.2f'|format(recibo.igss)) if recibo is defined and recibo.igss is defined else 'Q 0.00' }}">
          </div>

          <div class="col-6">
            <label class="form-label xsmall">ISR</label>
            <input id="isr" class="form-control compact-input" type="text" readonly value="{{ recibo.isr if recibo is defined else 'Q 0.00' }}">
          </div>

          <div class="col-12 mt-1">
            <label class="form-label xsmall">Otras deducciones</label>
            <input id="otrasDeducciones" class="form-control compact-input" type="text" readonly value="{{ recibo.otras_deducciones if recibo is defined else 'Q 0.00' }}">
          </div>
        </div>
      </div>
    </div>

    <!-- Líquido -->
    <div class="card-body px-2 py-2 liquido-total-row small-pad">
      <div class="liquido-total-inner">
        <div class="liquido-block">
          <label class="form-label xsmall">Líquido a recibir</label>
          <input id="liquidoTotal" class="form-control fw-bold text-end compact-amount" readonly value="Q 0.00">
        </div>
        <div class="letras-block">
          <label class="form-label xsmall">TOTAL EN LETRAS</label>
          <input id="totalEnLetras" class="form-control compact-input" type="text" readonly value="{{ recibo.total_letras if recibo is defined else '' }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Medios de pago -->
  <div class="card totals-card">
    <div class="card-body small-pad">
      <div class="payment-methods compact-row">
        <h6 class="mb-1 small">MEDIOS DE PAGO</h6>

        <div class="payment-row">
          <div class="form-check printable-option" data-option="EFECTIVO">
            <input class="form-check-input medio-radio" type="radio" name="medioPago" id="pagoEfectivo" value="EFECTIVO" checked>
            <label class="form-check-label xsmall" for="pagoEfectivo">EFECTIVO</label>
          </div>

          <div class="form-check printable-option" data-option="TRANSFERENCIA">
            <input class="form-check-input medio-radio" type="radio" name="medioPago" id="pagoTransferencia" value="TRANSFERENCIA">
            <label class="form-check-label xsmall" for="pagoTransferencia">TRANSFERENCIA</label>

            <div class="transferencia-fields compact-transfer" aria-hidden="true">
              <input id="transCuenta" class="form-control trans-input compact-input" type="text" aria-label="Número de cuenta (transferencia)" placeholder="No. cuenta">
              <input id="transBanco" class="form-control trans-input compact-input" type="text" aria-label="Banco (transferencia)" placeholder="Banco">
              <!-- Nuevo campo: Número de Autorización -->
              <input id="transAutorizacion" class="form-control trans-input compact-input" type="text" aria-label="Número de Autorización" placeholder="No. de Autorización">
            </div>
          </div>

          <div class="form-check printable-option" data-option="CHEQUE">
            <input class="form-check-input medio-radio" type="radio" name="medioPago" id="pagoCheque" value="CHEQUE">
            <label class="form-check-label xsmall" for="pagoCheque">CHEQUE</label>

            <div class="cheque-fields compact-transfer" aria-hidden="true">
              <input id="chequeNumero" class="form-control trans-input compact-input" type="text" aria-label="Número de cheque" placeholder="No. cheque">
              <input id="chequeBanco" class="form-control trans-input compact-input" type="text" aria-label="Banco (cheque)" placeholder="Banco">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firmas -->
  <div class="card signatures-card">
    <div class="card-body signatures-row print-signatures small-pad">
      <div class="sig-col">
        <div class="sig-line"></div>
        <div class="small text-muted xsmall">Firma del trabajador</div>
      </div>
      <div class="sig-col">
        <div class="sig-line"></div>
        <div class="small text-muted xsmall">Firma de la empresa</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const PLANILLA_STORAGE_KEY = 'empaquetex_planilla_noviembre_v1';

  function fmt(n){ return 'Q ' + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

  function pickEmployeeKey(e){
    return String(e && (e.dpi || e.DPI || e.numero || e.numero_identificacion || e.id || e.full_name) || '').trim();
  }

  function loadEmpleados(){
    fetch('/api/empleados').then(r => r.json()).then(list => {
      const sel = document.getElementById('empleadoSelect');
      if(!Array.isArray(list) || !sel) return;
      sel.querySelectorAll('option:not([value=""])').forEach(o => o.remove());
      list.forEach(e => {
        const opt = document.createElement('option');
        opt.value = pickEmployeeKey(e);
        opt.textContent = e.full_name || ((e.Nombre || '') + (e.Apellidos ? (' ' + e.Apellidos) : '')) || pickEmployeeKey(e) || 'Empleado';
        sel.appendChild(opt);
      });
    }).catch(()=>{});
  }

  function loadPlanillaFromLocal(){
    try {
      const raw = localStorage.getItem(PLANILLA_STORAGE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      return obj && Array.isArray(obj.rows) ? obj : null;
    } catch(e){
      return null;
    }
  }

  function findPlanillaRowByDpi(dpi){
    if(dpi === undefined || dpi === null) return null;
    const plan = loadPlanillaFromLocal();
    if(!plan) return null;
    const rows = plan.rows || [];
    const needle = String(dpi).trim();
    for(const r of rows){
      const candidates = [
        r && r.dpi, r && r.DPI, r && r.Dpi,
        r && r.numero, r && r.numero_identificacion, r && r.numeroDPI, r && r.numero_dpi,
        r && r.id, r && r.ID, r && r.identificacion,
        r && r.Nombre, r && r.nombre,
        r && r.full_name, r && r.fullName
      ];
      for(const c of candidates){
        if(c === undefined || c === null) continue;
        if(String(c).trim() === needle) return r;
      }
    }
    return null;
  }

  function toNumberSafe(v){
    if(v === null || v === undefined) return 0;
    if(typeof v === 'number') return v;
    const s = String(v).replace(/\s+/g,'').replace(/^Q/i,'').replace(/,/g,'').trim();
    const n = Number(s);
    if(isFinite(n)) return n;
    const f = parseFloat(s);
    return isFinite(f) ? f : 0;
  }

  function parseDateInputAsLocal(dateStr){
    if(!dateStr || typeof dateStr !== 'string') return null;
    const parts = dateStr.split('-');
    if(parts.length !== 3) return null;
    const y = parseInt(parts[0],10);
    const m = parseInt(parts[1],10);
    const d = parseInt(parts[2],10);
    if(!isFinite(y) || !isFinite(m) || !isFinite(d)) return null;
    return new Date(y, m - 1, d);
  }

  function syncPrintableComprobante(){
    const fecha = document.getElementById('comprobanteFecha')?.value || '';
    const printFecha = document.getElementById('print_comprobanteFecha');
    if(printFecha) {
      let text = fecha;
      if(fecha){
        try{
          const d = parseDateInputAsLocal(fecha);
          if(d && !isNaN(d.getTime())) {
            const dd = String(d.getDate()).padStart(2,'0');
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const yyyy = d.getFullYear();
            text = 'Fecha: ' + dd + '/' + mm + '/' + yyyy;
          } else {
            text = 'Fecha: ' + fecha;
          }
        }catch(e){
          text = 'Fecha: ' + fecha;
        }
      }
      printFecha.textContent = fecha ? text : '';
    }
  }

  // Previously removed Q for print. To preserve Q in printed output, these functions are no-op.
  function stripQForPrint(){
    // intentionally left blank to keep "Q " prefix visible in print
  }

  function restoreAmountsAfterPrint(){
    // intentionally left blank (no changes were made in stripQForPrint)
  }

  // Helper that writes a formatted Q value into an input
  function writeMoneyInput(id, value){
    const el = document.getElementById(id);
    if(!el) return;
    el.value = fmt(toNumberSafe(value));
  }

  document.getElementById('empleadoSelect')?.addEventListener('change', function(){
    const rawVal = this.value || '';
    if(!rawVal){
      ['nombre','dpi'].forEach(id=>{ const el = document.getElementById(id); if(el) el.value = ''; });
      ['sueldoBase','comisiones','bonificacion','hextrasMonto','igss','isr','otrasDeducciones'].forEach(id=> writeMoneyInput(id, 0));
      recalcLiquido();
      return;
    }

    const planRow = findPlanillaRowByDpi(rawVal);

    if(planRow){
      const nombre = planRow.nombre || planRow.Nombre || planRow.full_name || '';
      const dpiVal = planRow.dpi || planRow.DPI || planRow.numero || planRow.id || rawVal;

      const pn = document.getElementById('print_nombre'); if(pn) pn.value = nombre;
      const pd = document.getElementById('print_dpi'); if(pd) pd.value = dpiVal;

      writeMoneyInput('sueldoBase', planRow.sueldo ?? planRow.Sueldo ?? 0);
      writeMoneyInput('bonificacion', planRow.bono ?? planRow.bon ?? 0);
      writeMoneyInput('comisiones', planRow.comisiones ?? planRow.Comisiones ?? 0);
      writeMoneyInput('hextrasMonto', planRow.hextras ?? planRow.hextras_monto ?? 0);

      const igssVal = toNumberSafe(planRow.igss ?? planRow.IGSS ?? ((planRow.sueldo||planRow.Sueldo||0) * 0.0483));
      writeMoneyInput('igss', igssVal);

      writeMoneyInput('isr', planRow.isr ?? planRow._isrValue ?? 0);
      writeMoneyInput('otrasDeducciones', planRow.otras ?? planRow.otras_deducciones ?? 0);

      recalcLiquido();
      return;
    }

    fetch('/api/empleado/' + encodeURIComponent(rawVal)).then(r => r.json()).then(data => {
      const nombre = data.Nombre || data.nombre || data.full_name || '';
      const dpiVal = data['Numero de DPI'] || data.dpi || data.numero || rawVal;

      const pn = document.getElementById('print_nombre'); if(pn) pn.value = nombre;
      const pd = document.getElementById('print_dpi'); if(pd) pd.value = dpiVal;

      if(data.Sueldo !== undefined) writeMoneyInput('sueldoBase', data.Sueldo);
      if(data.bono !== undefined) writeMoneyInput('bonificacion', data.bono);
      if(data.comisiones !== undefined) writeMoneyInput('comisiones', data.comisiones);
      if(data.hextras_monto !== undefined) writeMoneyInput('hextrasMonto', data.hextras_monto);

      if(data.igss !== undefined){
        const ig = toNumberSafe(data.igss);
        writeMoneyInput('igss', ig);
      }

      if(data._isrValue !== undefined) writeMoneyInput('isr', data._isrValue);
      if(data.otras_deducciones !== undefined) writeMoneyInput('otrasDeducciones', data.otras_deducciones);

      recalcLiquido();
    }).catch(()=>{
      ['sueldoBase','bonificacion','comisiones','hextrasMonto','igss','isr','otrasDeducciones'].forEach(id=> writeMoneyInput(id, 0));
      recalcLiquido();
    });
  });

  function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }

  function recalcLiquido(){
    const toNum = id => {
      const el = document.getElementById(id);
      if(!el) return 0;
      const v = String(el.value || '').replace(/^Q\s*/i,'').replace(/,/g,'').trim();
      const n = Number(v);
      return isFinite(n) ? n : 0;
    };
    const ganancias = toNum('sueldoBase') + toNum('hextrasMonto') + toNum('bonificacion') + toNum('comisiones');
    const deducciones = toNum('igss') + toNum('isr') + toNum('otrasDeducciones');
    const liquido = round2(ganancias - deducciones);
    const liqEl = document.getElementById('liquidoTotal'); if(liqEl) liqEl.value = fmt(liquido);
    const letraEl = document.getElementById('totalEnLetras'); if(letraEl) letraEl.value = numeroALetrasEnEspañol(liquido);
  }

  function numeroALetrasEnEspañol(num){
    if (isNaN(num)) return '';
    const negativo = num < 0;
    const absNum = Math.abs(num);
    const entero = Math.trunc(absNum);
    const cent = Math.round((absNum - entero) * 100);

    const enteroTexto = entero === 0 ? 'cero' : enteroALetras(entero);
    let resultado = enteroTexto + (entero === 1 ? ' Quetzal' : ' Quetzales');

    if (cent > 0){
      const centPalabras = enteroALetras(cent);
      resultado += ' con ' + centPalabras + ' centavo' + (cent === 1 ? '' : 's');
    }

    resultado = resultado.charAt(0).toUpperCase() + resultado.slice(1);
    return (negativo ? 'menos ' : '') + resultado;
  }

  function enteroALetras(n){
    if (n === 0) return 'cero';
    const unidades = ['','uno','dos','tres','cuatro','cinco','seis','siete','ocho','nueve'];
    const especiales = ['diez','once','doce','trece','catorce','quince','dieciseis','diecisiete','dieciocho','diecinueve'];
    const decenas = ['','', 'veinte','treinta','cuarenta','cincuenta','sesenta','setenta','ochenta','noventa'];
    const centenas = ['','ciento','doscientos','trescientos','cuatrocientos','quinientos','seiscientos','setecientos','ochocientos','novecientos'];

    function tresCifrasToText(m){
      let s = '';
      const c = Math.floor(m / 100);
      const r = m % 100;
      if (m === 100) return 'cien';
      if (c > 0) s += centenas[c] + (r ? ' ' : '');
      if (r >= 10 && r <= 19){
        s += especiales[r - 10];
      } else if (r >= 20){
        const d = Math.floor(r / 10);
        const u = r % 10;
        if (d === 2 && u > 0){
          s += 'veinti' + unidades[u];
        } else {
          s += decenas[d];
          if (u > 0) s += ' y ' + unidades[u];
        }
      } else if (r > 0){
        s += unidades[r];
      }
      return s;
    }

    let parts = [];
    const millones = Math.floor(n / 1000000);
    const restoMillones = n % 1000000;
    const miles = Math.floor(restoMillones / 1000);
    const centenasResto = restoMillones % 1000;

    if (millones > 0){
      if (millones === 1) parts.push('un millón');
      else parts.push(tresCifrasToText(millones) + ' millones');
    }
    if (miles > 0){
      if (miles === 1) parts.push('mil');
      else parts.push(tresCifrasToText(miles) + ' mil');
    }
    if (centenasResto > 0){
      parts.push(tresCifrasToText(centenasResto));
    }

    return parts.join(' ').replace(/\s+/g,' ').trim();
  }

  // ---------- Control de medios de pago (pantalla + impresión) ----------
  function updateMediosOnScreen(){
    const val = document.querySelector('input[name="medioPago"]:checked')?.value || '';

    document.querySelectorAll('.transferencia-fields').forEach(el => {
      el.style.display = (val === 'TRANSFERENCIA') ? 'flex' : 'none';
      el.setAttribute('aria-hidden', (val === 'TRANSFERENCIA') ? 'false' : 'true');
    });
    document.querySelectorAll('.cheque-fields').forEach(el => {
      el.style.display = (val === 'CHEQUE') ? 'flex' : 'none';
      el.setAttribute('aria-hidden', (val === 'CHEQUE') ? 'false' : 'true');
    });

    document.body.classList.remove('print-medio-EFECTIVO','print-medio-TRANSFERENCIA','print-medio-CHEQUE');
    if(val) document.body.classList.add('print-medio-' + val);
  }
  document.querySelectorAll('input[name="medioPago"]').forEach(radio => {
    radio.addEventListener('change', updateMediosOnScreen);
  });
  updateMediosOnScreen();

  // Validación de fecha antes de imprimir
  function hasFechaValid(){
    const fecha = document.getElementById('comprobanteFecha')?.value || '';
    return String(fecha).trim() !== '';
  }

  // ---------- Print handlers ----------
  function beforePrintSetup(){
    updateMediosOnScreen();
    syncPrintableComprobante();
    const p = document.getElementById('print_comprobanteFecha');
    if(p){
      p.setAttribute('aria-hidden','false');
    }
    stripQForPrint();
  }
  function afterPrintCleanup(){
    document.body.classList.remove('print-medio-EFECTIVO','print-medio-TRANSFERENCIA','print-medio-CHEQUE');
    restoreAmountsAfterPrint();
    const p = document.getElementById('print_comprobanteFecha');
    if(p){
      p.setAttribute('aria-hidden','true');
    }
  }

  if (window.matchMedia) {
    const mql = window.matchMedia('print');
    if (mql.addEventListener) mql.addEventListener('change', (m) => { if(m.matches) {
        if(!hasFechaValid()){
          alert('Por favor ingrese una fecha antes de imprimir.');
        } else {
          beforePrintSetup();
        }
      } else afterPrintCleanup(); });
    else mql.addListener((m) => { if(m.matches) {
        if(!hasFechaValid()){
          alert('Por favor ingrese una fecha antes de imprimir.');
        } else {
          beforePrintSetup();
        }
      } else afterPrintCleanup(); });
  }
  window.addEventListener('beforeprint', beforePrintSetup);
  window.addEventListener('afterprint', afterPrintCleanup);

  const imprimirBtn = document.getElementById('imprimirBtn');
  if(imprimirBtn) imprimirBtn.addEventListener('click', function(){
    if(!hasFechaValid()){
      alert('No se puede imprimir. Debe de ingresar primero la fecha de emisión del recibo.');
      return;
    }
    beforePrintSetup();
    setTimeout(()=> window.print(), 120);
  });

  // Keep recalc hooked whenever amount inputs change (user edits not expected, but safe)
  ['sueldoBase','hextrasMonto','bonificacion','comisiones','igss','isr','otrasDeducciones'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', recalcLiquido);
  });

  // keep mirrored date updated live when user changes it
  document.getElementById('comprobanteFecha')?.addEventListener('input', syncPrintableComprobante);

  document.addEventListener('DOMContentLoaded', function(){
    loadEmpleados();
    // If template initialized with raw numeric values (without Q), convert them to Q-formatted on load
    ['sueldoBase','hextrasMonto','bonificacion','comisiones','igss','isr','otrasDeducciones'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const v = el.value || '';
      if(String(v).trim() !== ''){
        if(!/^Q\s*/i.test(String(v).trim())){
          el.value = fmt(toNumberSafe(v));
        }
      } else {
        el.value = fmt(0);
      }
    });
    recalcLiquido();
    syncPrintableComprobante();
    updateMediosOnScreen();
  });
})();
</script>

<style>
:root{
  --bg-1: #f7f6f3;
  --muted: #6b7280;
  --accent-naranja: #ff7a18;
  --accent-azul: #0b7285;
  font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* Page */
body { background: var(--bg-1); color:#0f1724; margin:0; padding:0; }
.container { max-width:1100px; margin:8px auto; padding:6px; box-sizing:border-box; }

/* Header */
.title-large { font-size: 1.2rem; font-weight: 800; color: var(--accent-azul); letter-spacing: -0.2px; margin-bottom:2px; }
.header-card { border-radius:8px; margin-bottom:6px; }
.header-body { padding:8px; }

/* Small padding utility for compact look */
.small-pad { padding:6px; }
.compact-row .col-6 { padding-bottom:4px; }
.xsmall { font-size:1.02rem; font-weight:700; color:var(--muted); }
.small { font-size:1.02rem; }

/* Inputs */
.form-control { border-radius:6px; border:1px solid rgba(11,19,30,0.06); background:#fff; padding:6px 8px; font-size:1.05rem; }
.form-control[readonly] { background:#fbfdff; color:#0b2a36; }
.compact-input { padding:5px 6px; font-size:1.04rem; }

/* Transfer inputs default wider on screen */
.trans-input { min-width:220px; max-width:520px; padding:8px 10px; box-sizing:border-box; }

/* Make transfer inputs able to shrink inside flex containers */
.transferencia-fields .trans-input,
.cheque-fields .trans-input {
  min-width: 0;
  flex: 1 1 auto;
}

/* Compact amount */
.compact-amount { width:150px; padding:6px; font-size:1.10rem; }

/* Small visual card */
.card { border-radius:8px; background:linear-gradient(180deg,#fff,#fbfcff); border:1px solid rgba(11,19,30,0.04); margin-bottom:6px; box-shadow:0 6px 18px rgba(11,50,80,0.03); }

/* Boxes for gains/deductions */
.section-grid { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
.section-left, .section-right { flex:1 1 320px; min-width:220px; }
.box-left, .box-right { padding:6px; border-radius:6px; background:#fff; border:1px solid rgba(11,19,30,0.04); }

/* Payment method extras */
.transferencia-fields, .cheque-fields { display:none; gap:6px; align-items:center; }

/* Liquido + letras: force single horizontal row */
.liquido-total-inner {
  display:flex;
  gap:12px;
  align-items:center;
  width:100%;
  box-sizing:border-box;
}
.liquido-block {
  min-width:150px;
  max-width:220px;
  display:flex;
  flex-direction:column;
  align-items:flex-end;
}
.letras-block {
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
}
.letras-block .form-control { width:100%; }

/* Signatures */
.sig-line { border-bottom:1px dashed #bfc7cb; height:1px; margin-bottom:6px; }
.signatures-row { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:6px; }

/* Print button */
.btn-imprimir {
  background: linear-gradient(90deg, #ff9042, #ff7a18);
  color: #fff;
  border: none;
  padding: .4rem .7rem;
  border-radius: 8px;
  font-weight: 800;
  cursor: pointer;
}

/* Reduce vertical spacing */
.mb-1 { margin-bottom:6px !important; }
.mt-1 { margin-top:6px !important; }

/* Header-print-row hidden on screen */
.header-print-row { display:none; }

/* Print styles */
@media print {
  @page { size: A4; margin: 4mm; }

  body { background:#fff; color:#000; margin:0; padding:0; }

  .receipt-root { width:48%; max-width:48%; float:left; margin:3mm 1% 0 1%; box-sizing:border-box; }

  .card { box-shadow:none !important; border:1px solid #ffffff !important; background:#fff !important; margin:0 0 4px 0; border-radius:4px !important; }
  .card .card-body { padding:4px !important; }

  /* Hide interactive controls not needed on print */
  .empleado-selection, select, .btn-imprimir, .header-controls { display:none !important; }
  input[type="date"] { display:none !important; }

  /* Show mirrored printable date and force header-print-row visible */
  .header-print-row { display:block !important; }
  .print-only { display:block !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; color:#111; font-size:13px; margin-bottom:6px; text-align:right; }

  input.form-control, input.form-control[readonly] {
    background: #fff !important;
    border: 1px solid #111 !important;
    color: #000 !important;
    padding: 4px 6px !important;
    font-size: 13px !important;
    box-shadow:none;
  }

  /* Keep líquido y letras on same line in print */
  .liquido-total-inner { flex-direction:row; gap:8px; align-items:center; }
  .liquido-block { min-width:120px; max-width:200px; align-items:flex-end; }
  .letras-block { min-width:120px; }

  /* Make transferencia / cheque textboxes slightly smaller in print so three fit */
  body.print-medio-TRANSFERENCIA .transferencia-fields .trans-input,
  body.print-medio-CHEQUE .cheque-fields .trans-input {
    /* reduced sizes so three inputs fit in page print */
    min-width:130px !important;
    max-width:150px !important;
    padding:3px 6px !important;
    font-size:13px !important;
  }

  /* Payment methods presentation in print */
  .printable-option { display:none; font-size:13px; }
  body.print-medio-EFECTIVO .printable-option[data-option="EFECTIVO"] { display:inline-flex; }
  body.print-medio-TRANSFERENCIA .printable-option[data-option="TRANSFERENCIA"] { display:inline-flex; }
  body.print-medio-CHEQUE .printable-option[data-option="CHEQUE"] { display:inline-flex; }

  /* Show transfer/cheque fields inline in print when selected
     IMPORTANT CHANGE: force a single horizontal row (no stacking) by using inline-flex,
     row direction and nowrap, and ensure inputs don't expand to full width */
  body.print-medio-TRANSFERENCIA .transferencia-fields,
  body.print-medio-CHEQUE .cheque-fields {
    display:inline-flex !important;
    gap:8px;
    align-items:center;
    margin-left:6px;
    flex-direction: row !important;
    flex-wrap: nowrap !important;
    white-space: nowrap !important;
  }

  body.print-medio-TRANSFERENCIA .transferencia-fields .trans-input,
  body.print-medio-CHEQUE .cheque-fields .trans-input {
    flex: 0 0 auto !important;
    min-width: 160px !important;
    max-width: 180px !important;
  }

  /* Compact signatures */
  .print-signatures .sig-col { flex:1 1 48%; text-align:center; padding:0 4px; }
  .sig-line { margin-bottom:6px; border-bottom:1px dashed #111; }

  .receipt-root, .card, .section-card, .totals-card, .signatures-row { page-break-inside: avoid; break-inside: avoid; }

  .receipt-root:last-of-type { margin-bottom:6mm; }
}

/* Ensure on-screen payment extras controlled by JS appear correctly */
input[name="medioPago"][value="TRANSFERENCIA"]:checked ~ .transferencia-fields,
input[name="medioPago"][value="CHEQUE"]:checked ~ .cheque-fields {
  display:flex;
  flex-direction:row;
  gap:6px;
  align-items:center;
}

/* micro polish */
.small.text-muted { color:var(--muted); font-size:0.98rem; }
.form-check-label { font-weight:700; color:#233642; font-size:0.95rem; }
.compact-transfer .form-control { padding:6px 8px; font-size:0.9rem; }

/* ------------------ Responsive additions for mobile (improvements) ------------------ */

/* Make the receipt fit a single column on small devices and improve touch targets */
@media (max-width: 600px) {
  .container {
    padding: 10px;
    max-width: 100%;
    margin: 6px;
  }

  /* Stack header controls vertically and make the print button full width */
  .header-body {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  .header-controls {
    width: 100%;
    display: flex;
    gap: 8px;
    align-items: stretch;
    justify-content: space-between;
  }
  .header-controls > div[style] {
    flex: initial;
    width: 48%;
    min-width: auto;
  }
  .btn-imprimir {
    width: 100%;
    padding: 0.6rem;
    border-radius: 8px;
    font-size: 1rem;
  }

  /* Make the receipt take full width (one per page vertical layout) */
  .receipt-root {
    width: 100% !important;
    max-width: 100% !important;
    float: none !important;
    margin: 6px 0 !important;
  }

  /* Compact left/right columns to full width */
  .section-grid {
    flex-direction: column;
  }
  .section-left, .section-right {
    min-width: 100%;
    flex: 1 1 100%;
  }

  /* Increase tap targets */
  .compact-input, .form-control {
    font-size: 1rem;
    padding: 10px;
  }
  .compact-amount {
    width: 100%;
    max-width: none;
    text-align: right;
    padding: 10px;
  }

  /* Transferencia and cheque fields become stacked and full width */
  .transferencia-fields, .cheque-fields {
    display: flex !important;
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }
  .transferencia-fields .trans-input, .cheque-fields .trans-input {
    min-width: 100% !important;
    max-width: 100% !important;
  }

  /* Liquido + letras switch to vertical layout on small screens */
  .liquido-total-inner {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }
  .liquido-block {
    min-width: 100%;
    max-width: 100%;
    align-items: flex-end;
  }
  .letras-block {
    min-width: 100%;
  }

  /* Reduce font sizes slightly for dense areas */
  .title-large { font-size: 1rem; }
  .xsmall, .small { font-size: 0.96rem; }

  /* Ensure signature lines are wide but reduced */
  .sig-line { border-bottom-width: 1px; width: 100%; max-width: 240px; margin: 0 auto 6px auto; }
  .signatures-row { flex-direction: column; align-items: center; gap: 12px; }

  /* Employee select should stretch */
  .empleado-selection .form-select { width: 100%; }
}

/* Extra tiny-device polish */
@media (max-width: 380px) {
  .btn-imprimir { font-size: 0.95rem; padding: 8px; }
  .form-control { font-size: 0.98rem; padding: 8px; }
  .compact-amount { font-size: 1rem; }
}

/* Final safety: ensure payment-row wraps to avoid horizontal overflow on medium narrow screens */
.payment-row {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
  width: 100%;
  box-sizing: border-box;
}

/* Make transferencia/cheque fields wrap and avoid forcing the container wider than viewport */
.transferencia-fields, .cheque-fields {
  max-width: 100%;
  box-sizing: border-box;
  flex-wrap: wrap;
}
</style>
{% endblock %}
