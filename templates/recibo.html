{% extends "layout.html" %}
{% block title %}Recibo de Pago{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <h3 class="mb-0">RECIBO DE PAGO</h3>
        <div class="small text-muted">Empresa: {{ empresa_nombre|default('EMPRESA') }}</div>
      </div>

      <div class="text-end" style="min-width:320px;">
        <div class="mb-2">
          <label class="form-label small text-muted">Comprobante No</label>
          <input id="comprobanteNumero" class="form-control form-control-sm" type="text" value="{{ recibo.numero if recibo is defined else '' }}">
        </div>

        <div class="d-flex gap-2 align-items-end justify-content-end">
          <div style="flex:1; min-width:140px;">
            <label class="form-label small text-muted">Fecha</label>
            <input id="comprobanteFecha" class="form-control form-control-sm" type="date" value="{{ recibo.fecha if recibo is defined else fecha_emision if fecha_emision is defined else '' }}">
          </div>

          <div style="align-self:flex-end;">
            <button id="imprimirBtn" class="btn btn-primary btn-sm" title="Imprimir recibo">Imprimir</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selección de empleado -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">Seleccionar Trabajador</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Empleado</label>
          <select id="empleadoSelect" class="form-select">
            <option value="">-- Seleccione empleado --</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Lugar / Ciudad</label>
          <input id="lugarPago" class="form-control" type="text" placeholder="GUATEMALA" value="GUATEMALA">
        </div>
      </div>
    </div>
  </div>

  <!-- Datos trabajador: Nombre completo, DPI -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">Datos del Trabajador</h5>
      <div class="row g-3">
        <div class="col-md-8">
          <label class="form-label">Nombre completo</label>
          <input id="nombre" class="form-control" readonly value="{{ recibo.nombre if recibo is defined else '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">DPI / Identificación</label>
          <input id="dpi" class="form-control" readonly value="{{ recibo.dpi if recibo is defined else '' }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Detalle de pago -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">Detalle de pago</h5>

      <div class="row">
        <!-- Ganancias -->
        <div class="col-md-6">
          <div class="card card-sm mb-3">
            <div class="card-body">
              <h6 class="mb-3">Ganancias</h6>

              <div class="mb-2">
                <label class="form-label small">Sueldo Base</label>
                <input id="sueldoBase" class="form-control" type="number" step="0.01" readonly value="{{ recibo.sueldo if recibo is defined else (recibo.Sueldo if recibo is defined else 0) }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">Horas extras (monto)</label>
                <input id="hextrasMonto" class="form-control" type="number" step="0.01" readonly value="{{ recibo.hextras_monto if recibo is defined else (recibo.hextras if recibo is defined else 0) }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">Bonificación</label>
                <input id="bonificacion" class="form-control" type="number" step="0.01" readonly value="{{ recibo.bono if recibo is defined else 0 }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">Comisiones</label>
                <input id="comisiones" class="form-control" type="number" step="0.01" readonly value="{{ recibo.comisiones if recibo is defined else 0 }}">
              </div>

            </div>
          </div>
        </div>

        <!-- Deducciones -->
        <div class="col-md-6">
          <div class="card card-sm mb-3">
            <div class="card-body">
              <h6 class="mb-3">Descuentos</h6>

              <div class="mb-2">
                <label class="form-label small">IGSS</label>
                <input id="igss" class="form-control" type="number" step="0.01" readonly value="{{ recibo.igss if recibo is defined else 0 }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">ISR</label>
                <input id="isr" class="form-control" type="number" step="0.01" readonly value="{{ recibo.isr if recibo is defined else (recibo._isrValue if recibo is defined else 0) }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">Otras deducciones</label>
                <input id="otrasDeducciones" class="form-control" type="number" step="0.01" readonly value="{{ recibo.otras_deducciones if recibo is defined else 0 }}">
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- Líquido -->
      <div class="row mt-3">
        <div class="col-md-12 text-end">
          <label class="form-label small">Líquido a recibir</label>
          <input id="liquidoTotal" class="form-control fw-bold text-end" readonly value="Q 0.00" style="font-size:1.15rem;">
        </div>
      </div>
    </div>
  </div>

  <!-- Total en letras y medios de pago (ordenado y claro) -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-start">
        <div class="col-md-8">
          <label class="form-label small">TOTAL EN LETRAS</label>
          <input id="totalEnLetras" class="form-control" type="text" readonly value="{{ recibo.total_letras if recibo is defined else '' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label small d-block">Fecha de pago (opcional)</label>
          <input id="fechaPago" class="form-control" type="date" value="">
        </div>
      </div>

      <hr class="my-3">

      <h6 class="mb-2">MEDIOS DE PAGO</h6>

      <!-- Clear, ordered layout:
           - radio buttons stacked with clear labels
           - associated input groups arranged in a single 2-column grid
           - only show the inputs for the selected method to reduce clutter
      -->
      <div id="mediosPagoWrapper">
        <div class="row g-2">
          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="medioPago" id="pagoEfectivo" value="EFECTIVO" checked>
              <label class="form-check-label fw-semibold" for="pagoEfectivo">EFECTIVO</label>
              <div class="ms-4 mt-2 medio-desc text-muted small">Pago en efectivo, sin datos bancarios necesarios.</div>
            </div>
          </div>

          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="medioPago" id="pagoTransferencia" value="TRANSFERENCIA">
              <label class="form-check-label fw-semibold" for="pagoTransferencia">TRANSFERENCIA BANCARIA</label>
            </div>

            <div id="transferenciaFields" class="mt-2 ms-4 row gx-2 gy-2 visually-hidden">
              <div class="col-12">
                <label class="form-label small mb-1">No. de cuenta</label>
                <input id="transCuenta" class="form-control" type="text" placeholder="No. de cuenta (transferencia)">
              </div>
              <div class="col-12">
                <label class="form-label small mb-1">Banco</label>
                <input id="transBanco" class="form-control" type="text" placeholder="Banco (transferencia)">
              </div>
              <div class="col-12">
                <div class="small text-muted">Revisa que los datos bancarios coincidan con la cuenta beneficiaria.</div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="medioPago" id="pagoCheque" value="CHEQUE">
              <label class="form-check-label fw-semibold" for="pagoCheque">CHEQUE</label>
            </div>

            <div id="chequeFields" class="mt-2 ms-4 row gx-2 gy-2 visually-hidden">
              <div class="col-12">
                <label class="form-label small mb-1">No. de cheque</label>
                <input id="chequeNumero" class="form-control" type="text" placeholder="No. de cheque">
              </div>
              <div class="col-12">
                <label class="form-label small mb-1">Banco</label>
                <input id="chequeBanco" class="form-control" type="text" placeholder="Banco (cheque)">
              </div>
              <div class="col-12">
                <div class="small text-muted">Si el cheque será depositado, indique banco y número para conciliación.</div>
              </div>
            </div>
          </div>

          <!-- Compact month/year fields kept separate and aligned -->
          <div class="col-6 mt-3">
            <label class="form-label small">Mes</label>
            <input id="mesPago" class="form-control" type="text" placeholder="Mes" value="{{ recibo.mes if recibo is defined else '' }}">
          </div>
          <div class="col-6 mt-3">
            <label class="form-label small">Año</label>
            <input id="anoPago" class="form-control" type="text" placeholder="Año" value="{{ recibo.ano if recibo is defined else '' }}">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firmas -->
  <div class="row mb-5">
    <div class="col-md-6 text-center">
      <div style="border-bottom:1px solid #ccc; height:1px; margin-bottom:8px;"></div>
      <div class="small text-muted">Firma del trabajador</div>
    </div>
    <div class="col-md-6 text-center">
      <div style="border-bottom:1px solid #ccc; height:1px; margin-bottom:8px;"></div>
      <div class="small text-muted">Firma de la empresa</div>
    </div>
  </div>
</div>

<!-- Scripts: carga empleados y lógica para sincronizar con la planilla local, cálculo y conversión a letras -->
<script>
(function(){
  const PLANILLA_STORAGE_KEY = 'empaquetex_planilla_noviembre_v1';

  function fmt(n){ return 'Q ' + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

  function loadEmpleados(){
    fetch('/api/empleados').then(r => r.json()).then(list => {
      const sel = document.getElementById('empleadoSelect');
      if(!Array.isArray(list)) return;
      list.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.dpi || '';
        opt.textContent = e.full_name || (e.Nombre ? ( (e.Apellidos||'') + ' ' + (e.Nombre||'') ) : e.dpi);
        sel.appendChild(opt);
      });
    }).catch(()=>{});
  }

  function loadPlanillaFromLocal(){
    try {
      const raw = localStorage.getItem(PLANILLA_STORAGE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      return obj && Array.isArray(obj.rows) ? obj : null;
    } catch(e){
      return null;
    }
  }

  function findPlanillaRowByDpi(dpi){
    const plan = loadPlanillaFromLocal();
    if(!plan) return null;
    const rows = plan.rows || [];
    for(const r of rows){
      if(String(r.dpi || '').trim() === String(dpi).trim()) return r;
    }
    return null;
  }

  function toNumberSafe(v){
    if(v === null || v === undefined) return 0;
    if(typeof v === 'number') return v;
    const s = String(v).replace(/\s+/g,'').replace(/^Q/i,'').replace(/,/g,'').trim();
    const n = Number(s);
    return isFinite(n) ? n : 0;
  }

  document.getElementById('empleadoSelect').addEventListener('change', function(){
    const dpiVal = this.value;
    if(!dpiVal){
      ['nombre','dpi','sueldoBase','comisiones','bonificacion','hextrasMonto','igss','isr','otrasDeducciones'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.value = (el.readOnly ? '' : 0);
      });
      recalcLiquido();
      return;
    }

    const planRow = findPlanillaRowByDpi(dpiVal);

    if(planRow){
      document.getElementById('nombre').value = planRow.nombre || planRow.Nombre || '';
      document.getElementById('dpi').value = planRow.dpi || planRow.DPI || dpiVal;

      document.getElementById('sueldoBase').value = toNumberSafe(planRow.sueldo || planRow.Sueldo || 0);
      document.getElementById('bonificacion').value = toNumberSafe(planRow.bono || planRow.bon || 0);
      document.getElementById('comisiones').value = toNumberSafe(planRow.comisiones || 0);
      document.getElementById('hextrasMonto').value = toNumberSafe(planRow.hextras || planRow._hextras || 0);

      const igssVal = toNumberSafe(planRow.igss ?? planRow.IGSS ?? ( (planRow.sueldo||planRow.Sueldo||0) * 0.0483 ));
      document.getElementById('igss').value = igssVal;

      document.getElementById('isr').value = toNumberSafe(planRow.isr ?? planRow._isrValue ?? 0);
      document.getElementById('otrasDeducciones').value = toNumberSafe(planRow.otras ?? planRow.otras_deducciones ?? 0);

      recalcLiquido();
      return;
    }

    fetch('/api/empleado/' + encodeURIComponent(dpiVal)).then(r => r.json()).then(data => {
      document.getElementById('nombre').value = data.Nombre || data.nombre || '';
      document.getElementById('dpi').value = data['Numero de DPI'] || data.dpi || dpiVal;

      if(data.Sueldo !== undefined) document.getElementById('sueldoBase').value = toNumberSafe(data.Sueldo);
      if(data.bono !== undefined) document.getElementById('bonificacion').value = toNumberSafe(data.bono);
      if(data.comisiones !== undefined) document.getElementById('comisiones').value = toNumberSafe(data.comisiones);
      if(data.hextras_monto !== undefined) document.getElementById('hextrasMonto').value = toNumberSafe(data.hextras_monto);
      if(data.igss !== undefined) document.getElementById('igss').value = toNumberSafe(data.igss);
      if(data._isrValue !== undefined) document.getElementById('isr').value = toNumberSafe(data._isrValue);
      if(data.otras_deducciones !== undefined) document.getElementById('otrasDeducciones').value = toNumberSafe(data.otras_deducciones);

      recalcLiquido();
    }).catch(()=>{});
  });

  function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }

  function recalcLiquido(){
    const toNum = id => Number(document.getElementById(id).value || 0);
    const ganancias = toNum('sueldoBase') + toNum('hextrasMonto') + toNum('bonificacion') + toNum('comisiones');
    const deducciones = toNum('igss') + toNum('isr') + toNum('otrasDeducciones');
    const liquido = round2(ganancias - deducciones);
    document.getElementById('liquidoTotal').value = fmt(liquido);
    document.getElementById('totalEnLetras').value = numeroALetrasEnEspañol(liquido);
  }

  // Conversión a letras en español (maneja hasta millones, negativos y centavos)
  function numeroALetrasEnEspañol(num){
    if (isNaN(num)) return '';
    const negativo = num < 0;
    const absNum = Math.abs(num);
    const entero = Math.trunc(absNum);
    const cent = Math.round((absNum - entero) * 100);

    const enteroTexto = entero === 0 ? 'cero' : enteroALetras(entero);
    let resultado = enteroTexto + (entero === 1 ? ' Quetzal' : ' Quetzales');

    if (cent > 0){
      const centPalabras = enteroALetras(cent);
      resultado += ' con ' + centPalabras + ' centavo' + (cent === 1 ? '' : 's');
    }

    resultado = resultado.charAt(0).toUpperCase() + resultado.slice(1);
    return (negativo ? 'menos ' : '') + resultado;
  }

  // Helper: convierte enteros >=0 a palabras en español (hasta 999 999 999)
  function enteroALetras(n){
    if (n === 0) return 'cero';
    const unidades = ['','uno','dos','tres','cuatro','cinco','seis','siete','ocho','nueve'];
    const especiales = ['diez','once','doce','trece','catorce','quince','dieciseis','diecisiete','dieciocho','diecinueve'];
    const decenas = ['','','veinte','treinta','cuarenta','cincuenta','sesenta','setenta','ochenta','noventa'];
    const centenas = ['','ciento','doscientos','trescientos','cuatrocientos','quinientos','seiscientos','setecientos','ochocientos','novecientos'];

    function tresCifrasToText(n){
      let s = '';
      const c = Math.floor(n / 100);
      const r = n % 100;
      if (n === 100) return 'cien';
      if (c > 0) s += centenas[c] + (r ? ' ' : '');
      if (r >= 10 && r <= 19){
        s += especiales[r - 10];
      } else if (r >= 20){
        const d = Math.floor(r / 10);
        const u = r % 10;
        if (d === 2 && u > 0){
          s += 'veinti' + unidades[u];
        } else {
          s += decenas[d];
          if (u > 0) s += ' y ' + unidades[u];
        }
      } else if (r > 0){
        s += unidades[r];
      }
      return s;
    }

    let parts = [];
    const millones = Math.floor(n / 1000000);
    const restoMillones = n % 1000000;
    const miles = Math.floor(restoMillones / 1000);
    const centenasResto = restoMillones % 1000;

    if (millones > 0){
      if (millones === 1) parts.push('un millón');
      else parts.push(tresCifrasToText(millones) + ' millones');
    }
    if (miles > 0){
      if (miles === 1) parts.push('mil');
      else parts.push(tresCifrasToText(miles) + ' mil');
    }
    if (centenasResto > 0){
      parts.push(tresCifrasToText(centenasResto));
    }

    return parts.join(' ').replace(/\s+/g,' ').trim();
  }

  ['sueldoBase','hextrasMonto','bonificacion','comisiones','igss','isr','otrasDeducciones'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', recalcLiquido);
  });

  // Print button
  document.addEventListener('DOMContentLoaded', function(){
    loadEmpleados();
    recalcLiquido();
    const imp = document.getElementById('imprimirBtn');
    if(imp) imp.addEventListener('click', function(){ window.print(); });

    // payment method toggles
    const transferenciaFields = document.getElementById('transferenciaFields');
    const chequeFields = document.getElementById('chequeFields');
    const radios = document.querySelectorAll('input[name="medioPago"]');
    function updateMediosVisibility(){
      const val = document.querySelector('input[name="medioPago"]:checked')?.value;
      if(val === 'TRANSFERENCIA'){
        transferenciaFields.classList.remove('visually-hidden');
        chequeFields.classList.add('visually-hidden');
      } else if(val === 'CHEQUE'){
        chequeFields.classList.remove('visually-hidden');
        transferenciaFields.classList.add('visually-hidden');
      } else {
        transferenciaFields.classList.add('visually-hidden');
        chequeFields.classList.add('visually-hidden');
      }
    }
    radios.forEach(r => r.addEventListener('change', updateMediosVisibility));
    updateMediosVisibility();
  });

})();
</script>

<style>
  .card-sm .card-body { padding: 0.9rem; }
  .form-label.small { font-size: .85rem; color:#6b7280; }
  input[readonly] { background:#f8f9fa; cursor: not-allowed; }
  #liquidoTotal { background: #fff8eb; }

  /* visually-hidden utility (keeps DOM accessible but hides visually) */
  .visually-hidden { display:none !important; }

  /* medios de pago spacing and emphasis */
  #mediosPagoWrapper .form-check { padding: .35rem 0; }
  #mediosPagoWrapper .medio-desc { margin-top:.25rem; }

  /* asegurar el botón visible en móvil */
  @media (max-width:576px){
    #imprimirBtn { width:100%; }
    .text-end[style] { min-width: unset; }
  }

  /* ocultar controles irrelevantes en impresión */
  @media print{
    button, select, input[type="text"].form-control-sm, .form-check-input, .form-check-label, input[placeholder] { display: none !important; }
    .card { box-shadow: none !important; border: none !important; }
    body { background: #fff !important; }
  }
</style>
{% endblock %}
