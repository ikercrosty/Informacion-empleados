{% extends "layout.html" %}
{% block title %}Recibo de Pago{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <h3 class="mb-0">RECIBO DE PAGO</h3>
        <div class="small text-muted">Empresa: {{ empresa_nombre|default('EMPRESA') }}</div>
      </div>

      <div class="text-end">
        <div class="mb-2">
          <label class="form-label small text-muted">Comprobante No</label>
          <input id="comprobanteNumero" class="form-control form-control-sm" type="text" value="{{ recibo.numero if recibo is defined else '' }}">
        </div>
        <div>
          <label class="form-label small text-muted">Fecha</label>
          <input id="comprobanteFecha" class="form-control form-control-sm" type="date" value="{{ recibo.fecha if recibo is defined else fecha_emision if fecha_emision is defined else '' }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Selección de empleado -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">Seleccionar Trabajador</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Empleado</label>
          <select id="empleadoSelect" class="form-select">
            <option value="">-- Seleccione empleado --</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Lugar / Ciudad</label>
          <input id="lugarPago" class="form-control" type="text" placeholder="GUATEMALA" value="GUATEMALA">
        </div>
      </div>
    </div>
  </div>

  <!-- Datos trabajador -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">Datos del Trabajador</h5>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Nombre</label>
          <input id="nombre" class="form-control" readonly value="{{ recibo.nombre if recibo is defined else '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Apellidos</label>
          <input id="apellidos" class="form-control" readonly value="{{ recibo.apellidos if recibo is defined else '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">DPI / Identificación</label>
          <input id="dpi" class="form-control" readonly value="{{ recibo.dpi if recibo is defined else '' }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Detalle de pago: ganancias a la izquierda, descuentos a la derecha -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">Detalle de pago</h5>

      <div class="row">
        <!-- Ganancias -->
        <div class="col-md-6">
          <div class="card card-sm mb-3">
            <div class="card-body">
              <h6 class="mb-3">Ganancias</h6>

              <div class="mb-2">
                <label class="form-label small">Sueldo Base</label>
                <input id="sueldoBase" class="form-control" type="number" step="0.01" value="{{ recibo.sueldo if recibo is defined else (recibo.Sueldo if recibo is defined else 0) }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">Horas extras (monto)</label>
                <input id="hextrasMonto" class="form-control" type="number" step="0.01" value="{{ recibo.hextras_monto if recibo is defined else (recibo.hextras if recibo is defined else 0) }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">Bonificación</label>
                <input id="bonificacion" class="form-control" type="number" step="0.01" value="{{ recibo.bono if recibo is defined else 0 }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">Bonificación incentivo</label>
                <input id="bonoIncentivo" class="form-control" type="number" step="0.01" value="{{ recibo.bono_incentivo if recibo is defined else 0 }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">Comisiones</label>
                <input id="comisiones" class="form-control" type="number" step="0.01" value="{{ recibo.comisiones if recibo is defined else 0 }}">
              </div>
            </div>
          </div>
        </div>

        <!-- Deducciones -->
        <div class="col-md-6">
          <div class="card card-sm mb-3">
            <div class="card-body">
              <h6 class="mb-3">Descuentos</h6>

              <div class="mb-2">
                <label class="form-label small">IGSS</label>
                <input id="igss" class="form-control" type="number" step="0.01" value="{{ recibo.igss if recibo is defined else 0 }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">ISR</label>
                <input id="isr" class="form-control" type="number" step="0.01" value="{{ recibo.isr if recibo is defined else (recibo._isrValue if recibo is defined else 0) }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">Otras deducciones</label>
                <input id="otrasDeducciones" class="form-control" type="number" step="0.01" value="{{ recibo.otras_deducciones if recibo is defined else 0 }}">
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- Liquido a recibir destacado -->
      <div class="row mt-3">
        <div class="col-md-12 text-end">
          <label class="form-label small">Líquido a recibir</label>
          <input id="liquidoTotal" class="form-control fw-bold text-end" readonly value="Q 0.00" style="font-size:1.15rem;">
        </div>
      </div>
    </div>
  </div>

  <!-- Sección inferior: Total en letras y Medios de pago -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-8">
          <label class="form-label small">TOTAL EN LETRAS</label>
          <input id="totalEnLetras" class="form-control" type="text" readonly value="{{ recibo.total_letras if recibo is defined else '' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label small">Fecha de pago</label>
          <input id="fechaPago" class="form-control" type="date" value="{{ recibo.fecha_pago if recibo is defined else '' }}">
        </div>
      </div>

      <hr class="my-3">

      <h6 class="mb-2">MEDIOS DE PAGO</h6>
      <div class="row g-2">
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="medioPago" id="pagoEfectivo" value="EFECTIVO" checked>
            <label class="form-check-label" for="pagoEfectivo">EFECTIVO</label>
          </div>
        </div>

        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="medioPago" id="pagoTransferencia" value="TRANSFERENCIA">
            <label class="form-check-label" for="pagoTransferencia">TRANSFERENCIA BANCARIA</label>
          </div>
          <div class="mt-2 ms-4">
            <input id="transCuenta" class="form-control mb-1" type="text" placeholder="No. de cuenta (transferencia)">
            <input id="transBanco" class="form-control" type="text" placeholder="Banco (transferencia)">
          </div>
        </div>

        <div class="col-12 mt-2">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="medioPago" id="pagoCheque" value="CHEQUE">
            <label class="form-check-label" for="pagoCheque">CHEQUE</label>
          </div>
          <div class="mt-2 ms-4">
            <input id="chequeNumero" class="form-control mb-1" type="text" placeholder="No. de cheque">
            <input id="chequeBanco" class="form-control" type="text" placeholder="Banco (cheque)">
          </div>
        </div>

        <div class="col-6 mt-3">
          <label class="form-label small">Mes</label>
          <input id="mesPago" class="form-control" type="text" placeholder="Mes" value="{{ recibo.mes if recibo is defined else '' }}">
        </div>
        <div class="col-6 mt-3">
          <label class="form-label small">Año</label>
          <input id="anoPago" class="form-control" type="text" placeholder="Año" value="{{ recibo.ano if recibo is defined else '' }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Firmas -->
  <div class="row mb-5">
    <div class="col-md-6 text-center">
      <div style="border-bottom:1px solid #ccc; height:1px; margin-bottom:8px;"></div>
      <div class="small text-muted">Firma del trabajador</div>
    </div>
    <div class="col-md-6 text-center">
      <div style="border-bottom:1px solid #ccc; height:1px; margin-bottom:8px;"></div>
      <div class="small text-muted">Firma de la empresa</div>
    </div>
  </div>
</div>

<!-- Scripts: carga empleados y lógica básica de cálculo -->
<script>
(function(){
  // Util: formatea número a cadena Q 0.00
  function fmt(n){ return 'Q ' + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

  // Cargar combo de empleados desde API
  function loadEmpleados(){
    fetch('/api/empleados').then(r => r.json()).then(list => {
      const sel = document.getElementById('empleadoSelect');
      if(!Array.isArray(list)) return;
      list.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.dpi || e.dpi;
        opt.textContent = e.full_name || e.full_name || (e.Nombre ? (e.Apellidos + ' ' + e.Nombre) : e.dpi);
        sel.appendChild(opt);
      });
    }).catch(()=>{ /* silent */ });
  }

  // Cuando seleccionan empleado, traer datos y poblar campos
  document.getElementById('empleadoSelect').addEventListener('change', function(){
    const dpiVal = this.value;
    if(!dpiVal){
      // limpiar
      ['nombre','apellidos','dpi','sueldoBase','comisiones','bonificacion','bonoIncentivo','hextrasMonto','igss','isr','otrasDeducciones'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.value = (el.readOnly ? '' : 0);
      });
      recalcLiquido();
      return;
    }
    fetch('/api/empleado/' + encodeURIComponent(dpiVal)).then(r => r.json()).then(data => {
      // Mapea campos comunes. Ajusta según nombres exactos de tu API
      document.getElementById('nombre').value = data.Nombre || data.nombre || '';
      document.getElementById('apellidos').value = data.Apellidos || data.apellidos || '';
      document.getElementById('dpi').value = data['Numero de DPI'] || data.dpi || dpiVal;

      // Si la planilla tiene información salarial almacenada en la fila del empleado, se debe traer desde otra API.
      // Como fallback, dejamos sueldo/comisiones/bonos en 0 si no existen.
      if(data.Sueldo) document.getElementById('sueldoBase').value = Number(data.Sueldo);
      // Mantén campos numéricos a 0 por defecto si no vienen
      ['comisiones','bonificacion','bonoIncentivo','hextrasMonto','igss','isr','otrasDeducciones'].forEach(id=>{
        const el = document.getElementById(id);
        if(el && (data[id] !== undefined)) el.value = Number(data[id]);
      });

      recalcLiquido();
    }).catch(()=>{/* no mostrar errores aquí */});
  });

  // Recalcular líquido: sum(ganancias) - sum(deducciones)
  function recalcLiquido(){
    const toNum = id => Number(document.getElementById(id).value || 0);
    const ganancias = toNum('sueldoBase') + toNum('hextrasMonto') + toNum('bonificacion') + toNum('bonoIncentivo') + toNum('comisiones');
    const deducciones = toNum('igss') + toNum('isr') + toNum('otrasDeducciones');
    const liquido = Math.round((ganancias - deducciones + Number.EPSILON) * 100) / 100;
    document.getElementById('liquidoTotal').value = fmt(liquido);
    document.getElementById('totalEnLetras').value = numeroALetras(liquido);
  }

  // Convertir número a texto en español (versión simple para enteros y cientos con centavos)
  function numeroALetras(num){
    if (isNaN(num)) return '';
    const entero = Math.trunc(Math.abs(num));
    const cent = Math.round((Math.abs(num) - entero) * 100);
    // representación sencilla para evitar librerías: usar Intl para miles y añadir texto
    const enteroForm = entero.toLocaleString('es-GT');
    return `${enteroForm} QUETZALES ${cent.toString().padStart(2,'0')}/100`;
  }

  // Delegado: recalcula cuando cambian inputs numéricos relevantes
  ['sueldoBase','hextrasMonto','bonificacion','bonoIncentivo','comisiones','igss','isr','otrasDeducciones'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', recalcLiquido);
  });

  // Inicializar
  document.addEventListener('DOMContentLoaded', function(){
    loadEmpleados();
    recalcLiquido();
  });

})();
</script>

<style>
  /* Estilos mínimos para que quede ordenado y compacto */
  .card-sm .card-body { padding: 0.9rem; }
  .form-label.small { font-size: .85rem; color:#6b7280; }
  input[readonly] { background:#f8f9fa; }
  #liquidoTotal { background: #fff8eb; }
</style>
{% endblock %}
