{% extends "layout.html" %}
{% block title %}Contacto de Emergencia{% endblock %}

{% block content %}
  <div class="jumbotron-welcome rounded-3 mb-3">
    <div class="d-flex flex-column flex-md-row align-items-center gap-3">
      <div class="flex-grow-1">
        <h1 class="h2 mb-1" style="letter-spacing: .2px; font-weight:700; color:#0b486b;">
          Contacto de Emergencia
        </h1>
        <p class="text-muted mb-2" style="font-size:01.20rem;">
          Personas a contactar en caso de emergencia
        <br>
<br>
<br>
        </p>
        <p class="text-muted mb-1" style="font-size:0.65rem;">
        'Presionar "Agrega" para poder agregar un nuevo empleado.'
        </p>
        <p class="text-muted mb-1" style="font-size:0.65rem;">
        'Hacer doble click en una fila para poder "Editar".'
        </p>
        <p class="text-muted mb-1" style="font-size:0.65rem;">
        'Siempre presionar el botón guardar para conservar los cambios.''
        </p>

        <div class="d-flex flex-wrap gap-2 align-items-center mt-2">
          <div class="d-flex gap-2">
          </div>
        </div>
      </div>

      <div class="d-none d-md-flex align-items-center" style="min-width:220px; justify-content:flex-end;">
        <div style="text-align:right;">
          <div style="font-size:.82rem; color:#6b7280;">Empresa</div>
          <div style="font-weight:700; color:#0b486b;">EMPAQUES Y TEXTURAS DE GUATEMALA, S.A.</div>
        </div>
      </div>
    </div>
  </div>

<div class="mb-3">
  <button id="btnAgregar" type="button" class="btn btn-success btn-sm">Agregar</button>
  <button id="btnEditar" type="button" class="btn btn-primary btn-sm" disabled>Editar</button>
  <button id="btnGuardar" type="button" class="btn btn-success btn-sm">Guardar</button>
  <button id="btnCancelar" type="button" class="btn btn-secondary btn-sm">Cancelar</button>
</div>

<div class="table-responsive">
  <table id="tablaEmergencia" class="table table-bordered table-striped table-hover table-sm" data-endpoint="/guardar_emergencia">
    <thead class="thead-dark">
      <tr>
        <th>DPI</th><th>Nombre</th><th>Apellidos</th>
        <th>Nombre contacto</th><th>Apellidos contacto</th><th>Teléfono de emergencia</th>
      </tr>
    </thead>
    <tbody>
      {% for e in empleados %}
      <tr>
        <td>{{ e['Numero de DPI']|default('') }}</td>
        <td>{{ e.get('Nombre')|default('') }}</td>
        <td>{{ e.get('Apellidos')|default('') }}</td>
        <td>{{ e.get('Nombre del contacto de emergencia')|default('') }}</td>
        <td>{{ e.get('Apellidos del contacto de emergencia')|default('') }}</td>
        <td>{{ e.get('Numero de telefono de emergencia')|default('') }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
(function waitRegister(){
  const meta = {
    id: 'tablaEmergencia',
    cols: 6,
    endpoint: '/guardar_emergencia',
    campos: [
      "Numero de DPI","Nombre","Apellidos",
      "Nombre del contacto de emergencia","Apellidos del contacto de emergencia",
      "Numero de telefono de emergencia"
    ],
    bloqueadas: [0,1,2]
  };
  function tryRegister(n=20){
    if (window.registrarTabla) {
      window.registrarTabla(meta.id, meta.cols, meta.endpoint, meta.campos, meta.bloqueadas);
      document.getElementById('btnAgregar').disabled = false;
      document.getElementById('btnEditar').disabled  = true;
      document.getElementById('btnGuardar').disabled = false;
      document.getElementById('btnCancelar').disabled= false;
      return;
    }
    if (n>0) setTimeout(()=>tryRegister(n-1),100);
    else console.error('registrarTabla no disponible para tablaEmergencia');
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', ()=>tryRegister(20));
  else tryRegister(20);
})();
</script>

<script>
/*
  Cambio requerido:
  - Evitar que clicks simples seleccionen filas o carguen datos (si otras librerías añaden handlers click).
  - Forzar que SOLO dblclick realice selección y, de ser necesario, inicie edición.
  - No cambiar ninguna otra lógica de negocio.
*/
(function(){
  // Helpers y referencias mínimas
  const TABLE_ID = 'tablaEmergencia';
  const tabla = document.getElementById(TABLE_ID);

  function clearSelection() {
    if (!tabla) return;
    tabla.querySelectorAll('tbody tr').forEach(r => r.classList.remove('selected'));
  }

  // Bloqueo robusto de clicks simples en la tabla:
  // 1) Evitamos comportamiento por defecto de cualquier listener que dependa del evento 'click'
  //    atacando el evento en capture y deteniendo su propagación hacia handlers posteriores.
  // 2) No interferimos con otros eventos (contextmenu, dblclick): solo clicks simples.
  // 3) Permitimos que dblclick funcione (no stopPropagation en dblclick).
  let clickCaptureInstalled = false;
  function installClickBlocker() {
    if (!tabla || clickCaptureInstalled) return;
    clickCaptureInstalled = true;

    // Handler en fase capture que evita que listeners registrados después reciban el click.
    tabla.addEventListener('click', function captureBlock(ev) {
      // Solo bloquear clicks simples sobre filas dentro del tbody
      const tr = ev.target.closest('tr');
      if (!tr || tr.parentElement.tagName !== 'TBODY') return;
      // Evitar que otros handlers ejecuten selección/fetch de foto, etc.
      ev.stopImmediatePropagation();
      // No hacemos preventDefault porque no queremos romper interacciones accesibles
      // (por ejemplo selección por teclado). Solo evitamos que handlers JS se ejecuten.
      // Nota: si alguna librería usa capture también, este handler se ejecutará en capture
      // y podrá detener la propagación a capture inferiores y a bubble.
    }, true);
  }

  // Instalar el bloqueo en cuanto exista la tabla
  function tryInstallClickBlocker(retries=20) {
    if (tabla) installClickBlocker();
    else if (retries>0) setTimeout(()=>tryInstallClickBlocker(retries-1), 100);
  }
  tryInstallClickBlocker(20);

  // Implementamos selección y acción en dblclick (único punto de entrada)
  tabla?.addEventListener('dblclick', async function(ev){
    const tr = ev.target.closest('tr');
    if (!tr || tr.parentElement.tagName !== 'TBODY') return;

    clearSelection();
    tr.classList.add('selected');

    // Extraer valores de la fila según columnas esperadas
    const dpi = (tr.cells[0] && tr.cells[0].innerText || '').trim();

    // Si la página tiene alguna lógica de edición local (iniciarEdicion), respetarla
    if (typeof window.iniciarEdicion === 'function') {
      try { window.iniciarEdicion(tr); }
      catch (e) {
        try { window.iniciarEdicion(); } catch (_) { /* no-op */ }
      }
    }

    // Si existe un handler global para cargar foto (o panel), llamarlo usando el DPI
    // Mantenemos la misma idea que en otras vistas: intentar cargar foto vía /api/foto/{dpi}
    // pero solo si la aplicación expone funciones relacionadas (no forzamos nada).
    try {
      if (!dpi) return;
      // Si hay un handler específico (por ejemplo window.cargarFotoEmpleado), usarlo.
      if (typeof window.cargarFotoEmpleado === 'function') {
        try { await window.cargarFotoEmpleado(dpi); } catch(_) {}
        return;
      }
      // Si no, intentar una petición fetch mínima para pre-cargar URL de foto si el endpoint existe.
      // Esto es opcional: no hacemos nada si falla (evitamos errores visibles).
      const fotoImg = document.getElementById('fotoEmpleado');
      const formSubir = document.getElementById('formSubirFoto');
      const formEliminar = document.getElementById('formEliminarFoto');
      const inputDpiUpload = document.getElementById('inputDpiForUpload');
      const inputDpiDelete = document.getElementById('inputDpiForDelete');

      if (inputDpiUpload) inputDpiUpload.value = dpi;
      if (inputDpiDelete) inputDpiDelete.value = dpi;

      if (!fotoImg) return;
      // Intentar fetch; si falla, dejamos la imagen por defecto y los formularios acorde.
      const res = await fetch(`/api/foto/${encodeURIComponent(dpi)}`, { cache: 'no-store' });
      if (!res.ok) {
        // no-photo: mostrar subir form
        if (fotoImg) fotoImg.src = fotoImg.dataset?.default || fotoImg.src;
        if (formSubir) formSubir.style.display = 'block';
        if (formEliminar) formEliminar.style.display = 'none';
        return;
      }
      const j = await res.json().catch(()=>null);
      if (j && j.url) {
        fotoImg.src = `${j.url}?t=${Date.now()}`;
        if (formSubir) formSubir.style.display = 'none';
        if (formEliminar) formEliminar.style.display = 'block';
      } else {
        if (fotoImg) fotoImg.src = fotoImg.dataset?.default || fotoImg.src;
        if (formSubir) formSubir.style.display = 'block';
        if (formEliminar) formEliminar.style.display = 'none';
      }
    } catch (e) {
      // silencioso: no rompemos la experiencia por un fallo en carga de imagen
      // puedes añadir aquí un console.warn si lo deseas
    }
  });

  // Aseguramos que cualquier handler que se base en 'click' del DOM no reciba eventos
  // (por ejemplo, si otras partes del app vuelven a añadir listeners). Reinstalamos si se reemplaza la tabla.
  const obs = new MutationObserver((mutations) => {
    for (const m of mutations) {
      if (m.type === 'childList' || m.type === 'attributes') {
        // si la tabla se re-renderiza, re-instalar el bloqueador
        tryInstallClickBlocker(3);
      }
    }
  });
  if (tabla) obs.observe(tabla, { childList: true, subtree: true, attributes: true });

  // Limpieza ligera si la página se descarga
  window.addEventListener('beforeunload', () => {
    try { obs.disconnect(); } catch(_) {}
  });

})();
</script>
{% endblock %}
