{% extends "layout.html" %}
{% block title %}Ficha{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-body d-flex align-items-center justify-content-between gap-3">
      <div>
        <h3 class="mb-0">FICHA DEL PERSONAL</h3>
        <div class="text-muted small mt-1">Selecciona un empleado para ver su ficha</div>
      </div>

      <div class="d-flex flex-column align-items-end gap-2">
        <select id="empleadoSelect" class="form-select form-select-sm" style="min-width:320px">
          <option value="">Cargando lista de empleados...</option>
        </select>

        <img id="fotoEmpleado" src="{{ url_for('static', filename='placeholder.png') }}" alt="Foto" style="width:120px;height:140px;object-fit:cover;border:1px solid #ddd;border-radius:4px;">
      </div>
    </div>
  </div>

  <form id="fichaForm" class="card shadow-sm border-0 mb-4">
    <div class="card-body p-4">

      <!-- Datos personales -->
      <h5 class="mb-3">DATOS PERSONALES</h5>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Número de DPI</label>
          <input id="dpi" value="{{ e['Numero de DPI'] if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Nombre</label>
          <input id="nombre" value="{{ e.get('Nombre') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Apellidos</label>
          <input id="apellidos" value="{{ e.get('Apellidos') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Apellidos de casada</label>
          <input id="apellidos_casada" value="{{ e.get('Apellidos de casada') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>

        <div class="col-md-3">
          <label class="form-label">Estado Civil</label>
          <input id="estado_civil" value="{{ e.get('Estado Civil') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Nacionalidad</label>
          <input id="nacionalidad" value="{{ e.get('Nacionalidad') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Departamento</label>
          <input id="departamento" value="{{ e.get('Departamento') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>

        {# Fecha de nacimiento - mostrar solo fecha en formato DD/MM/AAAA #}
        <div class="col-md-3">
          <label class="form-label">Fecha de nacimiento</label>
          {% set fn = e.get('Fecha de nacimiento') if e else None %}
          {% if fn %}
            {# Caso ISO YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS -> tomar primeros 10 y reordenar #}
            {% if '-' in fn and fn[:4].isdigit() %}
              {% set dpart = fn[:10].split('-') %}
              {% set fecha_nac = dpart[2] ~ '/' ~ dpart[1] ~ '/' ~ dpart[0] %}
            {% else %}
              {# Caso estilo 'Tue, 03 Jul 1990 00:00:00 GMT' o '03 Jul 1990' -> detectar día, mes abreviado y año #}
              {% set months = {'Jan':'01','Feb':'02','Mar':'03','Apr':'04','May':'05','Jun':'06','Jul':'07','Aug':'08','Sep':'09','Oct':'10','Nov':'11','Dec':'12',
                               'enero':'01','febrero':'02','marzo':'03','abril':'04','mayo':'05','junio':'06','julio':'07','agosto':'08','septiembre':'09','octubre':'10','noviembre':'11','diciembre':'12'} %}
              {% set tokens = fn.replace(',', ' ').split() %}
              {% set day=None %}{% set mon=None %}{% set year=None %}
              {% for t in tokens %}
                {% if day is none and t.isdigit() and 1 <= t|int <= 31 %}
                  {% set day = ("%02d"|format(t|int)) %}
                {% elif mon is none and (t[:3].capitalize() in months or t.lower() in months) %}
                  {% set key = t[:3].capitalize() if t[:3].capitalize() in months else t.lower() %}
                  {% set mon = months[key] %}
                {% elif year is none and t.isdigit() and (t|length == 4) %}
                  {% set year = t %}
                {% endif %}
              {% endfor %}
              {% if day and mon and year %}
                {% set fecha_nac = day ~ '/' ~ mon ~ '/' ~ year %}
              {% else %}
                {% set fecha_nac = fn %}
              {% endif %}
            {% endif %}
          {% else %}
            {% set fecha_nac = '' %}
          {% endif %}
          <input id="fecha_nacimiento" value="{{ fecha_nac }}" class="form-control form-control-sm" readonly>
        </div>

        <div class="col-md-4">
          <label class="form-label">Lugar de nacimiento</label>
          <input id="lugar_nacimiento" value="{{ e.get('Lugar de nacimiento') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-4">
          <label class="form-label">Número de Afiliación IGSS</label>
          <input id="iggs" value="{{ e.get('Numero de Afiliación del IGGS') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-4">
          <label class="form-label">Religión</label>
          <input id="religion" value="{{ e.get('Religión') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
      </div>

      <hr class="my-4">

      <!-- Domicilio y contacto -->
      <h5 class="mb-3">DOMICILIO Y CONTACTO</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Dirección del Domicilio</label>
          <input id="direccion" value="{{ e.get('Dirección del Domicilio') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Número de Teléfono</label>
          <input id="telefono" value="{{ e.get('Numero de Telefono') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Correo Electrónico</label>
          <input id="correo" value="{{ e.get('Correo Electronico') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
      </div>

      <hr class="my-4">

      <!-- Datos laborales (título y nota solicitada) -->
      <h5 class="mb-3">Datos Laborales (Exclusivo de la administración)</h5>
      <div class="text-muted small mb-3">Administración será la encargada de llenar este apartado.</div>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Puesto de trabajo</label>
          <input id="puesto" value="{{ e.get('Puesto de trabajo') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Tipo de contrato</label>
          <input id="tipo_contrato" value="{{ e.get('Tipo de contrato') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Jornada laboral</label>
          <input id="jornada" value="{{ e.get('Jornada laboral') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Duración del contrato</label>
          <input id="duracion" value="{{ e.get('Duración del trabajo') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>

        <div class="col-md-3">
          <label class="form-label">Fecha de inicio laboral</label>
          <input id="fecha_inicio" value="{{ e.get('Fecha de inicio laboral') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Días laborales</label>
          <input id="dias_laborales" value="{{ e.get('Dias Laborales') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
      </div>

      <hr class="my-4">

      <!-- Información académica -->
      <h5 class="mb-3">INFORMACIÓN ACADÉMICA</h5>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Nivel de estudios</label>
          <input id="nivel_estudios" value="{{ e.get('Nivel de estudios') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Profesión u Oficio</label>
          <input id="profesion" value="{{ e.get('Profesión u Oficio') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Colegio o establecimiento</label>
          <input id="colegio" value="{{ e.get('Colegio o establecimiento') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Cursos o títulos adicionales</label>
          <input id="cursos" value="{{ e.get('Cursos o títulos adicionales') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
      </div>

      <hr class="my-4">

      <!-- Datos del cónyuge -->
      <h5 class="mb-3">DATOS DEL CÓNYUGE</h5>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Nombres del cónyuge</label>
          <input id="conyuge_nombres" value="{{ e.get('Nombres del cónyuge') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Apellidos del cónyuge</label>
          <input id="conyuge_apellidos" value="{{ e.get('Apellidos del cónyuge') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Dirección del cónyuge</label>
          <input id="conyuge_direccion" value="{{ e.get('Dirección del cónyuge') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Teléfono del cónyuge</label>
          <input id="conyuge_telefono" value="{{ e.get('Teléfono del cónyuge') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-4 mt-2">
          <label class="form-label">Correo del cónyuge</label>
          <input id="conyuge_correo" value="{{ e.get('Correo del cónyuge') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
      </div>

      <hr class="my-4">

      <!-- Contacto de emergencia -->
      <h5 class="mb-3">CONTACTO DE EMERGENCIA</h5>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Nombre contacto</label>
          <input id="contacto_nombre" value="{{ e.get('Nombre contacto') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Apellidos contacto</label>
          <input id="contacto_apellidos" value="{{ e.get('Apellidos contacto') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Teléfono de emergencia</label>
          <input id="contacto_telefono" value="{{ e.get('Teléfono de emergencia') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
      </div>

      <hr class="my-4">

      <!-- Referencias laborales (Último empleo) -->
      <h5 class="mb-3">REFERENCIAS LABORALES (Último empleo)</h5>
      <div class="table-responsive">
        <table class="table table-sm table-borderless">
          <thead>
            <tr>
              <th>Nombre Empresa</th>
              <th>Dirección Empresa</th>
              <th>Inicio en la empresa</th>
              <th>Fin en la empresa</th>
              <th>Motivo del retiro</th>
              <th>Nombre del jefe inmediato</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>{{ e.get('Nombre Empresa') if e else '' }}</td>
              <td>{{ e.get('Dirección Empresa') if e else '' }}</td>
              <td>{{ e.get('Inicio en la empresa') if e else '' }}</td>
              <td>{{ e.get('Fin en la empresa') if e else '' }}</td>
              <td>{{ e.get('Motivo del retiro') if e else '' }}</td>
              <td>{{ e.get('Nombre del jefe inmediato') if e else '' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <hr class="my-4">

      <!-- Referencias médicas -->
      <h5 class="mb-3">REFERENCIAS MÉDICAS</h5>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">¿Padece alguna enfermedad?</label>
          <input id="padece_enfermedad" value="{{ e.get('Padece alguna enfermedad') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Tipo de enfermedad</label>
          <input id="tipo_enfermedad" value="{{ e.get('Tipo de enfermedad') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Recibe tratamiento</label>
          <input id="recibe_tratamiento" value="{{ e.get('Recibe tratamiento') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Nombre del tratamiento</label>
          <input id="nombre_tratamiento" value="{{ e.get('Nombre del tratamiento') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>

        <div class="col-md-4 mt-3">
          <label class="form-label">¿Es alérgico a algún medicamento?</label>
          <input id="alergico" value="{{ e.get('Es alérgico a algún medicamento') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-4 mt-3">
          <label class="form-label">Nombre del médico tratante</label>
          <input id="medico_tratante" value="{{ e.get('Nombre del médico tratante') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
        <div class="col-md-4 mt-3">
          <label class="form-label">Tipo de sangre</label>
          <input id="tipo_sangre" value="{{ e.get('Tipo de sangre') if e else '' }}" class="form-control form-control-sm" readonly>
        </div>
      </div>

      <div class="mt-4 text-end">
        <button type="button" id="btnClear" class="btn btn-outline-secondary btn-sm">Limpiar</button>
      </div>
    </div>
  </form>
</div>

<!-- Configuración que necesita main.js -->
<script>
  window.__FICHA_CONFIG = {
    placeholder: "{{ url_for('static', filename='placeholder.png') }}",
    apiEmpleados: "/api/empleados",
    apiEmpleadoBase: "/api/empleado/",
    apiFotoBase: "/api/foto/"
  };
</script>
<script>
(function(){
  const cfg = window.__FICHA_CONFIG || {};
  const apiList = cfg.apiEmpleados || '/api/empleados';
  const apiEmpleadoBase = cfg.apiEmpleadoBase || '/api/empleado/';
  const apiFotoBase = cfg.apiFotoBase || '/api/foto/';
  const placeholder = cfg.placeholder || '';

  // Elementos
  const selectEl = document.getElementById('empleadoSelect');
  const fotoEl = document.getElementById('fotoEmpleado');
  const btnClear = document.getElementById('btnClear');

  // Map of form fields by key -> element id in the template
  const FIELD_MAP = {
    "Numero de DPI": "dpi",
    "Nombre": "nombre",
    "Apellidos": "apellidos",
    "Apellidos de casada": "apellidos_casada",
    "Estado Civil": "estado_civil",
    "Nacionalidad": "nacionalidad",
    "Departamento": "departamento",
    "Fecha de nacimiento": "fecha_nacimiento",
    "Lugar de nacimiento": "lugar_nacimiento",
    "Numero de Afiliación del IGGS": "iggs",
    "Dirección del Domicilio": "direccion",
    "Numero de Telefono": "telefono",
    "Correo Electronico": "correo",
    "Religión": "religion",
    "Puesto de trabajo": "puesto",
    "Tipo de contrato": "tipo_contrato",
    "Jornada laboral": "jornada",
    "Duración del trabajo": "duracion",
    "Fecha de inicio laboral": "fecha_inicio",
    "Dias Laborales": "dias_laborales",

    // académico
    "Nivel de estudios": "nivel_estudios",
    "Profesión u Oficio": "profesion",
    "Colegio o establecimiento": "colegio",
    "Cursos o títulos adicionales": "cursos",

    // cónyuge
    "Nombres del cónyuge": "conyuge_nombres",
    "Apellidos del cónyuge": "conyuge_apellidos",
    "Dirección del cónyuge": "conyuge_direccion",
    "Teléfono del cónyuge": "conyuge_telefono",
    "Correo del cónyuge": "conyuge_correo",

    // emergencia
    "Nombre contacto": "contacto_nombre",
    "Apellidos contacto": "contacto_apellidos",
    "Numero de telefono de emergencia": "contacto_telefono",
    "Teléfono de emergencia": "contacto_telefono", // alternate key

    // laboral / referencias
    "Nombre Empresa": null, // in table row, different template keys; handled below
    "Dirección Empresa": null,
    "Inicio en la empresa": null,
    "Fin en la empresa": null,
    "Motivo del retiro": null,
    "Nombre del jefe inmediato": null,
    "Nombre Empresa": "Nombre Empresa",
    "Dirección Empresa": "Dirección Empresa",
    "Inicio en la empresa": "Inicio en la empresa",
    "Fin en la empresa": "Fin en la empresa",
    "Motivo del retiro": "Motivo del retiro",
    "Nombre del jefe inmediato": "Nombre del jefe inmediato",

    // médica
    "Padece alguna enfermedad": "padece_enfermedad",
    "Tipo de enfermedad": "tipo_enfermedad",
    "Recibe tratamiento medico": "recibe_tratamiento",
    "Nombre del tratamiento": "nombre_tratamiento",
    "Es alergico a algun medicamento": "alergico",
    "Nombre del medico Tratante": "medico_tratante",
    "Tipo de sangre": "tipo_sangre"
  };

  // Safe helper to set input value if element exists
  function setFieldById(id, value) {
    if (!id) return;
    const el = document.getElementById(id);
    if (!el) return;
    el.value = value == null ? '' : String(value);
  }

  // Normalize server keys to the template names used in DB (best-effort)
  function normalizeKey(k){
    if (!k) return k;
    return k.trim();
  }

  // Fill all mapped fields from a returned employee object
  function fillFields(emp){
    // set all mapped keys
    Object.keys(FIELD_MAP).forEach(serverKey => {
      const fieldId = FIELD_MAP[serverKey];
      if (!fieldId) return;
      const val = emp.hasOwnProperty(serverKey) ? emp[serverKey] : (emp[serverKey.replace(/ /g, ' ')] || '');
      setFieldById(fieldId, val);
    });

    // Some DB columns differ in name in templates — handle common alternates:
    setFieldById('iggs', emp['Numero de Afiliación del IGGS'] || emp['Numero de Afiliacion del IGGS'] || emp['Numero IGSS'] || '');
    setFieldById('direccion', emp['Dirección del Domicilio'] || emp['Direccion del Domicilio'] || emp['Dirección'] || '');
    setFieldById('telefono', emp['Numero de Telefono'] || emp['Numero de Telefono'] || emp['Telefono'] || '');
    setFieldById('correo', emp['Correo Electronico'] || emp['Correo'] || '');
    setFieldById('religion', emp['Religión'] || emp['Religion'] || '');
    setFieldById('dias_laborales', emp['Dias Laborales'] || emp['Dias Laborales'] || '');

    // laboral references table: write directly into the cells if present
    const refMap = {
      "Nombre Empresa": emp['Nombre Empresa'] || emp['Nombre de la Empresa (Ultimo Trabajo)'] || '',
      "Dirección Empresa": emp['Dirección Empresa'] || emp['Direccion de la empresa'] || emp['Dirección de la empresa'] || '',
      "Inicio en la empresa": emp['Inicio en la empresa'] || emp['Inicio laboral en la empresa'] || '',
      "Fin en la empresa": emp['Fin en la empresa'] || emp['Fin Laboral en la empresa'] || '',
      "Motivo del retiro": emp['Motivo del retiro'] || '',
      "Nombre del jefe inmediato": emp['Nombre del jefe inmediato'] || emp['Nombre del Jefe Imediato'] || ''
    };
    // find the referencias laborales table and set its first row cells
    const refTable = document.querySelector('table.table.table-sm.table-borderless');
    if (refTable) {
      const tbody = refTable.tBodies[0];
      if (tbody && tbody.rows && tbody.rows[0]) {
        const cells = tbody.rows[0].cells;
        const keys = Object.keys(refMap);
        for (let i=0;i<keys.length;i++){
          if (cells[i]) cells[i].innerText = refMap[keys[i]] || '';
        }
      }
    }

    // Fecha de nacimiento: convert ISO YYYY-MM-DD to DD/MM/YYYY if needed (the template expects DD/MM/YYYY)
    const rawFn = emp['Fecha de nacimiento'] || emp['fecha_nacimiento'] || '';
    if (rawFn && rawFn.indexOf('-') !== -1 && rawFn.length >= 10){
      const d = rawFn.slice(0,10).split('-');
      if (d.length === 3) setFieldById('fecha_nacimiento', `${d[2]}/${d[1]}/${d[0]}`);
      else setFieldById('fecha_nacimiento', rawFn);
    } else setFieldById('fecha_nacimiento', rawFn || '');

    // Otros campos no listed in FIELD_MAP: try to set by direct element id if matches key
    // (safe noop if element not found)
    for (const k in emp) {
      if (!Object.values(FIELD_MAP).includes(k) && typeof k === 'string') {
        const possibleId = k.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g,'');
        const el = document.getElementById(possibleId);
        if (el && el.tagName === 'INPUT') el.value = emp[k] || '';
      }
    }
  }

  // Clear all fields (restore placeholder image)
  function clearAll(){
    // clear mapped inputs
    Object.values(FIELD_MAP).forEach(id => { if (id) setFieldById(id, ''); });
    // clear reference row if present
    const refTable = document.querySelector('table.table.table-sm.table-borderless');
    if (refTable) {
      const tbody = refTable.tBodies[0];
      if (tbody && tbody.rows && tbody.rows[0]) {
        Array.from(tbody.rows[0].cells).forEach(td => td.innerText = '');
      }
    }
    // reset photo
    if (fotoEl) fotoEl.src = placeholder || fotoEl.getAttribute('data-original') || fotoEl.src;
    // reset select
    if (selectEl) selectEl.value = '';
  }

  // Populate select with [{dpi, full_name}]
  async function loadEmpleadoList(){
    if (!selectEl) return;
    try {
      const res = await fetch(apiList, { cache: 'no-store' });
      if (!res.ok) throw new Error('error retrieving list');
      const rows = await res.json();
      // expected rows: [{dpi: '...', full_name:'...'}]
      // clear existing options
      selectEl.innerHTML = '';
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.text = 'Seleccione un empleado...';
      selectEl.appendChild(emptyOpt);
      if (Array.isArray(rows) && rows.length){
        rows.forEach(r => {
          const o = document.createElement('option');
          o.value = r.dpi || r.Numero_de_DPI || r['Numero de DPI'] || r.dpi;
          o.text = (r.full_name || r.fullname || r.Nombre || r.full_name === undefined) ? (r.full_name || ( (r.Nombre||'') + ' ' + (r.Apellidos||'') ).trim() ) : String(o.value);
          selectEl.appendChild(o);
        });
      } else {
        const none = document.createElement('option');
        none.value = '';
        none.text = 'No hay empleados';
        selectEl.appendChild(none);
      }
    } catch (err) {
      console.error('loadEmpleadoList', err);
      selectEl.innerHTML = '';
      const errOpt = document.createElement('option');
      errOpt.value = '';
      errOpt.text = 'Error cargando empleados';
      selectEl.appendChild(errOpt);
    }
  }

  // Fetch full employee by dpi and fill
  async function loadEmpleado(dpi){
    if (!dpi) { clearAll(); return; }
    try {
      // fetch employee data
      const r = await fetch(apiEmpleadoBase + encodeURIComponent(dpi), { cache:'no-store' });
      if (!r.ok) throw new Error('empleado not found');
      const emp = await r.json();
      fillFields(emp);
    } catch (err) {
      console.error('loadEmpleado', err);
      // still try to clear fields and show placeholder
      clearAll();
    }

    // fetch photo
    try {
      const rp = await fetch(apiFotoBase + encodeURIComponent(dpi), { cache: 'no-store' });
      if (!rp.ok) throw new Error('photo fetch error');
      const jp = await rp.json();
      if (jp && jp.url) {
        if (fotoEl) fotoEl.src = `${jp.url}?t=${Date.now()}`;
      } else {
        if (fotoEl) fotoEl.src = placeholder || fotoEl.getAttribute('data-original') || fotoEl.src;
      }
    } catch (err) {
      if (fotoEl) fotoEl.src = placeholder || fotoEl.getAttribute('data-original') || fotoEl.src;
    }
  }

  // Event listeners
  if (selectEl) {
    selectEl.addEventListener('change', function(){
      const dpi = (this.value || '').trim();
      if (!dpi) { clearAll(); return; }
      loadEmpleado(dpi);
    });
  }

  if (btnClear) {
    btnClear.addEventListener('click', function(){
      clearAll();
      // also reset select
      if (selectEl) selectEl.value = '';
    });
  }

  // Initialize: remember original src, load list
  if (fotoEl && !fotoEl.getAttribute('data-original')) {
    fotoEl.setAttribute('data-original', fotoEl.src || placeholder);
  }
  loadEmpleadoList();
})();
</script>


<script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}