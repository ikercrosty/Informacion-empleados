{% extends "layout.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<!-- JUMBOTRON -->
<div class="jumbotron jumbotron-welcome text-center mb-0">
  <div class="container fade-in">
    <h1 class="display-4">Bienvenido a Empaquetex</h1>
    <p class="lead">Panel de control centralizado. Accede rápidamente a planillas o a la información de empleados.</p>
  </div>
  <!-- Curva decorativa inferior -->
  <svg class="wave" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120">
    <path fill="#ffffff" d="M0,64L48,80C96,96,192,128,288,128C384,128,480,96,576,74.7C672,53,768,43,864,64C960,85,1056,139,1152,160C1248,181,1344,171,1392,165.3L1440,160L1440,0L0,0Z"></path>
  </svg>
</div>

<!-- SECCIÓN DE ACCIONES -->
<section class="welcome-actions d-flex align-items-center">
  <div class="actions-inner container slide-up">
    <div class="row justify-content-center">
      <div class="col-12 col-md-5">
        <div class="action-card shadow-sm text-center">
          <div class="icon-wrap mb-3 icon-clipboard" aria-hidden="true">
            <i class="fas fa-clipboard-list fa-2x"></i>
          </div>
          <h5 class="mb-2">Planillas</h5>
          <p class="text-muted mb-3">Abrir y administrar planillas de pago; generar reportes y descargar comprobantes.</p>
          <a href="{{ url_for('planilla') }}" class="btn btn-outline-warning btn-block btn-lg action-btn" role="button">
            <i class="fas fa-file-alt mr-2" aria-hidden="true"></i> Ir a Planillas
          </a>
        </div>
      </div>

      <div class="col-12 col-md-5">
        <div class="action-card shadow-sm text-center">
          <div class="icon-wrap mb-3 icon-id" aria-hidden="true">
            <i class="fas fa-id-badge fa-2x"></i>
          </div>
          <h5 class="mb-2">Información de empleados</h5>
          <p class="text-muted mb-3">Ver y editar fichas, subir fotografías y consultar el historial completo por empleado.</p>
          <a href="{{ url_for('empleados') }}" id="btnAbrirInfo" class="btn btn-primary btn-block btn-lg action-btn action-btn-blue" role="button">
            <i class="fas fa-users mr-2" aria-hidden="true"></i> Abrir información empleados
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- BOTON DE ACCION FLOTANTE: Consultar tabla Usuarios -->
<button id="fabUsuarios" class="fab d-none" title="Consultar Usuarios" aria-label="Consultar Usuarios" aria-haspopup="dialog" aria-controls="modalUsuarios" aria-expanded="false">
  <i class="fas fa-user-cog" aria-hidden="true"></i>
</button>

<!-- Modal (se muestra como panel sobre FAB gracias a CSS) -->
<div class="modal fade" id="modalUsuarios" tabindex="-1" role="dialog" aria-labelledby="modalUsuariosLabel" aria-hidden="true">
  <div class="modal-dialog modal-panel" role="document"> <!-- class modal-panel mejora el posicionamiento -->
    <div class="modal-content" role="document">
      <div class="modal-header align-items-center">
        <h5 class="modal-title" id="modalUsuariosLabel">Usuarios</h5>
        <div class="modal-actions d-flex align-items-center">
          <button type="button" class="btn btn-sm btn-outline-secondary mr-2 d-none" id="usuariosRetry">Reintentar</button>
          <button type="button" class="close ml-0" data-dismiss="modal" aria-label="Cerrar" id="modalCloseBtn">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      </div>

      <div class="modal-body" id="modalUsuariosBody">
        <div id="usuariosLoading" class="usuarios-loading text-center py-3" aria-live="polite">
          <div class="spinner"></div>
          <div class="mt-2">Cargando usuarios...</div>
        </div>

        <div id="usuariosError" class="alert alert-danger d-none my-2" role="alert" aria-live="assertive"></div>

        <!-- PANEL DE TARJETAS pegado sobre el FAB -->
        <div class="users-grid-panel d-none" id="usuariosCards" role="region" aria-label="Lista de usuarios">
          <!-- Las tarjetas se insertan aquí dinámicamente -->
        </div>

        <div class="text-center d-none" id="usuariosEmptyMessage" aria-live="polite">
          <p class="text-muted mb-0">No se encontraron usuarios.</p>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnCerrarModal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- ESTILOS -->
<style>
/* Jumbotron - diseño actualizado y optimizado para reemplazo directo */
.jumbotron-welcome {
  position: relative;
  background: linear-gradient(180deg, #eef6ff 0%, #f7fbff 60%);
  padding: 3.6rem 1rem 4.4rem;
  margin-bottom: 0;
  border-radius: 0 0 30px 30px;
  box-shadow: 0 12px 36px rgba(6, 24, 45, 0.06);
  overflow: hidden;
  color: #0f1724;
  -webkit-backdrop-filter: blur(2px);
  backdrop-filter: blur(2px);
}

/* Contenido central dentro del jumbotron */
.jumbotron-welcome .container {
  max-width: 980px;
  margin: 0 auto;
  padding-left: 1rem;
  padding-right: 1rem;
}
.jumbotron-welcome h1 {
  font-weight: 700;
  color: #0b2540;
  margin-bottom: .35rem;
  font-size: 2.15rem;
  letter-spacing: -0.02em;
}
.jumbotron-welcome p.lead {
  color: #405266;
  font-size: 1.02rem;
  margin-bottom: 0;
  max-width: 820px;
  margin-left: auto;
  margin-right: auto;
}

/* Decorative wave placement */
.jumbotron-welcome .wave {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: auto;
  pointer-events: none;
  transform: translateZ(0);
  opacity: 0.98;
}

/* Subtle accent shape (non-intrusive decorative blob) */
.jumbotron-welcome::after {
  content: "";
  position: absolute;
  right: -10%;
  top: 8%;
  width: 320px;
  height: 320px;
  background: radial-gradient(circle at 30% 30%, rgba(30,88,165,0.10), rgba(30,88,165,0.03) 40%, transparent 60%);
  border-radius: 50%;
  pointer-events: none;
  transform: translate3d(0,0,0);
}

/* Actions */
.action-card { border-radius: 12px; padding: 1.6rem; transition: transform .18s ease, box-shadow .18s ease; }
.action-card:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(2,6,23,0.06); }

/* Icons */
.icon-clipboard { background: linear-gradient(180deg,#ffb74d,#ff9800); }
.icon-id { background: linear-gradient(180deg,#42a5f5,#1e88e5); }

/* FAB */
.fab {
  position: fixed;
  right: 22px;
  bottom: 22px;
  width: 62px;
  height: 62px;
  border-radius: 50%;
  background: linear-gradient(180deg,#1e88e5,#1565d8);
  color: #fff;
  border: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 14px 40px rgba(21,101,192,0.18);
  cursor: pointer;
  z-index: 1200;
  transition: transform .15s ease, box-shadow .15s ease;
  font-size: 1.15rem;
}
.fab:hover { transform: translateY(-4px); box-shadow: 0 20px 48px rgba(21,101,192,0.22); }

/* Make the modal act like a compact panel above the FAB */
.modal-dialog.modal-panel {
  margin: 0;
  position: fixed;
  right: 22px;
  bottom: 96px; /* sits above the FAB */
  width: 360px;
  max-width: calc(100% - 40px);
  transform: translateY(6px);
  z-index: 1150;
}
.modal.fade .modal-dialog.modal-panel {
  transition: transform .18s ease, opacity .18s ease;
}
.modal.show .modal-dialog.modal-panel {
  transform: translateY(0);
}

/* Modal content: compact, rounded, subtle shadow */
.modal-content {
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 12px 34px rgba(2,6,23,0.12);
  border: 1px solid rgba(2,6,23,0.04);
}

/* Header / Footer tweaks */
.modal-header { border-bottom: none; padding: .6rem .8rem; }
.modal-footer { border-top: none; padding: .6rem .8rem; }
.modal-title { font-weight: 600; color: #102a43; margin: 0; }

/* Loading spinner */
.usuarios-loading { display:flex; flex-direction:column; align-items:center; justify-content:center; padding: 14px 0; }
.spinner {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 4px solid rgba(30,88,165,0.12);
  border-top-color: #1e88e5;
  animation: spin .9s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Panel for users (compact cards) */
.users-grid-panel {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  padding: 8px;
  max-height: 48vh;
  overflow: auto;
}

/* A single user card: wider, clearer typography and wrapping email */
.user-card {
  display: grid;
  grid-template-columns: 56px 1fr auto;
  gap: 12px;
  align-items: center;
  background: linear-gradient(180deg, #ffffff, #fbfdff);
  border-radius: 10px;
  padding: 10px;
  box-shadow: none;
  border: 1px solid rgba(10,20,40,0.04);
}
.user-avatar {
  width: 56px;
  height: 56px;
  border-radius: 10px;
  background: linear-gradient(180deg,#eef7ff,#dfefff);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  color:#0f1724;
  font-size:1rem;
  flex-shrink:0;
  overflow:hidden;
}
.user-info { min-width:0; }
.user-name { font-weight:700; color:#102a43; margin:0; font-size:0.96rem; line-height:1.05; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.user-email { margin:0; font-size:0.82rem; color:#556070; overflow-wrap: anywhere; max-width: 220px; }

/* Controls area */
.user-controls { display:flex; gap:8px; align-items:center; margin-left:8px; }
.rol-select { min-width:120px; padding: .28rem .4rem; border-radius: .35rem; border: 1px solid rgba(2,6,23,0.06); background:#fff; font-size: .88rem; }

/* Clear visible focus outlines for select but keep accessible ring */
.rol-select:focus { outline: 3px solid rgba(30,88,165,0.12); }

/* Error / empty states */
#usuariosEmptyMessage { padding: 18px 0; }
#usuariosError { margin-top: 8px; }

/* Responsive adjustments */
@media (max-width: 520px) {
  .modal-dialog.modal-panel { right: 12px; bottom: 80px; width: calc(100% - 24px); }
  .user-email { max-width: 140px; font-size: 0.78rem; }
  .rol-select { min-width: 100px; font-size: 0.82rem; }
  .fab { right: 14px; bottom: 14px; width: 56px; height: 56px; }
}
</style>

<!-- SCRIPTS: comportamiento del FAB - consulta tabla Usuarios y edición de rol
     NOTA: lógica sin cambios importantes, solo DOM insertion adaptado a tarjetas -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const fab = document.getElementById('fabUsuarios');
  const modalEl = document.getElementById('modalUsuarios');
  const usuariosLoading = document.getElementById('usuariosLoading');
  const usuariosError = document.getElementById('usuariosError');
  const usuariosCards = document.getElementById('usuariosCards');
  const usuariosEmpty = document.getElementById('usuariosEmptyMessage');
  const usuariosRetry = document.getElementById('usuariosRetry');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const btnCerrarModal = document.getElementById('btnCerrarModal');

  // Mantén la misma configuración de PRINCIPAL_ADMINS para no tocar lógica de visibilidad
  const PRINCIPAL_ADMINS = ['1','2']; // Ej: ['admin1','admin2'] o [] para que cualquier admin lo vea

  let currentUser = null; // { usuario, rol }
  let loading = false;
  let abortController = null;

  async function fetchWhoami(){
    try {
      const r = await fetch('/whoami', { cache: 'no-store' });
      if (!r.ok) return null;
      const j = await r.json();
      return { usuario: String(j.usuario || ''), rol: String(j.rol || '').toLowerCase() };
    } catch (e) {
      return null;
    }
  }

  async function initFabVisibility(){
    currentUser = await fetchWhoami();
    if (!currentUser) { fab.classList.add('d-none'); return; }
    const isAdminRole = (currentUser.rol === 'admin' || currentUser.rol === 'superadmin');
    if (!isAdminRole) { fab.classList.add('d-none'); return; }

    if (Array.isArray(PRINCIPAL_ADMINS) && PRINCIPAL_ADMINS.length === 2) {
      if (PRINCIPAL_ADMINS.includes(currentUser.usuario)) fab.classList.remove('d-none');
      else fab.classList.add('d-none');
    } else {
      fab.classList.remove('d-none');
    }
  }

  function showModal() {
    if (typeof $ === 'function' && typeof $.fn.modal === 'function') {
      $('#modalUsuarios').modal({ backdrop: 'static', keyboard: false });
    } else {
      modalEl.classList.add('show'); modalEl.style.display = 'block'; modalEl.setAttribute('aria-hidden','false');
      document.addEventListener('keydown', fallbackEsc);
    }
  }
  function hideModal(){
    if (typeof $ === 'function' && typeof $.fn.modal === 'function') $('#modalUsuarios').modal('hide');
    else { modalEl.classList.remove('show'); modalEl.style.display='none'; modalEl.setAttribute('aria-hidden','true'); document.removeEventListener('keydown', fallbackEsc); }
  }
  function fallbackEsc(e){ if (e.key === 'Escape') hideModal(); }

  if (modalCloseBtn) modalCloseBtn.addEventListener('click', hideModal);
  if (btnCerrarModal) btnCerrarModal.addEventListener('click', hideModal);

  fab && fab.addEventListener('click', function () { fab.setAttribute('aria-expanded','true'); showModal(); loadUsuarios(); });
  if (typeof $ === 'function' && typeof $.fn.modal === 'function') {
    $('#modalUsuarios').on('hidden.bs.modal', function () { fab && fab.setAttribute('aria-expanded','false'); });
  }
  usuariosRetry && usuariosRetry.addEventListener('click', function(){ usuariosRetry.classList.add('d-none'); loadUsuarios(); });

  async function loadUsuarios(){
    if (loading) return;
    loading = true;
    usuariosError.classList.add('d-none');
    usuariosCards.classList.add('d-none');
    usuariosEmpty.classList.add('d-none');
    usuariosLoading.classList.remove('d-none');
    usuariosCards.innerHTML = '';

    abortController && abortController.abort();
    abortController = new AbortController();
    const signal = abortController.signal;
    const TIMEOUT_MS = 8000;
    const timeoutId = setTimeout(()=> abortController && abortController.abort(), TIMEOUT_MS);

    try {
      const res = await fetch('/api/usuarios', { cache: 'no-store', signal });
      clearTimeout(timeoutId);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const sessionName = currentUser ? String(currentUser.usuario) : null;

      const filtered = Array.isArray(data) ? data.filter(u => {
        const name = String(u.username || u.Usuarios || u.usuario || '');
        if (sessionName && name && name === sessionName) return false;
        if (Array.isArray(PRINCIPAL_ADMINS) && PRINCIPAL_ADMINS.length >= 1) {
          if (name && PRINCIPAL_ADMINS.includes(name)) return false;
        }
        return true;
      }) : [];

      if (!filtered.length) {
        usuariosLoading.classList.add('d-none');
        usuariosEmpty.classList.remove('d-none');
        usuariosRetry.classList.remove('d-none');
        loading = false;
        return;
      }

      // Crear tarjetas visuales por usuario (no alterar la lógica de cambios de rol)
      filtered.forEach((u, idx) => {
        const username = u.username || u.Usuarios || '';
        const email = u.email || u['Correo Electronico'] || '';
        const roleCurrent = (u.role || u.rol || '').toString().toLowerCase();

        const card = document.createElement('div');
        card.className = 'user-card';
        card.setAttribute('data-username', username);

        const avatar = document.createElement('div');
        avatar.className = 'user-avatar';
        const initials = (username || email || '').toString().trim().split(/\s+/).slice(0,2).map(s => s[0] ? s[0].toUpperCase() : '').join('');
        avatar.textContent = initials || 'U';

        const info = document.createElement('div');
        info.className = 'user-info';
        const nameEl = document.createElement('p');
        nameEl.className = 'user-name';
        nameEl.textContent = username || '(sin usuario)';
        const emailEl = document.createElement('p');
        emailEl.className = 'user-email';
        emailEl.textContent = email || '';
        info.appendChild(nameEl);
        info.appendChild(emailEl);

        const controls = document.createElement('div');
        controls.className = 'user-controls';

        const select = document.createElement('select');
        select.className = 'rol-select form-control form-control-sm';
        const roles = ['admin','colaborador'];
        roles.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r; opt.text = r.charAt(0).toUpperCase() + r.slice(1);
          if (r === roleCurrent) opt.selected = true;
          select.appendChild(opt);
        });

        if (!(currentUser && (currentUser.rol === 'admin' || currentUser.rol === 'superadmin'))) {
          select.setAttribute('disabled','disabled');
        } else {
          select.addEventListener('change', async function () {
            const newRole = this.value;
            const prev = roleCurrent;
            try {
              const payload = { usuario: username, rol: newRole };
              const r = await fetch('/api/usuarios/rol', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                cache: 'no-store'
              });
              if (!r.ok) {
                const text = await r.text().catch(()=>null);
                throw new Error('HTTP ' + r.status + (text ? ' - ' + text : ''));
              }
            } catch (err) {
              this.value = prev;
              alert('Error cambiando rol: ' + (err && err.message ? err.message : 'desconocido'));
              console.error('Error cambiando rol', err);
            }
          });
        }

        controls.appendChild(select);

        card.appendChild(avatar);
        card.appendChild(info);
        card.appendChild(controls);

        usuariosCards.appendChild(card);
      });

      usuariosLoading.classList.add('d-none');
      usuariosCards.classList.remove('d-none');
      usuariosRetry.classList.add('d-none');
    } catch (err) {
      clearTimeout(timeoutId);
      usuariosLoading.classList.add('d-none');
      usuariosCards.classList.add('d-none');
      const isAbort = err && (err.name === 'AbortError');
      usuariosError.textContent = isAbort ? 'La solicitud tardó demasiado.' : 'Error al cargar usuarios: ' + (err && err.message ? err.message : 'desconocido');
      usuariosError.classList.remove('d-none');
      usuariosRetry.classList.remove('d-none');
      console.error('Error cargando /api/usuarios', err);
    } finally {
      loading = false;
      abortController = null;
    }
  }

  initFabVisibility();
});
</script>

{% endblock %}
