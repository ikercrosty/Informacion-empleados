{% extends "layout.html" %}
{% block title %}Menu{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand font-weight-bold" href="{{ url_for('index') }}">Empaquetex</a>
    <div class="d-flex align-items-center">
      <span class="mr-3 small text-muted">Bienvenido</span>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">Cerrar sesión</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <!-- existing page content placeholder (no logic moved) -->
  {% block main_content %}
  <!-- Your page content goes here -->
  {% endblock %}
</div>

<!-- Floating Action Button + Mini Panel -->
<!--
  Reemplaza este archivo completo en VS Code. Esta implementación:
  - Muestra un FAB en la esquina inferior derecha.
  - Al hacer click abre un mini panel con la lista de usuarios (nombre + rol).
  - Permite alternar rol colaborador <-> administrador.
  - La opción para cambiar roles solo se muestra si el endpoint /whoami devuelve
    un objeto donde `principal === true` (el administrador "principal").
  - Las llamadas de actualización usan PATCH /api/usuario/<id>/rol (ajustar endpoint si su API difiere).
  - No altera la lógica existente del resto de la app.
-->

<!-- FAB -->
<button id="fabUsuarios" class="fab btn btn-primary" title="Usuarios">
  <i class="fas fa-user-friends"></i>
</button>

<!-- Mini panel -->
<div id="panelUsuarios" class="panel-usuarios shadow-sm" aria-hidden="true" role="dialog" aria-label="Panel de usuarios">
  <div class="panel-header d-flex align-items-center justify-content-between">
    <strong>Usuarios registrados</strong>
    <button id="closePanel" class="btn btn-sm btn-light" aria-label="Cerrar panel">&times;</button>
  </div>

  <div id="usuariosLoading" class="p-3 text-center text-muted small">Cargando...</div>

  <div id="usuariosList" class="usuarios-list p-2" style="display:none;">
    <!-- Lista poblada por JS -->
  </div>

  <div class="panel-footer p-2 text-center small text-muted">
    <span id="panelNotice">Solo el administrador principal puede cambiar roles desde aquí.</span>
  </div>
</div>

<style>
/* FAB style */
.fab {
  position: fixed;
  right: 18px;
  bottom: 18px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  z-index: 1050;
  box-shadow: 0 8px 20px rgba(11,114,133,0.18);
  font-size: 18px;
}

/* Panel style */
.panel-usuarios {
  position: fixed;
  right: 18px;
  bottom: 86px;
  width: 320px;
  max-height: 60vh;
  overflow: auto;
  background: #fff;
  border-radius: 10px;
  z-index: 1050;
  border: 1px solid rgba(11,19,30,0.06);
  box-shadow: 0 20px 40px rgba(11,50,80,0.08);
  display: none;
}

.panel-header {
  padding: 10px 12px;
  border-bottom: 1px solid rgba(11,19,30,0.04);
  background: linear-gradient(90deg,#f8fafc,#ffffff);
  border-radius: 10px 10px 0 0;
}

.panel-footer {
  border-top: 1px solid rgba(11,19,30,0.04);
  border-radius: 0 0 10px 10px;
  background: #fafafa;
}

/* User row */
.usuario-row {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:10px;
  border-radius:6px;
  transition: background .12s;
}
.usuario-row + .usuario-row { margin-top:6px; }
.usuario-row:hover { background: #f6fbff; }

.usuario-meta {
  display:flex;
  flex-direction:column;
  min-width: 0;
}
.usuario-nombre {
  font-weight:700;
  font-size:0.95rem;
  color:#0b2733;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.usuario-rol {
  font-size:0.82rem;
  color:#556977;
}

/* Toggle button small */
.btn-role {
  min-width: 110px;
  white-space:nowrap;
  font-weight:700;
}

/* Disabled hint */
.hint-disabled {
  color: #8b94a2;
  font-size: 0.85rem;
  margin-top:8px;
}

/* Small screens */
@media (max-width:420px){
  .panel-usuarios { width: calc(100% - 36px); right: 18px; left: 18px; bottom: 86px; }
  .fab { right: 18px; bottom: 18px; }
}
</style>

<script>
/* Panel users logic
   - Fetches /api/usuarios (array of users with id, nombre, rol) to list users.
   - Fetches /whoami to know current user and `principal` flag.
   - If current user is principal admin (whoami.principal === true), show role-change controls.
   - Calls PATCH /api/usuario/<id>/rol with { rol: 'admin'|'colaborador' } to update role.
   - Adjust endpoints to match your backend if different.
*/

(function () {
  const fab = document.getElementById('fabUsuarios');
  const panel = document.getElementById('panelUsuarios');
  const closeBtn = document.getElementById('closePanel');
  const listEl = document.getElementById('usuariosList');
  const loading = document.getElementById('usuariosLoading');
  const panelNotice = document.getElementById('panelNotice');

  let currentUser = null; // { username, rol, principal: true|false, id? }
  let usersCache = [];

  function togglePanel(show) {
    if (typeof show === 'undefined') show = panel.style.display !== 'block';
    panel.style.display = show ? 'block' : 'none';
    panel.setAttribute('aria-hidden', show ? 'false' : 'true');
    if (show) refreshUsers();
  }

  fab.addEventListener('click', function () {
    togglePanel();
  });
  closeBtn.addEventListener('click', function () {
    togglePanel(false);
  });

  // Keyboard: ESC closes panel
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape' && panel.style.display === 'block') togglePanel(false);
  });

  async function whoami() {
    try {
      const r = await fetch('/whoami', { cache: 'no-store' });
      if (!r.ok) return null;
      const j = await r.json();
      return j;
    } catch (e) {
      console.warn('whoami error', e);
      return null;
    }
  }

  async function fetchUsuarios() {
    try {
      const r = await fetch('/api/usuarios', { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      if (!Array.isArray(j)) return [];
      return j;
    } catch (e) {
      console.warn('fetch usuarios error', e);
      return [];
    }
  }

  function renderEmptyState() {
    listEl.innerHTML = '<div class="p-3 text-center text-muted small">No se encontraron usuarios.</div>';
    loading.style.display = 'none';
    listEl.style.display = '';
  }

  function createUserRow(user, canToggle, isSelfPrincipal) {
    const row = document.createElement('div');
    row.className = 'usuario-row';

    const meta = document.createElement('div');
    meta.className = 'usuario-meta';
    const name = document.createElement('div');
    name.className = 'usuario-nombre';
    name.textContent = user.nombre || user.nombre_completo || user.full_name || user.username || ('Usuario ' + (user.id || ''));
    const role = document.createElement('div');
    role.className = 'usuario-rol';
    role.textContent = (user.rol || 'colaborador').toUpperCase();

    meta.appendChild(name);
    meta.appendChild(role);
    row.appendChild(meta);

    const controls = document.createElement('div');

    // If user has id and we can toggle roles, show toggle
    if (canToggle && user.id !== undefined && user.id !== null) {
      const btn = document.createElement('button');
      btn.className = 'btn btn-sm btn-role ' + ( (user.rol === 'admin') ? 'btn-outline-warning' : 'btn-outline-primary' );
      btn.textContent = (user.rol === 'admin') ? 'Administrador' : 'Colaborador';
      btn.setAttribute('data-user-id', user.id);
      btn.disabled = false;

      btn.addEventListener('click', async function () {
        const targetRol = (user.rol === 'admin') ? 'colaborador' : 'admin';

        // Confirm only when demoting an admin (safety)
        if (user.rol === 'admin' && !confirm('Confirmar cambiar a colaborador a ' + (user.nombre || user.username || user.id) + '?')) return;

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        try {
          // PATCH endpoint; change if your API expects PUT or POST
          const res = await fetch('/api/usuario/' + encodeURIComponent(user.id) + '/rol', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rol: targetRol })
          });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const upd = await res.json();

          // accept server response role or fallback to targetRol
          user.rol = (upd && upd.rol) ? upd.rol : targetRol;

          // update UI
          role.textContent = user.rol.toUpperCase();
          btn.className = 'btn btn-sm btn-role ' + ( (user.rol === 'admin') ? 'btn-outline-warning' : 'btn-outline-primary' );
          btn.textContent = (user.rol === 'admin') ? 'Administrador' : 'Colaborador';
        } catch (err) {
          console.error('update role error', err);
          alert('Error actualizando rol. Ver consola para detalles.');
        } finally {
          btn.disabled = false;
        }
      });

      controls.appendChild(btn);
    } else {
      // show role badge only
      const badge = document.createElement('span');
      badge.className = 'badge badge-light';
      badge.style.fontWeight = '700';
      badge.textContent = (user.rol || 'colaborador').toUpperCase();
      controls.appendChild(badge);
    }

    row.appendChild(controls);
    return row;
  }

  async function refreshUsers() {
    loading.style.display = '';
    listEl.style.display = 'none';
    listEl.innerHTML = '';

    // Ensure we know current user before rendering; principal property required
    currentUser = await whoami();
    // server should return { rol: 'admin'|'colaborador', username: 'x', principal: true|false }
    const isPrincipal = !!(currentUser && currentUser.principal === true);

    try {
      usersCache = await fetchUsuarios();
    } catch (e) {
      usersCache = [];
    }

    loading.style.display = 'none';
    if (!Array.isArray(usersCache) || usersCache.length === 0) {
      renderEmptyState();
      return;
    }

    // Render users sorted: admins first, then collaborators
    usersCache.sort((a,b) => {
      const ra = (a.rol === 'admin') ? 0 : 1;
      const rb = (b.rol === 'admin') ? 0 : 1;
      if (ra !== rb) return ra - rb;
      const na = (a.nombre || a.full_name || a.username || '') .toLowerCase();
      const nb = (b.nombre || b.full_name || b.username || '') .toLowerCase();
      return na < nb ? -1 : na > nb ? 1 : 0;
    });

    listEl.innerHTML = '';
    for (const u of usersCache) {
      const canToggle = isPrincipal && (currentUser.username !== (u.username || u.nombre || u.id));
      // Important: principal can change others' roles; avoid allowing principal to toggle their own principal status here.
      const row = createUserRow(u, canToggle, isPrincipal);
      listEl.appendChild(row);
    }

    // If user is not principal, show a hint and hide controls
    if (!isPrincipal) {
      panelNotice.textContent = 'No tienes permisos para cambiar roles desde este panel.';
    } else {
      panelNotice.textContent = 'Eres administrador principal. Puedes cambiar roles desde aquí.';
    }

    listEl.style.display = '';
  }

  // Initial whoami check (silently) to determine if FAB should be shown at all
  (async function initFabVisibility() {
    const who = await whoami();
    const showFab = !!who; // keep FAB visible to everyone who is logged in; hide if unauthenticated
    // If you want to hide FAB from non-admins entirely, change condition to: (who && who.rol === 'admin')
    if (!showFab) {
      fab.style.display = 'none';
    }
  })();

  // Public: allow programmatic open from other code if needed
  window.EmpaquetexUsuariosPanel = {
    open: () => togglePanel(true),
    close: () => togglePanel(false),
    refresh: () => refreshUsers()
  };

  // Close panel when clicking outside
  document.addEventListener('click', function (e) {
    if (!panel) return;
    if (panel.style.display !== 'block') return;
    const isClickInside = panel.contains(e.target) || fab.contains(e.target);
    if (!isClickInside) togglePanel(false);
  });
})();
</script>
{% endblock %}
