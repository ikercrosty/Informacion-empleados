{% extends "layout.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<!-- JUMBOTRON -->
<div class="jumbotron jumbotron-welcome text-center mb-0">
  <div class="container fade-in">
    <h1 class="display-4">Bienvenido a Empaquetex</h1>
    <p class="lead">Panel de control centralizado. Accede rápidamente a planillas o a la información de empleados.</p>
  </div>
  <!-- Curva decorativa inferior -->
  <svg class="wave" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120">
    <path fill="#ffffff" d="M0,64L48,80C96,96,192,128,288,128C384,128,480,96,576,74.7C672,53,768,43,864,64C960,85,1056,139,1152,160C1248,181,1344,171,1392,165.3L1440,160L1440,0L0,0Z"></path>
  </svg>
</div>

<!-- SECCIÓN DE ACCIONES -->
<section class="welcome-actions d-flex align-items-center">
  <div class="actions-inner container slide-up">
    <div class="row justify-content-center">
      <div class="col-12 col-md-5">
        <div class="action-card shadow-sm text-center">
          <div class="icon-wrap mb-3 icon-clipboard" aria-hidden="true">
            <i class="fas fa-clipboard-list fa-2x"></i>
          </div>
          <h5 class="mb-2">Planillas</h5>
          <p class="text-muted mb-3">Abrir y administrar planillas de pago; generar reportes y descargar comprobantes.</p>
          <a href="{{ url_for('planilla') }}" class="btn btn-outline-warning btn-block btn-lg action-btn" role="button">
            <i class="fas fa-file-alt mr-2" aria-hidden="true"></i> Ir a Planillas
          </a>
        </div>
      </div>

      <div class="col-12 col-md-5">
        <div class="action-card shadow-sm text-center">
          <div class="icon-wrap mb-3 icon-id" aria-hidden="true">
            <i class="fas fa-id-badge fa-2x"></i>
          </div>
          <h5 class="mb-2">Información de empleados</h5>
          <p class="text-muted mb-3">Ver y editar fichas, subir fotografías y consultar el historial completo por empleado.</p>
          <a href="{{ url_for('empleados') }}" id="btnAbrirInfo" class="btn btn-primary btn-block btn-lg action-btn action-btn-blue" role="button">
            <i class="fas fa-users mr-2" aria-hidden="true"></i> Abrir información empleados
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- BOTON DE ACCION FLOTANTE: Consultar tabla Usuarios -->
<button id="fabUsuarios" class="fab d-none" title="Consultar Usuarios" aria-label="Consultar Usuarios" aria-haspopup="dialog" aria-controls="modalUsuarios" aria-expanded="false">
  <i class="fas fa-user-cog" aria-hidden="true"></i>
</button>

<!-- Modal para mostrar lista de Usuarios (se abre con el FAB) -->
<div class="modal fade" id="modalUsuarios" tabindex="-1" role="dialog" aria-labelledby="modalUsuariosLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content" role="document">
      <div class="modal-header">
        <h5 class="modal-title" id="modalUsuariosLabel">Usuarios (tabla Usuarios)</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar" id="modalCloseBtn">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalUsuariosBody">
        <div id="usuariosLoading" class="text-center py-3" aria-live="polite">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span class="sr-only">Cargando usuarios...</span>
          <div class="mt-2">Cargando usuarios...</div>
        </div>
        <div id="usuariosError" class="alert alert-danger d-none" role="alert" aria-live="assertive"></div>

        <div class="table-responsive d-none" id="usuariosTableWrap" role="region" aria-label="Tabla de usuarios">
          <table class="table table-sm table-hover" id="usuariosTable">
            <thead class="thead-light">
              <tr>
                <th scope="col">Usuario</th>
                <th scope="col">Correo</th>
                <th scope="col">Rol</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="text-center d-none" id="usuariosEmptyMessage" aria-live="polite">
          <p class="text-muted">No se encontraron usuarios.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button id="usuariosRetry" type="button" class="btn btn-outline-primary d-none">Reintentar</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnCerrarModal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- ESTILOS -->
<style>
/* Jumbotron */
.jumbotron-welcome {
  position: relative;
  background-color: #f5f7fa;
  padding: 3rem 1rem 4rem;
  margin-bottom: 0;
  border-radius: 0 0 30px 30px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  overflow: hidden;
}
.jumbotron-welcome h1,
.jumbotron-welcome p {
  color: #212529;
}
.jumbotron-welcome .wave {
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: auto;
}

/* Reducir espacio entre jumbotron y tarjetas */
.welcome-actions {
  padding-top: 1rem;
  padding-bottom: 2rem;
}

/* Animaciones */
.fade-in { animation: fadeIn 1s ease-in-out; }
.slide-up { animation: slideUp 1s ease forwards; opacity: 0; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

/* Iconos */
.icon-clipboard {
  background: #ff9800;
  color: #fff;
  border-radius: 50%;
  width: 70px;
  height: 70px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin: 0 auto;
}
.icon-id {
  background: #1e88e5;
  color: #fff;
  border-radius: 50%;
  width: 70px;
  height: 70px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin: 0 auto;
}

/* Floating action button (FAB) */
.fab {
  position: fixed;
  right: 22px;
  bottom: 22px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(180deg,#1e88e5,#1565d8);
  color: #fff;
  border: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 24px rgba(21,101,192,0.18);
  cursor: pointer;
  z-index: 1050;
  transition: transform .15s ease, box-shadow .15s ease;
}
.fab:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(21,101,192,0.22); }
.fab:active { transform: translateY(-1px); }
.fab:focus { outline: 3px solid rgba(21,101,192,0.18); }

/* Modal table styling minor adjustments */
#usuariosTable th, #usuariosTable td { vertical-align: middle; font-size: .95rem; }

/* Small responsive tweak to avoid cover by mobile UI */
@media (max-width: 480px) {
  .fab { right: 14px; bottom: 14px; width: 52px; height: 52px; }
}

/* Spinner center */
#usuariosLoading { display: flex; flex-direction: column; align-items: center; justify-content: center; }

/* Hide table wrap when empty */
#usuariosTableWrap { max-height: 50vh; overflow: auto; }

/* Visually hide element but keep for screen readers */
.sr-only { position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important; margin: -1px !important; overflow: hidden !important; clip: rect(0,0,0,0) !important; white-space: nowrap !important; border: 0 !important; }

/* Small select styling inside table */
.rol-select {
  min-width: 140px;
  padding: .25rem .4rem;
  border-radius: .25rem;
  border: 1px solid rgba(0,0,0,0.08);
}
</style>

<!-- SCRIPTS: comportamiento del FAB - consulta tabla Usuarios y edición de rol -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const fab = document.getElementById('fabUsuarios');
  const modalEl = document.getElementById('modalUsuarios');
  const usuariosLoading = document.getElementById('usuariosLoading');
  const usuariosError = document.getElementById('usuariosError');
  const usuariosTableWrap = document.getElementById('usuariosTableWrap');
  const usuariosTableBody = document.querySelector('#usuariosTable tbody');
  const usuariosEmpty = document.getElementById('usuariosEmptyMessage');
  const usuariosRetry = document.getElementById('usuariosRetry');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const btnCerrarModal = document.getElementById('btnCerrarModal');

  // Si quieres dos admins "principales" fijos en frontend, pon sus usernames exactos aquí.
  // Si no los quieres hardcodear, puedes eliminar esta comprobación y mostrar FAB a cualquier admin.
  const PRINCIPAL_ADMINS = ['admin1', 'admin2']; // reemplaza por tus dos usuarios exactos o deja [] para no usarlo

  let currentUser = null; // { usuario, rol }
  let loading = false;
  let abortController = null;

  async function fetchWhoami(){
    try {
      const r = await fetch('/whoami', { cache: 'no-store' });
      if (!r.ok) return null;
      const j = await r.json();
      return { usuario: String(j.usuario || ''), rol: String(j.rol || '').toLowerCase() };
    } catch (e) {
      return null;
    }
  }

  async function initFabVisibility(){
    currentUser = await fetchWhoami();
    if (!currentUser) { fab.classList.add('d-none'); return; }
    // mostrar FAB si rol es admin o superadmin AND (si PRINCIPAL_ADMINS no está vacío) si es uno de los dos principales
    const isAdminRole = (currentUser.rol === 'admin' || currentUser.rol === 'superadmin');
    if (!isAdminRole) { fab.classList.add('d-none'); return; }
    if (Array.isArray(PRINCIPAL_ADMINS) && PRINCIPAL_ADMINS.length === 2) {
      if (PRINCIPAL_ADMINS.includes(currentUser.usuario)) fab.classList.remove('d-none');
      else fab.classList.add('d-none');
    } else {
      // si no se definieron los dos admins principales, mostramos FAB a cualquier admin
      fab.classList.remove('d-none');
    }
  }

  function showModal() {
    if (typeof $ === 'function' && typeof $.fn.modal === 'function') {
      $('#modalUsuarios').modal({ backdrop: 'static', keyboard: false });
    } else {
      modalEl.classList.add('show'); modalEl.style.display = 'block'; modalEl.setAttribute('aria-hidden','false');
      document.addEventListener('keydown', fallbackEsc);
    }
  }
  function hideModal(){
    if (typeof $ === 'function' && typeof $.fn.modal === 'function') $('#modalUsuarios').modal('hide');
    else { modalEl.classList.remove('show'); modalEl.style.display='none'; modalEl.setAttribute('aria-hidden','true'); document.removeEventListener('keydown', fallbackEsc); }
  }
  function fallbackEsc(e){ if (e.key === 'Escape') hideModal(); }

  if (modalCloseBtn) modalCloseBtn.addEventListener('click', hideModal);
  if (btnCerrarModal) btnCerrarModal.addEventListener('click', hideModal);

  fab && fab.addEventListener('click', function () { fab.setAttribute('aria-expanded','true'); showModal(); loadUsuarios(); });
  if (typeof $ === 'function' && typeof $.fn.modal === 'function') {
    $('#modalUsuarios').on('hidden.bs.modal', function () { fab && fab.setAttribute('aria-expanded','false'); });
  }
  usuariosRetry && usuariosRetry.addEventListener('click', function(){ usuariosRetry.classList.add('d-none'); loadUsuarios(); });

  async function loadUsuarios(){
    if (loading) return;
    loading = true;
    usuariosError.classList.add('d-none');
    usuariosTableWrap.classList.add('d-none');
    usuariosEmpty.classList.add('d-none');
    usuariosLoading.classList.remove('d-none');
    usuariosTableBody.innerHTML = '';

    abortController && abortController.abort();
    abortController = new AbortController();
    const signal = abortController.signal;
    const TIMEOUT_MS = 8000;
    const timeoutId = setTimeout(()=> abortController && abortController.abort(), TIMEOUT_MS);

    try {
      const res = await fetch('/api/usuarios', { cache: 'no-store', signal });
      clearTimeout(timeoutId);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const sessionName = currentUser ? String(currentUser.usuario) : null;
      const filtered = Array.isArray(data) ? data.filter(u => {
        const name = String(u.username || u.Usuarios || u.usuario || '');
        return !(sessionName && name && name === sessionName);
      }) : [];

      if (!filtered.length) {
        usuariosLoading.classList.add('d-none');
        usuariosEmpty.classList.remove('d-none');
        usuariosRetry.classList.remove('d-none');
        loading = false;
        return;
      }

      filtered.forEach((u) => {
        const username = u.username || u.Usuarios || '';
        const email = u.email || u['Correo Electronico'] || '';
        const roleCurrent = (u.role || u.rol || '').toString().toLowerCase();

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(username)}</td><td>${escapeHtml(email)}</td><td></td>`;
        const select = document.createElement('select');
        select.className = 'rol-select form-control form-control-sm';
        const roles = ['admin','colaborador']; // solo tus dos roles reales
        roles.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r; opt.text = r.charAt(0).toUpperCase() + r.slice(1);
          if (r === roleCurrent) opt.selected = true;
          select.appendChild(opt);
        });

        // habilitar cambio solo si el usuario actual tiene rol admin/superadmin
        if (!(currentUser && (currentUser.rol === 'admin' || currentUser.rol === 'superadmin'))) {
          select.setAttribute('disabled','disabled');
        } else {
          select.addEventListener('change', async function () {
            const newRole = this.value;
            const prev = roleCurrent;
            try {
              const payload = { usuario: username, rol: newRole };
              const r = await fetch('/api/usuarios/rol', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                cache: 'no-store'
              });
              if (!r.ok) {
                const text = await r.text().catch(()=>null);
                throw new Error('HTTP ' + r.status + (text ? ' - ' + text : ''));
              }
              // opcional: mostrar mensaje de éxito
            } catch (err) {
              this.value = prev;
              alert('Error cambiando rol: ' + (err && err.message ? err.message : 'desconocido'));
              console.error('Error cambiando rol', err);
            }
          });
        }

        tr.cells[2].appendChild(select);
        usuariosTableBody.appendChild(tr);
      });

      usuariosLoading.classList.add('d-none');
      usuariosTableWrap.classList.remove('d-none');
      usuariosRetry.classList.add('d-none');
    } catch (err) {
      clearTimeout(timeoutId);
      usuariosLoading.classList.add('d-none');
      usuariosTableWrap.classList.add('d-none');
      const isAbort = err && (err.name === 'AbortError');
      usuariosError.textContent = isAbort ? 'La solicitud tardó demasiado.' : 'Error al cargar usuarios: ' + (err && err.message ? err.message : 'desconocido');
      usuariosError.classList.remove('d-none');
      usuariosRetry.classList.remove('d-none');
      console.error('Error cargando /api/usuarios', err);
    } finally {
      loading = false;
      abortController = null;
    }
  }

  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  initFabVisibility();
});
</script>


{% endblock %}
