{% extends "layout.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<!-- JUMBOTRON -->
<div class="jumbotron jumbotron-welcome text-center mb-0">
  <div class="container fade-in">
    <h1 class="display-4">Bienvenido a Empaquetex</h1>
    <p class="lead">Panel de control centralizado. Accede rápidamente a planillas o a la información de empleados.</p>
  </div>
  <svg class="wave" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120">
    <path fill="#ffffff" d="M0,64L48,80C96,96,192,128,288,128C384,128,480,96,576,74.7C672,53,768,43,864,64C960,85,1056,139,1152,160C1248,181,1344,171,1392,165.3L1440,160L1440,0L0,0Z"></path>
  </svg>
</div>

<!-- SECCIÓN DE ACCIONES -->
<section class="welcome-actions d-flex align-items-center">
  <div class="actions-inner container slide-up">
    <div class="row justify-content-center">
      <div class="col-12 col-md-5">
        <div class="action-card shadow-sm text-center">
          <div class="icon-wrap mb-3 icon-clipboard" aria-hidden="true">
            <i class="fas fa-clipboard-list fa-2x"></i>
          </div>
          <h5 class="mb-2">Planillas</h5>
          <p class="text-muted mb-3">Abrir y administrar planillas de pago; generar reportes y descargar comprobantes.</p>
          <a href="{{ url_for('planilla') }}" class="btn btn-outline-warning btn-block btn-lg action-btn" role="button">
            <i class="fas fa-file-alt mr-2" aria-hidden="true"></i> Ir a Planillas
          </a>
        </div>
      </div>

      <div class="col-12 col-md-5">
        <div class="action-card shadow-sm text-center">
          <div class="icon-wrap mb-3 icon-id" aria-hidden="true">
            <i class="fas fa-id-badge fa-2x"></i>
          </div>
          <h5 class="mb-2">Información de empleados</h5>
          <p class="text-muted mb-3">Ver y editar fichas, subir fotografías y consultar el historial completo por empleado.</p>
          <a href="{{ url_for('empleados') }}" id="btnAbrirInfo" class="btn btn-primary btn-block btn-lg action-btn action-btn-blue" role="button">
            <i class="fas fa-users mr-2" aria-hidden="true"></i> Abrir información empleados
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- FAB: aparece sólo para los 2 administradores fijos -->
<button id="fabUsuarios" class="fab d-none" title="Consultar Usuarios" aria-label="Consultar Usuarios"
        aria-haspopup="dialog" aria-controls="modalUsuarios" aria-expanded="false">
  <i class="fas fa-user-cog" aria-hidden="true"></i>
</button>

<!-- Modal para mostrar lista de Usuarios (sin columnas # ni Activo) -->
<div class="modal fade" id="modalUsuarios" tabindex="-1" role="dialog" aria-labelledby="modalUsuariosLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content" role="document">
      <div class="modal-header">
        <h5 class="modal-title" id="modalUsuariosLabel">Usuarios (tabla Usuarios)</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar" id="modalCloseBtn">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body" id="modalUsuariosBody">
        <div id="usuariosLoading" class="text-center py-3" aria-live="polite">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span class="sr-only">Cargando usuarios...</span>
          <div class="mt-2">Cargando usuarios...</div>
        </div>

        <div id="usuariosError" class="alert alert-danger d-none" role="alert" aria-live="assertive"></div>

        <div class="table-responsive d-none" id="usuariosTableWrap" role="region" aria-label="Tabla de usuarios">
          <table class="table table-sm table-hover" id="usuariosTable">
            <thead class="thead-light">
              <tr>
                <th scope="col">Usuario</th>
                <th scope="col">Correo</th>
                <th scope="col">Rol</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="text-center d-none" id="usuariosEmptyMessage" aria-live="polite">
          <p class="text-muted">No se encontraron usuarios.</p>
        </div>
      </div>

      <div class="modal-footer">
        <button id="usuariosRetry" type="button" class="btn btn-outline-primary d-none">Reintentar</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnCerrarModal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<style>
.jumbotron-welcome { position: relative; background-color: #f5f7fa; padding: 3rem 1rem 4rem; margin-bottom: 0; border-radius: 0 0 30px 30px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); overflow: hidden; }
.actions-inner .action-card { padding: 20px; border-radius: 12px; background: #fff; }
.fab { position: fixed; right: 22px; bottom: 22px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(180deg,#1e88e5,#1565d8); color: #fff; border: none; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(21,101,192,0.18); cursor: pointer; z-index: 1050; transition: transform .15s ease, box-shadow .15s ease; }
.fab:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(21,101,192,0.22); }
.sr-only { position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important; margin: -1px !important; overflow: hidden !important; clip: rect(0,0,0,0) !important; white-space: nowrap !important; border: 0 !important; }
.rol-select { min-width: 140px; padding: .25rem .4rem; border-radius: .25rem; border: 1px solid rgba(0,0,0,0.08); }
</style>

<script>
/*
  Reglas implementadas en este archivo:
  - El FAB aparece únicamente para los dos administradores fijos listados en FIXED_ADMIN_USERS.
  - El listado de usuarios NO incluye el usuario con el que se inició sesión.
  - El select de roles NO incluye "viewer".
  - Sólo los administradores fijos pueden cambiar roles; los administradores fijos no pueden cambiar su propio rol ni el de otros administradores fijos.
  - El cambio de rol se envía a PATCH /api/usuarios/rol con payload { usuario, correo, rol }.
  - Este archivo es cliente (menu.html completo). Asegura que el servidor implemente /whoami y /api/usuarios y /api/usuarios/rol como se espera.
*/

(function () {
  const FIXED_ADMIN_USERS = ['admin', 'admin2']; // <- reemplaza por los dos usuarios administradores fijos de tu sistema (exacto username)
  const fab = document.getElementById('fabUsuarios');
  const modalEl = document.getElementById('modalUsuarios');
  const usuariosLoading = document.getElementById('usuariosLoading');
  const usuariosError = document.getElementById('usuariosError');
  const usuariosTableWrap = document.getElementById('usuariosTableWrap');
  const usuariosTableBody = document.querySelector('#usuariosTable tbody');
  const usuariosEmpty = document.getElementById('usuariosEmptyMessage');
  const usuariosRetry = document.getElementById('usuariosRetry');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const btnCerrarModal = document.getElementById('btnCerrarModal');

  let currentUser = null; // { usuario, rol }
  let loading = false;
  let abortController = null;

  // Obtiene información del usuario actual (necesario para ocultarlo del listado y mostrar FAB)
  async function fetchWhoami() {
    try {
      const res = await fetch('/whoami', { cache: 'no-store' });
      if (!res.ok) return null;
      const j = await res.json();
      return { usuario: j.usuario || j.Usuarios || '', rol: (j.rol || '').toLowerCase() };
    } catch (e) {
      return null;
    }
  }

  // Decide visibilidad del FAB: sólo para los administradores fijos
  async function initFab() {
    currentUser = await fetchWhoami();
    if (!currentUser) {
      fab.classList.add('d-none');
      return;
    }
    const uname = String(currentUser.usuario || '').toLowerCase();
    if (FIXED_ADMIN_USERS.map(x => x.toLowerCase()).includes(uname)) {
      fab.classList.remove('d-none');
    } else {
      fab.classList.add('d-none');
    }
  }

  function showModal() {
    if (typeof $ === 'function' && typeof $.fn.modal === 'function') {
      $('#modalUsuarios').modal({ backdrop: 'static', keyboard: false });
    } else {
      modalEl.classList.add('show');
      modalEl.style.display = 'block';
      modalEl.setAttribute('aria-hidden', 'false');
      setTimeout(() => { const close = modalEl.querySelector('#modalCloseBtn'); if (close) close.focus(); }, 60);
      document.addEventListener('keydown', fallbackEsc);
    }
  }

  function hideModal() {
    if (typeof $ === 'function' && typeof $.fn.modal === 'function') {
      $('#modalUsuarios').modal('hide');
    } else {
      modalEl.classList.remove('show');
      modalEl.style.display = 'none';
      modalEl.setAttribute('aria-hidden', 'true');
      document.removeEventListener('keydown', fallbackEsc);
    }
  }

  function fallbackEsc(e) { if (e.key === 'Escape') hideModal(); }

  if (modalCloseBtn) modalCloseBtn.addEventListener('click', hideModal);
  if (btnCerrarModal) btnCerrarModal.addEventListener('click', hideModal);

  fab && fab.addEventListener('click', function () {
    fab.setAttribute('aria-expanded', 'true');
    showModal();
    loadUsuarios();
  });

  if (typeof $ === 'function' && typeof $.fn.modal === 'function') {
    $('#modalUsuarios').on('hidden.bs.modal', function () { fab && fab.setAttribute('aria-expanded', 'false'); });
  }

  usuariosRetry && usuariosRetry.addEventListener('click', function () {
    usuariosRetry.classList.add('d-none');
    loadUsuarios();
  });

  // Carga la lista de usuarios, filtra el usuario en sesión y construye filas con select de rol
  async function loadUsuarios() {
    if (loading) return;
    loading = true;

    usuariosError.classList.add('d-none');
    usuariosTableWrap.classList.add('d-none');
    usuariosEmpty.classList.add('d-none');
    usuariosLoading.classList.remove('d-none');
    usuariosTableBody.innerHTML = '';

    abortController && abortController.abort();
    abortController = new AbortController();
    const signal = abortController.signal;
    const TIMEOUT_MS = 7000;
    const timeoutId = setTimeout(() => abortController && abortController.abort(), TIMEOUT_MS);

    try {
      const res = await fetch('/api/usuarios', { cache: 'no-store', signal });
      clearTimeout(timeoutId);

      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        usuariosLoading.classList.add('d-none');
        usuariosEmpty.classList.remove('d-none');
        usuariosRetry.classList.remove('d-none');
        loading = false;
        return;
      }

      // filtrar para quitar el usuario con sesión actual (si existe)
      const sessionUser = (currentUser && currentUser.usuario) ? String(currentUser.usuario) : null;
      const list = data.filter(u => {
        const uname = String(u.Usuarios || u.usuario || u.username || u.user || '').trim();
        if (sessionUser && uname && uname === String(sessionUser)) return false;
        return true;
      });

      if (list.length === 0) {
        usuariosLoading.classList.add('d-none');
        usuariosEmpty.classList.remove('d-none');
        usuariosRetry.classList.remove('d-none');
        loading = false;
        return;
      }

      list.forEach((u) => {
        const tr = document.createElement('tr');

        const username = (u.Usuarios || u.usuario || u.username || u.user || '').toString();
        const correo = (u['Correo Electronico'] || u.email || u.correo || '').toString();
        const rolActual = ((u.rol || u.role || u.privilegio || '') || '').toString().toLowerCase();

        // columna Usuario
        const tdUser = document.createElement('td');
        tdUser.textContent = username;
        tr.appendChild(tdUser);

        // columna Correo
        const tdCorreo = document.createElement('td');
        tdCorreo.textContent = correo;
        tr.appendChild(tdCorreo);

        // columna Rol: select (sin 'viewer')
        const tdRol = document.createElement('td');
        const select = document.createElement('select');
        select.className = 'rol-select form-control form-control-sm';
        // roles permitidos (viewer eliminado)
        const ROLES = ['admin', 'colaborador'];
        ROLES.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r;
          opt.text = r.charAt(0).toUpperCase() + r.slice(1);
          if (r === rolActual) opt.selected = true;
          select.appendChild(opt);
        });

        // Decidir si habilitar el select:
        // - Sólo los administradores fijos pueden cambiar roles (FIXED_ADMIN_USERS).
        // - No permitir cambiar rol de usuarios que también sean administradores fijos.
        const isCurrentFixedAdmin = currentUser && FIXED_ADMIN_USERS.map(x => x.toLowerCase()).includes(String(currentUser.usuario || '').toLowerCase());
        const isTargetFixedAdmin = FIXED_ADMIN_USERS.map(x => x.toLowerCase()).includes(String(username || '').toLowerCase());

        if (!isCurrentFixedAdmin) {
          // usuario actual no es uno de los dos admins fijos: deshabilitar select para todos
          select.setAttribute('disabled', 'disabled');
        } else {
          // usuario actual es admin fijo: permitir cambio salvo si objetivo es admin fijo
          if (isTargetFixedAdmin) {
            select.setAttribute('disabled', 'disabled');
          } else {
            // attach handler para PATCH /api/usuarios/rol
            select.addEventListener('change', async function () {
              const newRole = this.value;
              const oldRole = rolActual;
              // optimista en UI: si falla revertir
              try {
                const payload = { usuario: username, correo: correo, rol: newRole };
                const patch = await fetch('/api/usuarios/rol', {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload),
                  cache: 'no-store'
                });
                if (!patch.ok) {
                  const text = await patch.text().catch(()=>null);
                  throw new Error('HTTP ' + patch.status + (text ? (' - ' + text) : ''));
                }
                // si servert devuelve ok, actualizar localmente la variable rolActual no estrictamente necesaria aquí
              } catch (err) {
                // revertir UI y notificar
                this.value = oldRole;
                alert('No se pudo cambiar el rol: ' + (err && err.message ? err.message : 'desconocido'));
                console.error('Error cambiando rol', err);
              }
            });
          }
        }

        tdRol.appendChild(select);
        tr.appendChild(tdRol);

        usuariosTableBody.appendChild(tr);
      });

      usuariosLoading.classList.add('d-none');
      usuariosTableWrap.classList.remove('d-none');
      usuariosRetry.classList.add('d-none');
    } catch (err) {
      clearTimeout(timeoutId);
      usuariosLoading.classList.add('d-none');
      usuariosTableWrap.classList.add('d-none');

      const isAbort = err && (err.name === 'AbortError' || err.message === 'The user aborted a request.');
      usuariosError.textContent = isAbort ? 'La solicitud tardó demasiado. Verifique la conexión y vuelva a intentar.' : 'Error al cargar usuarios: ' + (err && err.message ? err.message : 'desconocido');
      usuariosError.classList.remove('d-none');
      usuariosRetry.classList.remove('d-none');
      console.error('Error cargando /api/usuarios', err);
    } finally {
      loading = false;
      abortController = null;
    }
  }

  // escape básico para prevenir inserción de HTML
  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // Inicialización al cargar la plantilla
  document.addEventListener('DOMContentLoaded', async function () {
    // inicializar info de sesión y FAB
    currentUser = await fetchWhoami();
    await initFab();

    // Si el FAB está visible pre-cargado, el usuario es admin fijo; así permitimos abrir el modal
    // nada adicional a hacer hasta que se haga click en FAB
  });

  // Exponer fetchWhoami para uso interno
  async function fetchWhoami() {
    try {
      const r = await fetch('/whoami', { cache: 'no-store' });
      if (!r.ok) return null;
      const j = await r.json();
      return { usuario: j.usuario || j.Usuarios || '', rol: (j.rol || '').toLowerCase() };
    } catch (e) {
      return null;
    }
  }

  // initFab reutilizable (separa para poder llamarlo después si cambian sesión)
  async function initFab() {
    currentUser = currentUser || await fetchWhoami();
    if (!currentUser || !currentUser.usuario) {
      fab.classList.add('d-none');
      return;
    }
    const uname = String(currentUser.usuario || '').toLowerCase();
    if (FIXED_ADMIN_USERS.map(x => x.toLowerCase()).includes(uname)) {
      fab.classList.remove('d-none');
    } else {
      fab.classList.add('d-none');
    }
  }

})();
</script>

{% endblock %}
