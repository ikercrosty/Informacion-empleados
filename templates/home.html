{% extends "layout.html" %}
{% block title %}Datos Personales{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="jumbotron p-4 rounded-3 bg-white shadow-sm mb-3">
    <div class="d-flex flex-column flex-md-row align-items-start gap-3">
      <div class="flex-grow-1">
        <h1 class="h3 mb-1">Datos personales</h1>
        <p class="text-muted mb-0">Lista de empleados y foto del empleado seleccionado</p>
      </div>
    </div>
  </div>

  {# obtener rol desde session (se asume session["rol"] guardado en el backend) #}
  {% set rol = session.get('rol', '')|string|lower %}

  <div class="card shadow-sm border-0 bg-white">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="btn-group">
          <button id="btnAgregar" class="btn btn-success btn-sm">Agregar</button>

          {% if rol == 'admin' %}
            <button id="btnEditar" class="btn btn-primary btn-sm" data-requires-admin disabled>Editar</button>
            <button id="btnGuardar" class="btn btn-success btn-sm" data-requires-admin disabled>Guardar</button>
          {% else %}
            <button id="btnEditar" class="btn btn-primary btn-sm" data-disable-for-editor disabled>Editar</button>
            <button id="btnGuardar" class="btn btn-success btn-sm" data-disable-for-editor disabled>Guardar</button>
          {% endif %}

          <button id="btnCancelar" class="btn btn-secondary btn-sm" disabled>Cancelar</button>
        </div>
      </div>

      <div class="table-responsive">
        <table id="tablaEmpleados" class="table table-sm table-hover table-bordered w-100 mb-0">
          <thead class="small" style="background-color:#000000; color:#ffffff;">
            <tr>
              <th>DPI</th><th>Nombre</th><th>Apellidos</th><th>Apellidos de casada</th><th>Estado Civil</th>
              <th>Nacionalidad</th><th>Departamento</th><th>Fecha de nacimiento</th><th>Lugar de nacimiento</th>
              <th>Numero IGSS</th><th>Dirección</th><th>Telefono</th><th>Religión</th><th>Correo</th><th>Puesto</th>
              <th>Tipo de contrato</th><th>Jornada laboral</th><th>Duración del trabajo</th><th>Fecha de inicio laboral</th><th>Dias Laborales</th>
            </tr>
          </thead>
          <tbody class="small">
            {% if empleados %}
              {% for e in empleados %}
              <tr>
                <td>{{ e['Numero de DPI'] }}</td>
                <td>{{ e.get('Nombre') }}</td>
                <td>{{ e.get('Apellidos') }}</td>
                <td>{{ e.get('Apellidos de casada') }}</td>
                <td>{{ e.get('Estado Civil') }}</td>
                <td>{{ e.get('Nacionalidad') }}</td>
                <td>{{ e.get('Departamento') }}</td>
                <td>{{ e.get('Fecha de nacimiento') }}</td>
                <td>{{ e.get('Lugar de nacimiento') }}</td>
                <td>{{ e.get('Numero de Afiliación del IGGS') }}</td>
                <td>{{ e.get('Dirección del Domicilio') }}</td>
                <td>{{ e.get('Numero de Telefono') }}</td>
                <td>{{ e.get('Religión') }}</td>
                <td>{{ e.get('Correo Electronico') }}</td>
                <td>{{ e.get('Puesto de trabajo') }}</td>
                <td>{{ e.get('Tipo de contrato') }}</td>
                <td>{{ e.get('Jornada laboral') }}</td>
                <td>{{ e.get('Duración del trabajo') }}</td>
                <td>{{ e.get('Fecha de inicio laboral') }}</td>
                <td>{{ e.get('Dias Laborales') }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="20" class="text-center text-muted">No hay empleados. Usa "Agregar" para crear la primera fila.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Panel de foto -->
  <div class="mt-4 d-flex justify-content-center">
    <div class="w-100" style="max-width:320px;">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex flex-column align-items-center">
          <h5 class="mb-3">Foto del empleado</h5>

          <div class="mb-3 d-flex justify-content-center w-100">
            <img id="fotoEmpleado"
                 src="{{ url_for('static', filename='imagenes/default.jpg') }}"
                 alt="Foto empleado"
                 class="rounded"
                 style="width:220px;height:220px;object-fit:cover;border:1px solid #ddd;background:#f5f5f5;">
          </div>

          <form id="formSubirFoto" method="post" enctype="multipart/form-data" action="{{ url_for('subir_foto') }}" class="w-100" style="max-width:260px; display:none;">
            <input type="hidden" name="dpi" id="inputDpiForUpload" value="">
            <div class="form-group mb-2">
              <input id="fileFoto" name="foto" type="file" accept="image/*" class="form-control form-control-sm">
            </div>
            <button id="btnSubirFoto" type="button" class="btn btn-primary btn-sm w-100">Subir foto</button>
          </form>

          <form id="formEliminarFoto" method="post" action="{{ url_for('eliminar_foto') }}" class="w-100" style="max-width:260px; display:none; margin-top:12px;">
            <input type="hidden" name="dpi" id="inputDpiForDelete" value="">
            {% if rol == 'admin' %}
              <button id="btnEliminarFoto" type="button" class="btn btn-outline-danger btn-sm w-100" data-requires-admin>Eliminar foto</button>
            {% else %}
              <button id="btnEliminarFoto" type="button" class="btn btn-outline-danger btn-sm w-100" data-disable-for-editor disabled>Eliminar foto</button>
            {% endif %}
          </form>

          <small id="fotoHint" class="text-muted mt-3 text-center">
            Selecciona una fila de la tabla para gestionar la foto del empleado.
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* Modificaciones mínimas solicitadas: UX + defensa ligera por rol.
   Solo cambia comportamiento de UI y bloqueo client-side; la seguridad real debe quedar en el servidor. */
(function(){
  // Asegura que la plantilla definió rol (se definió arriba)
  window.CURRENT_ROLE = "{{ rol or '' }}".toLowerCase();

  // Aplica restricciones visuales al cargar (no quita la lógica de activación por selección)
  function applyInitialUiRestrictions() {
    const role = (window.CURRENT_ROLE || '').toLowerCase();
    // no removemos botones aquí; solo dejamos estados iniciales coherentes
    // btnAgregar siempre habilitado; editar/guardar inicialmente deshabilitados until a row selected
    const btnAgregar = document.getElementById('btnAgregar');
    const btnEditar  = document.getElementById('btnEditar');
    const btnGuardar = document.getElementById('btnGuardar');
    const btnCancelar= document.getElementById('btnCancelar');

    if (btnAgregar) btnAgregar.disabled = false;
    if (btnEditar)  btnEditar.disabled = true;
    if (btnGuardar) btnGuardar.disabled = true;
    if (btnCancelar) btnCancelar.disabled = true;

    // If editor, ensure any admin-only elements are disabled (keeps them visible if template left them)
    if (role !== 'admin') {
      document.querySelectorAll('[data-requires-admin]').forEach(el => {
        // keep element in DOM but disabled/hidden visually
        try { el.setAttribute('disabled','true'); el.classList.add('d-none'); } catch(e){}
      });
      document.querySelectorAll('[data-disable-for-editor]').forEach(el => {
        try { el.setAttribute('disabled','true'); el.classList.add('disabled'); } catch(e){}
      });
    } else {
      // admin: ensure admin elements visible
      document.querySelectorAll('[data-requires-admin]').forEach(el => {
        try { el.removeAttribute('disabled'); el.classList.remove('d-none'); } catch(e){}
      });
      document.querySelectorAll('[data-disable-for-editor]').forEach(el => {
        try { el.removeAttribute('disabled'); el.classList.remove('disabled'); } catch(e){}
      });
    }
  }

  // Defensa ligera: interceptar fetch y bloquear llamadas client-side sensibles para editors
  (function installFetchGuard(){
    const originalFetch = window.fetch;
    window.fetch = async function(input, init){
      try {
        const role = (window.CURRENT_ROLE || '').toLowerCase();
        const url = (typeof input === 'string') ? input : (input && input.url) || '';
        const method = (init && init.method) ? init.method.toUpperCase() : 'GET';

        // parse body for common formats
        let bodyObj = null;
        if (init && init.body) {
          if (typeof init.body === 'string') {
            try { bodyObj = JSON.parse(init.body); } catch(e){}
          } else if (init.body instanceof FormData) {
            bodyObj = {};
            for (const pair of init.body.entries()) bodyObj[pair[0]] = pair[1];
          } else if (init.body instanceof URLSearchParams) {
            bodyObj = {};
            for (const [k,v] of init.body.entries()) bodyObj[k]=v;
          }
        }

        // Block non-new updates to /guardar_empleado for editors
        if (url && url.indexOf('/guardar_empleado') !== -1) {
          if (role !== 'admin') {
            const isNew = Boolean(bodyObj && (bodyObj.nuevo === true || bodyObj.nuevo === 'true' || bodyObj.nuevo === '1' || bodyObj.nuevo === 1));
            if (!isNew) {
              return new Response(JSON.stringify({ mensaje: 'Permisos insuficientes (cliente)' }), { status: 403, headers: { 'Content-Type':'application/json' }});
            }
          }
        }

        // Block eliminar_foto for editors
        if (url && url.indexOf('/eliminar_foto') !== -1) {
          if (role !== 'admin') {
            return new Response(JSON.stringify({ error: 'Permisos insuficientes para eliminar foto (cliente)' }), { status: 403, headers: { 'Content-Type': 'application/json' }});
          }
        }

        // Block PUT to /api/empleado/:dpi for editors
        if (method === 'PUT' && url && url.match(/\/api\/empleado\/[^\/]+$/)) {
          if (role !== 'admin') {
            return new Response(JSON.stringify({ mensaje: 'Permisos insuficientes (cliente)' }), { status: 403, headers: { 'Content-Type':'application/json' }});
          }
        }
      } catch (e) {
        // ignore parse errors and fall through to original fetch
      }
      return originalFetch.apply(this, arguments);
    };
  })();

  applyInitialUiRestrictions();

  // --- registro tabla y panel de foto (sin cambiar lógica existente) ---
  const TABLE_ID = 'tablaEmpleados';
  const ENDPOINT = '/guardar_empleado';
  const COLUMNS = 20;
  const BLOQUEADAS = [];

  const CAMPOS = [
    "Numero de DPI","Nombre","Apellidos","Apellidos de casada","Estado Civil",
    "Nacionalidad","Departamento","Fecha de nacimiento","Lugar de nacimiento",
    "Numero de Afiliación del IGGS","Dirección del Domicilio","Numero de Telefono",
    "Religión","Correo Electronico","Puesto de trabajo","Tipo de contrato",
    "Jornada laboral","Duración del trabajo","Fecha de inicio laboral","Dias Laborales"
  ];

  function tryRegister(retries = 20){
    if (window.registrarTabla && typeof window.registrarTabla === 'function') {
      window.registrarTabla(TABLE_ID, COLUMNS, ENDPOINT, CAMPOS, BLOQUEADAS);

      // initial button states (registrarTabla may enable more later)
      const btnAgregar = document.getElementById('btnAgregar');
      const btnEditar  = document.getElementById('btnEditar');
      const btnGuardar = document.getElementById('btnGuardar');
      const btnCancelar= document.getElementById('btnCancelar');
      if (btnAgregar) btnAgregar.disabled = false;
      if (btnEditar)  btnEditar.disabled = true;
      if (btnGuardar) btnGuardar.disabled = true;
      if (btnCancelar) btnCancelar.disabled = true;

      // attach photo selection & controls
      attachPhotoSelection();
      attachPhotoControls();
      return;
    }
    if (retries <= 0) {
      console.error('registrarTabla no disponible para tablaEmpleados');
      return;
    }
    setTimeout(()=> tryRegister(retries - 1), 100);
  }

  // Photo panel behaviour: select row -> request /api/foto/:dpi and show/hide upload/delete
  function attachPhotoSelection(){
    const tabla = document.getElementById(TABLE_ID);
    if (!tabla) return;
    tabla.addEventListener('click', async (ev) => {
      const tr = ev.target.closest('tr');
      if (!tr || tr.parentElement.tagName !== 'TBODY') return;

      const dpi = (tr.cells[0] && tr.cells[0].innerText || '').trim();
      const fotoEmpleado = document.getElementById('fotoEmpleado');
      const inputDpiUpload = document.getElementById('inputDpiForUpload');
      const inputDpiDelete = document.getElementById('inputDpiForDelete');
      const formSubir = document.getElementById('formSubirFoto');
      const formEliminar = document.getElementById('formEliminarFoto');
      const fileFoto = document.getElementById('fileFoto');

      const btnEditar  = document.getElementById('btnEditar');
      const btnGuardar = document.getElementById('btnGuardar');
      const btnCancelar= document.getElementById('btnCancelar');

      if (inputDpiUpload) inputDpiUpload.value = dpi || '';
      if (inputDpiDelete) inputDpiDelete.value = dpi || '';

      // enable/disable buttons depending on role and selection
      const role = (window.CURRENT_ROLE || '').toLowerCase();
      if (dpi) {
        // selection made: enable Cancel always, enable Edit/Guardar only for admin
        if (btnCancelar) btnCancelar.disabled = false;
        if (role === 'admin') {
          if (btnEditar) btnEditar.disabled = false;
          if (btnGuardar) btnGuardar.disabled = false;
        } else {
          if (btnEditar) btnEditar.disabled = true;
          if (btnGuardar) btnGuardar.disabled = true;
        }
      } else {
        if (btnCancelar) btnCancelar.disabled = true;
        if (btnEditar) btnEditar.disabled = true;
        if (btnGuardar) btnGuardar.disabled = true;
      }

      if (!dpi) {
        if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
        if (formSubir) formSubir.style.display = "none";
        if (formEliminar) formEliminar.style.display = "none";
        if (fileFoto) fileFoto.value = "";
        return;
      }

      try {
        const r = await fetch(`/api/foto/${encodeURIComponent(dpi)}`, { cache: 'no-store' });
        if (!r.ok) throw new Error('no-photo');
        const j = await r.json();
        if (j && j.url) {
          if (fotoEmpleado) fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
          // show delete form if role admin; show upload form hidden
          if (formSubir) formSubir.style.display = "none";
          if (formEliminar) {
            if (role === 'admin') formEliminar.style.display = "block";
            else {
              // show the form block but the button inside is disabled by template; keep UX consistent
              formEliminar.style.display = "block";
            }
          }
        } else {
          if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
          if (formSubir) formSubir.style.display = "block";
          if (formEliminar) formEliminar.style.display = "none";
          if (fileFoto) fileFoto.value = "";
        }
      } catch (err) {
        if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
        if (formSubir) formSubir.style.display = "block";
        if (formEliminar) formEliminar.style.display = "none";
        if (fileFoto) fileFoto.value = "";
      }
    });
  }

  // Photo upload/delete handlers (idempotent)
  function attachPhotoControls(){
    const fileFoto = document.getElementById('fileFoto');
    if (fileFoto && !fileFoto.dataset.attached) {
      fileFoto.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f || !f.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (ev) => { const fotoEmpleado = document.getElementById('fotoEmpleado'); if (fotoEmpleado) fotoEmpleado.src = ev.target.result; };
        reader.readAsDataURL(f);
      });
      fileFoto.dataset.attached = '1';
    }

    const btnSubirFoto = document.getElementById('btnSubirFoto');
    const formSubir = document.getElementById('formSubirFoto');
    const inputDpiUpload = document.getElementById('inputDpiForUpload');
    if (btnSubirFoto && !btnSubirFoto.dataset.attached) {
      btnSubirFoto.addEventListener('click', async () => {
        const dpi = inputDpiUpload && inputDpiUpload.value && inputDpiUpload.value.trim();
        const fileFotoEl = document.getElementById('fileFoto');
        if (!dpi) return flash('Selecciona una fila con DPI antes de subir foto', 'danger');
        if (!fileFotoEl || !fileFotoEl.files || !fileFotoEl.files[0]) return flash('Selecciona un archivo de imagen', 'danger');
        const fd = new FormData();
        fd.append('dpi', dpi);
        fd.append('foto', fileFotoEl.files[0]);
        try {
          const res = await fetch(formSubir.action || '/subir_foto', { method: 'POST', body: fd });
          if (!res.ok) {
            const t = await res.text().catch(()=>null);
            throw new Error(`${res.status} ${t||res.statusText}`);
          }
          const j = await res.json();
          if (j && j.url) {
            const fotoEmpleado = document.getElementById('fotoEmpleado');
            if (fotoEmpleado) fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
            if (formSubir) formSubir.style.display = "none";
            const formEliminar = document.getElementById('formEliminarFoto');
            if (formEliminar) formEliminar.style.display = "block";
            flash('Foto subida', 'success');
          } else throw new Error('Respuesta inesperada del servidor');
        } catch (err) {
          flash('Error al subir foto: ' + (err.message||err), 'danger');
        }
      });
      btnSubirFoto.dataset.attached = '1';
    }

    const btnEliminarFoto = document.getElementById('btnEliminarFoto');
    const formEliminar = document.getElementById('formEliminarFoto');
    const inputDpiDelete = document.getElementById('inputDpiForDelete');
    if (btnEliminarFoto && !btnEliminarFoto.dataset.attached) {
      btnEliminarFoto.addEventListener('click', async () => {
        const dpi = inputDpiDelete && inputDpiDelete.value && inputDpiDelete.value.trim();
        if (!dpi) return flash('No hay DPI seleccionado', 'danger');

        // cliente final check: only admin allowed to trigger delete
        if (window.CURRENT_ROLE !== 'admin') {
          return flash('Permisos insuficientes para eliminar foto', 'danger');
        }

        try {
          const res = await fetch(formEliminar.action || '/eliminar_foto', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dpi })
          });
          if (!res.ok) {
            const t = await res.text().catch(()=>null);
            throw new Error(`${res.status} ${t||res.statusText}`);
          }
          const fotoEmpleado = document.getElementById('fotoEmpleado');
          if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
          if (formSubir) formSubir.style.display = "block";
          if (formEliminar) formEliminar.style.display = "none";
          flash('Foto eliminada', 'success');
        } catch (err) {
          flash('Error al eliminar foto', 'danger');
        }
      });
      btnEliminarFoto.dataset.attached = '1';
    }
  }

  // small flash helper used here
  function flash(msg, type='info') {
    const id = '__home_flash';
    const prev = document.getElementById(id);
    if (prev) prev.remove();
    const d = document.createElement('div');
    d.id = id;
    d.className = `alert alert-${type} py-1 px-2 small position-fixed`;
    d.style.top = '12px';
    d.style.right = '12px';
    d.style.zIndex = 9999;
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(()=> d.remove(), 2000);
  }

  window.__home_flash = { flash };

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ()=>tryRegister(20));
  else tryRegister(20);

})();
</script>

{% endblock %}
