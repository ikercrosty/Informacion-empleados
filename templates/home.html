{% extends "layout.html" %}
{% block title %}Datos personales{% endblock %}

{% block content %}
<div class="jumbotron">
  <h1 class="display-4">Datos personales</h1>
  <p class="lead">Datos personales del empleado</p>
</div>

<div class="row">
  <!-- Tabla y botones (izquierda) -->
  <div class="col-md-8">
    <div class="mb-3">
      <button id="btnAgregar" type="button" class="btn btn-success btn-sm">Agregar</button>
      <button id="btnEditar" type="button" class="btn btn-primary btn-sm" disabled>Editar</button>
      <button id="btnGuardar" type="button" class="btn btn-success btn-sm" disabled>Guardar</button>
      <button id="btnCancelar" type="button" class="btn btn-secondary btn-sm" disabled>Cancelar</button>
    </div>

    <div class="table-responsive">
      <table id="tablaEmpleados" class="table table-bordered table-striped table-hover table-sm">
        <thead class="thead-dark">
          <tr>
            <th>DPI</th>
            <th>Nombre</th>
            <th>Apellidos</th>
            <th>Estado Civil</th>
            <th>Nacionalidad</th>
            <th>Departamento</th>
            <th>Fecha de nacimiento</th>
          </tr>
        </thead>
        <tbody>
          {% for e in empleados %}
          <tr>
            <td>{{ e['Numero de DPI'] }}</td>
            <td>{{ e['Nombre'] }}</td>
            <td>{{ e['Apellidos'] }}</td>
            <td>{{ e.get('Estado Civil') }}</td>
            <td>{{ e.get('Nacionalidad') }}</td>
            <td>{{ e.get('Departamento') }}</td>
            <td>{{ e.get('Fecha de nacimiento') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Panel de imagen (derecha) -->
  <div class="col-md-4">
    <div class="card p-3">
      <h5 class="mb-3">Datos personales del empleado</h5>

      <div class="text-center mb-3">
        {% set inicial = empleados[0]['foto'] if empleados and empleados[0]['foto'] else None %}
        {% if inicial %}
          <img id="fotoEmpleado" src="{{ url_for('static', filename='fotos/' ~ inicial) }}"
               alt="Foto empleado" class="img-fluid rounded-circle"
               style="width:160px;height:160px;object-fit:cover;">
        {% else %}
          <img id="fotoEmpleado" src="{{ url_for('static', filename='imagenes/default.png') }}"
               alt="Foto empleado" class="img-fluid rounded-circle"
               style="width:160px;height:160px;object-fit:cover;">
        {% endif %}
      </div>

      <!-- Subir foto (ruta sin parÃ¡metro, DPI via hidden) -->
      <form id="formSubirFoto" method="post" action="{{ url_for('subir_foto') }}" enctype="multipart/form-data">
        <input type="hidden" name="dpi" id="inputDpiForUpload" value="{{ empleados[0]['Numero de DPI'] if empleados else '' }}">
        <div class="form-group">
          <input id="fileFoto" name="foto" type="file" accept="image/*" class="form-control-file">
        </div>
        <button id="btnSubirFoto" type="submit" class="btn btn-primary btn-block">Subir Foto</button>
      </form>

      <!-- Eliminar foto -->
      <form id="formEliminarFoto" method="post" action="{{ url_for('eliminar_foto') }}" class="mt-2">
        <input type="hidden" name="dpi" id="inputDpiForDelete" value="{{ empleados[0]['Numero de DPI'] if empleados else '' }}">
        <button id="btnEliminarFoto" type="submit" class="btn btn-outline-danger btn-block">Eliminar Foto</button>
      </form>

      <small class="text-muted mt-3 d-block">
        Selecciona una fila de la tabla para cargar/actualizar la foto del DPI correspondiente.
      </small>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='main.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tabla = document.getElementById('tablaEmpleados');
    const fotoEmpleado = document.getElementById('fotoEmpleado');
    const inputDpiUpload = document.getElementById('inputDpiForUpload');
    const inputDpiDelete = document.getElementById('inputDpiForDelete');
    const fileFoto = document.getElementById('fileFoto');

    // Preview inmediato al seleccionar archivo
    if (fileFoto && fotoEmpleado) {
      fileFoto.addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (!f || !f.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (ev) => { fotoEmpleado.src = ev.target.result; };
        reader.readAsDataURL(f);
      });
    }

    // Al hacer click en una fila, actualiza DPI y carga foto desde API
    if (tabla && fotoEmpleado && inputDpiUpload && inputDpiDelete) {
      tabla.addEventListener('click', (ev) => {
        const tr = ev.target.closest('tr');
        if (!tr || !tr.cells.length) return;
        const dpi = tr.cells[0].innerText.trim();
        if (!dpi) return;

        inputDpiUpload.value = dpi;
        inputDpiDelete.value = dpi;

        fetch(`/api/foto/${encodeURIComponent(dpi)}`)
          .then(r => r.json())
          .then(j => {
            if (j && j.foto) {
              fotoEmpleado.src = `/static/fotos/${j.foto}`;
            } else {
              fotoEmpleado.src = `{{ url_for('static', filename='imagenes/default.png') }}`;
            }
          })
          .catch(() => {
            fotoEmpleado.src = `{{ url_for('static', filename='imagenes/default.png') }}`;
          });
      });
    }
  });
</script>
{% endblock %}
