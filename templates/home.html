{% extends "layout.html" %}
{% block title %}Datos Personales{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-8">
    <div class="d-flex mb-2">
      <button id="btnAgregar" class="btn btn-primary mr-2">Agregar</button>
      <button id="btnEditar" class="btn btn-secondary mr-2" disabled>Editar</button>
      <button id="btnGuardar" class="btn btn-success mr-2" disabled>Guardar</button>
      <button id="btnCancelar" class="btn btn-danger" disabled>Cancelar</button>
    </div>

    <div class="table-responsive">
      <table id="tablaEmpleados" class="table table-striped table-bordered">
        <thead class="thead-light">
          <tr>
            <th>DPI</th>
            <th>Nombre</th>
            <th>Apellidos</th>
            <th>Estado Civil</th>
            <th>Nacionalidad</th>
            <th>Departamento</th>
            <th>Fecha de nacimiento</th>
          </tr>
        </thead>
        <tbody>
          {# Rellena filas desde backend #}
          {% for e in empleados %}
          <tr>
            <td>{{ e.dpi }}</td>
            <td>{{ e.nombre }}</td>
            <td>{{ e.apellidos }}</td>
            <td>{{ e.estado_civil }}</td>
            <td>{{ e.nacionalidad }}</td>
            <td>{{ e.departamento }}</td>
            <td>{{ e.fecha_nacimiento }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-3">
      <h5 class="mb-3">Foto del Empleado</h5>

      <!-- Preview -->
      <div class="text-center mb-3">
        <img id="fotoEmpleado" src="{{ url_for('static', filename='imagenes/default.png') }}" 
             alt="Foto empleado" class="img-fluid rounded-circle" style="width:160px;height:160px;object-fit:cover;">
      </div>

      <!-- Formulario subir foto -->
      <form id="formSubirFoto" method="post" action="{{ url_for('subir_foto') }}" enctype="multipart/form-data">
        <input type="hidden" name="dpi" id="inputDpiForUpload" value="">
        <div class="form-group">
          <input id="fileFoto" name="foto" type="file" accept="image/*" class="form-control-file">
        </div>
        <button id="btnSubirFoto" type="submit" class="btn btn-primary btn-block">Subir Foto</button>
      </form>

      <!-- Formulario eliminar foto -->
      <form id="formEliminarFoto" method="post" action="{{ url_for('eliminar_foto') }}" class="mt-2">
        <input type="hidden" name="dpi" id="inputDpiForDelete" value="">
        <button id="btnEliminarFoto" type="submit" class="btn btn-outline-danger btn-block">Eliminar Foto</button>
      </form>
    </div>
  </div>
</div>

<script>
  // Preview inmediato al seleccionar archivo
  document.addEventListener("DOMContentLoaded", () => {
    const fileFoto = document.getElementById('fileFoto');
    const fotoEmpleado = document.getElementById('fotoEmpleado');

    fileFoto && fileFoto.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      if (!f.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        fotoEmpleado.src = ev.target.result;
      };
      reader.readAsDataURL(f);
    });

    // Cuando el usuario hace click en una fila actualizamos los inputs DPI
    const tabla = document.getElementById('tablaEmpleados');
    if (tabla) {
      tabla.addEventListener('click', (ev) => {
        const tr = ev.target.closest('tr');
        if (!tr) return;
        const dpi = tr.cells[0].innerText.trim();
        if (!dpi) return;
        // Llenamos los campos hidden para subir/eliminar
        document.getElementById('inputDpiForUpload').value = dpi;
        document.getElementById('inputDpiForDelete').value = dpi;

        // Intentamos cargar la foto desde el servidor (API)
        fetch(`{{ url_for('api_foto_base') }}/${encodeURIComponent(dpi)}`)
          .then(r => r.json())
          .then(j => {
            if (j && j.foto) {
              fotoEmpleado.src = `/static/fotos/${j.foto}`;
            } else {
              fotoEmpleado.src = `{{ url_for('static', filename='imagenes/default.png') }}`;
            }
          })
          .catch(() => {
            fotoEmpleado.src = `{{ url_for('static', filename='imagenes/default.png') }}`;
          });
      });
    }
  });
</script>
{% endblock %}
