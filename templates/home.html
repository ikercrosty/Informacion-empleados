{% extends "layout.html" %}
{% block title %}Datos Personales{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="jumbotron p-4 rounded-3 bg-white shadow-sm mb-3">
    <div class="d-flex flex-column flex-md-row align-items-start gap-3">
      <div class="flex-grow-1">
        <h1 class="h3 mb-1">Datos personales</h1>
        <p class="text-muted mb-0">Lista de empleados y foto del empleado seleccionado</p>
      </div>
    </div>
  </div>

  {# rol disponible desde session; normalizado en minúsculas #}
  {% set rol = session.get('rol', '')|string|lower %}

  <div class="card shadow-sm border-0 bg-white">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="btn-group">
          <button id="btnAgregar" class="btn btn-success btn-sm" data-action="agregar">Agregar</button>

          {# siempre visibles; JS decide si la acción procede según rol #}
          <button id="btnEditar" class="btn btn-primary btn-sm" data-action="editar" data-role-required="admin">Editar</button>
          <button id="btnGuardar" class="btn btn-success btn-sm" data-action="guardar" data-role-required="admin">Guardar</button>

          <button id="btnCancelar" class="btn btn-secondary btn-sm" data-action="cancelar">Cancelar</button>
{% if rol == 'admin' %}
  <button id="btnEliminar" class="btn btn-danger btn-sm" data-action="eliminar" data-role-required="admin">Eliminar</button>
{% endif %}

      </div>
        </div>
      </div>

      <div class="table-responsive">
        <table id="tablaEmpleados" class="table table-sm table-hover table-bordered w-100 mb-0">
          <thead class="small" style="background-color:#000000; color:#ffffff;">
            <tr>
              <th>DPI</th><th>Nombre</th><th>Apellidos</th><th>Apellidos de casada</th><th>Estado Civil</th>
              <th>Nacionalidad</th><th>Departamento</th><th>Fecha de nacimiento</th><th>Lugar de nacimiento</th>
              <th>Numero IGSS</th><th>Dirección</th><th>Telefono</th><th>Religión</th><th>Correo</th><th>Puesto</th>
              <th>Tipo de contrato</th><th>Jornada laboral</th><th>Duración del trabajo</th><th>Fecha de inicio laboral</th><th>Dias Laborales</th>
            </tr>
          </thead>
          <tbody class="small">
            {% if empleados %}
              {% for e in empleados %}
              <tr>
                <td>{{ e['Numero de DPI'] }}</td>
                <td>{{ e.get('Nombre') }}</td>
                <td>{{ e.get('Apellidos') }}</td>
                <td>{{ e.get('Apellidos de casada') }}</td>
                <td>{{ e.get('Estado Civil') }}</td>
                <td>{{ e.get('Nacionalidad') }}</td>
                <td>{{ e.get('Departamento') }}</td>
                <td>{{ e.get('Fecha de nacimiento') }}</td>
                <td>{{ e.get('Lugar de nacimiento') }}</td>
                <td>{{ e.get('Numero de Afiliación del IGGS') }}</td>
                <td>{{ e.get('Dirección del Domicilio') }}</td>
                <td>{{ e.get('Numero de Telefono') }}</td>
                <td>{{ e.get('Religión') }}</td>
                <td>{{ e.get('Correo Electronico') }}</td>
                <td>{{ e.get('Puesto de trabajo') }}</td>
                <td>{{ e.get('Tipo de contrato') }}</td>
                <td>{{ e.get('Jornada laboral') }}</td>
                <td>{{ e.get('Duración del trabajo') }}</td>
                <td>{{ e.get('Fecha de inicio laboral') }}</td>
                <td>{{ e.get('Dias Laborales') }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="20" class="text-center text-muted">No hay empleados. Usa "Agregar" para crear la primera fila.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Panel de foto -->
  <div class="mt-4 d-flex justify-content-center">
    <div class="w-100" style="max-width:320px;">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex flex-column align-items-center">
          <h5 class="mb-3">Foto del empleado</h5>

          <div class="mb-3 d-flex justify-content-center w-100">
            <img id="fotoEmpleado"
                 src="{{ url_for('static', filename='imagenes/default.jpg') }}"
                 alt="Foto empleado"
                 class="rounded"
                 style="width:220px;height:220px;object-fit:cover;border:1px solid #ddd;background:#f5f5f5;">
          </div>

          <form id="formSubirFoto" method="post" enctype="multipart/form-data" action="{{ url_for('subir_foto') }}" class="w-100" style="max-width:260px; display:none;">
            <input type="hidden" name="dpi" id="inputDpiForUpload" value="">
            <div class="form-group mb-2">
              <input id="fileFoto" name="foto" type="file" accept="image/*" class="form-control form-control-sm">
            </div>
            <button id="btnSubirFoto" type="button" class="btn btn-primary btn-sm w-100" data-action="subir">Subir foto</button>
          </form>

          <form id="formEliminarFoto" method="post" action="{{ url_for('eliminar_foto') }}" class="w-100" style="max-width:260px; display:none; margin-top:12px;">
            <input type="hidden" name="dpi" id="inputDpiForDelete" value="">
            {# botón siempre visible pero solo realiza acción si rol == admin #}
            <button id="btnEliminarFoto" type="button" class="btn btn-outline-danger btn-sm w-100" data-action="eliminar" data-role-required="admin">Eliminar foto</button>
          </form>

          <small id="fotoHint" class="text-muted mt-3 text-center">
            Selecciona una fila de la tabla para gestionar la foto del empleado.
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/*
  Cambios solicitados:
  - botones siempre habilitados en HTML
  - JS valida rol antes de ejecutar acciones sensibles y muestra mensajes al usuario
  - eliminar foto funciona solo para admin (cliente); servidor debe validar también
*/

(function(){
  // rol inyectado desde servidor (session['rol'])
  const CURRENT_ROLE = ("{{ rol or '' }}").toLowerCase();

  // helper de notificación pequeña
  function flash(msg, type='info') {
    const id = '__home_flash';
    const prev = document.getElementById(id);
    if (prev) prev.remove();
    const d = document.createElement('div');
    d.id = id;
    d.className = `alert alert-${type} py-1 px-2 small position-fixed`;
    d.style.top = '12px';
    d.style.right = '12px';
    d.style.zIndex = 9999;
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(()=> d.remove(), 2200);
  }

  // Intercepta llamadas fetch sensibles y bloquea si rol no tiene permiso (defensa ligera)
  (function installFetchGuard(){
    const orig = window.fetch;
    window.fetch = async function(input, init){
      try {
        const url = (typeof input === 'string') ? input : (input && input.url) || '';
        const method = (init && init.method) ? init.method.toUpperCase() : 'GET';

        // examina cuerpo (JSON/FormData/URLSearchParams)
        let bodyObj = null;
        if (init && init.body) {
          if (typeof init.body === 'string') {
            try { bodyObj = JSON.parse(init.body); } catch(e){}
          } else if (init.body instanceof FormData) {
            bodyObj = {};
            for (const [k,v] of init.body.entries()) bodyObj[k]=v;
          } else if (init.body instanceof URLSearchParams) {
            bodyObj = {};
            for (const [k,v] of init.body.entries()) bodyObj[k]=v;
          }
        }

        // regla: /guardar_empleado -> si no es admin y no viene nuevo=true => bloquear (cliente)
        if (url.includes('/guardar_empleado')) {
          if (CURRENT_ROLE !== 'admin') {
            const isNew = Boolean(bodyObj && (bodyObj.nuevo === true || bodyObj.nuevo === 'true' || bodyObj.nuevo === '1' || bodyObj.nuevo === 1));
            if (!isNew) {
              flash('Permisos insuficientes para editar registros', 'warning');
              return new Response(JSON.stringify({ mensaje: 'Permisos insuficientes (cliente)' }), { status: 403, headers: { 'Content-Type': 'application/json' }});
            }
          }
        }

        // regla: eliminar_foto -> solo admin
        if (url.includes('/eliminar_foto')) {
          if (CURRENT_ROLE !== 'admin') {
            flash('Permisos insuficientes para eliminar foto', 'warning');
            return new Response(JSON.stringify({ error: 'Permisos insuficientes (cliente)' }), { status: 403, headers: { 'Content-Type': 'application/json' }});
          }
        }

        // regla: PUT /api/empleado/:dpi -> solo admin
        if (method === 'PUT' && url.match(/\/api\/empleado\/[^\/]+$/)) {
          if (CURRENT_ROLE !== 'admin') {
            flash('Permisos insuficientes para modificar empleado (cliente)', 'warning');
            return new Response(JSON.stringify({ mensaje: 'Permisos insuficientes (cliente)' }), { status: 403, headers: { 'Content-Type': 'application/json' }});
          }
        }
      } catch (e) {
        // si algo falla en el guard, dejamos pasar la petición al fetch original
      }
      return orig.apply(this, arguments);
    };
  })();


  function clearSelection() {
  tabla.querySelectorAll('tbody tr').forEach(r => r.classList.remove('selected'));
}

tabla?.addEventListener('click', (ev) => {
  const tr = ev.target.closest('tr');
  if (!tr || tr.parentElement.tagName !== 'TBODY') return;
  clearSelection();
  tr.classList.add('selected');
  // opcional: actualizar panel foto / inputs DPI si ya lo haces
  const dpi = (tr.cells[0] && tr.cells[0].innerText || '').trim();
  document.getElementById('inputDpiForUpload').value = dpi || '';
  document.getElementById('inputDpiForDelete').value = dpi || '';
});

  // UI: comportamiento de botones (nunca deshabilitados por HTML)
  // btnAgregar siempre hace lo mismo
  document.getElementById('btnAgregar')?.addEventListener('click', (ev) => {
    // delega a tu lógica existente; por ahora mostramos mensaje de UX
    flash('Agregar: abre formulario (UX) — si tu app tiene modal, se debe abrir', 'info');
    // si tienes una función global para iniciar creación, la llamas aquí:
    if (typeof window.iniciarAgregar === 'function') window.iniciarAgregar();
  });

  // btnEditar / btnGuardar: verifican rol antes de ejecutar
  document.getElementById('btnEditar')?.addEventListener('click', (ev) => {
    if (CURRENT_ROLE !== 'admin') {
      flash('Permisos insuficientes para editar registros', 'warning');
      return;
    }
    // llama a la lógica de edición de tu app (ej. activar edición de fila seleccionada)
    if (typeof window.iniciarEdicion === 'function') window.iniciarEdicion();
    else flash('Editar: acción iniciada', 'info');
  });

  document.getElementById('btnGuardar')?.addEventListener('click', async (ev) => {
    if (CURRENT_ROLE !== 'admin') {
      flash('Permisos insuficientes para guardar cambios', 'warning');
      return;
    }
    // tu lógica para recolectar datos y enviar a /guardar_empleado
    if (typeof window.guardarCambios === 'function') {
      try {
        await window.guardarCambios();
      } catch (e) {
        flash('Error al guardar', 'danger');
      }
    } else {
      flash('Guardar: acción ejecutada (implementa window.guardarCambios)', 'info');
    }
  });

  document.getElementById('btnCancelar')?.addEventListener('click', (ev) => {
    if (typeof window.cancelarEdicion === 'function') window.cancelarEdicion();
    else flash('Cancelar: acción ejecutada', 'info');
  });

  // Foto: selección de fila y muestra de formularios
  const TABLE_ID = 'tablaEmpleados';
  const tabla = document.getElementById(TABLE_ID);
  const fotoEmpleado = document.getElementById('fotoEmpleado');
  const formSubir = document.getElementById('formSubirFoto');
  const formEliminar = document.getElementById('formEliminarFoto');
  const inputDpiUpload = document.getElementById('inputDpiForUpload');
  const inputDpiDelete = document.getElementById('inputDpiForDelete');
  const fileFoto = document.getElementById('fileFoto');

  function clearPhotoPanel() {
    if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
    if (formSubir) formSubir.style.display = 'none';
    if (formEliminar) formEliminar.style.display = 'none';
    if (fileFoto) fileFoto.value = '';
    if (inputDpiUpload) inputDpiUpload.value = '';
    if (inputDpiDelete) inputDpiDelete.value = '';
  }
  const btnEliminar = document.getElementById('btnEliminar');
if (btnEliminar) {
  btnEliminar.addEventListener('click', async () => {
    // seguridad cliente: role inyectado desde plantilla
    const CURRENT_ROLE = ("{{ rol or '' }}").toLowerCase();
    if (CURRENT_ROLE !== 'admin') {
      flash('Permisos insuficientes para eliminar empleados', 'warning');
      return;
    }

    // buscar fila seleccionada
    const tr = tabla.querySelector('tbody tr.selected');
    if (!tr) {
      flash('Debes seleccionar una fila antes de eliminar', 'warning');
      return;
    }

    const dpi = (tr.cells[0] && tr.cells[0].innerText || '').trim();
    if (!dpi) {
      flash('No se pudo obtener el DPI de la fila seleccionada', 'danger');
      return;
    }

    if (!confirm(`¿Estás seguro de eliminar al empleado con DPI ${dpi}? Esta acción no se puede deshacer.`)) return;

    try {
      const res = await fetch('/eliminar_empleado', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dpi })
      });
      const j = await res.json().catch(()=>({}));

      if (res.ok) {
        flash(j.mensaje || 'Empleado eliminado', 'success');
        tr.remove();
        // limpia panel foto si usas uno
        const fotoEmpleado = document.getElementById('fotoEmpleado');
        if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
      } else {
        flash(j.mensaje || j.error || 'Error al eliminar', 'danger');
      }
    } catch (err) {
      flash('Error al eliminar: ' + (err.message || err), 'danger');
    }
  });
}


  tabla?.addEventListener('click', async (ev) => {
    const tr = ev.target.closest('tr');
    if (!tr || tr.parentElement.tagName !== 'TBODY') return;
    const dpi = (tr.cells[0] && tr.cells[0].innerText || '').trim();
    if (!dpi) { clearPhotoPanel(); return; }
    if (inputDpiUpload) inputDpiUpload.value = dpi;
    if (inputDpiDelete) inputDpiDelete.value = dpi;

    // request foto
    try {
      const res = await fetch(`/api/foto/${encodeURIComponent(dpi)}`, { cache: 'no-store' });
      if (!res.ok) throw new Error('no-photo');
      const j = await res.json();
      if (j && j.url) {
        if (fotoEmpleado) fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
        if (formSubir) formSubir.style.display = 'none';
        if (formEliminar) formEliminar.style.display = 'block';
      } else {
        if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
        if (formSubir) formSubir.style.display = 'block';
        if (formEliminar) formEliminar.style.display = 'none';
      }
    } catch (e) {
      if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
      if (formSubir) formSubir.style.display = 'block';
      if (formEliminar) formEliminar.style.display = 'none';
    }
  });

  // subir foto (permitido para ambos roles)
  document.getElementById('btnSubirFoto')?.addEventListener('click', async () => {
    const dpi = inputDpiUpload && inputDpiUpload.value && inputDpiUpload.value.trim();
    if (!dpi) return flash('Selecciona una fila con DPI antes de subir foto', 'danger');
    if (!fileFoto || !fileFoto.files || !fileFoto.files[0]) return flash('Selecciona un archivo de imagen', 'danger');

    const fd = new FormData();
    fd.append('dpi', dpi);
    fd.append('foto', fileFoto.files[0]);

    try {
      const res = await fetch(formSubir.action || '/subir_foto', { method: 'POST', body: fd });
      if (!res.ok) {
        const t = await res.text().catch(()=>null);
        throw new Error(`${res.status} ${t||res.statusText}`);
      }
      const j = await res.json();
      if (j && j.url) {
        if (fotoEmpleado) fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
        if (formSubir) formSubir.style.display = 'none';
        if (formEliminar) formEliminar.style.display = 'block';
        flash('Foto subida', 'success');
      } else throw new Error('Respuesta inesperada');
    } catch (err) {
      flash('Error al subir foto: ' + (err.message||err), 'danger');
    }
  });

  // eliminar foto (SOLO admin puede proceder; cliente bloquea y muestra mensaje)
  document.getElementById('btnEliminarFoto')?.addEventListener('click', async () => {
    const dpi = inputDpiDelete && inputDpiDelete.value && inputDpiDelete.value.trim();
    if (!dpi) return flash('No hay DPI seleccionado', 'danger');

    if (CURRENT_ROLE !== 'admin') {
      flash('Permisos insuficientes para eliminar foto', 'warning');
      return;
    }

    try {
      const res = await fetch(formEliminar.action || '/eliminar_foto', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dpi })
      });
      if (!res.ok) {
        const t = await res.text().catch(()=>null);
        throw new Error(`${res.status} ${t||res.statusText}`);
      }
      if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
      if (formSubir) formSubir.style.display = 'block';
      if (formEliminar) formEliminar.style.display = 'none';
      flash('Foto eliminada', 'success');
    } catch (err) {
      flash('Error al eliminar foto', 'danger');
    }
  });

  // mantener hooks de registrarTabla si existen en tu app
  function tryRegister(retries = 20){
    if (window.registrarTabla && typeof window.registrarTabla === 'function') {
      window.registrarTabla('tablaEmpleados', 20, '/guardar_empleado', [
        "Numero de DPI","Nombre","Apellidos","Apellidos de casada","Estado Civil",
        "Nacionalidad","Departamento","Fecha de nacimiento","Lugar de nacimiento",
        "Numero de Afiliación del IGGS","Dirección del Domicilio","Numero de Telefono",
        "Religión","Correo Electronico","Puesto de trabajo","Tipo de contrato",
        "Jornada laboral","Duración del trabajo","Fecha de inicio laboral","Dias Laborales"
      ], []);
      // no forzamos estados disabled en botones; la app puede activar vistas/edición por selección
      return;
    }
    if (retries <= 0) return;
    setTimeout(()=> tryRegister(retries-1), 100);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ()=>tryRegister(20));
  else tryRegister(20);

})();

</script>

{% endblock %}
