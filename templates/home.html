{% extends "layout.html" %}
{% block title %}Datos Personales{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Jumbotron solo con el encabezado -->
  <div class="jumbotron p-4 rounded-3 bg-white shadow-sm mb-3">
    <div class="d-flex flex-column flex-md-row align-items-start gap-3">
      <div class="flex-grow-1">
        <h1 class="h3 mb-1">Datos personales</h1>
        <p class="text-muted mb-0">Lista de empleados y foto del empleado seleccionado</p>
      </div>
    </div>
  </div>


<div class="card shadow-sm border-0 bg-white">
    <div class="card-body p-3">
      <!-- Botones y tabla (tabla ocupa todo el ancho del fondo blanco) -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="btn-group">
          <button id="btnAgregar" class="btn btn-success btn-sm">Agregar</button>
          <button id="btnEditar" class="btn btn-primary btn-sm" disabled>Editar</button>
          <button id="btnGuardar" class="btn btn-success btn-sm" disabled>Guardar</button>
          <button id="btnCancelar" class="btn btn-secondary btn-sm" disabled>Cancelar</button>
        </div>
      </div>

      <div class="table-responsive">
        <table id="tablaEmpleados" class="table table-sm table-hover table-bordered w-100 mb-0">
          <thead class="small" style="background-color:#000000; color:#ffffff;">
                  <tr>
                    <th>DPI</th>
                    <th>Nombre</th>
                    <th>Apellidos</th>
                    <th>Apellidos de casada</th>
                    <th>Estado Civil</th>
                    <th>Nacionalidad</th>
                    <th>Departamento</th>
                    <th>Fecha de nacimiento</th>
                    <th>Lugar de nacimiento</th>
                    <th>Numero IGSS</th>
                    <th>Dirección</th>
                    <th>Telefono</th>
                    <th>Religión</th>
                    <th>Correo</th>
                    <th>Puesto</th>
                    <th>Tipo de contrato</th>
                    <th>Jornada laboral</th>
                    <th>Duración del trabajo</th>
                    <th>Fecha de inicio laboral</th>
                    <th>Dias Laborales</th>
                  </tr>
                </thead>
                <tbody class="small">
                  {% if empleados %}
                    {% for e in empleados %}
                    <tr>
                      <td>{{ e['Numero de DPI'] }}</td>
                      <td>{{ e.get('Nombre') }}</td>
                      <td>{{ e.get('Apellidos') }}</td>
                      <td>{{ e.get('Apellidos de casada') }}</td>
                      <td>{{ e.get('Estado Civil') }}</td>
                      <td>{{ e.get('Nacionalidad') }}</td>
                      <td>{{ e.get('Departamento') }}</td>
                      <td>{{ e.get('Fecha de nacimiento') }}</td>
                      <td>{{ e.get('Lugar de nacimiento') }}</td>
                      <td>{{ e.get('Numero de Afiliación del IGGS') }}</td>
                      <td>{{ e.get('Dirección del Domicilio') }}</td>
                      <td>{{ e.get('Numero de Telefono') }}</td>
                      <td>{{ e.get('Religión') }}</td>
                      <td>{{ e.get('Correo Electronico') }}</td>
                      <td>{{ e.get('Puesto de trabajo') }}</td>
                      <td>{{ e.get('Tipo de contrato') }}</td>
                      <td>{{ e.get('Jornada laboral') }}</td>
                      <td>{{ e.get('Duración del trabajo') }}</td>
                      <td>{{ e.get('Fecha de inicio laboral') }}</td>
                      <td>{{ e.get('Dias Laborales') }}</td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="20" class="text-center text-muted">No hay empleados. Usa "Agregar" para crear la primera fila.</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel de foto -->
   <div class="mt-4 d-flex justify-content-center">
        <div class="w-100" style="max-width:320px;">
          <div class="card shadow-sm border-0">
            <div class="card-body d-flex flex-column align-items-center">
              <h5 class="mb-3">Foto del empleado</h5>

            <div class="mb-3 d-flex justify-content-center w-100">
              <img id="fotoEmpleado"
                   src="{{ url_for('static', filename='imagenes/default.jpg') }}"
                   alt="Foto empleado"
                   class="rounded"
                   style="width:220px;height:220px;object-fit:cover;border:1px solid #ddd;background:#f5f5f5;">
            </div>

            <form id="formSubirFoto" method="post" enctype="multipart/form-data" action="{{ url_for('subir_foto') }}" class="w-100" style="max-width:260px; display:none;">
              <input type="hidden" name="dpi" id="inputDpiForUpload" value="">
              <div class="form-group mb-2">
                <input id="fileFoto" name="foto" type="file" accept="image/*" class="form-control form-control-sm">
              </div>
              <button id="btnSubirFoto" type="button" class="btn btn-primary btn-sm w-100">Subir foto</button>
            </form>

            <form id="formEliminarFoto" method="post" action="{{ url_for('eliminar_foto') }}" class="w-100" style="max-width:260px; display:none; margin-top:12px;">
              <input type="hidden" name="dpi" id="inputDpiForDelete" value="">
              <button id="btnEliminarFoto" type="button" class="btn btn-outline-danger btn-sm w-100">Eliminar foto</button>
            </form>

            <small id="fotoHint" class="text-muted mt-3 text-center">
              Selecciona una fila de la tabla para gestionar la foto del empleado.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Register table with shared main.js like about/emergencia pages.
  // Keep DPI/Nombre/Apellidos editable in home (no bloqueadas).
  const TABLE_ID = 'tablaEmpleados';
  const ENDPOINT = '/guardar_empleado';
  const COLUMNS = 20;
  const BLOQUEADAS = []; // home: no locked columns

  const CAMPOS = [
    "Numero de DPI","Nombre","Apellidos","Apellidos de casada","Estado Civil",
    "Nacionalidad","Departamento","Fecha de nacimiento","Lugar de nacimiento",
    "Numero de Afiliación del IGGS","Dirección del Domicilio","Numero de Telefono",
    "Religión","Correo Electronico","Puesto de trabajo","Tipo de contrato",
    "Jornada laboral","Duración del trabajo","Fecha de inicio laboral","Dias Laborales"
  ];

  // Track last clicked row so we can correctly update the "original DPI" marker that backend/registrarTabla might need.
  // Problem being solved: when the user edits the DPI cell, some registration/save logic may still use the original DPI stored elsewhere to find the DB row.
  // We update a data-original-dpi attribute on the TR before the save operation so the backend receives the new DPI as key.
  let lastClickedRow = null;

  function tryRegister(retries = 20){
    if (window.registrarTabla && typeof window.registrarTabla === 'function') {
      // Wrap registrarTabla call so we can perform DPI-fix before any "save" is triggered by the shared main.js
      window.registrarTabla(TABLE_ID, COLUMNS, ENDPOINT, CAMPOS, BLOQUEADAS);

      // set initial button states like other pages (main.js will wire handlers)
      const btnAgregar = document.getElementById('btnAgregar');
      const btnEditar  = document.getElementById('btnEditar');
      const btnGuardar = document.getElementById('btnGuardar');
      const btnCancelar= document.getElementById('btnCancelar');
      if (btnAgregar) btnAgregar.disabled = false;
      if (btnEditar)  btnEditar.disabled = true;
      if (btnGuardar) btnGuardar.disabled = true;
      if (btnCancelar) btnCancelar.disabled = true;

      // attach photo selection & controls
      attachPhotoSelection();
      attachPhotoControls();

      // Attach helpers to reliably capture row selection and ensure DPI edited is preserved on save
      attachRowClickTracker();
      attachPreSaveDpiSync();

      return;
    }
    if (retries <= 0) {
      console.error('registrarTabla no disponible para tablaEmpleados');
      return;
    }
    setTimeout(()=> tryRegister(retries - 1), 100);
  }

  // Photo panel behaviour: select row -> request /api/foto/:dpi and show/hide upload/delete
  function attachPhotoSelection(){
    const tabla = document.getElementById(TABLE_ID);
    if (!tabla) return;
    tabla.addEventListener('click', async (ev) => {
      const tr = ev.target.closest('tr');
      if (!tr || tr.parentElement.tagName !== 'TBODY') return;

      // record last clicked row (used by save sync)
      lastClickedRow = tr;

      // mark visual selection if main script doesn't do it
      Array.from(tr.parentElement.children).forEach(r => r.classList.remove('table-active','selected'));
      tr.classList.add('table-active','selected');

      const dpi = (tr.cells[0] && tr.cells[0].innerText || '').trim();
      const fotoEmpleado = document.getElementById('fotoEmpleado');
      const inputDpiUpload = document.getElementById('inputDpiForUpload');
      const inputDpiDelete = document.getElementById('inputDpiForDelete');
      const formSubir = document.getElementById('formSubirFoto');
      const formEliminar = document.getElementById('formEliminarFoto');
      const fileFoto = document.getElementById('fileFoto');

      if (inputDpiUpload) inputDpiUpload.value = dpi || '';
      if (inputDpiDelete) inputDpiDelete.value = dpi || '';

      if (!dpi) {
        if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
        if (formSubir) formSubir.style.display = "none";
        if (formEliminar) formEliminar.style.display = "none";
        if (fileFoto) fileFoto.value = "";
        return;
      }

      try {
        const r = await fetch(`/api/foto/${encodeURIComponent(dpi)}`, { cache: 'no-store' });
        if (!r.ok) throw new Error('no-photo');
        const j = await r.json();
        if (j && j.url) {
          if (fotoEmpleado) fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
          if (formSubir) formSubir.style.display = "none";
          if (formEliminar) formEliminar.style.display = "block";
        } else {
          if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
          if (formSubir) formSubir.style.display = "block";
          if (formEliminar) formEliminar.style.display = "none";
          if (fileFoto) fileFoto.value = "";
        }
      } catch (err) {
        if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
        if (formSubir) formSubir.style.display = "block";
        if (formEliminar) formEliminar.style.display = "none";
        if (fileFoto) fileFoto.value = "";
      }
    });
  }

  // Photo upload/delete handlers (idempotent)
  function attachPhotoControls(){
    const fileFoto = document.getElementById('fileFoto');
    if (fileFoto && !fileFoto.dataset.attached) {
      fileFoto.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f || !f.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (ev) => { const fotoEmpleado = document.getElementById('fotoEmpleado'); if (fotoEmpleado) fotoEmpleado.src = ev.target.result; };
        reader.readAsDataURL(f);
      });
      fileFoto.dataset.attached = '1';
    }

    const btnSubirFoto = document.getElementById('btnSubirFoto');
    const formSubir = document.getElementById('formSubirFoto');
    const inputDpiUpload = document.getElementById('inputDpiForUpload');
    if (btnSubirFoto && !btnSubirFoto.dataset.attached) {
      btnSubirFoto.addEventListener('click', async () => {
        const dpi = inputDpiUpload && inputDpiUpload.value && inputDpiUpload.value.trim();
        const fileFotoEl = document.getElementById('fileFoto');
        if (!dpi) return flash('Selecciona una fila con DPI antes de subir foto', 'danger');
        if (!fileFotoEl || !fileFotoEl.files || !fileFotoEl.files[0]) return flash('Selecciona un archivo de imagen', 'danger');
        const fd = new FormData();
        fd.append('dpi', dpi);
        fd.append('foto', fileFotoEl.files[0]);
        try {
          const res = await fetch(formSubir.action || '/subir_foto', { method: 'POST', body: fd });
          if (!res.ok) {
            const t = await res.text().catch(()=>null);
            throw new Error(`${res.status} ${t||res.statusText}`);
          }
          const j = await res.json();
          if (j && j.url) {
            const fotoEmpleado = document.getElementById('fotoEmpleado');
            if (fotoEmpleado) fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
            if (formSubir) formSubir.style.display = "none";
            const formEliminar = document.getElementById('formEliminarFoto');
            if (formEliminar) formEliminar.style.display = "block";
            flash('Foto subida', 'success');
          } else throw new Error('Respuesta inesperada del servidor');
        } catch (err) {
          flash('Error al subir foto: ' + (err.message||err), 'danger');
        }
      });
      btnSubirFoto.dataset.attached = '1';
    }

    const btnEliminarFoto = document.getElementById('btnEliminarFoto');
    const formEliminar = document.getElementById('formEliminarFoto');
    const inputDpiDelete = document.getElementById('inputDpiForDelete');
    if (btnEliminarFoto && !btnEliminarFoto.dataset.attached) {
      btnEliminarFoto.addEventListener('click', async () => {
        const dpi = inputDpiDelete && inputDpiDelete.value && inputDpiDelete.value.trim();
        if (!dpi) return flash('No hay DPI seleccionado', 'danger');
        try {
          const res = await fetch(formEliminar.action || '/eliminar_foto', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dpi })
          });
          if (!res.ok) throw new Error('error');
          const fotoEmpleado = document.getElementById('fotoEmpleado');
          if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
          if (formSubir) formSubir.style.display = "block";
          if (formEliminar) formEliminar.style.display = "none";
          flash('Foto eliminada', 'success');
        } catch (err) {
          flash('Error al eliminar foto', 'danger');
        }
      });
      btnEliminarFoto.dataset.attached = '1';
    }
  }

  // small flash helper used here
  function flash(msg, type='info') {
    const id = '__home_flash';
    const prev = document.getElementById(id);
    if (prev) prev.remove();
    const d = document.createElement('div');
    d.id = id;
    d.className = `alert alert-${type} py-1 px-2 small position-fixed`;
    d.style.top = '12px';
    d.style.right = '12px';
    d.style.zIndex = 9999;
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(()=> d.remove(), 2000);
  }

  // expose flash for inner handlers
  window.__home_flash = { flash };

  //
  // ------- NEW: helpers to ensure DPI edits persist -------
  //
  // Strategy:
  // 1) Track the last clicked row so we know which row user intends to edit/save (lastClickedRow).
  // 2) Before the shared save logic executes (most pages wire save to #btnGuardar), we synchronize a dataset marker
  //    on the TR element that many backend/updater helpers use as the "original key" (data-original-dpi).
  //    We also ensure the first cell contains the current edited DPI text (in case registrarTabla reads cell text).
  // 3) This is a minimal, defensive patch that does not change registrarTabla internals but ensures the save operation
  //    has the correct DPI value to update the existing record instead of using the stale/original DPI.
  //

  // Attach click tracker to tbody rows (if not already handled above in photo selection)
  function attachRowClickTracker(){
    const tabla = document.getElementById(TABLE_ID);
    if (!tabla) return;
    const tbody = tabla.querySelector('tbody');
    if(!tbody) return;

    // Track clicks anywhere inside tbody rows (covers selection and editing)
    tbody.addEventListener('click', (ev) => {
      const tr = ev.target.closest('tr');
      if (!tr) return;
      lastClickedRow = tr;
      // If registrarTabla or other code marks selection differently, we still mark visually to help user.
      Array.from(tbody.children).forEach(r => r.classList.remove('table-active','selected'));
      tr.classList.add('table-active','selected');
    });

    // Also track focusin on cells (useful when cells are contenteditable)
    tbody.addEventListener('focusin', (ev) => {
      const tr = ev.target.closest('tr');
      if(tr) lastClickedRow = tr;
    }, true);
  }

  // Before save, sync DPI value into a data-original-dpi attribute so server/updater can find the row by new DPI.
  // We hook the #btnGuardar click which is used on this page to submit edits; this is defensive and idempotent.
  function attachPreSaveDpiSync(){
    const btnGuardar = document.getElementById('btnGuardar');
    if(!btnGuardar) return;

    // Only attach once
    if(btnGuardar.dataset.dpiSyncAttached) return;
    btnGuardar.dataset.dpiSyncAttached = '1';

    btnGuardar.addEventListener('click', () => {
      try {
        // Find the selected row (prefer explicit lastClickedRow), fall back to any .table-active or .selected row
        let tr = lastClickedRow;
        if(!tr) {
          const tabla = document.getElementById(TABLE_ID);
          if(tabla) {
            tr = tabla.querySelector('tbody tr.table-active, tbody tr.selected') || tabla.querySelector('tbody tr');
          }
        }
        if(!tr) return;

        // Read the first cell text (current DPI edited by user)
        const firstCell = tr.cells && tr.cells[0];
        const currentDpi = firstCell && String(firstCell.innerText || firstCell.textContent || '').trim();

        // Set a dataset marker with the current DPI so server/updater uses it as key (many implementations look for a row attribute)
        if(currentDpi) {
          tr.dataset.originalDpi = currentDpi;
          // also set a standard attribute name sometimes used by helpers
          tr.setAttribute('data-original-dpi', currentDpi);
          // ensure the visible first cell contains the exact DPI value (removes accidental whitespace)
          if(firstCell) firstCell.innerText = currentDpi;
        }
      } catch(e){
        // don't block saving if anything goes wrong; log for developer
        console.error('pre-save DPI sync failed', e);
      }
    });
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ()=>tryRegister(20));
  else tryRegister(20);

})();
</script>

{% endblock %}
