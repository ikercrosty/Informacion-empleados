{% extends "layout.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="jumbotron p-4 rounded-3 bg-white shadow-sm">
    <div class="d-flex flex-column flex-md-row align-items-start gap-3">
      <div class="flex-grow-1">
        <h1 class="h3 mb-1">Datos personales</h1>
        <p class="text-muted mb-0">Lista de empleados y foto del empleado seleccionado</p>
      </div>
    </div>

    <hr class="my-3">

    <div class="row g-3">
      <!-- Tabla -->
      <div class="col-12 col-lg-9">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body p-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="btn-group">
                <button id="btnAgregar" class="btn btn-success btn-sm">Agregar</button>
                <button id="btnEditar" class="btn btn-primary btn-sm" disabled>Editar</button>
                <button id="btnGuardar" class="btn btn-success btn-sm" disabled>Guardar</button>
                <button id="btnCancelar" class="btn btn-secondary btn-sm" disabled>Cancelar</button>
              </div>
            </div>

            <div class="table-responsive">
              <table id="tablaEmpleados" class="table table-sm table-hover table-bordered w-100 mb-0">
                <thead class="small" style="background-color:#000000; color:#ffffff;">
                  <tr>
                    <th>DPI</th>
                    <th>Nombre</th>
                    <th>Apellidos</th>
                    <th>Apellidos de casada</th>
                    <th>Estado Civil</th>
                    <th>Nacionalidad</th>
                    <th>Departamento</th>
                    <th>Fecha de nacimiento</th>
                    <th>Lugar de nacimiento</th>
                    <th>Numero IGSS</th>
                    <th>Dirección</th>
                    <th>Telefono</th>
                    <th>Religión</th>
                    <th>Correo</th>
                    <th>Puesto</th>
                    <th>Tipo de contrato</th>
                    <th>Jornada laboral</th>
                    <th>Duración del trabajo</th>
                    <th>Fecha de inicio laboral</th>
                    <th>Dias Laborales</th>
                  </tr>
                </thead>
                <tbody class="small">
                  {% if empleados %}
                    {% for e in empleados %}
                    <tr>
                      <td>{{ e['Numero de DPI'] }}</td>
                      <td>{{ e.get('Nombre') }}</td>
                      <td>{{ e.get('Apellidos') }}</td>
                      <td>{{ e.get('Apellidos de casada') }}</td>
                      <td>{{ e.get('Estado Civil') }}</td>
                      <td>{{ e.get('Nacionalidad') }}</td>
                      <td>{{ e.get('Departamento') }}</td>
                      <td>{{ e.get('Fecha de nacimiento') }}</td>
                      <td>{{ e.get('Lugar de nacimiento') }}</td>
                      <td>{{ e.get('Numero de Afiliación del IGGS') }}</td>
                      <td>{{ e.get('Dirección del Domicilio') }}</td>
                      <td>{{ e.get('Numero de Telefono') }}</td>
                      <td>{{ e.get('Religión') }}</td>
                      <td>{{ e.get('Correo Electronico') }}</td>
                      <td>{{ e.get('Puesto de trabajo') }}</td>
                      <td>{{ e.get('Tipo de contrato') }}</td>
                      <td>{{ e.get('Jornada laboral') }}</td>
                      <td>{{ e.get('Duración del trabajo') }}</td>
                      <td>{{ e.get('Fecha de inicio laboral') }}</td>
                      <td>{{ e.get('Dias Laborales') }}</td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="20" class="text-center text-muted">No hay empleados. Usa "Agregar" para crear la primera fila.</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel de foto -->
      <div class="col-12 col-lg-3 d-flex align-items-start">
        <div class="card shadow-sm border-0 w-100">
          <div class="card-body d-flex flex-column align-items-center">
            <h5 class="mb-3">Foto del empleado</h5>

            <div class="mb-3 d-flex justify-content-center w-100">
              <img id="fotoEmpleado"
                   src="{{ url_for('static', filename='imagenes/default.jpg') }}"
                   alt="Foto empleado"
                   class="rounded"
                   style="width:220px;height:220px;object-fit:cover;border:1px solid #ddd;background:#f5f5f5;">
            </div>

            <form id="formSubirFoto" method="post" enctype="multipart/form-data" action="{{ url_for('subir_foto') }}" class="w-100" style="max-width:260px; display:none;">
              <input type="hidden" name="dpi" id="inputDpiForUpload" value="">
              <div class="form-group mb-2">
                <input id="fileFoto" name="foto" type="file" accept="image/*" class="form-control form-control-sm">
              </div>
              <button id="btnSubirFoto" type="button" class="btn btn-primary btn-sm w-100">Subir foto</button>
            </form>

            <form id="formEliminarFoto" method="post" action="{{ url_for('eliminar_foto') }}" class="w-100" style="max-width:260px; display:none; margin-top:12px;">
              <input type="hidden" name="dpi" id="inputDpiForDelete" value="">
              <button id="btnEliminarFoto" type="button" class="btn btn-outline-danger btn-sm w-100">Eliminar foto</button>
            </form>

            <small id="fotoHint" class="text-muted mt-3 text-center">
              Selecciona una fila de la tabla para gestionar la foto del empleado.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tabla = document.getElementById('tablaEmpleados');
  const fotoEmpleado = document.getElementById('fotoEmpleado');
  const inputDpiUpload = document.getElementById('inputDpiForUpload');
  const inputDpiDelete = document.getElementById('inputDpiForDelete');
  const formSubir = document.getElementById('formSubirFoto');
  const formEliminar = document.getElementById('formEliminarFoto');
  const fileFoto = document.getElementById('fileFoto');

  const btnAgregar = document.getElementById('btnAgregar');
  const btnEditar = document.getElementById('btnEditar');
  const btnGuardar = document.getElementById('btnGuardar');
  const btnCancelar = document.getElementById('btnCancelar');
  const btnSubirFoto = document.getElementById('btnSubirFoto');
  const btnEliminarFoto = document.getElementById('btnEliminarFoto');

  const DEFAULT_SRC = "{{ url_for('static', filename='imagenes/default.jpg') }}";

  let selectedRow = null;
  let originalCells = null;
  let editing = false;
  let isNewRow = false;

  function resetPanelToDefault() {
    if (fotoEmpleado) fotoEmpleado.src = DEFAULT_SRC;
    if (inputDpiUpload) inputDpiUpload.value = "";
    if (inputDpiDelete) inputDpiDelete.value = "";
    if (formSubir) formSubir.style.display = "none";
    if (formEliminar) formEliminar.style.display = "none";
    if (fileFoto) fileFoto.value = "";
    clearSelectionUI();
  }

  function clearSelectionUI() {
    if (selectedRow) selectedRow.classList.remove('table-active');
    selectedRow = null;
    originalCells = null;
    editing = false;
    isNewRow = false;
    if (btnEditar) btnEditar.disabled = true;
    if (btnGuardar) btnGuardar.disabled = true;
    if (btnCancelar) btnCancelar.disabled = true;
  }

  resetPanelToDefault();

  if (fileFoto) {
    fileFoto.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f || !f.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = (ev) => { fotoEmpleado.src = ev.target.result; };
      reader.readAsDataURL(f);
    });
  }

  // PROTECCIÓN: evitar adjuntar el listener dos veces
  if (btnAgregar) {
    if (!btnAgregar.dataset.listenerAttached) {
      btnAgregar.addEventListener('click', () => {
        const tb = tabla.querySelector('tbody');
        if (!tb) { flashMessage('Tabla no disponible. Recarga la página.', 'danger'); return; }

        const placeholder = tb.querySelector('tr td[colspan]');
        if (placeholder) placeholder.parentElement.remove();

        const tr = document.createElement('tr');
        for (let i = 0; i < 20; i++) {
          const td = document.createElement('td');
          td.textContent = '';
          tr.appendChild(td);
        }
        tb.insertBefore(tr, tb.firstChild);

        if (selectedRow) selectedRow.classList.remove('table-active');
        selectedRow = tr;
        selectedRow.classList.add('table-active');
        isNewRow = true;
        startEdit();
      });
      // marque para no adjuntar otra vez si el script se ejecuta dos veces
      btnAgregar.dataset.listenerAttached = '1';
    }
  }

  if (tabla) {
    tabla.addEventListener('click', async (ev) => {
      const tr = ev.target.closest('tr');
      if (!tr || !tr.cells.length) return;

      if (editing && selectedRow && tr !== selectedRow) return;

      if (selectedRow && selectedRow !== tr) selectedRow.classList.remove('table-active');
      selectedRow = tr;
      selectedRow.classList.add('table-active');
      if (btnEditar) btnEditar.disabled = false;
      if (btnGuardar) btnGuardar.disabled = true;
      if (btnCancelar) btnCancelar.disabled = false;

      const dpi = (tr.cells[0] && tr.cells[0].innerText || '').trim();
      if (!dpi) {
        resetPanelToDefault();
        return;
      }
      if (inputDpiUpload) inputDpiUpload.value = dpi;
      if (inputDpiDelete) inputDpiDelete.value = dpi;

      try {
        const r = await fetch(`/api/foto/${encodeURIComponent(dpi)}`, { cache: 'no-store' });
        if (!r.ok) throw new Error('no-photo');
        const j = await r.json();
        if (j && j.url) {
          fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
          if (formSubir) formSubir.style.display = "none";
          if (formEliminar) formEliminar.style.display = "block";
        } else {
          fotoEmpleado.src = DEFAULT_SRC;
          if (formSubir) formSubir.style.display = "block";
          if (formEliminar) formEliminar.style.display = "none";
          if (fileFoto) fileFoto.value = "";
        }
      } catch (err) {
        fotoEmpleado.src = DEFAULT_SRC;
        if (formSubir) formSubir.style.display = "block";
        if (formEliminar) formEliminar.style.display = "none";
        if (fileFoto) fileFoto.value = "";
      }
    });
  }

  document.addEventListener('click', (e) => {
    const insideTable = e.target.closest('#tablaEmpleados');
    const insideControls = e.target.closest('#formSubirFoto') || e.target.closest('#formEliminarFoto') || e.target.closest('#fileFoto');
    if (!insideTable && !insideControls && !editing) {
      resetPanelToDefault();
    }
  });

  function startEdit() {
    if (!selectedRow || editing) return;
    editing = true;
    originalCells = Array.from(selectedRow.cells).map(td => td.innerText);
    selectedRow.querySelectorAll('td').forEach((td, idx) => {
      const text = td.innerText || '';
      if (idx === 0 && !isNewRow) {
        td.innerHTML = `<input class="form-control form-control-sm" value="${escapeHtml(text)}" readonly>`;
      } else {
        td.innerHTML = `<input class="form-control form-control-sm" value="${escapeHtml(text)}">`;
      }
    });
    if (btnEditar) btnEditar.disabled = true;
    if (btnGuardar) btnGuardar.disabled = false;
    if (btnCancelar) btnCancelar.disabled = false;
    const firstEditable = selectedRow.querySelector('td input:not([readonly])');
    if (firstEditable) firstEditable.focus();
  }

  async function saveEdit() {
    if (!selectedRow || !editing) return;
    const inputs = Array.from(selectedRow.querySelectorAll('td input'));
    const dpi = (inputs[0] && inputs[0].value || '').trim();
    if (!dpi) { flashMessage('DPI es obligatorio', 'danger'); return; }

    const payload = {
      "Numero de DPI": dpi,
      "Nombre": inputs[1] ? inputs[1].value.trim() : '',
      "Apellidos": inputs[2] ? inputs[2].value.trim() : '',
      "Apellidos de casada": inputs[3] ? inputs[3].value.trim() : '',
      "Estado Civil": inputs[4] ? inputs[4].value.trim() : '',
      "Nacionalidad": inputs[5] ? inputs[5].value.trim() : '',
      "Departamento": inputs[6] ? inputs[6].value.trim() : '',
      "Fecha de nacimiento": inputs[7] ? inputs[7].value.trim() : '',
      "Lugar de nacimiento": inputs[8] ? inputs[8].value.trim() : '',
      "Numero de Afiliación del IGGS": inputs[9] ? inputs[9].value.trim() : '',
      "Dirección del Domicilio": inputs[10] ? inputs[10].value.trim() : '',
      "Numero de Telefono": inputs[11] ? inputs[11].value.trim() : '',
      "Religión": inputs[12] ? inputs[12].value.trim() : '',
      "Correo Electronico": inputs[13] ? inputs[13].value.trim() : '',
      "Puesto de trabajo": inputs[14] ? inputs[14].value.trim() : '',
      "Tipo de contrato": inputs[15] ? inputs[15].value.trim() : '',
      "Jornada laboral": inputs[16] ? inputs[16].value.trim() : '',
      "Duración del trabajo": inputs[17] ? inputs[17].value.trim() : '',
      "Fecha de inicio laboral": inputs[18] ? inputs[18].value.trim() : '',
      "Dias Laborales": inputs[19] ? inputs[19].value.trim() : ''
    };

    try {
      let res;
      if (!isNewRow) {
        res = await fetch(`/api/empleado/${encodeURIComponent(dpi)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.status === 405) {
          res = await fetch('/api/empleados', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }
      } else {
        res = await fetch('/api/empleados', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }

      if (!res.ok) {
        const txt = await res.text().catch(()=>null);
        throw new Error(`${res.status} ${txt || res.statusText}`);
      }

      selectedRow.querySelectorAll('td').forEach((td, idx) => {
        const v = Object.values(payload)[idx];
        td.innerText = v !== undefined ? v : '';
      });

      editing = false;
      isNewRow = false;
      if (btnGuardar) btnGuardar.disabled = true;
      if (btnEditar) btnEditar.disabled = false;
      flashMessage('Guardado correctamente', 'success');
    } catch (err) {
      flashMessage('Error al guardar: ' + err.message, 'danger');
    }
  }

  function cancelEdit() {
    if (!selectedRow) return;
    if (editing && originalCells) {
      selectedRow.querySelectorAll('td').forEach((td, idx) => {
        td.innerText = originalCells[idx] || '';
      });
    }
    if (isNewRow && selectedRow && selectedRow.parentNode) {
      selectedRow.parentNode.removeChild(selectedRow);
    }
    editing = false;
    isNewRow = false;
    if (btnEditar) btnEditar.disabled = selectedRow ? false : true;
    if (btnGuardar) btnGuardar.disabled = true;
    if (btnCancelar) btnCancelar.disabled = true;
    if (selectedRow) { selectedRow.classList.remove('table-active'); selectedRow = null; }
    resetPanelToDefault();
  }

  if (btnSubirFoto) {
    btnSubirFoto.addEventListener('click', async () => {
      const dpi = inputDpiUpload.value && inputDpiUpload.value.trim();
      if (!dpi) { flashMessage('Selecciona una fila con DPI antes de subir foto', 'danger'); return; }
      if (!fileFoto || !fileFoto.files || !fileFoto.files[0]) { flashMessage('Selecciona un archivo de imagen', 'danger'); return; }

      const fd = new FormData();
      fd.append('dpi', dpi);
      fd.append('foto', fileFoto.files[0]);

      try {
        const res = await fetch(formSubir.action || '/subir_foto', { method: 'POST', body: fd });
        if (!res.ok) {
          const t = await res.text().catch(()=>null);
          throw new Error(`${res.status} ${t||res.statusText}`);
        }
        const j = await res.json();
        if (j && j.url) {
          fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
          formSubir.style.display = "none";
          formEliminar.style.display = "block";
          flashMessage('Foto subida', 'success');
        } else {
          throw new Error('Respuesta inesperada del servidor');
        }
      } catch (err) {
        flashMessage('Error al subir foto: ' + err.message, 'danger');
      }
    });
  }

  if (btnEliminarFoto) {
    btnEliminarFoto.addEventListener('click', async () => {
      const dpi = inputDpiDelete.value && inputDpiDelete.value.trim();
      if (!dpi) { flashMessage('No hay DPI seleccionado', 'danger'); return; }
      try {
        const res = await fetch(formEliminar.action || '/eliminar_foto', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dpi })
        });
        if (!res.ok) throw new Error('error');
        fotoEmpleado.src = DEFAULT_SRC;
        formSubir.style.display = "block";
        formEliminar.style.display = "none";
        flashMessage('Foto eliminada', 'success');
      } catch (err) {
        flashMessage('Error al eliminar foto', 'danger');
      }
    });
  }

  function escapeHtml(str) {
    if (str == null) return '';
    return String(str).replace(/[&<>"'`=\/]/g, function(s) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s];
    });
  }

  function flashMessage(msg, type='info') {
    const existing = document.getElementById('flashMessage');
    if (existing) existing.remove();
    const container = document.createElement('div');
    container.id = 'flashMessage';
    container.className = `alert alert-${type} py-1 px-2 small position-fixed`;
    container.style.top = '16px';
    container.style.right = '16px';
    container.style.zIndex = 2000;
    container.innerText = msg;
    document.body.appendChild(container);
    setTimeout(()=> container.remove(), 3000);
  }

  if (btnEditar) btnEditar.addEventListener('click', startEdit);
  if (btnGuardar) btnGuardar.addEventListener('click', saveEdit);
  if (btnCancelar) btnCancelar.addEventListener('click', cancelEdit);

});
</script>

<script>
  
  function tryRegister(n=20){
    if (window.registrarTabla && typeof window.registrarTabla === 'function') {
      window.registrarTabla(meta.id, meta.cols, meta.endpoint, meta.campos, meta.bloqueadas);
      document.getElementById('btnAgregar').disabled = false;
      document.getElementById('btnEditar').disabled  = true;
      document.getElementById('btnGuardar').disabled = false;
      document.getElementById('btnCancelar').disabled= false;
      return;
    }
    if (n>0) setTimeout(()=>tryRegister(n-1),100);
    else {
      console.error('registrarTabla no disponible para tablaEmpleados');
    }
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ()=>tryRegister(20));
  else tryRegister(20);;
</script>


{% endblock %}
