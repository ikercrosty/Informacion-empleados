{% extends "layout.html" %}
{% block title %}Datos personales{% endblock %}

{% block content %}
<div class="jumbotron">
  <h1 class="display-4">Datos personales</h1>
  <p class="lead">Datos personales del empleado</p>
</div>

<div class="row">
  <!-- Tabla y botones (izquierda) -->
  <div class="col-md-8">
    <div class="mb-3 d-flex flex-wrap">
      <button id="btnAgregar" type="button" class="btn btn-success btn-sm mr-2 mb-2">Agregar</button>
      <button id="btnEditar" type="button" class="btn btn-primary btn-sm mr-2 mb-2" disabled>Editar</button>
      <button id="btnGuardar" type="button" class="btn btn-success btn-sm mr-2 mb-2" disabled>Guardar</button>
      <button id="btnCancelar" type="button" class="btn btn-secondary btn-sm mb-2" disabled>Cancelar</button>
    </div>

    <div class="table-responsive">
      <table id="tablaEmpleados" class="table table-bordered table-striped table-hover table-sm">
        <thead class="thead-dark table-compact">
          <tr>
            <th>DPI</th>
            <th>Nombre</th>
            <th>Apellidos</th>
            <th>Apellidos de casada</th>
            <th>Estado Civil</th>
            <th>Nacionalidad</th>
            <th>Departamento</th>
            <th>Fecha de nacimiento</th>
            <th>Lugar de nacimiento</th>
            <th>Numero IGSS</th>
            <th>Dirección</th>
            <th>Telefono</th>
            <th>Religión</th>
            <th>Correo</th>
            <th>Puesto</th>
            <th>Tipo de contrato</th>
            <th>Jornada laboral</th>
            <th>Duración del trabajo</th>
            <th>Fecha de inicio laboral</th>
            <th>Dias Laborales</th>
          </tr>
        </thead>
        <tbody>
          {% for e in empleados %}
          <tr>
            <td>{{ e['Numero de DPI'] }}</td>
            <td>{{ e.get('Nombre') }}</td>
            <td>{{ e.get('Apellidos') }}</td>
            <td>{{ e.get('Apellidos de casada') }}</td>
            <td>{{ e.get('Estado Civil') }}</td>
            <td>{{ e.get('Nacionalidad') }}</td>
            <td>{{ e.get('Departamento') }}</td>
            <td>{{ e.get('Fecha de nacimiento') }}</td>
            <td>{{ e.get('Lugar de nacimiento') }}</td>
            <td>{{ e.get('Numero de Afiliación del IGGS') }}</td>
            <td>{{ e.get('Dirección del Domicilio') }}</td>
            <td>{{ e.get('Numero de Telefono') }}</td>
            <td>{{ e.get('Religión') }}</td>
            <td>{{ e.get('Correo Electronico') }}</td>
            <td>{{ e.get('Puesto de trabajo') }}</td>
            <td>{{ e.get('Tipo de contrato') }}</td>
            <td>{{ e.get('Jornada laboral') }}</td>
            <td>{{ e.get('Duración del trabajo') }}</td>
            <td>{{ e.get('Fecha de inicio laboral') }}</td>
            <td>{{ e.get('Dias Laborales') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Panel de imagen (derecha) -->
  <div class="col-md-4">
    <div class="card p-3">
      <h5 class="mb-3">Datos personales del empleado</h5>

      <div class="text-center mb-3">
        <img id="fotoEmpleado"
             src="{{ url_for('static', filename='imagenes/default.png') }}"
             alt="Foto empleado"
             class="img-fluid rounded-circle"
             style="width:160px;height:160px;object-fit:cover;">
      </div>

      <!-- Upload controls (ocultos por defecto) -->
      <div id="uploadControls" style="display:none;">
        <form id="formSubirFoto" method="post" action="{{ url_for('subir_foto') }}" enctype="multipart/form-data">
          <input type="hidden" name="dpi" id="inputDpiForUpload" value="">
          <div class="form-group">
            <input id="fileFoto" name="foto" type="file" accept="image/*" class="form-control-file">
          </div>
          <button id="btnSubirFoto" type="submit" class="btn btn-primary btn-block">Subir Foto</button>
        </form>
      </div>

      <!-- Delete control (oculto por defecto) -->
      <div id="deleteControl" style="display:none;">
        <form id="formEliminarFoto" method="post" action="{{ url_for('eliminar_foto') }}">
          <input type="hidden" name="dpi" id="inputDpiForDelete" value="">
          <button id="btnEliminarFoto" type="submit" class="btn btn-outline-danger btn-block">Eliminar Foto</button>
        </form>
      </div>

      <small class="text-muted mt-3 d-block">
        Selecciona una fila de la tabla para gestionar la foto del empleado.
      </small>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tabla = document.getElementById('tablaEmpleados');
  const fotoEmpleado = document.getElementById('fotoEmpleado');
  const inputDpiUpload = document.getElementById('inputDpiForUpload');
  const inputDpiDelete = document.getElementById('inputDpiForDelete');
  const uploadControls = document.getElementById('uploadControls');
  const deleteControl = document.getElementById('deleteControl');
  const fileFoto = document.getElementById('fileFoto');

  const DEFAULT_SRC = "{{ url_for('static', filename='imagenes/default.png') }}";

  function resetPanelToDefault() {
    fotoEmpleado.src = DEFAULT_SRC;
    inputDpiUpload.value = "";
    inputDpiDelete.value = "";
    uploadControls.style.display = "none";
    deleteControl.style.display = "none";
    if (fileFoto) fileFoto.value = "";
  }

  // Estado inicial: no fila seleccionada
  resetPanelToDefault();

  // Preview local cuando el usuario selecciona archivo para subir
  if (fileFoto) {
    fileFoto.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f || !f.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = (ev) => { fotoEmpleado.src = ev.target.result; };
      reader.readAsDataURL(f);
    });
  }

  // Manejo de selección de fila
  if (tabla) {
    tabla.addEventListener('click', (ev) => {
      const tr = ev.target.closest('tr');
      if (!tr || !tr.cells.length) return;
      const dpi = tr.cells[0].innerText.trim();
      if (!dpi) return;

      // Set hidden inputs DPI
      inputDpiUpload.value = dpi;
      inputDpiDelete.value = dpi;

      // Llamar API para validar si existe foto y que el archivo realmente exista
      fetch(`/api/foto/${encodeURIComponent(dpi)}`)
        .then(r => r.json())
        .then(j => {
          // API antigua puede devolver {foto: filename} o nueva versión {foto,url}
          const url = j && (j.url || (j.foto ? `/static/fotos/${j.foto}` : null));
          if (url) {
            // Añadimos una cache-busting query con timestamp para evitar mostrar icono roto por cached 404
            fotoEmpleado.src = `${url}?t=${Date.now()}`;
            uploadControls.style.display = "none";
            deleteControl.style.display = "block";
          } else {
            // No hay foto registrada o no existe en disco
            fotoEmpleado.src = DEFAULT_SRC;
            uploadControls.style.display = "block";
            deleteControl.style.display = "none";
            if (fileFoto) fileFoto.value = "";
          }
        })
        .catch(() => {
          // En caso de error tratamos como sin foto
          fotoEmpleado.src = DEFAULT_SRC;
          uploadControls.style.display = "block";
          deleteControl.style.display = "none";
          if (fileFoto) fileFoto.value = "";
        });
    });
  }

  // Si el usuario hace click fuera de la tabla y fuera de controles, reestablecer estado por defecto
  document.addEventListener('click', (e) => {
    const insideTable = e.target.closest('#tablaEmpleados');
    const insideControls = e.target.closest('#uploadControls') || e.target.closest('#deleteControl');
    if (!insideTable && !insideControls) {
      resetPanelToDefault();
    }
  });
});
</script>
{% endblock %}

