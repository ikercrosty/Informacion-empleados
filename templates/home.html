{% extends "layout.html" %}
{% block title %}Detalles personales{% endblock %}

{% block content %}
<div class="row">
  <!-- Título claro y consistente -->
  <div class="col-12">
    <h3 class="planilla-title mb-3">Detalles personales</h3>
  </div>

  <!-- Tabla de empleados -->
  <div class="col-md-8">
    <!-- Botones: restaurados a estilo original (oscuro) -->
    <div class="d-flex mb-3">
      <button id="btnAgregar" class="btn btn-dark mr-2">Agregar</button>
      <button id="btnEditar" class="btn btn-secondary mr-2" disabled>Editar</button>
      <button id="btnGuardar" class="btn btn-success mr-2" disabled>Guardar</button>
      <button id="btnCancelar" class="btn btn-danger" disabled>Cancelar</button>
    </div>

    <div class="table-responsive">
      <table id="tablaEmpleados" class="table table-striped table-bordered">
        <!-- Encabezados en negro (Bootstrap thead-dark) -->
        <thead class="thead-dark">
          <tr>
            <th>DPI</th>
            <th>Nombre</th>
            <th>Apellidos</th>
            <th>Estado Civil</th>
            <th>Nacionalidad</th>
            <th>Departamento</th>
            <th>Fecha de nacimiento</th>
          </tr>
        </thead>
        <tbody>
          {% for e in empleados %}
          <tr>
            <td>{{ e['Numero de DPI'] }}</td>
            <td>{{ e['Nombre'] }}</td>
            <td>{{ e['Apellidos'] }}</td>
            <td>{{ e['Estado Civil'] }}</td>
            <td>{{ e['Nacionalidad'] }}</td>
            <td>{{ e['Departamento'] }}</td>
            <td>{{ e['Fecha de nacimiento'] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Panel de foto del empleado (tal como lo dejaste, sin cambios funcionales) -->
  <div class="col-md-4">
    <div class="card p-3">
      <h5 class="mb-3">Foto del Empleado</h5>

      <!-- Preview inicial: usa la primera foto disponible, si no default -->
      <div class="text-center mb-3">
        {% set inicial = empleados[0]['foto'] if empleados and empleados[0]['foto'] else None %}
        {% if inicial %}
          <img id="fotoEmpleado" src="{{ url_for('static', filename='fotos/' ~ inicial) }}"
               alt="Foto empleado" class="img-fluid rounded-circle"
               style="width:160px;height:160px;object-fit:cover;">
        {% else %}
          <img id="fotoEmpleado" src="{{ url_for('static', filename='imagenes/default.png') }}"
               alt="Foto empleado" class="img-fluid rounded-circle"
               style="width:160px;height:160px;object-fit:cover;">
        {% endif %}
      </div>

      <!-- Subir foto: DPI por hidden (ruta sin parámetro en URL) -->
      <form id="formSubirFoto" method="post" action="{{ url_for('subir_foto') }}" enctype="multipart/form-data">
        <input type="hidden" name="dpi" id="inputDpiForUpload" value="{{ empleados[0]['Numero de DPI'] if empleados else '' }}">
        <div class="form-group">
          <input id="fileFoto" name="foto" type="file" accept="image/*" class="form-control-file">
        </div>
        <button id="btnSubirFoto" type="submit" class="btn btn-primary btn-block">Subir Foto</button>
      </form>

      <!-- Eliminar foto -->
      <form id="formEliminarFoto" method="post" action="{{ url_for('eliminar_foto') }}" class="mt-2">
        <input type="hidden" name="dpi" id="inputDpiForDelete" value="{{ empleados[0]['Numero de DPI'] if empleados else '' }}">
        <button id="btnEliminarFoto" type="submit" class="btn btn-outline-danger btn-block">Eliminar Foto</button>
      </form>

      <small class="text-muted mt-3 d-block">
        Consejo: selecciona una fila de la tabla para cargar/actualizar la foto de ese DPI.
      </small>
    </div>
  </div>
</div>

<!-- JS: preview, selección de DPI y carga desde API -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tabla = document.getElementById('tablaEmpleados');
    const fotoEmpleado = document.getElementById('fotoEmpleado');
    const inputDpiUpload = document.getElementById('inputDpiForUpload');
    const inputDpiDelete = document.getElementById('inputDpiForDelete');
    const fileFoto = document.getElementById('fileFoto');

    // Preview inmediato al seleccionar archivo
    if (fileFoto && fotoEmpleado) {
      fileFoto.addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (!f || !f.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (ev) => { fotoEmpleado.src = ev.target.result; };
        reader.readAsDataURL(f);
      });
    }

    // Al hacer click en una fila, actualiza DPI y busca foto en API
    if (tabla && fotoEmpleado && inputDpiUpload && inputDpiDelete) {
      tabla.addEventListener('click', (ev) => {
        const tr = ev.target.closest('tr');
        if (!tr || !tr.cells.length) return;
        const dpi = tr.cells[0].innerText.trim();
        if (!dpi) return;

        inputDpiUpload.value = dpi;
        inputDpiDelete.value = dpi;

        fetch(`/api/foto/${encodeURIComponent(dpi)}`)
          .then(r => r.json())
          .then(j => {
            if (j && j.foto) {
              fotoEmpleado.src = `/static/fotos/${j.foto}`;
            } else {
              fotoEmpleado.src = `{{ url_for('static', filename='imagenes/default.png') }}`;
            }
          })
          .catch(() => {
            fotoEmpleado.src = `{{ url_for('static', filename='imagenes/default.png') }}`;
          });
      });
    }
  });
</script>
{% endblock %}
