{% extends "layout.html" %}
{% block title %}Datos Personales{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Jumbotron -->
  <div class="jumbotron-welcome rounded-3 mb-3">
    <div class="d-flex flex-column flex-md-row align-items-center gap-3">
      <div class="flex-grow-1">
        <h1 class="h3 mb-1" style="letter-spacing: .2px; font-weight:700; color:#0b486b;">
          Datos personales
        </h1>
        <p class="text-muted mb-2" style="font-size:0.95rem;">
          Lista de empleados y foto del empleado seleccionado
        <br>
        <br>
        <br>
        </p>

        <h4 class="text-align = left" style="font-size:0.98rem; color: #e6d138;">
        Una vez ingresado el DPI no se podra modificar.
        </h4>
        <br>

        <p class="text-muted mb-1" style="font-size:0.65rem;">
        'Presionar "Agrega" para poder agregar un nuevo empleado.'
        </p>
        <p class="text-muted mb-1" style="font-size:0.65rem;">
        'Hacer doble click en una fila para poder "Editar".'
        </p>
        <p class="text-muted mb-1" style="font-size:0.65rem;">
        'Siempre presionar el botón guardar para conservar los cambios.''
        </p>

        <div class="d-flex flex-wrap gap-2 align-items-center mt-2">
          <div class="d-flex gap-2">
          </div>
        </div>
      </div>

      <div class="d-none d-md-flex align-items-center" style="min-width:220px; justify-content:flex-end;">
        <div style="text-align:right;">
          <div style="font-size:.82rem; color:#6b7280;">Empresa</div>
          <div style="font-weight:700; color:#0b486b;">EMPAQUES Y TEXTURAS DE GUATEMALA, S.A.</div>
        </div>
      </div>
    </div>
  </div>

  {% set rol = session.get('rol', '')|string|lower %}

  <div class="card shadow-sm border-0 bg-white">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="btn-group">
          <button id="btnAgregar" class="btn btn-success btn-sm" data-action="agregar">Agregar</button>

          <!-- visibles; JS decide si procede -->
          <button id="btnEditar" class="btn btn-primary btn-sm" data-action="editar" data-role-required="colaborador">Editar</button>
          <button id="btnGuardar" class="btn btn-success btn-sm" data-action="guardar" data-role-required="colaborador">Guardar</button>

          <button id="btnCancelar" class="btn btn-secondary btn-sm" data-action="cancelar">Cancelar</button>

          <!-- Mostrar Eliminar por servidor cuando rol == admin para accesibilidad progresiva -->
          {% if rol == 'admin' %}
            <button id="btnEliminar" class="btn btn-danger btn-sm" data-action="eliminar" data-role-required="admin">Eliminar</button>
          {% endif %}
        </div>
      </div>

      <div class="table-responsive">
        <table id="tablaEmpleados" class="table table-sm table-hover table-bordered w-100 mb-0">
          <thead class="small" style="background-color:#000000; color:#ffffff;">
            <tr>
              <th>DPI</th><th>Nombre</th><th>Apellidos</th><th>Apellidos de casada</th><th>Estado Civil</th>
              <th>Nacionalidad</th><th>Departamento</th><th>Fecha de nacimiento</th><th>Lugar de nacimiento</th>
              <th>Numero IGSS</th><th>Dirección</th><th>Telefono</th><th>Religión</th><th>Correo</th><th>Puesto</th>
              <th>Tipo de contrato</th><th>Jornada laboral</th><th>Duración del Contrato</th><th>Fecha de inicio laboral</th><th>Dias Laborales</th>
            </tr>
          </thead>
          <tbody class="small">
            {% if empleados %}
              {% for e in empleados %}
              <tr>
                <td>{{ e['Numero de DPI'] }}</td>
                <td>{{ e.get('Nombre') }}</td>
                <td>{{ e.get('Apellidos') }}</td>
                <td>{{ e.get('Apellidos de casada') }}</td>
                <td>{{ e.get('Estado Civil') }}</td>
                <td>{{ e.get('Nacionalidad') }}</td>
                <td>{{ e.get('Departamento') }}</td>
                <td>{{ e.get('Fecha de nacimiento') }}</td>
                <td>{{ e.get('Lugar de nacimiento') }}</td>
                <td>{{ e.get('Numero de Afiliación del IGGS') }}</td>
                <td>{{ e.get('Dirección del Domicilio') }}</td>
                <td>{{ e.get('Numero de Telefono') }}</td>
                <td>{{ e.get('Religión') }}</td>
                <td>{{ e.get('Correo Electronico') }}</td>
                <td>{{ e.get('Puesto de trabajo') }}</td>
                <td>{{ e.get('Tipo de contrato') }}</td>
                <td>{{ e.get('Jornada laboral') }}</td>
                <td>{{ e.get('Duración del trabajo') }}</td>
                <td>{{ e.get('Fecha de inicio laboral') }}</td>
                <td>{{ e.get('Dias Laborales') }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="20" class="text-center text-muted">No hay empleados. Usa "Agregar" para crear la primera fila.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Panel de foto -->
  <div class="mt-4 d-flex justify-content-center">
    <div class="w-100" style="max-width:320px;">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex flex-column align-items-center">
          <h5 class="mb-3">Foto del empleado</h5>

          <div class="mb-3 d-flex justify-content-center w-100">
            <img id="fotoEmpleado"
                 src="{{ url_for('static', filename='imagenes/default.jpg') }}"
                 alt="Foto empleado"
                 class="rounded"
                 style="width:220px;height:220px;object-fit:cover;border:1px solid #ddd;background:#f5f5f5;">
          </div>

          <form id="formSubirFoto" method="post" enctype="multipart/form-data" action="{{ url_for('subir_foto') }}" class="w-100" style="max-width:260px; display:none;">
            <input type="hidden" name="dpi" id="inputDpiForUpload" value="">
            <div class="form-group mb-2">
              <input id="fileFoto" name="foto" type="file" accept="image/*" class="form-control form-control-sm">
            </div>
            <button id="btnSubirFoto" type="button" class="btn btn-primary btn-sm w-100" data-action="subir">Subir foto</button>
          </form>

          <form id="formEliminarFoto" method="post" action="{{ url_for('eliminar_foto') }}" class="w-100" style="max-width:260px; display:none; margin-top:12px;">
            <input type="hidden" name="dpi" id="inputDpiForDelete" value="">
            <!-- botón visible pero cliente bloquea según rol -->
            <button id="btnEliminarFoto" type="button" class="btn btn-outline-danger btn-sm w-100" data-action="eliminar" data-role-required="admin">Eliminar foto</button>
          </form>

          <small id="fotoHint" class="text-muted mt-3 text-center">
            Selecciona una fila de la tabla para gestionar la foto del empleado.
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/*
  Cambios solicitados:
  - Selección y carga de foto SÓLO por doble click.
  - Bloqueo de cualquier listener de click simple (captura) para evitar que otras partes activen selección con un click.
  - No se modifica otra lógica de negocio.
*/
(function(){
  const CURRENT_ROLE = ("{{ rol or '' }}").toLowerCase();

  function flash(msg, type='info') {
    const id = '__home_flash';
    const prev = document.getElementById(id);
    if (prev) prev.remove();
    const d = document.createElement('div');
    d.id = id;
    d.className = `alert alert-${type} py-1 px-2 small position-fixed`;
    d.style.top = '12px';
    d.style.right = '12px';
    d.style.zIndex = 9999;
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(()=> d.remove(), 2200);
  }

  (function installFetchGuard(){
    const orig = window.fetch;
    window.fetch = async function(input, init){
      try {
        const url = (typeof input === 'string') ? input : (input && input.url) || '';
        const method = (init && init.method) ? init.method.toUpperCase() : 'GET';

        let bodyObj = null;
        if (init && init.body) {
          if (typeof init.body === 'string') {
            try { bodyObj = JSON.parse(init.body); } catch(e){}
          } else if (init.body instanceof FormData) {
            bodyObj = {};
            for (const [k,v] of init.body.entries()) bodyObj[k]=v;
          } else if (init.body instanceof URLSearchParams) {
            bodyObj = {};
            for (const [k,v] of init.body.entries()) bodyObj[k]=v;
          }
        }

        if (url.includes('/guardar_empleado')) {
          if (!['admin','colaborador'].includes(CURRENT_ROLE)) {
            const isNew = Boolean(bodyObj && (bodyObj.nuevo === true || bodyObj.nuevo === 'true' || bodyObj.nuevo === '1' || bodyObj.nuevo === 1));
            if (!isNew) {
              flash('Permisos insuficientes para editar registros', 'warning');
              return new Response(JSON.stringify({ mensaje: 'Permisos insuficientes (cliente)' }), { status: 403, headers: { 'Content-Type': 'application/json' }});
            }
          }
        }

        if (url.includes('/eliminar_foto')) {
          if (CURRENT_ROLE !== 'admin') {
            flash('Permisos insuficientes para eliminar foto', 'warning');
            return new Response(JSON.stringify({ error: 'Permisos insuficientes (cliente)' }), { status: 403, headers: { 'Content-Type': 'application/json' }});
          }
        }

        if (method === 'PUT' && url.match(/\/api\/empleado\/[^\/]+$/)) {
          if (CURRENT_ROLE !== 'admin') {
            flash('Permisos insuficientes para modificar empleado (cliente)', 'warning');
            return new Response(JSON.stringify({ mensaje: 'Permisos insuficientes (cliente)' }), { status: 403, headers: { 'Content-Type': 'application/json' }});
          }
        }
      } catch (e) {
        // ignore guard errors
      }
      return orig.apply(this, arguments);
    };
  })();

  document.getElementById('btnAgregar')?.addEventListener('click', (ev) => {
    flash('Agregar: abre formulario (UX)', 'info');
    if (typeof window.iniciarAgregar === 'function') window.iniciarAgregar();
  });

  document.getElementById('btnEditar')?.addEventListener('click', (ev) => {
    if (!['admin','colaborador'].includes(CURRENT_ROLE)) {
      flash('Permisos insuficientes para editar registros', 'warning');
      return;
    }
    // btnEditar should operate only on a selected row; if your registrarTabla previously edited on single click,
    // that behavior is now prevented by the click-capture blocker. BtnEditar calls iniciarEdicion() as before.
    if (typeof window.iniciarEdicion === 'function') {
      // prefer to pass the selected row if exists
      const tabla = document.getElementById('tablaEmpleados');
      const seleccionado = tabla && tabla.querySelector('tbody tr.selected');
      try { if (seleccionado) window.iniciarEdicion(seleccionado); else window.iniciarEdicion(); } catch(e){ try{ window.iniciarEdicion(); }catch(_){} }
    } else flash('Editar: acción iniciada', 'info');
  });

  document.getElementById('btnGuardar')?.addEventListener('click', async (ev) => {
    if (!['admin','colaborador'].includes(CURRENT_ROLE)) {
      flash('Permisos insuficientes para guardar cambios', 'warning');
      return;
    }
    if (typeof window.guardarCambios === 'function') {
      try { await window.guardarCambios(); } catch (e) { flash('Error al guardar', 'danger'); }
    } else {
      flash('Guardar: acción ejecutada (implementa window.guardarCambios)', 'info');
    }
  });

  document.getElementById('btnCancelar')?.addEventListener('click', (ev) => {
    if (typeof window.cancelarEdicion === 'function') window.cancelarEdicion();
    else flash('Cancelar: acción ejecutada', 'info');
  });

  const TABLE_ID = 'tablaEmpleados';
  const tabla = document.getElementById(TABLE_ID);
  const fotoEmpleado = document.getElementById('fotoEmpleado');
  const formSubir = document.getElementById('formSubirFoto');
  const formEliminar = document.getElementById('formEliminarFoto');
  const inputDpiUpload = document.getElementById('inputDpiForUpload');
  const inputDpiDelete = document.getElementById('inputDpiForDelete');
  const fileFoto = document.getElementById('fileFoto');

  function clearPhotoPanel() {
    if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
    if (formSubir) formSubir.style.display = 'none';
    if (formEliminar) formEliminar.style.display = 'none';
    if (fileFoto) fileFoto.value = '';
    if (inputDpiUpload) inputDpiUpload.value = '';
    if (inputDpiDelete) inputDpiDelete.value = '';
  }

  async function eliminarFilaSeleccionada(tr) {
    if (!tr) {
      flash('Debes seleccionar una fila antes de eliminar', 'warning');
      return;
    }
    const dpi = (tr.cells[0] && tr.cells[0].innerText || '').trim();
    if (!dpi) { flash('No se pudo obtener el DPI de la fila seleccionada', 'danger'); return; }
    if (!confirm(`¿Estás seguro de eliminar al empleado con DPI ${dpi}? Esta acción no se puede deshacer.`)) return;
    try {
      const res = await fetch('/eliminar_empleado', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dpi })
      });
      const j = await res.json().catch(()=>({}));
      if (res.ok) {
        flash(j.mensaje || 'Empleado eliminado', 'success');
        tr.remove();
        if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
      } else {
        flash(j.mensaje || j.error || 'Error al eliminar', 'danger');
      }
    } catch (err) {
      flash('Error al eliminar: ' + (err.message || err), 'danger');
    }
  }

  const btnEliminar = document.getElementById('btnEliminar');
  if (btnEliminar) {
    btnEliminar.addEventListener('click', async () => {
      if (CURRENT_ROLE !== 'admin') { flash('Permisos insuficientes para eliminar empleados', 'warning'); return; }
      const tr = tabla.querySelector('tbody tr.selected') || tabla.querySelector('tbody tr');
      await eliminarFilaSeleccionada(tr);
    });
  }

  function clearSelection() {
    tabla.querySelectorAll('tbody tr').forEach(r => r.classList.remove('selected'));
  }

  // --- BLOCK ALL single-click selection handlers (capture phase) ---
  // This prevents third-party scripts or earlier listeners from acting on a single click.
  // We only stop click events originating inside table body rows.
  if (tabla) {
    tabla.addEventListener('click', function(e){
      // If a dblclick is occurring, clicks still fire; do not block clicks that are part of a dblclick sequence.
      // We detect dblclick by checking e.detail: for browsers, detail==1 first click, detail==2 second click.
      // We allow the browser to process dblclick (we won't call stopImmediatePropagation when detail>1).
      if (e.detail && e.detail >= 2) return;
      const tr = e.target.closest('tr');
      if (tr && tr.parentElement && tr.parentElement.tagName === 'TBODY') {
        // prevent other click handlers from selecting rows on single click
        e.stopImmediatePropagation();
        e.preventDefault();
        return;
      }
    }, true); // use capture to intercept early
  }

  // Helper: load foto for a row
  async function cargarFotoParaFila(tr) {
    if (!tr) { clearPhotoPanel(); return; }
    const dpi = (tr.cells[0] && tr.cells[0].innerText || '').trim();
    if (!dpi) { clearPhotoPanel(); return; }
    if (inputDpiUpload) inputDpiUpload.value = dpi;
    if (inputDpiDelete) inputDpiDelete.value = dpi;

    try {
      const res = await fetch(`/api/foto/${encodeURIComponent(dpi)}`, { cache: 'no-store' });
      if (!res.ok) throw new Error('no-photo');
      const j = await res.json();
      if (j && j.url) {
        if (fotoEmpleado) fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
        if (formSubir) formSubir.style.display = 'none';
        if (formEliminar) formEliminar.style.display = 'block';
      } else {
        if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
        if (formSubir) formSubir.style.display = 'block';
        if (formEliminar) formEliminar.style.display = 'none';
      }
    } catch (e) {
      if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
      if (formSubir) formSubir.style.display = 'block';
      if (formEliminar) formEliminar.style.display = 'none';
    }
  }

  // dblclick: select row + load photo + optionally start edit or delete (shift+dblclick)
  if (tabla) {
    tabla.addEventListener('dblclick', async (ev) => {
      const tr = ev.target.closest('tr');
      if (!tr || tr.parentElement.tagName !== 'TBODY') return;

      clearSelection();
      tr.classList.add('selected');

      await cargarFotoParaFila(tr);

      // shift + dblclick => delete (admin)
      if (ev.shiftKey) {
        if (CURRENT_ROLE !== 'admin') {
          flash('Permisos insuficientes para eliminar empleados', 'warning');
          return;
        }
        await eliminarFilaSeleccionada(tr);
        return;
      }

      // dblclick triggers editing (if allowed)
      if (!['admin','colaborador'].includes(CURRENT_ROLE)) {
        flash('Permisos insuficientes para editar registros', 'warning');
        return;
      }
      if (typeof window.iniciarEdicion === 'function') {
        try { window.iniciarEdicion(tr); } catch (e) { try { window.iniciarEdicion(); } catch(_){} }
      } else {
        flash('Editar: acción iniciada', 'info');
      }
    });
  }

  // Keep upload/delete photo handlers unchanged
  document.getElementById('btnSubirFoto')?.addEventListener('click', async () => {
    const dpi = inputDpiUpload && inputDpiUpload.value && inputDpiUpload.value.trim();
    if (!dpi) return flash('Selecciona una fila con DPI antes de subir foto', 'danger');
    if (!fileFoto || !fileFoto.files || !fileFoto.files[0]) return flash('Selecciona un archivo de imagen', 'danger');

    const fd = new FormData();
    fd.append('dpi', dpi);
    fd.append('foto', fileFoto.files[0]);

    try {
      const res = await fetch(formSubir.action || '/subir_foto', { method: 'POST', body: fd });
      if (!res.ok) {
        const t = await res.text().catch(()=>null);
        throw new Error(`${res.status} ${t||res.statusText}`);
      }
      const j = await res.json();
      if (j && j.url) {
        if (fotoEmpleado) fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
        if (formSubir) formSubir.style.display = 'none';
        if (formEliminar) formEliminar.style.display = 'block';
        flash('Foto subida', 'success');
      } else throw new Error('Respuesta inesperada');
    } catch (err) {
      flash('Error al subir foto: ' + (err.message||err), 'danger');
    }
  });

  document.getElementById('btnEliminarFoto')?.addEventListener('click', async () => {
    const dpi = inputDpiDelete && inputDpiDelete.value && inputDpiDelete.value.trim();
    if (!dpi) return flash('No hay DPI seleccionado', 'danger');

    if (CURRENT_ROLE !== 'admin') {
      flash('Permisos insuficientes para eliminar foto', 'warning');
      return;
    }

    try {
      const res = await fetch(formEliminar.action || '/eliminar_foto', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dpi })
      });
      if (!res.ok) {
        const t = await res.text().catch(()=>null);
        throw new Error(`${res.status} ${t||res.statusText}`);
      }
      if (fotoEmpleado) fotoEmpleado.src = "{{ url_for('static', filename='imagenes/default.jpg') }}";
      if (formSubir) formSubir.style.display = 'block';
      if (formEliminar) formEliminar.style.display = 'none';
      flash('Foto eliminada', 'success');
    } catch (err) {
      flash('Error al eliminar foto', 'danger');
    }
  });

  function tryRegister(retries = 20){
    if (window.registrarTabla && typeof window.registrarTabla === 'function') {
      window.registrarTabla('tablaEmpleados', 20, '/guardar_empleado', [
        "Numero de DPI","Nombre","Apellidos","Apellidos de casada","Estado Civil",
        "Nacionalidad","Departamento","Fecha de nacimiento","Lugar de nacimiento",
        "Numero de Afiliación del IGGS","Dirección del Domicilio","Numero de Telefono",
        "Religión","Correo Electronico","Puesto de trabajo","Tipo de contrato",
        "Jornada laboral","Duración del trabajo","Fecha de inicio laboral","Dias Laborales"
      ], []);
      return;
    }
    if (retries <= 0) return;
    setTimeout(()=> tryRegister(retries-1), 100);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ()=>tryRegister(20));
  else tryRegister(20);

})();
</script>

{% endblock %}
