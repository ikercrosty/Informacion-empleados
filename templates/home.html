{% extends "layout.html" %}
{% block title %}Datos personales{% endblock %}

{% block content %}
<div class="jumbotron">
  <h1 class="display-4">Datos personales</h1>
  <p class="lead">Datos personales del empleado</p>
</div>



<div class="row">
  <!-- Tabla y botones (izquierda) -->
  <div class="col-md-8">
    <div class="mb-3 d-flex flex-wrap">
      <button id="btnAgregar" type="button" class="btn btn-success btn-sm mr-2 mb-2">Agregar</button>
      <button id="btnEditar" type="button" class="btn btn-primary btn-sm mr-2 mb-2" disabled>Editar</button>
      <button id="btnGuardar" type="button" class="btn btn-success btn-sm mr-2 mb-2" disabled>Guardar</button>
      <button id="btnCancelar" type="button" class="btn btn-secondary btn-sm mb-2" disabled>Cancelar</button>
    </div>

    <div class="table-responsive">
      <table id="tablaEmpleados" class="table table-bordered table-striped table-hover table-sm">
        <thead class="thead-dark table-compact">
          <tr>
            <th>DPI</th>
            <th>Nombre</th>
            <th>Apellidos</th>
            <th>Apellidos de casada</th>
            <th>Estado Civil</th>
            <th>Nacionalidad</th>
            <th>Departamento</th>
            <th>Fecha de nacimiento</th>
            <th>Lugar de nacimiento</th>
            <th>Numero IGSS</th>
            <th>Dirección</th>
            <th>Telefono</th>
            <th>Religión</th>
            <th>Correo</th>
            <th>Puesto</th>
            <th>Tipo de contrato</th>
            <th>Jornada laboral</th>
            <th>Duración del trabajo</th>
            <th>Fecha de inicio laboral</th>
            <th>Dias Laborales</th>
          </tr>
        </thead>
        <tbody>
          {% for e in empleados %}
          <tr>
            <td>{{ e['Numero de DPI'] }}</td>
            <td>{{ e.get('Nombre') }}</td>
            <td>{{ e.get('Apellidos') }}</td>
            <td>{{ e.get('Apellidos de casada') }}</td>
            <td>{{ e.get('Estado Civil') }}</td>
            <td>{{ e.get('Nacionalidad') }}</td>
            <td>{{ e.get('Departamento') }}</td>
            <td>{{ e.get('Fecha de nacimiento') }}</td>
            <td>{{ e.get('Lugar de nacimiento') }}</td>
            <td>{{ e.get('Numero de Afiliación del IGGS') }}</td>
            <td>{{ e.get('Dirección del Domicilio') }}</td>
            <td>{{ e.get('Numero de Telefono') }}</td>
            <td>{{ e.get('Religión') }}</td>
            <td>{{ e.get('Correo Electronico') }}</td>
            <td>{{ e.get('Puesto de trabajo') }}</td>
            <td>{{ e.get('Tipo de contrato') }}</td>
            <td>{{ e.get('Jornada laboral') }}</td>
            <td>{{ e.get('Duración del trabajo') }}</td>
            <td>{{ e.get('Fecha de inicio laboral') }}</td>
            <td>{{ e.get('Dias Laborales') }}</td>
          </tr>
          {% endfor %}
          ...
<!-- HTML del final de la página -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>

        </tbody>
      </table>
    </div>
  </div>

  <!-- Panel de imagen (derecha) -->
  <!-- Panel de foto: coloca ESTE bloque donde quieras mostrar la imagen y controles -->
<div class="text-center mb-3">
  <img id="fotoEmpleado"
       src="{{ url_for('static', filename='imagenes/default.png') }}"
       alt="Foto empleado"
       class="img-fluid rounded"
       style="width:220px;height:220px;object-fit:cover;border:1px solid #ddd;">
</div>

<!-- Formulario para subir foto (AJAX manejado por main.js) -->
<form id="formSubirFoto" method="post" enctype="multipart/form-data" action="/subir_foto" style="display:none;">
  <input type="hidden" name="dpi" id="inputDpiForUpload" value="">
  <div class="form-group">
    <input id="fileFoto" name="foto" type="file" accept="image/*" class="form-control-file" required>
  </div>
  <button id="btnSubirFoto" type="submit" class="btn btn-primary btn-block">Subir foto</button>
</form>

<!-- Formulario para eliminar foto (AJAX manejado por main.js) -->
<form id="formEliminarFoto" method="post" action="/eliminar_foto" style="display:none;">
  <input type="hidden" name="dpi" id="inputDpiForDelete" value="">
  <button id="btnEliminarFoto" type="submit" class="btn btn-outline-danger btn-block">Eliminar foto</button>
</form>

<small class="text-muted mt-3 d-block">
  Selecciona una fila de la tabla para gestionar la foto del empleado.
</small>

    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tabla = document.getElementById('tablaEmpleados');
  const fotoEmpleado = document.getElementById('fotoEmpleado');
  const inputDpiUpload = document.getElementById('inputDpiForUpload');
  const inputDpiDelete = document.getElementById('inputDpiForDelete');
  const uploadControls = document.getElementById('uploadControls');
  const deleteControl = document.getElementById('deleteControl');
  const fileFoto = document.getElementById('fileFoto');

  const DEFAULT_SRC = "{{ url_for('static', filename='imagenes/default.png') }}";

  function resetPanelToDefault() {
    fotoEmpleado.src = DEFAULT_SRC;
    inputDpiUpload.value = "";
    inputDpiDelete.value = "";
    uploadControls.style.display = "none";
    deleteControl.style.display = "none";
    if (fileFoto) fileFoto.value = "";
  }

  // Estado inicial
  resetPanelToDefault();

  // Preview local al seleccionar archivo
  if (fileFoto) {
    fileFoto.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f || !f.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = (ev) => { fotoEmpleado.src = ev.target.result; };
      reader.readAsDataURL(f);
    });
  }

  // Selección de fila de la tabla
  if (tabla) {
    tabla.addEventListener('click', async (ev) => {
      const tr = ev.target.closest('tr');
      if (!tr || !tr.cells.length) return;
      const dpi = tr.cells[0].innerText.trim();
      if (!dpi) return;

      // Set DPI ocultos
      inputDpiUpload.value = dpi;
      inputDpiDelete.value = dpi;

      // Consultar API de foto
      try {
        const r = await fetch(`/api/foto/${encodeURIComponent(dpi)}`, { cache: 'no-store' });
        const j = await r.json();

        // Si trae URL válida, mostrar foto y habilitar eliminar
        if (j && j.url && (j.url.startsWith('/') || j.url.startsWith('http'))) {
          fotoEmpleado.src = `${j.url}?t=${Date.now()}`;
          uploadControls.style.display = "none";
          deleteControl.style.display = "block";
        } else {
          // No hay foto: mostrar default y habilitar subir
          fotoEmpleado.src = DEFAULT_SRC;
          uploadControls.style.display = "block";
          deleteControl.style.display = "none";
          if (fileFoto) fileFoto.value = "";
        }
      } catch (err) {
        // Error en API: tratar como sin foto
        fotoEmpleado.src = DEFAULT_SRC;
        uploadControls.style.display = "block";
        deleteControl.style.display = "none";
        if (fileFoto) fileFoto.value = "";
      }
    });
  }

  // Reset si clic fuera de la tabla y controles
  document.addEventListener('click', (e) => {
    const insideTable = e.target.closest('#tablaEmpleados');
    const insideControls = e.target.closest('#uploadControls') || e.target.closest('#deleteControl');
    if (!insideTable && !insideControls) {
      resetPanelToDefault();
    }
  });
});
</script>
{% endblock %}
