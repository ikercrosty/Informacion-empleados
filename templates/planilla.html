{% extends "layout.html" %}
{% block title %}Planilla - Noviembre 2025{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mt-3">Planilla - Noviembre 2025</h2>
  <p class="text-muted">Empresa: EMPAQUES Y TEXTURAS DE GUATEMALA, SOCIEDAD ANÓNIMA</p>

  <div class="form-row align-items-center mb-2">
    <div class="col-auto">
      <label class="sr-only" for="planillaName">Nombre de planilla</label>
      <input id="planillaName" class="form-control form-control-sm" type="text" value="Planilla - Noviembre 2025" />
    </div>
    <div class="col-auto">
      <label class="sr-only" for="emisionDate">Fecha de emisión</label>
      <input id="emisionDate" class="form-control form-control-sm" type="date" />
    </div>
    <div class="col-auto">
      <button id="addRow" class="btn btn-sm btn-outline-primary">Agregar fila</button>
      <button id="exportExcel" class="btn btn-sm btn-outline-secondary">Exportar a Excel</button>
      <button id="deleteRow" class="btn btn-sm btn-outline-danger">Eliminar fila</button>
    </div>
    <div class="col-auto">
      <small id="exportHint" class="text-danger" style="display:none;">Debe ingresar la fecha de emisión antes de exportar</small>
    </div>
  </div>

  <div class="table-responsive mb-3 horizontal-scroll">
    <table id="planillaTable" class="table table-bordered table-sm">
      <colgroup>
        <col style="width:4%"><col style="width:36%"><col style="width:9%"><col style="width:9%"><col style="width:7%">
        <col style="width:8%"><col style="width:6%"><col style="width:8%"><col style="width:8%"><col style="width:8%">
        <col style="width:8%"><col style="width:8%"><col style="width:10%">
      </colgroup>
      <thead class="thead-light">
        <tr>
          <th>No.</th>
          <th>Apellido(s), Nombre(s)</th>
          <th>Sueldo Base</th>
          <th>Bonificación</th>
          <th>Días Laborados</th>
          <th>Comisiones</th>
          <th>Horas extra</th>
          <th>Horas Extras (monto)</th>
          <th>Total Devengado</th>
          <th>IGSS (4.83%)</th>
          <th>ISR calculado</th>
          <th>Otras deducciones</th>
          <th>Total Deducciones</th>
        </tr>
      </thead>

      <tbody>
        <tr data-row="1">
          <td>1</td>
          <td class="align-middle">EDNA ANABELY MARISTELA VELASQUEZ MALDONADO</td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell sueldo" type="number" step="0.01" value="3726.05"></div></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell bono" type="number" step="0.01" value="250.00"></div></td>
          <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="30"></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell comisiones" type="number" step="0.01" value="0"></div></td>
          <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="0"></td>
          <td class="text-right hextras">Q 0.00</td>
          <td class="text-right total-devengado">Q 0.00</td>
          <td class="text-right igss">Q 0.00</td>
          <td class="text-right isr-cell"></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell otras" type="number" step="0.01" value="0"></div></td>
          <td class="text-right total-deducciones">Q 0.00</td>
        </tr>

        <tr data-row="2">
          <td>2</td>
          <td class="align-middle">MAGDALIDA OCTAVIA VASQUEZ LOPEZ</td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell sueldo" type="number" step="0.01" value="3726.05"></div></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell bono" type="number" step="0.01" value="250.00"></div></td>
          <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="30"></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell comisiones" type="number" step="0.01" value="0"></div></td>
          <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="0"></td>
          <td class="text-right hextras">Q 0.00</td>
          <td class="text-right total-devengado">Q 0.00</td>
          <td class="text-right igss">Q 0.00</td>
          <td class="text-right isr-cell"></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell otras" type="number" step="0.01" value="0"></div></td>
          <td class="text-right total-deducciones">Q 0.00</td>
        </tr>

        <tr data-row="3">
          <td>3</td>
          <td class="align-middle">ANGEL ESTUARDO LEONIDAS ANIVAL ESCOBAR</td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell sueldo" type="number" step="0.01" value="3726.05"></div></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell bono" type="number" step="0.01" value="250.00"></div></td>
          <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="30"></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell comisiones" type="number" step="0.01" value="0"></div></td>
          <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="0"></td>
          <td class="text-right hextras">Q 0.00</td>
          <td class="text-right total-devengado">Q 0.00</td>
          <td class="text-right igss">Q 0.00</td>
          <td class="text-right isr-cell"></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell otras" type="number" step="0.01" value="0"></div></td>
          <td class="text-right total-deducciones">Q 0.00</td>
        </tr>
      </tbody>

      <tfoot>
        <tr class="font-weight-bold">
          <td colspan="2" class="text-right">TOTAL</td>
          <td id="total-sueldo" class="text-right">Q 0.00</td>
          <td id="total-bono" class="text-right">Q 0.00</td>
          <td id="total-dias" class="text-right">0</td>
          <td id="total-comisiones" class="text-right">Q 0.00</td>
          <td id="total-horas" class="text-right">0</td>
          <td id="total-hextras" class="text-right">Q 0.00</td>
          <td id="total-devengado" class="text-right">Q 0.00</td>
          <td id="total-igss" class="text-right">Q 0.00</td>
          <td id="total-isr" class="text-right">Q 0.00</td>
          <td id="total-otras" class="text-right">Q 0.00</td>
          <td id="total-deducciones" class="text-right">Q 0.00</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
/* Parámetros fiscales */
const IGSS_RATE = 0.0483;
const GASTOS_PERSONALES_ANUAL = 48000;
const ISR_ANNUAL_RATE = 0.05;
const ISR_MIN_SALARIO = 4000.00;

/* Helpers */
function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }
function formatNum(n){ return n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
function withQ(n){ return 'Q ' + formatNum(n); }

/* Horas extras mensual */
function computeHorasMontoMensual(sueldo, dias, horas) {
  if (!dias || dias <= 0) return 0;
  const valorHora = sueldo / dias / 8;
  const monto = valorHora * 1.5 * horas;
  return round2(monto);
}

/* ISR según ganancias brutas anuales (nuevo procedimiento) */
function computeISRMonthlyFromRow(sueldo, bono, comisiones, hextrasMensual) {
  if (sueldo < ISR_MIN_SALARIO) return 0;
  const gbMensual = sueldo + bono + comisiones + hextrasMensual;
  const gbAnual = gbMensual * 12;
  const igssAnual = round2(gbAnual * IGSS_RATE);
  const baseCalculo = gbAnual - (igssAnual + GASTOS_PERSONALES_ANUAL);
  if (baseCalculo <= 0) return 0;
  const isrAnual = round2(baseCalculo * ISR_ANNUAL_RATE);
  const isrMensual = round2(isrAnual / 12);
  return isrMensual;
}

/* Recalcula una fila completa y actualiza dataset */
function recalcRow(tr) {
  const sueldo = parseFloat(tr.querySelector('.sueldo').value) || 0;
  const bono = parseFloat(tr.querySelector('.bono').value) || 0;
  const comisiones = parseFloat(tr.querySelector('.comisiones').value) || 0;
  const dias = parseInt(tr.querySelector('.dias').value) || 0;
  const horas = parseInt(tr.querySelector('.horas').value) || 0;
  const otras = parseFloat(tr.querySelector('.otras').value) || 0;

  const hextrasMonto = computeHorasMontoMensual(sueldo, dias, horas);
  const totalDevengado = round2(sueldo + bono + comisiones + hextrasMonto);
  const igss = round2((sueldo + bono + comisiones + hextrasMonto) * IGSS_RATE);
  const isrMensual = computeISRMonthlyFromRow(sueldo, bono, comisiones, hextrasMonto);

  const totalDeducciones = round2(igss + isrMensual + otras);
  const liquido = round2(totalDevengado - totalDeducciones);

  tr.querySelector('.hextras').textContent = withQ(hextrasMonto);
  tr.querySelector('.total-devengado').textContent = withQ(totalDevengado);
  tr.querySelector('.igss').textContent = withQ(igss);
  tr.querySelector('.isr-cell').textContent = isrMensual > 0 ? withQ(isrMensual) : '';
  tr.dataset._isrValue = isrMensual;
  tr.dataset._hextras = hextrasMonto;
  tr.querySelector('.total-deducciones').textContent = withQ(totalDeducciones);
  tr.querySelector('.liquido')?.textContent = withQ(liquido);
}

/* Recalcula totales usando dataset values */
function recalcTotals() {
  const rows = document.querySelectorAll('#planillaTable tbody tr');
  let totals = {sueldo:0, bono:0, dias:0, comisiones:0, horas:0, hextras:0, devengado:0, igss:0, isr:0, otras:0, deducciones:0};
  rows.forEach(tr => {
    const sueldo = parseFloat(tr.querySelector('.sueldo').value) || 0;
    const bono = parseFloat(tr.querySelector('.bono').value) || 0;
    const dias = parseInt(tr.querySelector('.dias').value) || 0;
    const comisiones = parseFloat(tr.querySelector('.comisiones').value) || 0;
    const horas = parseInt(tr.querySelector('.horas').value) || 0;
    const otras = parseFloat(tr.querySelector('.otras').value) || 0;

    const hextrasMonto = parseFloat(tr.dataset._hextras) || computeHorasMontoMensual(sueldo, dias, horas);
    const totalDevengado = round2(sueldo + bono + comisiones + hextrasMonto);
    const igss = round2((sueldo + bono + comisiones + hextrasMonto) * IGSS_RATE);
    const isrMensual = parseFloat(tr.dataset._isrValue) || 0;
    const totalDeducciones = round2(igss + isrMensual + otras);

    totals.sueldo += sueldo;
    totals.bono += bono;
    totals.dias += dias;
    totals.comisiones += comisiones;
    totals.horas += horas;
    totals.hextras += hextrasMonto;
    totals.devengado += totalDevengado;
    totals.igss += igss;
    totals.isr += isrMensual;
    totals.otras += otras;
    totals.deducciones += totalDeducciones;
  });

  document.getElementById('total-sueldo').textContent = withQ(totals.sueldo);
  document.getElementById('total-bono').textContent = withQ(totals.bono);
  document.getElementById('total-dias').textContent = totals.dias.toString();
  document.getElementById('total-comisiones').textContent = withQ(totals.comisiones);
  document.getElementById('total-horas').textContent = totals.horas.toString();
  document.getElementById('total-hextras').textContent = withQ(totals.hextras);
  document.getElementById('total-devengado').textContent = withQ(totals.devengado);
  document.getElementById('total-igss').textContent = withQ(totals.igss);
  document.getElementById('total-isr').textContent = withQ(totals.isr);
  document.getElementById('total-otras').textContent = withQ(totals.otras);
  document.getElementById('total-deducciones').textContent = withQ(totals.deducciones);
}

/* Delegated listener: cualquier cambio en inputs con clase num-cell recalcula fila y totales */
document.addEventListener('input', (e) => {
  if (!e.target.classList) return;
  if (e.target.classList.contains('num-cell')) {
    const tr = e.target.closest('tr');
    recalcRow(tr);
    recalcTotals();
  }
});

/* Inicializar filas existentes */
document.querySelectorAll('#planillaTable tbody tr').forEach(tr => recalcRow(tr));
recalcTotals();

/* Add row */
document.getElementById('addRow').addEventListener('click', () => {
  const tbody = document.querySelector('#planillaTable tbody');
  const idx = tbody.querySelectorAll('tr').length + 1;
  const tr = document.createElement('tr');
  tr.dataset.row = idx;
  tr.innerHTML = `
    <td>${idx}</td>
    <td class="align-middle"><input class="form-control form-control-sm nombre" type="text" value=""></td>
    <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell sueldo" type="number" step="0.01" value="0"></div></td>
    <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell bono" type="number" step="0.01" value="0"></div></td>
    <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="30"></td>
    <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell comisiones" type="number" step="0.01" value="0"></div></td>
    <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="0"></td>
    <td class="text-right hextras">Q 0.00</td>
    <td class="text-right total-devengado">Q 0.00</td>
    <td class="text-right igss">Q 0.00</td>
    <td class="text-right isr-cell"></td>
    <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell otras" type="number" step="0.01" value="0"></div></td>
    <td class="text-right total-deducciones">Q 0.00</td>
  `;
  tbody.appendChild(tr);
  recalcRow(tr);
  recalcTotals();
});

/* Delete last row */
document.getElementById('deleteRow').addEventListener('click', () => {
  const tbody = document.querySelector('#planillaTable tbody');
  const rows = tbody.querySelectorAll('tr');
  if (rows.length === 0) return;
  tbody.removeChild(rows[rows.length - 1]);
  recalcTotals();
});

/* Export to Excel (.xlsx): requiere fecha de emisión */
document.getElementById('exportExcel').addEventListener('click', () => {
  const dateInput = document.getElementById('emisionDate').value;
  const planillaName = document.getElementById('planillaName').value.trim() || 'Planilla';
  const exportHint = document.getElementById('exportHint');
  if (!dateInput) {
    exportHint.style.display = 'inline';
    return;
  }
  exportHint.style.display = 'none';

  // Clonar tabla y limpiar inputs
  const table = document.getElementById('planillaTable');
  const clone = table.cloneNode(true);
  clone.querySelectorAll('input').forEach(inp => {
    const parent = inp.parentElement || inp;
    parent.replaceChild(document.createTextNode(inp.value), inp);
  });

  // Convertir celdas Q... a números para Excel
  clone.querySelectorAll('td, th').forEach(cell => {
    let txt = (cell.textContent || '').replace(/\u00A0/g, ' ').trim();
    if (txt === '') return;
    const removed = txt.replace(/^Q\s*/i, '').replace(/,/g, '');
    const n = Number(removed);
    if (removed !== '' && isFinite(n)) cell.textContent = n;
    else cell.textContent = txt;
  });

  // Crear hoja a partir de la tabla limpia
  const ws = XLSX.utils.table_to_sheet(clone, {raw:true});

  // Insertar encabezados (nombre de planilla y fecha) en filas 1 y 2
  XLSX.utils.sheet_add_aoa(ws, [[planillaName]], {origin: "A1"});
  XLSX.utils.sheet_add_aoa(ws, [[`Fecha de emisión:`, dateInput]], {origin: "A2"});

  // Ajustar rango: sheet_to_book lo maneja bien con las filas añadidas
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Planilla");

  // Nombre de archivo seguro
  const safeName = planillaName.replace(/[^a-z0-9_\- ]/gi,'').replace(/\s+/g,'_');
  const filename = `${safeName}_${dateInput}.xlsx`;
  XLSX.writeFile(wb, filename);
});
</script>

<style>
  .horizontal-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  #planillaTable { min-width: 1200px; font-size: 0.95rem; }
  .money-inline { display:flex; align-items:center; gap:0.35rem; }
  .money-prefix { background:#f1f3f5; border:1px solid #ced4da; padding:.25rem .4rem; border-radius:4px; min-width:24px; text-align:center; font-weight:600; }
  #planillaTable td.total-devengado, #planillaTable td.igss, #planillaTable td.total-deducciones, #planillaTable td.isr-cell, #planillaTable tfoot td { text-align:right; vertical-align:middle; }
  .form-row .col-auto { margin-right:.5rem; }
  #exportHint { margin-left: .5rem; }
  input.form-control-sm[type="date"] { height: calc(.875rem + 1.5em); }
</style>
{% endblock %}
