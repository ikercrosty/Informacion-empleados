{% extends "layout.html" %}
{% block title %}Planilla {% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
      <div>
        <h3 class="mb-0" style="letter-spacing:.2px">Planilla - Empaquetex </h3>
        <div class="text-muted small mt-1">Empresa: EMPAQUES Y TEXTURAS DE GUATEMALA, SOCIEDAD ANÓNIMA</div>
      </div>

      <!-- Header controls: reorganizados y estilizados -->
      <div class="controls d-flex flex-column flex-md-row align-items-stretch align-items-md-center gap-3 w-100">
        <!-- Left: document name + date grouped -->
        <div class="control-group d-flex gap-2 align-items-center flex-wrap">
          <div class="field">
            <h6 class="mb-1 control-label">Ingrese nombre para el documento</h6>
            <input id="planillaName" class="form-control form-control-sm" type="text" value="Planilla " />
          </div>

          <div class="field ms-2">
            <h6 class="mb-1 control-label">Fecha de emisión</h6>
            <div class="input-with-icon">
              <input id="emisionDate" class="form-control form-control-sm" type="date" />
              <span class="calendar-icon" aria-hidden="true"></span>
            </div>
          </div>
        </div>

        <!-- Right: action buttons grouped in a clean toolbar -->
        <div class="action-toolbar ms-auto d-flex align-items-center gap-2">
          <div class="btn-group-main d-flex gap-2">
            <button id="exportExcel" class="btn btn-export btn-sm" title="Exportar a Excel">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-file-earmark-excel me-2" viewBox="0 0 16 16"><path d="M5.884 6.68 4.52 9.5l1.364 2.82H3.54L2 9.5l1.54-2.82h1.344z"/><path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zM10.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V5.5H10.5A1.5 1.5 0 0 1 9 4V3.5z"/></svg>
              Exportar
            </button>

            <button id="btnGuardarPlanilla" class="btn btn-save btn-sm" title="Guardar planilla">Guardar</button>

            <button id="addRow" class="btn btn-secondary btn-sm" title="Agregar fila">Agregar</button>

            <button id="deleteRow" class="btn btn-danger-outline btn-sm" title="Eliminar fila">Eliminar</button>

            <button id="btnEditarSueldo" class="btn btn-warning-outline btn-sm" title="Editar sueldos" style="display:none;">Editar sueldos</button>
          </div>
        </div>

        <small id="exportHint" class="text-danger ms-3" style="display:none;">Ingrese fecha de emisión para exportar</small>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body p-3">
      <div class="table-responsive horizontal-scroll">
        <table id="planillaTable" class="table table-hover table-sm align-middle mb-0" style="min-width:1600px">
          <colgroup>
            <col style="width:3%">
            <col style="width:30%">
            <col style="width:9%">
            <col style="width:7%">
            <col style="width:6%">
            <col style="width:8%">
            <col style="width:6%">
            <col style="width:8%">
            <col style="width:8%">
            <col style="width:8%">
            <col style="width:8%">
            <col style="width:8%">
            <col style="width:8%">
            <col style="width:8%">
            <col style="width:12%">
          </colgroup>

          <thead class="table-header-custom text-white">
            <tr>
              <th>No.</th>
              <th>Apellido(s), Nombre(s)</th>
              <th>Sueldo Base</th>
              <th>Bonificación</th>
              <th>Días Laborados</th>
              <th>Comisiones</th>
              <th>Horas extra</th>
              <th>Horas Extras (monto)</th>
              <th>Total Devengado</th>
              <th>Calculo del IGSS</th>
              <th>Calculo del ISR</th>
              <th>Otras deducciones</th>
              <th>Total Deducciones</th>
              <th>Líquido a recibir</th>
              <th>Medio de pago (Banco) / Firma</th>
              <th>Observaciones</th>
            </tr>
          </thead>

          <tbody>
           
          </tbody>

          <tfoot>
            <tr class="table-header-custom" style="font-weight:700">
              <td></td>
              <td class="text-end">TOTALES</td>
              <td id="total-sueldo" class="text-end">Q 0.00</td>
              <td id="total-bono" class="text-end">Q 0.00</td>
              <td id="total-dias" class="text-end"></td>
              <td id="total-comisiones" class="text-end">Q 0.00</td>
              <td id="total-horas" class="text-end">0</td>
              <td id="total-hextras" class="text-end">Q 0.00</td>
              <td id="total-devengado" class="text-end">Q 0.00</td>
              <td id="total-igss" class="text-end">Q 0.00</td>
              <td id="total-isr" class="text-end">Q 0.00</td>
              <td id="total-otras" class="text-end">Q 0.00</td>
              <td id="total-deducciones" class="text-end">Q 0.00</td>
              <td id="total-liquido" class="text-end">Q 0.00</td>
              <td></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
/* ------------------ Fiscal constants and helpers (unchanged) ------------------ */
const IGSS_RATE = 0.0483;
const GASTOS_PERSONALES_ANUAL = 48000;
const ISR_ANNUAL_RATE = 0.05;
const ISR_MIN_SALARIO = 4000.00;

const STORAGE_KEY = 'empaquetex_planilla_noviembre_v1';
const SERVER_SYNC_KEY = STORAGE_KEY + '_server_meta';

function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }
function formatNum(n){ return Number(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
function withQ(n){ return 'Q ' + formatNum(n); }

function computeHorasMontoMensual(sueldo, dias, horas) {
  if (!dias || dias <= 0) return 0;
  const valorHora = sueldo / dias / 8;
  const monto = valorHora * 1.5 * horas;
  return round2(monto);
}

function computeISRMonthlyFromRow(sueldo, bono, comisiones, hextrasMensual) {
  if ((sueldo * 2) < ISR_MIN_SALARIO) return 0;
  const sueldoBaseAnual = (sueldo * 2) * 12;
  const bonoIncentivoAnual = (bono * 2) * 12;
  const hextrasAnual = hextrasMensual * 12;
  const comisionesAnual = comisiones * 12;
  const sumaGananciasAnual = round2(sueldoBaseAnual + bonoIncentivoAnual + hextrasAnual + comisionesAnual);
  const igssLaboralAnual = round2(sumaGananciasAnual * IGSS_RATE);
  const baseCalculo = round2(sumaGananciasAnual - (GASTOS_PERSONALES_ANUAL + igssLaboralAnual));
  if (baseCalculo <= 0) return 0;
  const isrAnual = round2(baseCalculo * ISR_ANNUAL_RATE);
  const isrMensual = round2(isrAnual / 12);
  return isrMensual;
}

/* ------------------ Row calculations (unchanged) ------------------ */
function recalcRow(tr) {
  if (!tr) return;
  const sueldo = parseFloat(tr.querySelector('input.sueldo')?.value) || 0;
  const bono = parseFloat(tr.querySelector('input.bono')?.value) || 0;
  const comisiones = parseFloat(tr.querySelector('input.comisiones')?.value) || 0;
  const dias = parseInt(tr.querySelector('input.dias')?.value) || 0;
  const horas = parseInt(tr.querySelector('input.horas')?.value) || 0;
  const otras = parseFloat(tr.querySelector('input.otras')?.value) || 0;

  const hextrasMonto = computeHorasMontoMensual(sueldo, dias, horas);
  const totalDevengado = round2(sueldo + bono + comisiones + hextrasMonto);
  const igss = round2(sueldo * IGSS_RATE);

  const isrMensual = computeISRMonthlyFromRow(sueldo, bono, comisiones, hextrasMonto);

  const totalDeducciones = round2(igss + isrMensual + otras);
  const liquido = round2(totalDevengado - totalDeducciones);

  const hextrasCell = tr.querySelector('.hextras'); if (hextrasCell) hextrasCell.textContent = withQ(hextrasMonto);
  const devCell = tr.querySelector('.total-devengado'); if (devCell) devCell.textContent = withQ(totalDevengado);
  const igssCell = tr.querySelector('.igss'); if (igssCell) igssCell.textContent = withQ(igss);

  const isrCell = tr.querySelector('.isr-cell');
  if (isrCell) {
    if (isrMensual > 0) isrCell.textContent = withQ(isrMensual);
    else isrCell.textContent = '';
  }

  tr.dataset._isrValue = isrMensual;
  tr.dataset._hextras = hextrasMonto;

  const totDedCell = tr.querySelector('.total-deducciones'); if (totDedCell) totDedCell.textContent = withQ(totalDeducciones);
  const liquiCell = tr.querySelector('.liquido'); if (liquiCell) liquiCell.textContent = withQ(liquido);
}

function recalcTotals() {
  const rows = document.querySelectorAll('#planillaTable tbody tr');
  let totals = {sueldo:0, bono:0, comisiones:0, horas:0, hextras:0, devengado:0, igss:0, isr:0, otras:0, deducciones:0, liquido:0};
  rows.forEach(tr => {
    const sueldo = parseFloat(tr.querySelector('input.sueldo')?.value) || 0;
    const bono = parseFloat(tr.querySelector('input.bono')?.value) || 0;
    const comisiones = parseFloat(tr.querySelector('input.comisiones')?.value) || 0;
    const horas = parseInt(tr.querySelector('input.horas')?.value) || 0;
    const otras = parseFloat(tr.querySelector('input.otras')?.value) || 0;

    const dias = parseInt(tr.querySelector('input.dias')?.value) || 0;
    const hextrasMonto = parseFloat(tr.dataset._hextras) || computeHorasMontoMensual(sueldo, dias, horas);
    const totalDevengado = round2(sueldo + bono + comisiones + hextrasMonto);
    const igss = round2(sueldo * IGSS_RATE);
    const isrMensual = parseFloat(tr.dataset._isrValue) || 0;
    const totalDeducciones = round2(igss + isrMensual + otras);
    const liquido = round2(totalDevengado - totalDeducciones);

    totals.sueldo += sueldo;
    totals.bono += bono;
    totals.comisiones += comisiones;
    totals.horas += horas;
    totals.hextras += hextrasMonto;
    totals.devengado += totalDevengado;
    totals.igss += igss;
    totals.isr += isrMensual;
    totals.otras += otras;
    totals.deducciones += totalDeducciones;
    totals.liquido += liquido;
  });

  if (document.getElementById('total-sueldo')) document.getElementById('total-sueldo').textContent = withQ(totals.sueldo);
  if (document.getElementById('total-bono')) document.getElementById('total-bono').textContent = withQ(totals.bono);
  if (document.getElementById('total-dias')) document.getElementById('total-dias').textContent = '';
  if (document.getElementById('total-comisiones')) document.getElementById('total-comisiones').textContent = withQ(totals.comisiones);
  if (document.getElementById('total-horas')) document.getElementById('total-horas').textContent = totals.horas.toString();
  if (document.getElementById('total-hextras')) document.getElementById('total-hextras').textContent = withQ(totals.hextras);
  if (document.getElementById('total-devengado')) document.getElementById('total-devengado').textContent = withQ(totals.devengado);
  if (document.getElementById('total-igss')) document.getElementById('total-igss').textContent = withQ(totals.igss);
  if (document.getElementById('total-isr')) document.getElementById('total-isr').textContent = withQ(totals.isr);
  if (document.getElementById('total-otras')) document.getElementById('total-otras').textContent = withQ(totals.otras);
  if (document.getElementById('total-deducciones')) document.getElementById('total-deducciones').textContent = withQ(totals.deducciones);
  if (document.getElementById('total-liquido')) document.getElementById('total-liquido').textContent = withQ(totals.liquido);
}

/* ------------------ Serialization (unchanged) ------------------ */
function serializeTable() {
  const rows = [];
  document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
    const nombre = (tr.querySelector('input.nombre')?.value ?? tr.cells[1].textContent ?? '').trim();
    const sueldo = parseFloat(tr.querySelector('input.sueldo')?.value ?? 0) || 0;
    const bono = parseFloat(tr.querySelector('input.bono')?.value ?? 0) || 0;
    const dias = parseInt(tr.querySelector('input.dias')?.value ?? 0) || 0;
    const comisiones = parseFloat(tr.querySelector('input.comisiones')?.value ?? 0) || 0;
    const horas = parseInt(tr.querySelector('input.horas')?.value ?? 0) || 0;
    const otras = parseFloat(tr.querySelector('input.otras')?.value ?? 0) || 0;
    const medioPago = tr.querySelector('input.medio-pago')?.value ?? '';
    const observ = tr.querySelector('input.observaciones')?.value ?? '';
    const hextras = parseFloat(tr.dataset._hextras) || 0;
    const isr = parseFloat(tr.dataset._isrValue) || 0;
    const dpi = tr.dataset.dpi || '';
    rows.push({ nombre, sueldo, bono, dias, comisiones, horas, otras, medioPago, observ, hextras, isr, dpi });
  });
  const meta = { saved_at: new Date().toISOString(), planillaName: document.getElementById('planillaName')?.value ?? '', emisionDate: document.getElementById('emisionDate')?.value ?? '' };
  return { rows, meta };
}

function restoreTable(data) {
  if (!data || !Array.isArray(data.rows)) return;
  const tbody = document.querySelector('#planillaTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  data.rows.forEach((r, i) => {
    const idx = i + 1;
    const tr = document.createElement('tr');
    tr.dataset.row = idx;
    if (r.dpi) tr.dataset.dpi = r.dpi;
    tr.innerHTML = `
      <td>${idx}</td>
      <td class="align-middle"><input class="form-control form-control-sm nombre" type="text" value="${escapeHtml(r.nombre || '')}"></td>
      <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell sueldo" type="number" step="0.01" value="${Number(r.sueldo||0).toFixed(2)}"></div></td>
      <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control bono" type="number" step="0.01" value="${Number(r.bono||125).toFixed(2)}" readonly></div></td>
      <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="${Number(r.dias||15)}"></td>
      <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell comisiones" type="number" step="0.01" value="${Number(r.comisiones||0).toFixed(2)}"></div></td>
      <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="${Number(r.horas||0)}"></td>
      <td class="text-end hextras">Q ${Number(r.hextras||0).toFixed(2)}</td>
      <td class="text-end total-devengado">Q 0.00</td>
      <td class="text-end igss">Q 0.00</td>
      <td class="text-end isr-cell">${r.isr && r.isr>0 ? 'Q ' + Number(r.isr).toFixed(2) : ''}</td>
      <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell otras" type="number" step="0.01" value="${Number(r.otras||0).toFixed(2)}"></div></td>
      <td class="text-end total-deducciones">Q 0.00</td>
      <td class="text-end liquido">Q 0.00</td>
      <td><input class="form-control medio-pago" type="text" value="${escapeHtml(r.medioPago||'')}"></td>
      <td><input class="form-control observaciones" type="text" value="${escapeHtml(r.observ||'')}"></td>
    `;
  
    // If sueldo > 0, lock it (require admin to unlock)
const sueldoInput = tr.querySelector('input.sueldo');
const sueldoNum = Number(r.sueldo || 0);
if (sueldoInput) {
  if (sueldoNum > 0) {
    // bloquear completamente (sin selección ni foco)
    lockSueldoInput(sueldoInput);
    sueldoInput.setAttribute('data-prev', sueldoNum.toFixed(2));
  } else {
    // desbloqueado por defecto
    unlockSueldoInput(sueldoInput);
    sueldoInput.setAttribute('data-prev', (0).toFixed(2));
  }
}

    tr.dataset._hextras = Number(r.hextras||0);
    tr.dataset._isrValue = Number(r.isr||0);
    tbody.appendChild(tr);
  });
  document.querySelectorAll('#planillaTable tbody tr').forEach(tr => recalcRow(tr));
  recalcTotals();
}

/* ------------------ Utilities and UI handlers (unchanged behavior) ------------------ */
function escapeHtml(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ------------------ SUELDO locking rules and admin-edit control ------------------ */
/*
  Behavior implemented:
  - When a sueldo input receives a non-zero (or non-empty) value and loses focus, it becomes readonly and is flagged data.sueldoLocked=1.
  - Only users with role 'admin' can enable "Editar sueldos" button. When admin clicks it, sueldo fields flagged as locked become editable for the admin session.
  - After admin edits and blurs, the sueldo cells will re-lock (same logic).
  - Non-admin users never see the Edit button and cannot change locked sueldo cells.
*/

async function whoamiRole() {
  try {
    const r = await fetch('/whoami', {cache:'no-store'});
    if (!r.ok) return '';
    const j = await r.json();
    return (j && j.rol) ? String(j.rol).toLowerCase() : '';
  } catch (e) {
    return '';
  }
}

async function initSueldoEditControl() {
  const btn = document.getElementById('btnEditarSueldo');
  if (!btn) {
    // Si no existe el botón en el DOM, no hacemos nada
    console.warn('initSueldoEditControl: btnEditarSueldo no encontrado');
    return;
  }

  // Estado inicial: no en modo edición
  btn.dataset.editing = '0';
  btn.textContent = 'Editar sueldos';
  btn.classList.remove('btn-danger');
  btn.classList.add('btn-warning');
  btn.style.display = ''; // visible para todos

  // Intento de marcar flag admin (opcional, solo informativo)
  try {
    const r = await fetch('/whoami', { cache: 'no-store' });
    if (r.ok) {
      const j = await r.json();
      const role = (j && j.rol) ? String(j.rol).toLowerCase() : '';
      btn.dataset.admin = (role === 'admin') ? '1' : '0';
    } else {
      btn.dataset.admin = '0';
    }
  } catch (e) {
    btn.dataset.admin = '0';
  }

  // Click handler: visible para todos, pero solo admin puede activar edición
  btn.addEventListener('click', async () => {
    // Verificar rol en el servidor al momento del click
    let roleNow = '';
    try {
      const r2 = await fetch('/whoami', { cache: 'no-store' });
      if (r2.ok) {
        const j2 = await r2.json();
        roleNow = (j2 && j2.rol) ? String(j2.rol).toLowerCase() : '';
      }
    } catch (err) {
      roleNow = '';
    }

    // Si no es admin, mostrar mensaje y no permitir editar
    if (roleNow !== 'admin') {
      alert('Permisos insuficientes. Solo administradores pueden editar sueldos.');
      return;
    }

    // Si es admin, alternar modo edición
    const editing = btn.dataset.editing === '1';
    if (!editing) {
      // activar edición admin: desbloquear temporalmente los sueldos bloqueados
      document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
        if (tr.dataset.sueldoLocked === '1') {
          const inp = tr.querySelector('input.sueldo');
          if (inp) {
            inp.classList.add('sueldo-admin-edit');
            try { unlockSueldoInput(inp); } catch (e) { inp.removeAttribute('readonly'); }
          }
        }
      });
      btn.textContent = 'Finalizar edición sueldos';
      btn.dataset.editing = '1';
      btn.classList.remove('btn-warning');
      btn.classList.add('btn-danger');
    } else {
      // finalizar edición admin: volver a bloquear según valor
      document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
        const inp = tr.querySelector('input.sueldo');
        if (inp && inp.classList.contains('sueldo-admin-edit')) {
          inp.classList.remove('sueldo-admin-edit');
          const n = parseFloat(inp.value) || 0;
          if (n > 0) {
            try { lockSueldoInput(inp); } catch (e) { inp.setAttribute('readonly','readonly'); tr.dataset.sueldoLocked = '1'; }
            inp.setAttribute('data-prev', Number(n).toFixed(2));
          } else {
            try { unlockSueldoInput(inp); } catch (e) { inp.removeAttribute('readonly'); tr.dataset.sueldoLocked = '0'; }
            inp.setAttribute('data-prev', Number(n).toFixed(2));
          }
        }
      });
      btn.textContent = 'Editar sueldos';
      btn.dataset.editing = '0';
      btn.classList.remove('btn-danger');
      btn.classList.add('btn-warning');
      recalcTotals();
      try { saveToLocalAndServer(); } catch (e) { console.warn('save error', e); }
    }
  });
}


/* ------------------ IMPORTANT: autosave enabled so edits sync to server for all devices
   Input handler recalculates rows and totals and calls saveToLocalAndServer() so changes persist to server.
*/
document.addEventListener('input', (e) => {
  if (!e.target.classList) return;

  // Prevent non-admin edits to sueldo when locked
  if (e.target.classList.contains('sueldo')) {
    const tr = e.target.closest('tr');
    const locked = tr && tr.dataset.sueldoLocked === '1';
    // allow if user is admin editing (we mark with sueldo-admin-edit), otherwise revert
    if (locked && !e.target.classList.contains('sueldo-admin-edit')) {
      // revert the change (reload previously stored value)
      const prev = e.target.getAttribute('data-prev');
      e.target.value = Number(prev !== null ? prev : e.target.value || 0).toFixed(2);
      return;
    }
  }

  if (e.target.classList.contains('num-cell') || e.target.classList.contains('nombre') || e.target.classList.contains('medio-pago') || e.target.classList.contains('observaciones')) {
    const tr = e.target.closest('tr');
    if (tr) recalcRow(tr);
    recalcTotals();
    // Autosave on every edit so other devices receive it via server
    try { saveToLocalAndServer(); } catch (err) { console.warn('save error', err); }
  }
});

// When sueldo input loses focus, apply half-sueldo behavior once and if value > 0, lock the cell (non-admin cannot re-edit)
document.addEventListener('blur', (e) => {
  if (!e.target.classList) return;
  if (e.target.classList.contains('sueldo')) {
    // aplicar mitad si corresponde
    try { applyHalfToSueldoInput(e.target); } catch (err) { /* ignore if not present */ }

    const tr = e.target.closest('tr');
    const n = parseFloat(e.target.value) || 0;
    e.target.setAttribute('data-prev', Number(n).toFixed(2));

    if (n > 0) {
      // bloquear completamente (sin selección ni foco)
      lockSueldoInput(e.target);
      e.target.classList.remove('sueldo-admin-edit');
    } else {
      // desbloquear para edición
      unlockSueldoInput(e.target);
    }

    if (tr) recalcRow(tr);
    recalcTotals();
    try { saveToLocalAndServer(); } catch (err) { console.warn('save error', err); }
  }
}, true);


function initBonosYDias() {
  document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
    const bonoInp = tr.querySelector('input.bono');
    if (bonoInp) {
      bonoInp.value = 125.00;
      bonoInp.setAttribute('readonly', 'readonly');
      bonoInp.classList.remove('num-cell');
    }
    const diasInp = tr.querySelector('input.dias');
    if (diasInp) {
      const val = parseInt(diasInp.value);
      if (!isFinite(val) || val <= 0) diasInp.value = 15;
    }
    recalcRow(tr);
  });
  recalcTotals();
}

function createRowHtml(index) {
  return `
    <td>${index}</td>
    <td class="align-middle"><input class="form-control form-control-sm nombre" type="text" value=""></td>
    <td>
      <div class="money-inline">
        <span class="money-prefix">Q</span>
        <input class="form-control num-cell sueldo" type="number" step="0.01" value="0.00">
      </div>
    </td>
    <td>
      <div class="money-inline">
        <span class="money-prefix">Q</span>
        <input class="form-control bono" type="number" step="0.01" value="125.00" readonly>
      </div>
    </td>
    <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="15"></td>
    <td>
      <div class="money-inline">
        <span class="money-prefix">Q</span>
        <input class="form-control num-cell comisiones" type="number" step="0.01" value="0.00">
      </div>
    </td>
    <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="0"></td>
    <td class="text-end hextras">Q 0.00</td>
    <td class="text-end total-devengado">Q 0.00</td>
    <td class="text-end igss">Q 0.00</td>
    <td class="text-end isr-cell"></td>
    <td>
      <div class="money-inline">
        <span class="money-prefix">Q</span>
        <input class="form-control num-cell otras" type="number" step="0.01" value="0.00">
      </div>
    </td>
    <td class="text-end total-deducciones">Q 0.00</td>
    <td class="text-end liquido">Q 0.00</td>
    <td><input class="form-control medio-pago" type="text" value=""></td>
    <td><input class="form-control observaciones" type="text" value=""></td>
  `;
}

document.addEventListener('blur', (e) => {
  if (!e.target.classList) return;
  if (e.target.classList.contains('nombre')) {
    const val = (e.target.value || '').trim();
    if (val !== '') {
      e.target.setAttribute('readonly', 'readonly');
    }
  }
}, true);

function enforceFixedFieldsOnAllRows() {
  document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
    const bonoInp = tr.querySelector('input.bono');
    if (bonoInp) {
      bonoInp.value = 125.00;
      bonoInp.setAttribute('readonly', 'readonly');
    }
    const diasInp = tr.querySelector('input.dias');
    if (diasInp) diasInp.value = 15;
  });
}

/* Row add/delete handlers with accidental-deletion protection
   Now they autosave (so changes propagate to server), but still ask confirmations for imported rows.
*/
document.getElementById('addRow').addEventListener('click', () => {
  const tbody = document.querySelector('#planillaTable tbody');
  const newIndex = tbody.querySelectorAll('tr').length + 1;
  const tr = document.createElement('tr');
  tr.dataset.row = newIndex;
  tr.dataset.new = "true"; // mark as user-created
  tr.innerHTML = createRowHtml(newIndex);
  tbody.appendChild(tr);
  // Ensure new row sueldo is unlocked explicitly
const sueldoInp = tr.querySelector('input.sueldo');
if (sueldoInp) {
  unlockSueldoInput(sueldoInp);
  sueldoInp.setAttribute('data-prev', Number(0).toFixed(2));
}


  const nombreInp = tr.querySelector('input.nombre');
  if (nombreInp) nombreInp.removeAttribute('readonly');

  const bonoInp = tr.querySelector('input.bono');
  if (bonoInp) {
    bonoInp.value = 125.00;
    bonoInp.setAttribute('readonly', 'readonly');
  }
  const diasInp = tr.querySelector('input.dias');
  if (diasInp) diasInp.value = 15;

  // New rows: sueldo default 0 and unlocked
  tr.dataset.sueldoLocked = '0';

  recalcRow(tr);
  recalcTotals();
  // autosave for everyone
  saveToLocalAndServer();
});

async function canCurrentUserDelete() {
  try {
    const r = await fetch('/whoami', {cache:'no-store'});
    if (!r.ok) return false;
    const j = await r.json();
    const role = (j && j.rol) ? String(j.rol).toLowerCase() : '';
    return role === 'admin';
  } catch (e) {
    console.warn('whoami error', e);
    return false;
  }
}

document.getElementById('deleteRow').addEventListener('click', async () => {
  const tbody = document.querySelector('#planillaTable tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  if (rows.length === 0) return;

  const last = rows[rows.length - 1];

  // If the row was imported from server (has data-dpi) or name is readonly, require admin + confirmation
  const isServerRow = !!last.dataset.dpi;
  const nameInput = last.querySelector('input.nombre');
  const nameReadonly = nameInput && nameInput.hasAttribute('readonly');

  if (isServerRow || nameReadonly) {
    const ok = await canCurrentUserDelete();
    if (!ok) {
      alert('Permisos insuficientes para eliminar filas importadas. Solo administradores pueden eliminarlas.');
      return;
    }
    const dpi = last.dataset.dpi || '';
    const confirmMsg = dpi ? `Confirma eliminar la fila importada con DPI ${dpi}?` : 'Confirma eliminar la última fila importada?';
    if (!confirm(confirmMsg)) return;
  } else {
    // For user-created rows ask light confirmation
    if (!confirm('¿Eliminar la última fila añadida?')) return;
  }

  tbody.removeChild(last);
  recalcTotals();
  // autosave after delete
  saveToLocalAndServer();
});

/* Export to Excel (unchanged) */
document.getElementById('exportExcel').addEventListener('click', () => {
  const dateInput = document.getElementById('emisionDate').value;
  const planillaName = document.getElementById('planillaName').value.trim() || 'Planilla';
  const exportHint = document.getElementById('exportHint');
  if (!dateInput) {
    if (exportHint) exportHint.style.display = 'inline';
    return;
  }
  if (exportHint) exportHint.style.display = 'none';

  const table = document.getElementById('planillaTable');
  const clone = table.cloneNode(true);
  clone.querySelectorAll('input').forEach(inp => {
    const parent = inp.parentElement || inp;
    parent.replaceChild(document.createTextNode(inp.value), inp);
  });

  clone.querySelectorAll('td, th').forEach(cell => {
    let txt = (cell.textContent || '').replace(/\u00A0/g, ' ').trim();
    if (txt === '') return;
    const removed = txt.replace(/^Q\s*/i, '').replace(/,/g, '');
    const n = Number(removed);
    if (removed !== '' && isFinite(n)) cell.textContent = n;
    else cell.textContent = txt;
  });

  const ws = XLSX.utils.table_to_sheet(clone, {raw:true});
  ws['!cols'] = [
    { wch: 6 }, { wch: 40 }, { wch: 20 }, { wch: 14 }, { wch: 12 }, { wch: 14 },
    { wch: 10 }, { wch: 18 }, { wch: 18 }, { wch: 16 }, { wch: 16 }, { wch: 16 },
    { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 24 }
  ];

  const range = XLSX.utils.decode_range(ws['!ref']);
  const headerRowIndex = range.s.r;
  const maxCol = range.e.c;

  for (let c = range.s.c; c <= maxCol; c++) {
    const cellAddr = XLSX.utils.encode_cell({ c: c, r: headerRowIndex });
    if (!ws[cellAddr]) continue;
    ws[cellAddr].s = ws[cellAddr].s || {};
    ws[cellAddr].s.fill = { patternType: "solid", fgColor: { rgb: "0EA5A4" } };
    ws[cellAddr].s.font = { name: "Calibri", sz: 11, bold: true, color: { rgb: "FFFFFF" } };
    ws[cellAddr].s.alignment = { vertical: "center", horizontal: "center" };
    ws[cellAddr].s.border = {
      top: { style: "thin", color: { rgb: "BFDCE3" } },
      bottom: { style: "thin", color: { rgb: "BFDCE3" } },
      left: { style: "thin", color: { rgb: "BFDCE3" } },
      right: { style: "thin", color: { rgb: "BFDCE3" } }
    };
  }

  let totalsRow = null;
  for (let r = headerRowIndex + 1; r <= range.e.r; r++) {
    const cellB = XLSX.utils.encode_cell({r, c: 1});
    if (ws[cellB] && String(ws[cellB].v).toUpperCase().includes('TOTALES')) {
      totalsRow = r;
      break;
    }
  }
  if (totalsRow === null) totalsRow = range.e.r;

  for (let c = range.s.c; c <= maxCol; c++) {
    const addr = XLSX.utils.encode_cell({r: totalsRow, c});
    if (!ws[addr]) continue;
    ws[addr].s = ws[addr].s || {};
    ws[addr].s.fill = { patternType: "solid", fgColor: { rgb: "035E59" } };
    ws[addr].s.font = { name: "Calibri", sz: 11, bold: true, color: { rgb: "FFFFFF" } };
    ws[addr].s.alignment = { vertical: "center", horizontal: (c < 2 ? "left" : "right") };
    ws[addr].s.border = {
      top: { style: "medium", color: { rgb: "0B7285" } },
      bottom: { style: "medium", color: { rgb: "0B7285" } },
      left: { style: "thin", color: { rgb: "BFDCE3" } },
      right: { style: "thin", color: { rgb: "BFDCE3" } }
    };
  }

  for (let R = headerRowIndex; R <= range.e.r; ++R) {
    for (let C = range.s.c; C <= maxCol; ++C) {
      const addr = XLSX.utils.encode_cell({r:R,c:C});
      if (!ws[addr]) continue;
      ws[addr].s = ws[addr].s || {};
      ws[addr].s.border = ws[addr].s.border || {
        top: { style: "thin", color: { rgb: "E6EEF6" } },
        bottom: { style: "thin", color: { rgb: "E6EEF6" } },
        left: { style: "thin", color: { rgb: "E6EEF6" } },
        right: { style: "thin", color: { rgb: "E6EEF6" } }
      };
    }
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Planilla");
  wb.Workbook = wb.Workbook || {};
  wb.Workbook.Views = wb.Workbook.Views || [{ RTL: false }];

  const safeName = planillaName.replace(/[^a-z0-9_\- ]/gi,'').replace(/\s+/g,'_');
  const filename = `${safeName}_${dateInput}.xlsx`;
  XLSX.writeFile(wb, filename);
});

/* ------------------ Auto half-sueldo behavior (fixed: ensure applied only once) ------------------ */
(function(){
  function parseNumberSafe(v){
    if (v == null) return 0;
    try {
      const s = String(v).replace(/\s+/g,'').replace(/,/g,'').trim();
      const n = Number(s);
      return isFinite(n) ? n : 0;
    } catch {
      return 0;
    }
  }

  // Expose applyHalfToSueldoInput globally and ensure it's called exactly once per blur/paste action.
  window.applyHalfToSueldoInput = function(inp){
    if (!inp) return;
    const raw = inp.value;
    const n = parseNumberSafe(raw);
    if (n === 0) {
      inp.value = n.toFixed(2);
    } else {
      const half = Math.round((n / 2 + Number.EPSILON) * 100) / 100;
      if (inp.type === 'number') inp.value = half;
      else inp.value = half.toFixed(2);
    }
    try {
      const tr = inp.closest('tr');
      if (typeof recalcRow === 'function' && tr) recalcRow(tr);
      if (typeof recalcTotals === 'function') recalcTotals();
      if (typeof saveToLocal === 'function') saveToLocal();
    } catch (e) { console.error('Error aplicando mitad al sueldo:', e); }
  }

  // Keep paste handler so pasted numbers are normalized and halved once
  document.addEventListener('paste', function(e){
    const t = e.target;
    if (!t || !t.classList) return;
    if (t.classList.contains('sueldo')) {
      setTimeout(() => applyHalfToSueldoInput(t), 20);
    }
  });

  // Important: only one blur listener calls applyHalfToSueldoInput (the central one above).
  // No additional blur listeners here to avoid double division.
})();

/* ------------------ Sync with server: /api/empleados, /api/planilla, /guardar_planilla ------------------ */

/*
 Notes for server:
 - This client expects these endpoints (your Flask provides them):
    GET  /api/planilla        -> returns { rows: [...], meta: { server_saved_at: ISO, planillaName, emisionDate } } OR 204/empty
    POST /guardar_planilla    -> accepts { rows, meta } and returns { ok:true, saved_at: ISO }
 - Client now autosaves on edit/add/delete so changes propagate to server and are visible on other machines.
*/

const POLL_INTERVAL_MS = 20000; // 20s
let pollHandle = null;
let lastKnownServerSavedAt = null;
let pendingServerSave = null;

async function fetchEmployeesList() {
  try {
    const res = await fetch('/api/empleados');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    return Array.isArray(data) ? data : [];
  } catch (e) {
    console.warn('Error fetching /api/empleados:', e);
    return [];
  }
}

function addEmployeeRowIfMissing(emp) {
  if (!emp) return false;
  const dpi = String(emp.dpi || '').trim();
  const full = (emp.full_name || emp.fullName || emp.fullname || emp.Nombre || '').trim();
  if (!dpi || !full) return false;

  const tbody = document.querySelector('#planillaTable tbody');
  if (!tbody) return false;

  // If a row with same dpi exists, skip
  const existing = tbody.querySelector(`tr[data-dpi="${dpi}"]`);
  if (existing) return false;

  // Also check names to avoid duplicate when DPI missing
  const nameExists = Array.from(tbody.querySelectorAll('input.nombre')).some(inp => (inp.value||'').trim() === full);
  if (nameExists) return false;

  const idx = tbody.querySelectorAll('tr').length + 1;
  const tr = document.createElement('tr');
  tr.dataset.row = idx;
  tr.dataset.dpi = dpi; // mark row with dpi
  tr.innerHTML = createRowHtml(idx);

  // fill name (readonly) and default sueldo 0
  const nameInput = tr.querySelector('input.nombre');
  if (nameInput) {
    nameInput.value = full;
    nameInput.setAttribute('readonly', 'readonly');
  }
  const sueldoInput = tr.querySelector('input.sueldo');
  if (sueldoInput) sueldoInput.value = (0).toFixed(2);

  // ensure fixed fields
  const bonoInp = tr.querySelector('input.bono');
  if (bonoInp) { bonoInp.value = 125.00; bonoInp.setAttribute('readonly','readonly'); }
  const diasInp = tr.querySelector('input.dias');
  if (diasInp) diasInp.value = 15;

  // mark sueldo unlocked initially for imported rows with 0
  tr.dataset.sueldoLocked = '0';

  tbody.appendChild(tr);
  recalcRow(tr);
  recalcTotals();
  return true;
}

async function syncEmployeesOnce() {
  const list = await fetchEmployeesList();
  if (!list || !list.length) return;
  let added = 0;
  for (const emp of list) {
    const ok = addEmployeeRowIfMissing(emp);
    if (ok) added++;
  }
  if (added > 0) {
    saveToLocalAndServer();
  }
}

function startEmployeesPolling() {
  syncEmployeesOnce();
  if (pollHandle) clearInterval(pollHandle);
  pollHandle = setInterval(syncEmployeesOnce, POLL_INTERVAL_MS);
}

/* ------------------ LocalStorage helpers + server sync (unchanged) ------------------ */

function saveToLocal() {
  try {
    const data = serializeTable();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {
    console.error('Error saving planilla to localStorage', e);
  }
}

function loadFromLocal() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const obj = JSON.parse(raw);
    if (obj && Array.isArray(obj.rows) && obj.rows.length) {
      restoreTable(obj);
      if (obj.meta) {
        if (obj.meta.planillaName) document.getElementById('planillaName').value = obj.meta.planillaName;
        if (obj.meta.emisionDate) document.getElementById('emisionDate').value = obj.meta.emisionDate;
      }
      // load last known server meta if present
      const serverMetaRaw = localStorage.getItem(SERVER_SYNC_KEY);
      if (serverMetaRaw) {
        try { const m = JSON.parse(serverMetaRaw); lastKnownServerSavedAt = m.server_saved_at || null; } catch {}
      }
      return true;
    }
    return false;
  } catch (e) {
    console.error('Error loading planilla from localStorage', e);
    return false;
  }
}

function saveServerMeta(meta) {
  try {
    localStorage.setItem(SERVER_SYNC_KEY, JSON.stringify(meta || {}));
    lastKnownServerSavedAt = meta && meta.server_saved_at ? meta.server_saved_at : lastKnownServerSavedAt;
  } catch (e) { console.warn('saveServerMeta error', e); }
}

function safeFetchJson(url, opts = {}) {
  return fetch(url, opts).then(r => {
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.json().catch(() => ({}));
  });
}

function saveToServerOnce(payload) {
  return safeFetchJson('/guardar_planilla', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}

async function saveToLocalAndServer() {
  // always save locally
  try { saveToLocal(); } catch (e) { console.error('local save error', e); }

  // queue server save (if another save pending, let it finish first)
  if (pendingServerSave) {
    // schedule one later to reduce contention
    setTimeout(saveToLocalAndServer, 800);
    return;
  }

  const payload = serializeTable();
  payload.meta = payload.meta || {};
  payload.meta.client_saved_at = new Date().toISOString();

  pendingServerSave = payload;
  try {
    const res = await saveToServerOnce(payload);
    if (res && (res.saved_at || res.server_saved_at)) {
      const meta = { server_saved_at: res.saved_at || res.server_saved_at, planillaName: payload.meta.planillaName || '', emisionDate: payload.meta.emisionDate || '' };
      saveServerMeta(meta);
      console.info('Planilla synced to server at', meta.server_saved_at);
    } else {
      if (res && res.ok) {
        const now = new Date().toISOString();
        saveServerMeta({ server_saved_at: now, planillaName: payload.meta.planillaName || '', emisionDate: payload.meta.emisionDate || '' });
      }
    }
    // show success toast with timestamp
    showSavedToast(true);
  } catch (err) {
    console.warn('server save failed, will retry once', err);
    // local saved already; show local-saved toast with failure flag
    showSavedToast(false);
    setTimeout(async () => {
      try {
        await saveToServerOnce(payload);
        const now = new Date().toISOString();
        saveServerMeta({ server_saved_at: now, planillaName: payload.meta.planillaName || '', emisionDate: payload.meta.emisionDate || '' });
        console.info('Retry server save succeeded');
        showSavedToast(true);
      } catch (e) {
        console.warn('server save retry failed', e);
        showSavedToast(false);
      } finally {
        pendingServerSave = null;
      }
    }, 1400);
    pendingServerSave = null;
    return;
  }
  pendingServerSave = null;
}

/* ------------------ Server planilla load + polling for remote changes ------------------ */

async function tryLoadServerPlanillaOnce() {
  try {
    const res = await fetch('/api/planilla', { cache: 'no-store' });
    if (!res.ok) return null;
    const data = await res.json();
    if (data && Array.isArray(data.rows) && data.rows.length) return data;
    return null;
  } catch (e) {
    console.warn('Error fetching /api/planilla', e);
    return null;
  }
}

async function pollServerPlanilla() {
  try {
    const res = await fetch('/api/planilla', { cache: 'no-store' });
    if (!res.ok) return;
    const data = await res.json().catch(()=>null);
    if (!data || !Array.isArray(data.rows) || !data.rows.length) return;
    const serverMeta = data.meta || {};
    const serverSavedAt = serverMeta.server_saved_at || serverMeta.saved_at || null;

    const localRaw = localStorage.getItem(STORAGE_KEY);
    if (!localRaw) {
      console.info('No local planilla, restoring server version');
      restoreTable(data);
      if (data.meta) {
        if (data.meta.planillaName) document.getElementById('planillaName').value = data.meta.planillaName;
        if (data.meta.emisionDate) document.getElementById('emisionDate').value = data.meta.emisionDate;
      }
      saveToLocal();
      saveServerMeta(serverMeta);
      return;
    }

    if (serverSavedAt && (!lastKnownServerSavedAt || new Date(serverSavedAt) > new Date(lastKnownServerSavedAt))) {
      const localObj = JSON.parse(localRaw);
      const localMeta = localObj.meta || {};
      const localClientSavedAt = localMeta.client_saved_at || localMeta.saved_at || null;

      if (localClientSavedAt && new Date(localClientSavedAt) > new Date(serverSavedAt)) {
        console.info('Server has older data than local edits; keeping local');
        saveServerMeta(serverMeta);
        return;
      }

      console.info('Server planilla newer, restoring from server');
      restoreTable(data);
      if (data.meta) {
        if (data.meta.planillaName) document.getElementById('planillaName').value = data.meta.planillaName;
        if (data.meta.emisionDate) document.getElementById('emisionDate').value = data.meta.emisionDate;
      }
      saveToLocal();
      saveServerMeta(serverMeta);
    }
  } catch (e) {
    console.warn('Error in pollServerPlanilla', e);
  }
}

function startServerPolling() {
  if (pollHandle) clearInterval(pollHandle);
  pollServerPlanilla();
  pollHandle = setInterval(pollServerPlanilla, POLL_INTERVAL_MS);
}

/* ------------------ populate behavior on load (unchanged) ------------------ */

async function populateFromEmployeesIfEmpty() {
  const restored = loadFromLocal();
  if (restored) {
    startEmployeesPolling();
    startServerPolling();
    return;
  }

  const serverPlanilla = await tryLoadServerPlanillaOnce();
  if (serverPlanilla) {
    restoreTable(serverPlanilla);
    if (serverPlanilla.meta) {
      if (serverPlanilla.meta.planillaName) document.getElementById('planillaName').value = serverPlanilla.meta.planillaName;
      if (serverPlanilla.meta.emisionDate) document.getElementById('emisionDate').value = serverPlanilla.meta.emisionDate;
      saveServerMeta(serverPlanilla.meta);
    }
    saveToLocal();
    startEmployeesPolling();
    startServerPolling();
    return;
  }

  const employees = await fetchEmployeesList();
  if (employees && employees.length) {
    const tbody = document.querySelector('#planillaTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    employees.forEach((emp, i) => {
      const dpi = String(emp.dpi || '').trim();
      const full = (emp.full_name || emp.fullName || emp.fullname || emp.Nombre || '').trim();
      const idx = i + 1;
      const tr = document.createElement('tr');
      tr.dataset.row = idx;
      if (dpi) tr.dataset.dpi = dpi;
      tr.innerHTML = createRowHtml(idx);
      const nameInput = tr.querySelector('input.nombre');
      if (nameInput) {
        nameInput.value = full;
        nameInput.setAttribute('readonly', 'readonly');
      }
      const sueldoInput = tr.querySelector('input.sueldo');
      if (sueldoInput) sueldoInput.value = (0).toFixed(2);
      const bonoInp = tr.querySelector('input.bono');
      if (bonoInp) { bonoInp.value = 125.00; bonoInp.setAttribute('readonly','readonly'); }
      const diasInp = tr.querySelector('input.dias');
      if (diasInp) diasInp.value = 15;
      // mark sueldo unlocked initially for imported employees
      tr.dataset.sueldoLocked = '0';
      tbody.appendChild(tr);
    });
    document.querySelectorAll('#planillaTable tbody tr').forEach(tr => recalcRow(tr));
    recalcTotals();
    saveToLocalAndServer();
  }
  startEmployeesPolling();
  startServerPolling();
}

/* ------------------ Guardar button hookup + toast ------------------
   The button triggers saveToLocalAndServer(); toast shows timestamp and success/local-only status */
function showSavedToast(serverOk) {
  const id = '__planilla_saved_toast';
  const prev = document.getElementById(id);
  if (prev) prev.remove();

  const d = document.createElement('div');
  d.id = id;
  d.className = 'alert py-1 px-2 small position-fixed';
  d.style.top = '12px';
  d.style.right = '12px';
  d.style.zIndex = 99999;
  d.style.borderRadius = '6px';
  d.style.boxShadow = '0 6px 20px rgba(11,114,133,0.08)';
  d.style.background = serverOk ? '#D1FAE5' : '#FFF3CD';
  d.style.color = serverOk ? '#065F46' : '#7A4F01';

  const ts = new Date();
  const hh = String(ts.getHours()).padStart(2,'0');
  const mm = String(ts.getMinutes()).padStart(2,'0');
  const ss = String(ts.getSeconds()).padStart(2,'0');
  const timeStr = `${hh}:${mm}:${ss}`;

  d.innerText = serverOk ? `Planilla guardada - ${timeStr}` : `Planilla guardada localmente - ${timeStr}`;
  document.body.appendChild(d);
  setTimeout(() => {
    const el = document.getElementById(id);
    if (el) el.remove();
  }, 3500);
}

document.getElementById('btnGuardarPlanilla').addEventListener('click', async () => {
  try {
    // Ensure calculations up-to-date
    document.querySelectorAll('#planillaTable tbody tr').forEach(tr => recalcRow(tr));
    recalcTotals();

    // Save locally + try server sync (function already saves locally as first step)
    await saveToLocalAndServer();
    showSavedToast(true);
  } catch (e) {
    console.warn('Error al guardar planilla:', e);
    showSavedToast(false);
  }
});

/* ------------------ Initialization ------------------ */
document.addEventListener('DOMContentLoaded', async () => {

  const restored = loadFromLocal();

  initBonosYDias();
  enforceFixedFieldsOnAllRows();

  // Initialize sueldo locking UI and button based on user role
  await initSueldoEditControl();
// --- Activar edición admin: desbloquear temporalmente los sueldos bloqueados ---
document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
  if (tr.dataset.sueldoLocked === '1') {
    const inp = tr.querySelector('input.sueldo');
    if (inp) {
      // marcar como edición admin y permitir interacción temporalmente
      inp.classList.add('sueldo-admin-edit');
      unlockSueldoInput(inp); // permite selección y foco temporalmente
    }
  }
});

// actualizar estado del botón y apariencia
btn.textContent = 'Finalizar edición sueldos';
btn.dataset.editing = '1';
btn.classList.remove('btn-warning');
btn.classList.add('btn-danger');

// finalizar edición admin: volver a bloquear según valor
document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
  const inp = tr.querySelector('input.sueldo');
  if (inp && inp.classList.contains('sueldo-admin-edit')) {
    inp.classList.remove('sueldo-admin-edit');
    const n = parseFloat(inp.value) || 0;
    if (n > 0) {
      lockSueldoInput(inp);
      inp.setAttribute('data-prev', Number(n).toFixed(2));
    } else {
      unlockSueldoInput(inp);
      inp.setAttribute('data-prev', Number(n).toFixed(2));
    }
  }
});
btn.textContent = 'Editar sueldos';
btn.dataset.editing = '0';
btn.classList.remove('btn-danger');
btn.classList.add('btn-warning');
recalcTotals();
try { saveToLocalAndServer(); } catch (e) { console.warn('save error', e); }


  populateFromEmployeesIfEmpty();

  // do not force extra save here; autosave runs on edits/add/delete
});
// Normalizar bloqueo/desbloqueo según valores actuales y reaplicar guardInput
document.querySelectorAll('input.sueldo').forEach(inp => {
  const n = parseFloat(inp.value) || 0;
  if (n > 0) lockSueldoInput(inp);
  else unlockSueldoInput(inp);
  if (typeof guardInput === 'function') guardInput(inp);
});


// --- Helpers: lock / unlock sueldo inputs ---
function lockSueldoInput(inp) {
  if (!inp) return;
  inp.classList.add('sueldo-locked');
  inp.setAttribute('readonly', 'readonly');
  inp.setAttribute('tabindex', '-1');
  inp.setAttribute('aria-disabled', 'true');
  const tr = inp.closest('tr');
  if (tr) tr.dataset.sueldoLocked = '1';
}
function unlockSueldoInput(inp) {
  if (!inp) return;
  inp.classList.remove('sueldo-locked');
  inp.removeAttribute('readonly');
  inp.removeAttribute('tabindex');
  inp.removeAttribute('aria-disabled');
  const tr = inp.closest('tr');
  if (tr) tr.dataset.sueldoLocked = '0';
}

</script>

<style>
  :root{
    --bg-grad-start: #f3f6ff;
    --bg-grad-end: #fafbff;
    --muted: #6c757d;
    --accent1: #0ea5a4;
    --accent2: #0b7285;
    --panel: #f8f9fa;
    --planilla-cell-vertical-padding: 1.6rem;
    --planilla-cell-horizontal-padding: 1.5rem;
    --planilla-input-min-height: 60px;
    --planilla-input-font-size: 1.03rem;
    --planilla-money-min-width: 260px;
    --planilla-name-col-min-width: 360px;

    /* Header specific */
    --header-bg: #ffffff;
    --toolbar-bg: linear-gradient(90deg,var(--accent1),var(--accent2));
    --btn-export-bg: linear-gradient(90deg,#18b2aa,#0b7285);
    --btn-save-bg: linear-gradient(90deg,#10b981,#059669);
    --btn-secondary-bg: #6c757d;
    --btn-danger-outline-border: #ef4444;
    --btn-warning-outline-border: #f59e0b;
  }

  body { background: linear-gradient(180deg,var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); }
  .card { border-radius: .6rem; }
  .card .card-body { padding: 1rem 1.1rem; background: var(--header-bg); }
  h3 { font-weight:600; color:var(--accent2); }

  .controls .control-label { font-size: .8rem; color: var(--muted); margin:0; }

  .field input.form-control { min-width: 220px; max-width: 320px; }

  .input-with-icon { display:flex; align-items:center; gap:8px; }
  .calendar-icon {
    display:inline-block;
    width:28px;
    height:28px;
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="%230b7285" viewBox="0 0 16 16"><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h.5A1.5 1.5 0 0 1 15 2.5v11A1.5 1.5 0 0 1 13.5 15h-11A1.5 1.5 0 0 1 1 13.5v-11A1.5 1.5 0 0 1 2.5 1H3V.5A.5.5 0 0 1 3.5 0zM2.5 3A.5.5 0 0 0 2 3.5V4h12v-.5a.5.5 0 0 0-.5-.5H13v.5a.5.5 0 0 1-1 0V3H4v.5a.5.5 0 0 1-1 0V3H2.5z"/></svg>') no-repeat center center;
    background-size: 18px;
    opacity: .85;
  }

  .action-toolbar { min-width: 360px; }

  /* toolbar buttons: consistent sizing and spacing */
  .btn-group-main { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .btn {
    border-radius: .45rem;
    padding: .38rem .6rem;
    font-size: .88rem;
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    cursor: pointer;
    border: none;
  }

  .btn-export {
    background: var(--btn-export-bg);
    color: #fff;
    box-shadow: 0 6px 18px rgba(11,114,133,0.08);
  }

  .btn-save {
    background: var(--btn-save-bg);
    color: #fff;
    box-shadow: 0 6px 12px rgba(16,185,129,0.06);
  }

  .btn-secondary {
    background: #e9ecef;
    color: #212529;
    border: 1px solid #d1d5db;
  }

  .btn-danger-outline {
    background: transparent;
    color: #ef4444;
    border: 1px solid var(--btn-danger-outline-border);
  }

  .btn-warning-outline {
    background: transparent;
    color: #b45309;
    border: 1px solid var(--btn-warning-outline-border);
  }

  .btn-export svg { margin-right: 6px; }

  .text-danger { color:#dc2626; }

  /* keep existing table styles mostly unchanged */
  .form-control { border-radius:.45rem; font-size: var(--planilla-input-font-size); }

  .table-header-custom { background: linear-gradient(90deg,#0ea5a4,#036b6a); }
  .table-header-custom th { color:#fff; border:0; font-weight:700; padding:.9rem 1rem; }

  table.table { border-collapse: separate; border-spacing:0; border-radius:.6rem; overflow:hidden; box-shadow: 0 1px 2px rgba(15,23,42,0.04); width:100%; }
  table.table td, table.table th {
    vertical-align: middle;
    padding: var(--planilla-cell-vertical-padding) var(--planilla-cell-horizontal-padding);
  }

  .horizontal-scroll { overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .text-end { text-align:right; }
  .fw-bold { font-weight:700; }

  .money-inline {
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    white-space: nowrap;
    flex-wrap: nowrap;
    vertical-align: middle;
  }
  .money-prefix {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex: 0 0 auto;
    margin-right: 0;
    min-width: 46px;
    height: var(--planilla-input-min-height);
    padding: 0 .8rem;
    border-radius: .45rem;
    background: linear-gradient(180deg,#fff 0%, #f3f6fb 100%);
    border:1px solid rgba(0,0,0,0.06);
    font-weight:600;
    color:#333;
    box-sizing: border-box;
  }

  .money-inline .form-control {
    min-width: var(--planilla-money-min-width);
    min-height: var(--planilla-input-min-height);
    height: var(--planilla-input-min-height);
    padding-top: .50rem;
    padding-bottom: .50rem;
    box-sizing: border-box;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #planillaTable input.form-control {
    font-size: var(--planilla-input-font-size);
    min-height: var(--planilla-input-min-height);
    height: var(--planilla-input-min-height);
    box-sizing: border-box;
    padding: .45rem .6rem;
    white-space: nowrap;
  }

  /* visual hint for admin-editable sueldo fields */
  input.sueldo.sueldo-admin-edit {
    outline: 2px dashed #f59e0b;
    background: #fff7ed;
  }
  /* Make sueldo inputs not selectable and hide caret when not admin-editable */
input.sueldo {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  caret-color: transparent;
  cursor: default;
}

/* When admin enables edition (sueldo-admin-edit) restore normal behavior */
input.sueldo.sueldo-admin-edit {
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
  caret-color: auto;
  cursor: text;
}

/* Avoid visible focus ring when not editable; keep accessible ring for admin-edit */
input.sueldo:focus:not(.sueldo-admin-edit) {
  outline: none;
}


  #planillaTable td.total-devengado,
  #planillaTable td.igss,
  #planillaTable td.total-deducciones,
  #planillaTable td.liquido,
  #planillaTable td.isr-cell {
    white-space: nowrap;
  }

  #planillaTable col:nth-child(2),
  #planillaTable td:nth-child(2),
  #planillaTable th:nth-child(2) {
    min-width: var(--planilla-name-col-min-width);
    white-space: normal;
    word-break: break-word;
  }

  #planillaTable td input.horas {
    text-align:center;
    padding-top: .35rem;
    padding-bottom: .35rem;
    height: calc(var(--planilla-input-min-height) - .8rem);
  }

  table.table tbody tr { background: #fff; }
  table.table tbody tr:nth-child(odd) { background: #fbfeff; }

  @media (max-width: 1000px) {
    :root {
      --planilla-money-min-width: 200px;
      --planilla-input-min-height: 56px;
      --planilla-cell-horizontal-padding: 1.2rem;
      --planilla-name-col-min-width: 300px;
      --planilla-cell-vertical-padding: 1.2rem;
    }
    #planillaTable { min-width: 1400px; }
  }

  /* ---- Responsive improvements added for header ---- */
  @media (max-width: 768px) {
    .card .card-body { padding: .75rem; }
    .controls { gap: 8px; }
    .control-group { flex: 1 1 220px; }
    .action-toolbar { margin-top: 6px; }
    .btn-group-main { justify-content: flex-start; }
    .field input.form-control { min-width: 140px; max-width: 260px; }
  }

  @media (max-width: 480px) {
    .controls { flex-direction: column; align-items:stretch; gap:10px; }
    .action-toolbar { width:100%; display:flex; justify-content: flex-start; }
    .btn-group-main { width:100%; gap:8px; flex-wrap:wrap; }
    .btn { flex: 1 1 auto; justify-content:center; }
    .field input.form-control { width:100%; }
  }

  /* ---- End responsive improvements ---- */

table.table {
  border-collapse: collapse;
}
table.table th,
table.table td {
  border-right: 1px solid #e6eef6;
  border-bottom: 1px solid #e9f0f7;
}
table.table th:last-child,
table.table td:last-child {
  border-right: none;
}
.table-header-custom th {
  border-bottom: 2px solid rgba(15,23,42,0.06);
}
table.table th:first-child,
table.table td:first-child {
  border-left: 1px solid #e6eef6;
}
table.table tbody tr:first-child td {
  border-top: 1px solid #eef6fb;
}
.table-responsive { overflow-x:auto; -webkit-overflow-scrolling:touch; }
#planillaTable tfoot tr td {
  border-top: 2px solid var(--tfoot-top-border);
  border-right: 1px solid #e6eef6;
}
#planillaTable tfoot tr td:last-child {
  border-right: none;
}
  .sueldo-locked {
  pointer-events: none;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  outline: none !important;
}
.sueldo-admin-edit {
  pointer-events: auto !important;
  user-select: text !important;
}


</style>

{% endblock %}
