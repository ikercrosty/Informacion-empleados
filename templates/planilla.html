{% extends "layout.html" %}
{% block title %}Planilla - Noviembre 2025{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
      <div>
        <h3 class="mb-0" style="letter-spacing:.2px">Planilla - Empaquetex </h3>
        <div class="text-muted small mt-1">Empresa: EMPAQUES Y TEXTURAS DE GUATEMALA, SOCIEDAD ANÓNIMA</div>
      </div>

      <div class="d-flex flex-wrap align-items-center gap-2">
        <h6>Ingrese nombre para el documento: </h6><input id="planillaName" class="form-control form-control-sm" type="text" value="Planilla " style="min-width:240px" />
        <br>
        <h6>Ingrese fecha de emisión del documento: </h6><input id="emisionDate" class="form-control form-control-sm" type="date" />
        <button id="exportExcel" class="btn btn-primary btn-sm d-flex align-items-center" title="Exportar a Excel">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-file-earmark-excel me-2" viewBox="0 0 16 16"><path d="M5.884 6.68 4.52 9.5l1.364 2.82H3.54L2 9.5l1.54-2.82h1.344z"/><path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zM10.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V5.5H10.5A1.5 1.5 0 0 1 9 4V3.5z"/></svg>
          Exportar a Excel
        </button>
        <button id="addRow" class="btn btn-outline-secondary btn-sm" title="Agregar fila">Agregar fila</button>
        <button id="deleteRow" class="btn btn-outline-danger btn-sm" title="Eliminar fila">Eliminar fila</button>
        <small id="exportHint" class="text-danger" style="display:none; margin-left:.5rem;">Ingrese fecha de emisión para exportar</small>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body p-3">
      <div class="table-responsive horizontal-scroll">
        <table id="planillaTable" class="table table-hover table-sm align-middle mb-0" style="min-width:1400px">
          <colgroup>
            <col style="width:4%">
            <col style="width:40%">
            <col style="width:10%">
            <col style="width:10%">
            <col style="width:7%">
            <col style="width:9%">
            <col style="width:6%">
            <col style="width:9%">
            <col style="width:9%">
            <col style="width:9%">
            <col style="width:9%">
            <col style="width:9%">
            <col style="width:10%">
          </colgroup>

          <thead class="table-header-custom text-white">
            <tr>
              <th>No.</th>
              <th>Apellido(s), Nombre(s)</th>
              <th>Sueldo Base</th>
              <th>Bonificación</th>
              <th>Días Laborados</th>
              <th>Comisiones</th>
              <th>Horas extra</th>
              <th>Horas Extras (monto)</th>
              <th>Total Devengado</th>
              <th>Calculo del IGGS </th>
              <th>Calculo del ISR</th>
              <th>Otras deducciones</th>
              <th>Total Deducciones</th>
            </tr>
          </thead>

          <tbody>
            <tr data-row="1">
              <td>1</td>
              <td class="align-middle">EDNA ANABELY MARISTELA VELASQUEZ MALDONADO</td>
              <td>
                <div class="money-inline">
                  <span class="money-prefix">Q</span>
                  <input class="form-control num-cell sueldo" type="number" step="0.01" value="3723.05">
                </div>
              </td>
              <td>
                <div class="money-inline">
                  <span class="money-prefix">Q</span>
                  <input class="form-control num-cell bono" type="number" step="0.01" value="150.00">
                </div>
              </td>
              <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="15"></td>
              <td>
                <div class="money-inline">
                  <span class="money-prefix">Q</span>
                  <input class="form-control num-cell comisiones" type="number" step="0.01" value="0">
                </div>
              </td>
              <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="0"></td>
              <td class="text-end hextras">Q 0.00</td>
              <td class="text-end total-devengado">Q 0.00</td>
              <td class="text-end igss">Q 0.00</td>
              <td class="text-end isr-cell"></td>
              <td>
                <div class="money-inline">
                  <span class="money-prefix">Q</span>
                  <input class="form-control num-cell otras" type="number" step="0.01" value="0">
                </div>
              </td>
              <td class="text-end total-deducciones">Q 0.00</td>
            </tr>

            <tr data-row="2">
              <td>2</td>
              <td class="align-middle">IGDALIA ALIDA OCTAVI VELASQUEZ MALDONDO</td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell sueldo" type="number" step="0.01" value="3723.05"></div></td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell bono" type="number" step="0.01" value="150.00"></div></td>
              <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="15"></td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell comisiones" type="number" step="0.01" value="0"></div></td>
              <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="0"></td>
              <td class="text-end hextras">Q 0.00</td>
              <td class="text-end total-devengado">Q 0.00</td>
              <td class="text-end igss">Q 0.00</td>
              <td class="text-end isr-cell"></td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell otras" type="number" step="0.01" value="0"></div></td>
              <td class="text-end total-deducciones">Q 0.00</td>
            </tr>

            <tr data-row="3">
              <td>3</td>
              <td class="align-middle">ANGEL ESTUARDO ESCOBAR VELÁSQUEZ</td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell sueldo" type="number" step="0.01" value="4500.00"></div></td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell bono" type="number" step="0.01" value="150.00"></div></td>
              <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="15"></td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell comisiones" type="number" step="0.01" value="0"></div></td>
              <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="0"></td>
              <td class="text-end hextras">Q 0.00</td>
              <td class="text-end total-devengado">Q 0.00</td>
              <td class="text-end igss">Q 0.00</td>
              <td class="text-end isr-cell"></td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell otras" type="number" step="0.01" value="0"></div></td>
              <td class="text-end total-deducciones">Q 0.00</td>
            </tr>

            <tr data-row="4">
              <td>4</td>
              <td class="align-middle">LEONIDAS ANIBAL ESCOBAR PASCUAL</td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell sueldo" type="number" step="0.01" value="4500.00"></div></td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell bono" type="number" step="0.01" value="150.00"></div></td>
              <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="15"></td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell comisiones" type="number" step="0.01" value="0"></div></td>
              <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="0"></td>
              <td class="text-end hextras">Q 0.00</td>
              <td class="text-end total-devengado">Q 0.00</td>
              <td class="text-end igss">Q 0.00</td>
              <td class="text-end isr-cell"></td>
              <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell otras" type="number" step="0.01" value="0"></div></td>
              <td class="text-end total-deducciones">Q 0.00</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
/* Parámetros fiscales */
const IGSS_RATE = 0.0483;
const GASTOS_PERSONALES_ANUAL = 48000;
const ISR_ANNUAL_RATE = 0.05;
const ISR_MIN_SALARIO = 4000.00;

/* localStorage key */
const STORAGE_KEY = 'empaquetex_planilla_noviembre_v1';

/* Helpers */
function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }
function formatNum(n){ return n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
function withQ(n){ return 'Q ' + formatNum(n); }

/* Horas extras mensual: sueldo / dias / 8 * 1.5 * horas */
function computeHorasMontoMensual(sueldo, dias, horas) {
  if (!dias || dias <= 0) return 0;
  const valorHora = sueldo / dias / 8;
  const monto = valorHora * 1.5 * horas;
  return round2(monto);
}

/* ISR según ganancias brutas anuales */
function computeISRMonthlyFromRow(sueldo, bono, comisiones, hextrasMensual) {
  if (sueldo < ISR_MIN_SALARIO) return 0;
  const gbMensual = sueldo + bono + comisiones + hextrasMensual;
  const gbAnual = gbMensual * 12;
  const igssAnual = round2(gbAnual * IGSS_RATE);
  const baseCalculo = gbAnual - (igssAnual + GASTOS_PERSONALES_ANUAL);
  if (baseCalculo <= 0) return 0;
  const isrAnual = round2(baseCalculo * ISR_ANNUAL_RATE);
  const isrMensual = round2(isrAnual / 12);
  return isrMensual;
}

/* Recalcula fila */
function recalcRow(tr) {
  const sueldo = parseFloat(tr.querySelector('input.sueldo').value) || 0;
  const bono = parseFloat(tr.querySelector('input.bono').value) || 0;
  const comisiones = parseFloat(tr.querySelector('input.comisiones').value) || 0;
  const dias = parseInt(tr.querySelector('input.dias').value) || 0;
  const horas = parseInt(tr.querySelector('input.horas').value) || 0;
  const otras = parseFloat(tr.querySelector('input.otras').value) || 0;

  const hextrasMonto = computeHorasMontoMensual(sueldo, dias, horas);
  const totalDevengado = round2(sueldo + bono + comisiones + hextrasMonto);
  const igss = round2((sueldo + bono + comisiones + hextrasMonto) * IGSS_RATE);

  const isrMensual = computeISRMonthlyFromRow(sueldo, bono, comisiones, hextrasMonto);

  const totalDeducciones = round2(igss + isrMensual + otras);
  const liquido = round2(totalDevengado - totalDeducciones);

  const hextrasCell = tr.querySelector('.hextras'); if (hextrasCell) hextrasCell.textContent = withQ(hextrasMonto);
  const devCell = tr.querySelector('.total-devengado'); if (devCell) devCell.textContent = withQ(totalDevengado);
  const igssCell = tr.querySelector('.igss'); if (igssCell) igssCell.textContent = withQ(igss);

  const isrCell = tr.querySelector('.isr-cell');
  if (isrCell) {
    if (isrMensual > 0) isrCell.textContent = withQ(isrMensual);
    else isrCell.textContent = '';
  }

  tr.dataset._isrValue = isrMensual;
  tr.dataset._hextras = hextrasMonto;

  const totDedCell = tr.querySelector('.total-deducciones'); if (totDedCell) totDedCell.textContent = withQ(totalDeducciones);
  const liquiCell = tr.querySelector('.liquido'); if (liquiCell) liquiCell.textContent = withQ(liquido);
}

/* Recalcula totales (NO suma días) */
function recalcTotals() {
  const rows = document.querySelectorAll('#planillaTable tbody tr');
  let totals = {sueldo:0, bono:0, comisiones:0, horas:0, hextras:0, devengado:0, igss:0, isr:0, otras:0, deducciones:0};
  rows.forEach(tr => {
    const sueldo = parseFloat(tr.querySelector('input.sueldo').value) || 0;
    const bono = parseFloat(tr.querySelector('input.bono').value) || 0;
    const comisiones = parseFloat(tr.querySelector('input.comisiones').value) || 0;
    const horas = parseInt(tr.querySelector('input.horas').value) || 0;
    const otras = parseFloat(tr.querySelector('input.otras').value) || 0;

    const dias = parseInt(tr.querySelector('input.dias').value) || 0; // usado por fila, no se suma
    const hextrasMonto = parseFloat(tr.dataset._hextras) || computeHorasMontoMensual(sueldo, dias, horas);
    const totalDevengado = round2(sueldo + bono + comisiones + hextrasMonto);
    const igss = round2((sueldo + bono + comisiones + hextrasMonto) * IGSS_RATE);
    const isrMensual = parseFloat(tr.dataset._isrValue) || 0;
    const totalDeducciones = round2(igss + isrMensual + otras);

    totals.sueldo += sueldo;
    totals.bono += bono;
    totals.comisiones += comisiones;
    totals.horas += horas;
    totals.hextras += hextrasMonto;
    totals.devengado += totalDevengado;
    totals.igss += igss;
    totals.isr += isrMensual;
    totals.otras += otras;
    totals.deducciones += totalDeducciones;
  });

  // If you have elements to show totals, ensure their IDs exist in the page (placeholders removed in this template)
  if (document.getElementById('total-sueldo')) document.getElementById('total-sueldo').textContent = withQ(totals.sueldo);
  if (document.getElementById('total-bono')) document.getElementById('total-bono').textContent = withQ(totals.bono);
  if (document.getElementById('total-dias')) document.getElementById('total-dias').textContent = '';
  if (document.getElementById('total-comisiones')) document.getElementById('total-comisiones').textContent = withQ(totals.comisiones);
  if (document.getElementById('total-horas')) document.getElementById('total-horas').textContent = totals.horas.toString();
  if (document.getElementById('total-hextras')) document.getElementById('total-hextras').textContent = withQ(totals.hextras);
  if (document.getElementById('total-devengado')) document.getElementById('total-devengado').textContent = withQ(totals.devengado);
  if (document.getElementById('total-igss')) document.getElementById('total-igss').textContent = withQ(totals.igss);
  if (document.getElementById('total-isr')) document.getElementById('total-isr').textContent = withQ(totals.isr);
  if (document.getElementById('total-otras')) document.getElementById('total-otras').textContent = withQ(totals.otras);
  if (document.getElementById('total-deducciones')) document.getElementById('total-deducciones').textContent = withQ(totals.deducciones);
}

/* Serializar tabla para localStorage */
function serializeTable() {
  const rows = [];
  document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
    const nombre = (tr.querySelector('.nombre')?.value ?? tr.cells[1].textContent ?? '').trim();
    const sueldo = parseFloat(tr.querySelector('input.sueldo')?.value ?? 0) || 0;
    const bono = parseFloat(tr.querySelector('input.bono')?.value ?? 0) || 0;
    const dias = parseInt(tr.querySelector('input.dias')?.value ?? 0) || 0;
    const comisiones = parseFloat(tr.querySelector('input.comisiones')?.value ?? 0) || 0;
    const horas = parseInt(tr.querySelector('input.horas')?.value ?? 0) || 0;
    const otras = parseFloat(tr.querySelector('input.otras')?.value ?? 0) || 0;
    const hextras = parseFloat(tr.dataset._hextras) || 0;
    const isr = parseFloat(tr.dataset._isrValue) || 0;
    rows.push({ nombre, sueldo, bono, dias, comisiones, horas, otras, hextras, isr });
  });
  const meta = { saved_at: new Date().toISOString(), planillaName: document.getElementById('planillaName').value, emisionDate: document.getElementById('emisionDate').value };
  return { rows, meta };
}

/* Restaurar tabla desde objeto */
function restoreTable(data) {
  if (!data || !Array.isArray(data.rows)) return;
  const tbody = document.querySelector('#planillaTable tbody');
  tbody.innerHTML = '';
  data.rows.forEach((r, i) => {
    const idx = i + 1;
    const tr = document.createElement('tr');
    tr.dataset.row = idx;
    tr.innerHTML = `
      <td>${idx}</td>
      <td class="align-middle"><input class="form-control form-control-sm nombre" type="text" value="${escapeHtml(r.nombre || '')}"></td>
      <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell sueldo" type="number" step="0.01" value="${Number(r.sueldo||0).toFixed(2)}"></div></td>
      <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell bono" type="number" step="0.01" value="${Number(r.bono||0).toFixed(2)}"></div></td>
      <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="${Number(r.dias||0)}"></td>
      <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell comisiones" type="number" step="0.01" value="${Number(r.comisiones||0).toFixed(2)}"></div></td>
      <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="${Number(r.horas||0)}"></td>
      <td class="text-end hextras">Q ${Number(r.hextras||0).toFixed(2)}</td>
      <td class="text-end total-devengado">Q 0.00</td>
      <td class="text-end igss">Q 0.00</td>
      <td class="text-end isr-cell">${r.isr && r.isr>0 ? 'Q '+Number(r.isr).toFixed(2) : ''}</td>
      <td><div class="money-inline"><span class="money-prefix">Q</span><input class="form-control num-cell otras" type="number" step="0.01" value="${Number(r.otras||0).toFixed(2)}"></div></td>
      <td class="text-end total-deducciones">Q 0.00</td>
    `;
    tr.dataset._hextras = Number(r.hextras||0);
    tr.dataset._isrValue = Number(r.isr||0);
    tbody.appendChild(tr);
  });
  // recalcular todo
  document.querySelectorAll('#planillaTable tbody tr').forEach(tr => recalcRow(tr));
  recalcTotals();
}

/* Guardar en localStorage */
function saveToLocal() {
  try {
    const data = serializeTable();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {
    console.error('Error guardando planilla en localStorage', e);
  }
}

/* Cargar desde localStorage al inicio */
function loadFromLocal() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const obj = JSON.parse(raw);
    // restaurar planilla si hay filas guardadas
    if (obj && Array.isArray(obj.rows) && obj.rows.length) {
      restoreTable(obj);
      if (obj.meta) {
        if (obj.meta.planillaName) document.getElementById('planillaName').value = obj.meta.planillaName;
        if (obj.meta.emisionDate) document.getElementById('emisionDate').value = obj.meta.emisionDate;
      }
    }
  } catch (e) {
    console.error('Error cargando planilla desde localStorage', e);
  }
}

/* Escapar texto para insertar en value */
function escapeHtml(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* Delegated listener para inputs: recalcula y guarda */
document.addEventListener('input', (e) => {
  if (!e.target.classList) return;
  if (e.target.classList.contains('num-cell') || e.target.classList.contains('nombre')) {
    const tr = e.target.closest('tr');
    recalcRow(tr);
    recalcTotals();
    saveToLocal();
  }
});

/* Init */
document.addEventListener('DOMContentLoaded', () => {
  // cargar guardado si existe (sobrescribe tabla inicial si hay datos guardados)
  loadFromLocal();

  // recalcular (para casos donde no hubo localStorage)
  document.querySelectorAll('#planillaTable tbody tr').forEach(tr => recalcRow(tr));
  recalcTotals();
});

/* --- Inicializar bonos existentes: forzar 150 y readonly --- */
function lockExistingBonos() {
  document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
    const bonoInp = tr.querySelector('input.bono');
    if (bonoInp) {
      bonoInp.value = 150.00;
      bonoInp.setAttribute('readonly', 'readonly');
      bonoInp.classList.remove('num-cell'); // evitar doble disparo si quieres
    }
    // asegurar nombres ya cargados queden readonly
    const nombreInp = tr.querySelector('input.nombre');
    if (nombreInp) {
      if ((nombreInp.value || '').trim() !== '') {
        nombreInp.setAttribute('readonly', 'readonly');
      } else {
        nombreInp.removeAttribute('readonly');
      }
    }
    // forzar dias a 15 en todas las filas actuales
    const diasInp = tr.querySelector('input.dias');
    if (diasInp) diasInp.value = 15;
  });
}

/* --- Cuando se agrega fila: bonificación = 150 (readonly) y nombre editable sólo hasta llenarlo --- */
function createRowHtml(index) {
  return `
    <td>${index}</td>
    <td class="align-middle"><input class="form-control form-control-sm nombre" type="text" value=""></td>
    <td>
      <div class="money-inline">
        <span class="money-prefix">Q</span>
        <input class="form-control num-cell sueldo" type="number" step="0.01" value="0">
      </div>
    </td>
    <td>
      <div class="money-inline">
        <span class="money-prefix">Q</span>
        <input class="form-control bono" type="number" step="0.01" value="150.00" readonly>
      </div>
    </td>
    <td><input class="form-control form-control-sm num-cell dias" type="number" step="1" min="0" value="15"></td>
    <td>
      <div class="money-inline">
        <span class="money-prefix">Q</span>
        <input class="form-control num-cell comisiones" type="number" step="0.01" value="0">
      </div>
    </td>
    <td><input class="form-control form-control-sm num-cell horas" type="number" step="1" min="0" value="0"></td>
    <td class="text-end hextras">Q 0.00</td>
    <td class="text-end total-devengado">Q 0.00</td>
    <td class="text-end igss">Q 0.00</td>
    <td class="text-end isr-cell"></td>
    <td>
      <div class="money-inline">
        <span class="money-prefix">Q</span>
        <input class="form-control num-cell otras" type="number" step="0.01" value="0">
      </div>
    </td>
    <td class="text-end total-deducciones">Q 0.00</td>
  `;
}

/* --- Listener que bloquea nombre cuando se llena por primera vez --- */
document.addEventListener('blur', (e) => {
  if (!e.target.classList) return;
  if (e.target.classList.contains('nombre')) {
    const val = (e.target.value || '').trim();
    if (val !== '') {
      e.target.setAttribute('readonly', 'readonly');
    }
  }
}, true);

/* --- Protección adicional: impedir cambios a bonificaciones por JS accidental --- */
function enforceBonoProtectionOnAllRows() {
  document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
    const bonoInp = tr.querySelector('input.bono');
    if (bonoInp) {
      bonoInp.value = 150.00;
      bonoInp.setAttribute('readonly', 'readonly');
    }
    // forzar dias a 15 también
    const diasInp = tr.querySelector('input.dias');
    if (diasInp) diasInp.value = 15;
  });
}

/* --- Modificar el handler de Add row para usar createRowHtml y aplicar protecciones --- */
document.getElementById('addRow').addEventListener('click', () => {
  const tbody = document.querySelector('#planillaTable tbody');
  const newIndex = tbody.querySelectorAll('tr').length + 1;
  const tr = document.createElement('tr');
  tr.dataset.row = newIndex;
  tr.innerHTML = createRowHtml(newIndex);
  tbody.appendChild(tr);

  // inicializar comportamiento del nombre (editable hasta que se llene)
  const nombreInp = tr.querySelector('input.nombre');
  if (nombreInp) nombreInp.removeAttribute('readonly');

  // asegurar bono fijo
  const bonoInp = tr.querySelector('input.bono');
  if (bonoInp) {
    bonoInp.value = 150.00;
    bonoInp.setAttribute('readonly', 'readonly');
  }

  // forzar dias por defecto a 15
  const diasInp = tr.querySelector('input.dias');
  if (diasInp) diasInp.value = 15;

  // recalcular fila y totales
  recalcRow(tr);
  recalcTotals();
  saveToLocal();
});

/* --- Al iniciar: aplicar bloqueo a bonos existentes y listeners para proteger valores --- */
document.addEventListener('DOMContentLoaded', () => {
  lockExistingBonos();
  enforceBonoProtectionOnAllRows();
});

/* Delete last row */
document.getElementById('deleteRow').addEventListener('click', () => {
  const tbody = document.querySelector('#planillaTable tbody');
  const rows = tbody.querySelectorAll('tr');
  if (rows.length === 0) return;
  tbody.removeChild(rows[rows.length - 1]);
  recalcTotals();
  saveToLocal();
});

/* Export to Excel (.xlsx): requiere fecha de emisión */
document.getElementById('exportExcel').addEventListener('click', () => {
  const dateInput = document.getElementById('emisionDate').value;
  const planillaName = document.getElementById('planillaName').value.trim() || 'Planilla';
  const exportHint = document.getElementById('exportHint');
  if (!dateInput) {
    exportHint.style.display = 'inline';
    return;
  }
  exportHint.style.display = 'none';

  // Clonar tabla y limpiar inputs
  const table = document.getElementById('planillaTable');
  const clone = table.cloneNode(true);
  clone.querySelectorAll('input').forEach(inp => {
    const parent = inp.parentElement || inp;
    parent.replaceChild(document.createTextNode(inp.value), inp);
  });

  // Convertir celdas Q... a números
  clone.querySelectorAll('td, th').forEach(cell => {
    let txt = (cell.textContent || '').replace(/\u00A0/g, ' ').trim();
    if (txt === '') return;
    const removed = txt.replace(/^Q\s*/i, '').replace(/,/g, '');
    const n = Number(removed);
    if (removed !== '' && isFinite(n)) cell.textContent = n;
    else cell.textContent = txt;
  });

  // Crear hoja y añadir encabezado con nombre y fecha
  const ws = XLSX.utils.table_to_sheet(clone, {raw:true});
  XLSX.utils.sheet_add_aoa(ws, [[planillaName]], {origin: "A1"});
  XLSX.utils.sheet_add_aoa(ws, [[`Fecha de emisión:`, dateInput]], {origin: "A2"});

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Planilla");

  const safeName = planillaName.replace(/[^a-z0-9_\- ]/gi,'').replace(/\s+/g,'_');
  const filename = `${safeName}_${dateInput}.xlsx`;
  XLSX.writeFile(wb, filename);
});

// --- Auto-dividir Sueldo Base entre 2 al ingresar ---
// (esta sección la dejo tal cual, no se tocó salvo lo estrictamente necesario)
(function(){
  function parseNumberSafe(v){
    if (v == null) return 0;
    try {
      const s = String(v).replace(/\s+/g,'').replace(/,/g,'').trim();
      const n = Number(s);
      return isFinite(n) ? n : 0;
    } catch {
      return 0;
    }
  }

  function applyHalfToSueldoInput(inp){
    if (!inp) return;
    const raw = inp.value;
    const n = parseNumberSafe(raw);
    if (n === 0) {
      inp.value = n.toFixed(2);
    } else {
      const half = Math.round((n / 2 + Number.EPSILON) * 100) / 100;
      if (inp.type === 'number') inp.value = half;
      else inp.value = half.toFixed(2);
    }
    try {
      const tr = inp.closest('tr');
      if (typeof recalcRow === 'function' && tr) recalcRow(tr);
      if (typeof recalcTotals === 'function') recalcTotals();
      if (typeof saveToLocal === 'function') saveToLocal();
    } catch (e) {
      console.error('Error aplicando mitad al sueldo:', e);
    }
  }

  document.addEventListener('input', function(e){
    const t = e.target;
    if (!t || !t.classList) return;
    if (t.classList.contains('sueldo')) {
      // no dividir en cada tecla por defecto
    }
  }, true);

  document.addEventListener('paste', function(e){
    const t = e.target;
    if (!t || !t.classList) return;
    if (t.classList.contains('sueldo')) {
      setTimeout(()=> applyHalfToSueldoInput(t), 20);
    }
  });

  document.addEventListener('blur', function(e){
    const t = e.target;
    if (!t || !t.classList) return;
    if (t.classList.contains('sueldo')) {
      applyHalfToSueldoInput(t);
    }
  }, true);

  window.addEventListener('load', function(){
    document.querySelectorAll('input.sueldo').forEach(inp => {
      const val = inp.value;
      if (val !== null && String(val).trim() !== '') applyHalfToSueldoInput(inp);
    });
  });
})();
</script>

<style>
  :root{
    --bg-grad-start: #f3f6ff;
    --bg-grad-end: #fafbff;
    --muted: #6c757d;
    --accent1: #0ea5a4;
    --accent2: #0b7285;
    --panel: #f8f9fa;
    --planilla-cell-vertical-padding: 1.08rem;
    --planilla-cell-horizontal-padding: 1.5rem;
    --planilla-input-min-height: 52px;
    --planilla-input-font-size: 1.03rem;
    --planilla-money-min-width: 225px;
    --planilla-name-col-min-width: 360px;
  }

  body { background: linear-gradient(180deg,var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); }
  .card { border-radius: .6rem; }
  .card .card-body { padding: 1rem 1.1rem; }
  h3 { font-weight:600; color:var(--accent2); }

  .form-control { border-radius:.45rem; font-size: var(--planilla-input-font-size); }

  .btn-primary { background: linear-gradient(90deg,var(--accent1),var(--accent2)); border: none; box-shadow: 0 6px 20px rgba(11,114,133,0.08); }
  .btn-outline-secondary { border-radius:.45rem; }
  .table-header-custom { background: linear-gradient(90deg,#0ea5a4,#036b6a); }
  .table-header-custom th { color:#fff; border:0; font-weight:700; padding:.9rem 1rem; }

  table.table { border-collapse: separate; border-spacing:0; border-radius:.6rem; overflow:hidden; box-shadow: 0 1px 2px rgba(15,23,42,0.04); width:100%; }
  table.table td, table.table th {
    vertical-align: middle;
    padding: var(--planilla-cell-vertical-padding) var(--planilla-cell-horizontal-padding);
  }

  .horizontal-scroll { overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .text-end { text-align:right; }
  .fw-bold { font-weight:700; }

  .money-inline {
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    white-space: nowrap;
    flex-wrap: nowrap;
  }
  .money-prefix {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex: 0 0 auto;
    margin-right: 0;
    min-width: 38px;
    height: var(--planilla-input-min-height);
    padding: 0 .6rem;
    border-radius: .45rem;
    background: linear-gradient(180deg,#fff 0%, #f3f6fb 100%);
    border:1px solid rgba(0,0,0,0.06);
    font-weight:600;
    color:#333;
    box-sizing: border-box;
  }

  .money-inline .form-control {
    min-width: var(--planilla-money-min-width);
    min-height: var(--planilla-input-min-height);
    height: var(--planilla-input-min-height);
    padding-top: .50rem;
    padding-bottom: .50rem;
    box-sizing: border-box;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #planillaTable input.form-control {
    font-size: var(--planilla-input-font-size);
    min-height: var(--planilla-input-min-height);
    height: var(--planilla-input-min-height);
    box-sizing: border-box;
    padding: .45rem .6rem;
  }

  #planillaTable col:nth-child(2),
  #planillaTable td:nth-child(2),
  #planillaTable th:nth-child(2) {
    min-width: var(--planilla-name-col-min-width);
    white-space: normal;
    word-break: break-word;
  }

  #planillaTable td.total-devengado,
  #planillaTable td.igss,
  #planillaTable td.total-deducciones,
  #planillaTable td.liquido,
  #planillaTable td.isr-cell,
  #planillaTable tfoot td {
    text-align: right;
    vertical-align: middle;
  }

  #planillaTable td input.horas {
    text-align:center;
    padding-top: .35rem;
    padding-bottom: .35rem;
    height: calc(var(--planilla-input-min-height) - .8rem);
  }

  table.table tbody tr { background: #fff; }
  table.table tbody tr:nth-child(odd) { background: #fbfeff; }

  @media (max-width: 1000px) {
    :root {
      --planilla-money-min-width: 165px;
      --planilla-input-min-height: 48px;
      --planilla-cell-horizontal-padding: 1.2rem;
      --planilla-name-col-min-width: 265px;
    }
    #planillaTable { min-width: 1220px; }
  }

  @media (max-width: 576px) {
    :root {
      --planilla-money-min-width: 130px;
      --planilla-input-min-height: 50px;
      --planilla-cell-horizontal-padding: 1.0rem;
      --planilla-name-col-min-width: 210px;
    }
    #planillaTable { min-width: 1030px; }
  }

table.table {
  border-collapse: collapse;
}

table.table th,
table.table td {
  border-right: 1px solid #e6eef6;
  border-bottom: 1px solid #e9f0f7;
}

table.table th:last-child,
table.table td:last-child {
  border-right: none;
}

.table-header-custom th {
  border-bottom: 2px solid rgba(15,23,42,0.06);
}

table.table th:first-child,
table.table td:first-child {
  border-left: 1px solid #e6eef6;
}

table.table tbody tr:first-child td {
  border-top: 1px solid #eef6fb;
}

.table-responsive { overflow-x:auto; -webkit-overflow-scrolling:touch; }

#planillaTable tfoot tr td {
  border-top: 2px solid var(--tfoot-top-border);
  border-right: 1px solid #e6eef6;
}
#planillaTable tfoot tr td:last-child {
  border-right: none;
}
</style>

{% endblock %}
