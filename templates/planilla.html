{% extends "layout.html" %}
{% block title %}Planilla - Noviembre 2025{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mt-3">Planilla - Noviembre 2025</h2>
  <p class="text-muted">Empresa: EMPAQUES Y TEXTURAS DE GUATEMALA, SOCIEDAD ANÓNIMA</p>

  <div class="table-responsive mb-3 horizontal-scroll">
    <table id="planillaTable" class="table table-bordered table-sm">
      <colgroup>
        <col style="width:4%">
        <col style="width:36%">
        <col style="width:9%">
        <col style="width:9%">
        <col style="width:7%">
        <col style="width:8%">
        <col style="width:6%">
        <col style="width:8%">
        <col style="width:8%">
        <col style="width:8%">
        <col style="width:8%">
        <col style="width:8%">
        <col style="width:10%">
      </colgroup>

      <thead class="thead-light">
        <tr>
          <th>No.</th>
          <th>Apellido(s), Nombre(s)</th>
          <th>Sueldo Base</th>
          <th>Bonificación</th>
          <th>Días Laborados</th>
          <th>Comisiones</th>
          <th>Horas extra</th>
          <th>Horas Extras (monto)</th>
          <th>Total Devengado</th>
          <th>IGSS (4.83%)</th>
          <th>ISR (calculado)</th>
          <th>Otras deducciones</th>
          <th>Total Deducciones</th>
          <th>Líquido a pagar</th>
          <th>Medio de pago (Banco) / Firma</th>
          <th>Observaciones</th>
        </tr>
      </thead>

      <tbody>
        <!-- ejemplo fila 1 -->
        <tr data-row="1">
          <td class="align-middle">1</td>
          <td class="align-middle">EDNA ANABELY MARISTELA VELASQUEZ MALDONAOD</td>

          <td>
            <div class="money-inline">
              <span class="money-prefix">Q</span>
              <input type="number" step="0.01" class="form-control num-cell sueldo" value="3723.05">
            </div>
          </td>

          <td>
            <div class="money-inline">
              <span class="money-prefix">Q</span>
              <input type="number" step="0.01" class="form-control num-cell bono" value="250.00">
            </div>
          </td>

          <td><input type="number" step="1" min="0" class="form-control form-control-sm num-cell dias" value="30"></td>

          <td>
            <div class="money-inline">
              <span class="money-prefix">Q</span>
              <input type="number" step="0.01" class="form-control num-cell comisiones" value="0">
            </div>
          </td>

          <td><input type="number" step="1" min="0" class="form-control form-control-sm num-cell horas" value="0"></td>

          <!-- Horas Extras (monto) calculada -->
          <td class="text-right align-middle hextras">Q 0.00</td>

          <td class="text-right align-middle total-devengado">Q 0.00</td>
          <td class="text-right align-middle igss">Q 0.00</td>

          <!-- ISR editable: calculado automáticamente pero editable por el usuario;
               si el usuario lo edita, se marca como manual y deja de calcularse hasta que cambien otros campos -->
          <td>
            <div class="money-inline">
              <span class="money-prefix">Q</span>
              <input type="number" step="0.01" class="form-control num-cell isr" value="0">
            </div>
          </td>

          <td>
            <div class="money-inline">
              <span class="money-prefix">Q</span>
              <input type="number" step="0.01" class="form-control num-cell otras" value="0">
            </div>
          </td>

          <td class="text-right align-middle total-deducciones">Q 0.00</td>
          <td class="text-right align-middle liquido">Q 0.00</td>

          <td><input type="text" class="form-control form-control-sm medio-pago" value=""></td>
          <td><input type="text" class="form-control form-control-sm obs" value=""></td>
        </tr>

        <!-- copia las filas necesarias o usa Agregar fila -->
        <tr data-row="2"> <!-- ejemplo fila 2 -->
          <td class="align-middle">2</td>
          <td class="align-middle">IGDALIA ALIDA OCTAVI VELASQUEZ MALDONDO</td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input type="number" step="0.01" class="form-control num-cell sueldo" value="3723.05"></div></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input type="number" step="0.01" class="form-control num-cell bono" value="250.00"></div></td>
          <td><input type="number" step="1" min="0" class="form-control form-control-sm num-cell dias" value="30"></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input type="number" step="0.01" class="form-control num-cell comisiones" value="0"></div></td>
          <td><input type="number" step="1" min="0" class="form-control form-control-sm num-cell horas" value="0"></td>
          <td class="text-right align-middle hextras">Q 0.00</td>
          <td class="text-right align-middle total-devengado">Q 0.00</td>
          <td class="text-right align-middle igss">Q 0.00</td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input type="number" step="0.01" class="form-control num-cell isr" value="0"></div></td>
          <td><div class="money-inline"><span class="money-prefix">Q</span><input type="number" step="0.01" class="form-control num-cell otras" value="0"></div></td>
          <td class="text-right align-middle total-deducciones">Q 0.00</td>
          <td class="text-right align-middle liquido">Q 0.00</td>
          <td><input type="text" class="form-control form-control-sm medio-pago" value=""></td>
          <td><input type="text" class="form-control form-control-sm obs" value=""></td>
        </tr>

        <!-- agrega más filas según necesites -->
      </tbody>

      <tfoot>
        <tr class="font-weight-bold">
          <td colspan="2" class="text-right">TOTAL</td>
          <td id="total-sueldo" class="text-right">Q 0.00</td>
          <td id="total-bono" class="text-right">Q 0.00</td>
          <td id="total-dias" class="text-right">0</td>
          <td id="total-comisiones" class="text-right">Q 0.00</td>
          <td id="total-horas" class="text-right">0</td>
          <td id="total-hextras" class="text-right">Q 0.00</td>
          <td id="total-devengado" class="text-right">Q 0.00</td>
          <td id="total-igss" class="text-right">Q 0.00</td>
          <td id="total-isr" class="text-right">Q 0.00</td>
          <td id="total-otras" class="text-right">Q 0.00</td>
          <td id="total-deducciones" class="text-right">Q 0.00</td>
          <td id="total-liquido" class="text-right">Q 0.00</td>
          <td></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="mb-4">
    <button id="addRow" class="btn btn-sm btn-outline-primary">Agregar fila</button>
    <button id="exportCsv" class="btn btn-sm btn-outline-secondary">Exportar CSV</button>
    <span class="ml-3 text-muted">Los cálculos se realizan en tiempo real: Horas Extras (monto) = Sueldo Base / Días Laborados / 8 * 1.5 * Horas extra. Total Devengado = Sueldo Base + Bonificación + Comisiones + Horas Extras (monto). IGSS = Sueldo Base * 4.83%. ISR mensual calculado desde la hoja CALCULO DEL ISR del archivo y aplica solo si Sueldo Base ≥ Q 4,000. Si editas manualmente el ISR en una fila, el sistema respetará tu cambio hasta que modifiques un campo base (sueldo, días, horas, bono, comisiones, otras), momento en el que el ISR volverá a recalcularse automáticamente.</span>
  </div>
</div>

<script>
/* Parámetros fiscales tomados del archivo CALCULO DEL ISR */
const IGSS_RATE = 0.0483;
const GASTOS_PERSONALES_ANUAL = 48000; // artículo 72 en tu hoja
const ISR_ANNUAL_RATE = 0.05; // según tu hoja
const ISR_MIN_SALARIO = 4000.00; // ISR solo si sueldo base >= Q 4,000

/* helpers */
function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }
function formatNum(n){ return n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
function withQ(n){ return 'Q ' + formatNum(n); }

/* compute hours-amount: sueldo / dias / 8 * 1.5 * horas */
function computeHorasMonto(sueldo, dias, horas) {
  if (!dias || dias <= 0) return 0;
  const valorHora = sueldo / dias / 8;
  const monto = valorHora * 1.5 * horas;
  return round2(monto);
}

/* compute ISR monthly using the logic in the CALCULO DEL ISR sheet:
   - aplicable solo si sueldoBaseMensual >= ISR_MIN_SALARIO
   - salario_anual = sueldo_base * 12
   - igss_anual = salario_anual * IGSS_RATE
   - base_calculo = salario_anual - GASTOS_PERSONALES_ANUAL - igss_anual
   - if base_calculo <= 0 => isr_anual = 0
   - else isr_anual = base_calculo * ISR_ANNUAL_RATE
   - isr_mensual = isr_anual / 12
*/
function computeISRMonthly(sueldoBaseMensual) {
  if (sueldoBaseMensual < ISR_MIN_SALARIO) return 0;
  const salarioAnual = sueldoBaseMensual * 12;
  const igssAnual = salarioAnual * IGSS_RATE;
  const baseCalculo = salarioAnual - GASTOS_PERSONALES_ANUAL - igssAnual;
  if (baseCalculo <= 0) return 0;
  const isrAnual = baseCalculo * ISR_ANNUAL_RATE;
  const isrMensual = isrAnual / 12;
  return round2(isrMensual);
}

/* marca/desmarca ISR manual por fila */
function setIsrManualFlag(tr, manual) {
  if (manual) tr.dataset.isrManual = '1';
  else delete tr.dataset.isrManual;
}
function isIsrManual(tr) { return tr.dataset.isrManual === '1'; }

/* recalcula una sola fila; respeta ISR manual si está marcado */
function recalcRow(tr) {
  const sueldo = parseFloat(tr.querySelector('.sueldo').value) || 0;
  const bono = parseFloat(tr.querySelector('.bono').value) || 0;
  const comisiones = parseFloat(tr.querySelector('.comisiones').value) || 0;
  const dias = parseInt(tr.querySelector('.dias').value) || 0;
  const horas = parseInt(tr.querySelector('.horas').value) || 0;
  const otras = parseFloat(tr.querySelector('.otras').value) || 0;

  const hextrasMonto = computeHorasMonto(sueldo, dias, horas);
  const totalDevengado = round2(sueldo + bono + comisiones + hextrasMonto);
  const igss = round2(sueldo * IGSS_RATE);

  const isrCalculado = computeISRMonthly(sueldo);

  /* actualiza visuales calculadas */
  tr.querySelector('.hextras').textContent = withQ(hextrasMonto);
  tr.querySelector('.total-devengado').textContent = withQ(totalDevengado);
  tr.querySelector('.igss').textContent = withQ(igss);

  /* ISR: si el usuario editó manualmente, no sobrescribimos.
     Si no hay marca manual, actualizamos el campo ISR con el valor calculado. */
  const isrInput = tr.querySelector('.isr');
  if (!isIsrManual(tr)) {
    isrInput.value = isrCalculado.toFixed(2);
  }

  const isrFinal = parseFloat(isrInput.value) || 0;
  const totalDeducciones = round2(igss + isrFinal + otras);
  const liquido = round2(totalDevengado - totalDeducciones);

  tr.querySelector('.total-deducciones').textContent = withQ(totalDeducciones);
  tr.querySelector('.liquido').textContent = withQ(liquido);
}

/* recalcula totales del pie */
function recalcTotals() {
  const rows = document.querySelectorAll('#planillaTable tbody tr');
  let totals = {sueldo:0, bono:0, dias:0, comisiones:0, horas:0, hextras:0, devengado:0, igss:0, isr:0, otras:0, deducciones:0, liquido:0};
  rows.forEach(tr => {
    const sueldo = parseFloat(tr.querySelector('.sueldo').value) || 0;
    const bono = parseFloat(tr.querySelector('.bono').value) || 0;
    const dias = parseInt(tr.querySelector('.dias').value) || 0;
    const comisiones = parseFloat(tr.querySelector('.comisiones').value) || 0;
    const horas = parseInt(tr.querySelector('.horas').value) || 0;
    const otras = parseFloat(tr.querySelector('.otras').value) || 0;

    const hextrasMonto = computeHorasMonto(sueldo, dias, horas);
    const totalDevengado = round2(sueldo + bono + comisiones + hextrasMonto);
    const igss = round2(sueldo * IGSS_RATE);
    const isrFinal = parseFloat(tr.querySelector('.isr').value) || 0;
    const totalDeducciones = round2(igss + isrFinal + otras);
    const liquido = round2(totalDevengado - totalDeducciones);

    totals.sueldo += sueldo;
    totals.bono += bono;
    totals.dias += dias;
    totals.comisiones += comisiones;
    totals.horas += horas;
    totals.hextras += hextrasMonto;
    totals.devengado += totalDevengado;
    totals.igss += igss;
    totals.isr += isrFinal;
    totals.otras += otras;
    totals.deducciones += totalDeducciones;
    totals.liquido += liquido;
  });

  document.getElementById('total-sueldo').textContent = withQ(totals.sueldo);
  document.getElementById('total-bono').textContent = withQ(totals.bono);
  document.getElementById('total-dias').textContent = totals.dias.toString();
  document.getElementById('total-comisiones').textContent = withQ(totals.comisiones);
  document.getElementById('total-horas').textContent = totals.horas.toString();
  document.getElementById('total-hextras').textContent = withQ(totals.hextras);
  document.getElementById('total-devengado').textContent = withQ(totals.devengado);
  document.getElementById('total-igss').textContent = withQ(totals.igss);
  document.getElementById('total-isr').textContent = withQ(totals.isr);
  document.getElementById('total-otras').textContent = withQ(totals.otras);
  document.getElementById('total-deducciones').textContent = withQ(totals.deducciones);
  document.getElementById('total-liquido').textContent = withQ(totals.liquido);
}

/* cuando el usuario edita campos base (sueldo, bono, dias, comisiones, horas, otras),
   se elimina la marca manual de ISR para que vuelva a recalcularse */
function attachBaseFieldReset(tr) {
  ['sueldo','bono','dias','comisiones','horas','otras'].forEach(cls => {
    const el = tr.querySelector('.' + cls);
    if (!el) return;
    el.addEventListener('input', () => {
      setIsrManualFlag(tr, false); // clear manual flag when core values change
      recalcRow(tr);
      recalcTotals();
    });
  });
}

/* ISR input: si el usuario lo cambia manualmente, marcamos la fila como manual */
function attachIsrManualControl(tr) {
  const isrInput = tr.querySelector('.isr');
  if (!isrInput) return;
  isrInput.addEventListener('input', () => {
    // If user manually types, set manual flag
    setIsrManualFlag(tr, true);
    recalcRow(tr);
    recalcTotals();
  });
}

/* Delegated listener: recompute when other numeric inputs change (handles added rows) */
document.addEventListener('input', (e) => {
  if (!e.target.classList) return;
  if (e.target.classList.contains('num-cell')) {
    const tr = e.target.closest('tr');
    // if the edited field was ISR, attachIsrManualControl already handled marking manual
    if (e.target.classList.contains('isr')) {
      // user typed ISR manually — handled by specific handler; still update totals
      recalcRow(tr);
      recalcTotals();
      return;
    }
    // other numeric fields
    // for base fields, base-field input handler removes ISR manual flag via attachBaseFieldReset
    recalcRow(tr);
    recalcTotals();
  }
});

/* Inicializar filas existentes: attach handlers y calcular */
document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
  attachBaseFieldReset(tr);
  attachIsrManualControl(tr);
  recalcRow(tr);
});
recalcTotals();

/* Agregar fila (mantiene el comportamiento) */
document.getElementById('addRow').addEventListener('click', () => {
  const tbody = document.querySelector('#planillaTable tbody');
  const newIndex = tbody.querySelectorAll('tr').length + 1;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="align-middle">${newIndex}</td>
    <td><input type="text" class="form-control form-control-sm" value=""></td>

    <td><div class="money-inline"><span class="money-prefix">Q</span><input type="number" step="0.01" class="form-control num-cell sueldo" value="0"></div></td>
    <td><div class="money-inline"><span class="money-prefix">Q</span><input type="number" step="0.01" class="form-control num-cell bono" value="0"></div></td>
    <td><input type="number" step="1" min="0" class="form-control form-control-sm num-cell dias" value="30"></td>
    <td><div class="money-inline"><span class="money-prefix">Q</span><input type="number" step="0.01" class="form-control num-cell comisiones" value="0"></div></td>
    <td><input type="number" step="1" min="0" class="form-control form-control-sm num-cell horas" value="0"></td>
    <td class="text-right align-middle hextras">Q 0.00</td>

    <td class="text-right align-middle total-devengado">Q 0.00</td>
    <td class="text-right align-middle igss">Q 0.00</td>

    <td><div class="money-inline"><span class="money-prefix">Q</span><input type="number" step="0.01" class="form-control num-cell isr" value="0"></div></td>
    <td><div class="money-inline"><span class="money-prefix">Q</span><input type="number" step="0.01" class="form-control num-cell otras" value="0"></div></td>

    <td class="text-right align-middle total-deducciones">Q 0.00</td>
    <td class="text-right align-middle liquido">Q 0.00</td>

    <td><input type="text" class="form-control form-control-sm medio-pago" value=""></td>
    <td><input type="text" class="form-control form-control-sm obs" value=""></td>`;
  tbody.appendChild(tr);

  attachBaseFieldReset(tr);
  attachIsrManualControl(tr);
  recalcRow(tr);
  recalcTotals();
});

/* Export CSV (valores numéricos sin prefijo 'Q') */
document.getElementById('exportCsv').addEventListener('click', () => {
  const rows = [];
  const header = Array.from(document.querySelectorAll('#planillaTable thead th')).map(th => th.innerText.trim());
  rows.push(header.join(','));
  document.querySelectorAll('#planillaTable tbody tr').forEach(tr => {
    const cols = [];
    cols.push(tr.querySelector('td:nth-child(1)').innerText.trim());
    const nameCell = tr.querySelector('td:nth-child(2)');
    cols.push(nameCell.querySelector('input') ? `"${nameCell.querySelector('input').value.replace(/"/g,'""')}"` : `"${nameCell.innerText.trim().replace(/"/g,'""')}"`);

    const sueldo = parseFloat(tr.querySelector('.sueldo').value) || 0;
    const bono = parseFloat(tr.querySelector('.bono').value) || 0;
    const dias = parseInt(tr.querySelector('.dias').value) || 0;
    const comis = parseFloat(tr.querySelector('.comisiones').value) || 0;
    const horas = parseInt(tr.querySelector('.horas').value) || 0;
    const hex = parseFloat(tr.querySelector('.hextras').textContent.replace(/Q\s?/g,'')) || 0;
    const devengado = parseFloat(tr.querySelector('.total-devengado').textContent.replace(/Q\s?/g,'')) || 0;
    const igss = parseFloat(tr.querySelector('.igss').textContent.replace(/Q\s?/g,'')) || 0;
    const isr = parseFloat(tr.querySelector('.isr').value) || 0;
    const otras = parseFloat(tr.querySelector('.otras').value) || 0;
    const totDed = parseFloat(tr.querySelector('.total-deducciones').textContent.replace(/Q\s?/g,'')) || 0;
    const liqui = parseFloat(tr.querySelector('.liquido').textContent.replace(/Q\s?/g,'')) || 0;
    const medio = tr.querySelector('.medio-pago') ? tr.querySelector('.medio-pago').value.replace(/"/g,'""') : '';
    const obs = tr.querySelector('.obs') ? tr.querySelector('.obs').value.replace(/"/g,'""') : '';
    cols.push(sueldo, bono, dias, comis, horas, hex, devengado, igss, isr, otras, totDed, liqui, `"${medio}"`, `"${obs}"`);
    rows.push(cols.join(','));
  });

  const csv = rows.join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'planilla_noviembre.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
</script>

<style>
  .horizontal-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  #planillaTable { min-width: 1500px; font-size: 0.98rem; }
  #planillaTable thead th { white-space: nowrap; padding: .65rem .6rem; }

  .money-inline { display:flex; align-items:center; gap:0.35rem; }
  .money-prefix { background:#f1f3f5; border:1px solid #ced4da; padding:.32rem .45rem; border-radius:4px; min-width:26px; text-align:center; font-weight:600; }
  .money-inline .form-control { padding:.45rem .6rem; min-width:140px; }

  #planillaTable input.form-control { font-size: .98rem; width:100%; box-sizing:border-box; }

  #planillaTable td:nth-child(2) { white-space: normal; word-break: break-word; }

  #planillaTable td.total-devengado,
  #planillaTable td.igss,
  #planillaTable td.total-deducciones,
  #planillaTable td.liquido,
  #planillaTable tfoot td { text-align: right; vertical-align: middle; }

  #planillaTable td input.horas { text-align:center; }
  @media (max-width:992px) {
    #planillaTable { min-width: 1300px; }
    colgroup col:nth-child(2) { width:45%; }
  }
</style>
{% endblock %}
